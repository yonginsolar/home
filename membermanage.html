<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ì¡°í•©ì› ê´€ë¦¬ | ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•©</title>
    
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <link href="https://webfontworld.github.io/gmarket/GmarketSans.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <link rel="stylesheet" href="style.css">

    <style>
        /* ëŒ€ì‹œë³´ë“œ ì „ìš© ì¶”ê°€ ìŠ¤íƒ€ì¼ (style.cssì™€ ì¶©ëŒ ì—†ì´ ë ˆì´ì•„ì›ƒ ì¡ê¸° ìœ„í•¨) */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .card-box {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            border: 1px solid #eee;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        /* íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .menu-btn {
            padding: 15px;
            border: 1px solid #eee;
            background: #fff;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            color: #555;
        }
        .menu-btn:hover {
            background: #f8f9fa;
            color: var(--color-primary);
            border-color: var(--color-primary);
        }
        .menu-btn.active {
            background: var(--color-primary);
            color: #fff;
            border-color: var(--color-primary);
        }

        /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 10000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #eee;
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ìˆ¨ê¹€ í´ë˜ìŠ¤ */
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header id="header" class="fixed-top">
        <div class="container d-flex align-items-center justify-content-between">
            <div class="logo">
                <h1><a href="index.html">ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›</a></h1>
            </div>
            <nav id="navbar" class="navbar">
                <ul>
                    <li><a class="nav-link" href="index.html">í™ˆ</a></li>
                    <li><a class="nav-link active" href="#">ì¡°í•©ì› ê³µê°„</a></li>
                </ul>
                <i class="bi bi-list mobile-nav-toggle"></i>
            </nav>
        </div>
    </header>

    <div class="navbar-mobile">
        <ul>
            <li><a href="index.html">í™ˆìœ¼ë¡œ</a></li>
            <li><a href="#" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a></li>
        </ul>
        <i class="bi bi-x mobile-nav-toggle"></i>
    </div>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div style="margin-top:15px; font-weight:bold; color:#555;" id="loadingMsg">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
    </div>

    <main id="main" style="padding-top: 100px; padding-bottom: 60px; min-height: 80vh; background:#fcfcfc;">
        
        <div id="loginSection" class="container">
            <div class="signup-wrapper" style="max-width: 500px;">
                <h2 class="form-title" style="text-align: center;">ì¡°í•©ì› ë¡œê·¸ì¸</h2>
                
                <div class="info-box" style="margin-bottom: 30px;">
                    <div class="info-text">ê°€ì… ì‹œ ë“±ë¡í•œ <b>ì´ë©”ì¼ ì£¼ì†Œ</b>ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                    <div class="info-text">ì´ë©”ì¼ë¡œ <b>ì¸ì¦ë²ˆí˜¸(6ìë¦¬)</b>ê°€ ë°œì†¡ë©ë‹ˆë‹¤.</div>
                </div>

                <div class="email-gate-group">
                    <input type="email" id="emailInput" class="form-control" placeholder="example@email.com" onkeyup="if(event.key==='Enter') requestAuth()">
                    <button class="btn btn-dark" id="btnSendAuth" onclick="requestAuth()">ì¸ì¦ìš”ì²­</button>
                </div>

                <div id="authInputBox" class="hidden" style="margin-top: 20px; animation: modalPop 0.3s ease-out;">
                    <label style="font-weight:bold; font-size:14px; margin-bottom:5px; display:block;">ì¸ì¦ë²ˆí˜¸ ì…ë ¥</label>
                    <div class="input-group">
                        <div class="split-box">
                            <input type="text" id="authCode" placeholder="123456" style="text-align:center; letter-spacing: 5px; font-weight:bold; font-size:18px;" maxlength="6">
                        </div>
                    </div>
                    <button class="btn-submit-main" onclick="verifyAuth()">ë¡œê·¸ì¸ í™•ì¸</button>
                    <div id="timer" style="text-align:center; margin-top:10px; color:#dc3545; font-weight:bold;">05:00</div>
                </div>

                <div style="margin-top: 40px; border-top: 1px solid #eee; padding-top: 30px;">
                    <button class="btn-kakao" onclick="startKakaoLogin()">
                        <i class="bi bi-chat-fill" style="margin-right:8px;"></i> ì¹´ì¹´ì˜¤ë¡œ ì‹œì‘í•˜ê¸°
                    </button>
                    <div style="text-align:center; font-size:12px; color:#888; margin-top:10px;">
                        (ê¸°ì¡´ íšŒì›ì´ ì¹´ì¹´ì˜¤ë¥¼ ì—°ë™í•œ ê²½ìš°ì—ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤)
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboardSection" class="container hidden">
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="form-title" style="margin:0;">ë‚˜ì˜ ì¡°í•©ì› ì •ë³´</h2>
                <button class="btn-edit" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <section class="counts" style="padding: 0 0 30px 0;">
                <div class="row no-gutters">
                    <div class="col-lg-4 col-md-6 d-md-flex align-items-md-stretch">
                        <div class="count-box">
                            <i class="bi bi-person"></i>
                            <span id="sumName">-</span>
                            <p>ì¡°í•©ì›ëª…</p>
                            <div style="margin-top:10px; font-weight:bold; color:#555;" id="sumId"></div>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6 d-md-flex align-items-md-stretch">
                        <div class="count-box">
                            <i class="bi bi-cash-coin"></i>
                            <span id="sumTotal">0ì›</span>
                            <p>ì´ ë‚©ì… ì¶œìê¸ˆ</p>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6 d-md-flex align-items-md-stretch">
                        <div class="count-box">
                            <i class="bi bi-check-circle"></i>
                            <span id="sumStatus" style="color:var(--color-primary); font-size:24px;">ì •ìƒ (í™œë™ì¤‘)</span>
                            <p>íšŒì› ìƒíƒœ</p>
                            <div style="font-size:13px; margin-top:5px; color:#888;" id="sumEmail"></div>
                        </div>
                    </div>
                </div>
            </section>

            <div class="dashboard-grid">
                <div class="left-col">
                    <div class="card-box">
                        <h3 style="font-family:'GmarketSans'; font-size:18px; font-weight:bold;">ğŸ“Œ ì—…ë¬´ ì‹ ì²­</h3>
                        <div class="menu-grid">
                            <button class="menu-btn" onclick="toggleTab('extra', this)">ì¶”ê°€ ì¶œì</button>
                            <button class="menu-btn" onclick="toggleTab('reduction', this)">ê°ì ì‹ ì²­</button>
                            <button class="menu-btn" onclick="toggleTab('withdraw', this)">íƒˆí‡´ ì‹ ì²­</button>
                            <button class="menu-btn" onclick="toggleTab('cert', this)" style="color:var(--color-primary);">ì¦ëª…ì„œ ë°œê¸‰</button>
                        </div>
                        
                        <div id="actionArea" style="margin-top:20px; border-top:1px dashed #ddd; padding-top:20px;">
                            <div id="tabPlaceholder" style="text-align:center; color:#999; font-size:14px;">
                                ìœ„ ë©”ë‰´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.
                            </div>

                            <div id="tabExtra" class="hidden">
                                <h4 class="sheet-title">ì¶”ê°€ ì¶œì ì‹ ì²­</h4>
                                <div class="info-box" style="margin:10px 0;">ì…ê¸ˆ ì „ ì‹ ì²­ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.</div>
                                <div class="input-group">
                                    <label>ì•½ì • ê¸ˆì•¡ (1ë§Œì› ë‹¨ìœ„)</label>
                                    <input type="number" id="exAmount" class="form-control" placeholder="ê¸ˆì•¡ ì…ë ¥" step="10000">
                                </div>
                                <button class="btn-submit-main" onclick="submitApplication('extra')">ì‹ ì²­í•˜ê¸°</button>
                            </div>

                            <div id="tabReduction" class="hidden">
                                <h4 class="sheet-title">ê°ì ì‹ ì²­</h4>
                                <div class="info-box" style="background:#fff3e0; border-color:#ff9800;">
                                    ë“±ë¡ëœ ê³„ì¢Œë¡œ í™˜ê¸‰ë©ë‹ˆë‹¤.<br>
                                    <b id="bankInfoRed" style="color:#e65100;"></b>
                                </div>
                                <div class="input-group">
                                    <label>í™˜ê¸‰ ìš”ì²­ì•¡</label>
                                    <input type="number" id="redAmount" class="form-control" placeholder="ê¸ˆì•¡ ì…ë ¥" step="10000">
                                </div>
                                <button class="btn-submit-main" onclick="submitApplication('reduction')">ì‹ ì²­í•˜ê¸°</button>
                            </div>

                            <div id="tabWithdraw" class="hidden">
                                <h4 class="sheet-title" style="color:#dc3545;">íƒˆí‡´ ì‹ ì²­</h4>
                                <div class="info-box" style="background:#ffebee; border-color:#ef5350;">
                                    <b>ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</b><br>
                                    í™˜ê¸‰ ê³„ì¢Œ: <span id="bankInfoWd"></span>
                                </div>
                                <div class="input-group">
                                    <label>íƒˆí‡´ ì‚¬ìœ </label>
                                    <textarea id="wdReason" class="form-control" style="height:80px; width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;"></textarea>
                                </div>
                                <button class="btn-submit-main" style="background:#333;" onclick="submitApplication('withdraw')">íƒˆí‡´ ì‹ ì²­</button>
                            </div>

                            <div id="tabCert" class="hidden">
                                <h4 class="sheet-title">ì¶œì ì¦ëª…ì„œ ë°œê¸‰</h4>
                                <div style="text-align:center; padding:20px;">
                                    <i class="bi bi-file-earmark-pdf" style="font-size:40px; color:var(--color-primary);"></i>
                                    <p style="margin-top:10px; font-size:14px; color:#666;">
                                        í˜„ì¬ ë‚©ì…ëœ ì¶œìê¸ˆì„ ê¸°ì¤€ìœ¼ë¡œ<br>ì¦ëª…ì„œ(PDF)ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
                                    </p>
                                    <button class="btn-submit-main" onclick="downloadCert()">ë‹¤ìš´ë¡œë“œ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="right-col">
                    <div class="card-box">
                        <h3 style="font-family:'GmarketSans'; font-size:18px; font-weight:bold; margin-bottom:20px;">ğŸ“… ìµœê·¼ í™œë™ ë‚´ì—­</h3>
                        
                        <div id="timelineList">
                            <div style="text-align:center; color:#999; padding:20px;">ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                        </div>

                    </div>
                </div>
            </div>

        </div>

    </main>

    <footer id="footer">
        <div class="footer-top">
            <div class="container">
                <div class="row">
                    <div class="col-lg-4 col-md-6">
                        <h3>ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›<span>.</span></h3>
                        <p>
                            ê²½ê¸°ë„ ìš©ì¸ì‹œ ì²˜ì¸êµ¬ <br>
                            ë¬¸ì˜: 010-2513-5736<br>
                            ì´ë©”ì¼: yonginsolar@gmail.com
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <div id="alertModal" class="center-modal">
        <div class="modal-content">
            <div style="font-size:40px; margin-bottom:10px;">ğŸ“¢</div>
            <div id="alertMsg" style="font-weight:bold; margin-bottom:20px; white-space:pre-wrap;"></div>
            <button class="btn-submit-main" onclick="document.getElementById('alertModal').style.display='none'">í™•ì¸</button>
        </div>
    </div>

<script>
    // =========================================================================
    // 1. ì„¤ì • ë° ì´ˆê¸°í™”
    // =========================================================================
    const SUPABASE_URL = 'ì—¬ê¸°ì—_SUPABASE_URL_ì…ë ¥'; 
    const SUPABASE_KEY = 'ì—¬ê¸°ì—_SUPABASE_ANON_KEY_ì…ë ¥';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let curMem = null;  
    let curAuth = null; 
    let timerInterval = null;

    function showLoading(show, msg) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        if(msg) document.getElementById('loadingMsg').innerText = msg;
    }

    function showAlert(msg) {
        document.getElementById('alertMsg').innerText = msg;
        document.getElementById('alertModal').style.display = 'flex';
    }

    // ì´ˆê¸° ë¡œë“œ ì‹œ ì„¸ì…˜ ì²´í¬
    window.addEventListener('DOMContentLoaded', async () => {
        const { data: { session } } = await _supabase.auth.getSession();
        if (session) {
            handleLoginSuccess(session.user);
        } else {
            // ë¯¸ë¡œê·¸ì¸ ìƒíƒœë©´ ì•„ë¬´ê²ƒë„ ì•ˆ í•¨ (ë¡œê·¸ì¸ í™”ë©´ ìœ ì§€)
        }
    });

    // =========================================================================
    // 2. ì´ë©”ì¼ ë¡œê·¸ì¸ ë¡œì§ (Magic Link / OTP)
    // =========================================================================
    async function requestAuth() {
        const email = document.getElementById('emailInput').value.trim();
        if(!email || !email.includes('@')) return showAlert('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');

        showLoading(true, 'ì¸ì¦ë²ˆí˜¸ ë°œì†¡ ì¤‘...');

        const { error } = await _supabase.auth.signInWithOtp({
            email: email,
            options: { shouldCreateUser: false } // ê¸°ì¡´ íšŒì›ë§Œ ë¡œê·¸ì¸ ê°€ëŠ¥
        });

        showLoading(false);

        if(error) {
            if(error.message.includes('Signups not allowed') || error.message.includes('not found')) {
                showAlert('ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.\nê°€ì… ì‹œ ì‚¬ìš©í•œ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            } else {
                showAlert('ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
            }
        } else {
            // UI ë³€ê²½
            document.getElementById('emailInput').readOnly = true;
            document.getElementById('btnSendAuth').innerText = 'ì¬ì „ì†¡';
            document.getElementById('authInputBox').classList.remove('hidden');
            startTimer(300); // 5ë¶„ íƒ€ì´ë¨¸
            document.getElementById('authCode').focus();
        }
    }

    async function verifyAuth() {
        const email = document.getElementById('emailInput').value.trim();
        const code = document.getElementById('authCode').value.trim();
        if(code.length < 6) return showAlert('ì¸ì¦ë²ˆí˜¸ 6ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');

        showLoading(true, 'ë¡œê·¸ì¸ í™•ì¸ ì¤‘...');

        const { data, error } = await _supabase.auth.verifyOtp({
            email: email, token: code, type: 'email'
        });

        if(error) {
            showLoading(false);
            showAlert('ì¸ì¦ ì‹¤íŒ¨: ' + error.message);
        } else {
            handleLoginSuccess(data.user);
        }
    }

    // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸
    async function startKakaoLogin() {
        const { error } = await _supabase.auth.signInWithOAuth({
            provider: 'kakao',
            options: { redirectTo: window.location.href }
        });
        if(error) showAlert('ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì˜¤ë¥˜: ' + error.message);
    }

    function startTimer(duration) {
        let timer = duration, minutes, seconds;
        clearInterval(timerInterval);
        timerInterval = setInterval(function () {
            minutes = parseInt(timer / 60, 10);
            seconds = parseInt(timer % 60, 10);

            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;

            document.getElementById('timer').textContent = minutes + ":" + seconds;

            if (--timer < 0) {
                clearInterval(timerInterval);
                document.getElementById('timer').textContent = "ì‹œê°„ ì´ˆê³¼";
            }
        }, 1000);
    }

    function logout() {
        if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            _supabase.auth.signOut().then(() => location.reload());
        }
    }

    // =========================================================================
    // 3. ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§
    // =========================================================================
    async function handleLoginSuccess(user) {
        curAuth = user;
        showLoading(true, 'ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');

        // 1. DB ë§¤í•‘ (ê¸°ì¡´ì— ë§Œë“  claim_member_profile í•¨ìˆ˜ í˜¸ì¶œ)
        const { data: claimRes, error: claimErr } = await _supabase.rpc('claim_member_profile');
        
        if (claimErr || (!claimRes.success && claimRes.message === 'not_found')) {
            showLoading(false);
            await _supabase.auth.signOut();
            showAlert('í•´ë‹¹ ì´ë©”ì¼ê³¼ ì¼ì¹˜í•˜ëŠ” ì¡°í•©ì› ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.\nì‚¬ë¬´êµ­ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
            return;
        }

        // 2. ë°ì´í„° ì¡°íšŒ
        await refreshDashboard();
    }

    async function refreshDashboard() {
        try {
            const myUuid = curAuth.id;

            // [1] ë‚´ ì •ë³´
            const { data: member, error: memErr } = await _supabase
                .from('coop_members')
                .select('*')
                .eq('id', myUuid)
                .single();
            if(memErr) throw memErr;
            curMem = member;

            // [2] ì‹ ì²­ ë‚´ì—­
            const { data: apps } = await _supabase
                .from('coop_applications')
                .select('*')
                .eq('member_uid', myUuid)
                .order('created_at', { ascending: false });

            // [3] ì…ê¸ˆ ë‚´ì—­ (Timelineìš©)
            const { data: ledger } = await _supabase
                .from('ref_members')
                .select('*')
                .eq('member_id', curMem.member_id)
                .order('deposit_date', { ascending: false });

            renderDashboard(member, apps || [], ledger || []);
            showLoading(false);

        } catch (e) {
            showLoading(false);
            console.error(e);
            showAlert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
        }
    }

    function renderDashboard(member, apps, ledger) {
        // í™”ë©´ ì „í™˜
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('dashboardSection').classList.remove('hidden');

        // ê¸°ë³¸ ì •ë³´ ì±„ìš°ê¸°
        document.getElementById('sumName').innerText = member.name;
        document.getElementById('sumId').innerText = member.member_id;
        document.getElementById('sumEmail').innerText = member.email;
        document.getElementById('sumTotal').innerText = (member.pledge_amount || 0).toLocaleString() + 'ì›';

        // ì€í–‰ ì •ë³´ í‘œì‹œ
        const bankStr = member.bank_name ? `${member.bank_name} (ê³„ì¢ŒìˆìŒ)` : 'ê³„ì¢Œ ë¯¸ë“±ë¡';
        document.getElementById('bankInfoRed').innerText = bankStr;
        document.getElementById('bankInfoWd').innerText = bankStr;

        // íƒ€ì„ë¼ì¸ ë Œë”ë§ (Timeline CSS ì ìš©)
        renderTimeline(ledger, apps);
    }

    function renderTimeline(ledger, apps) {
        const list = document.getElementById('timelineList');
        let html = '';

        // ë‘ ë°ì´í„°ë¥¼ í•©ì³ì„œ ë‚ ì§œìˆœ ì •ë ¬ (ë‹¨ìˆœ ì˜ˆì‹œ)
        // ì‹¤ì œë¡œëŠ” VO ê°ì²´ë¡œ ë§Œë“¤ì–´ì„œ ì •ë ¬í•˜ëŠ” ê²Œ ì¢‹ìŒ
        // ì—¬ê¸°ì„œëŠ” ì…ê¸ˆ ë‚´ì—­(Ledger) ìœ„ì£¼ë¡œ ë³´ì—¬ì£¼ê³ , ì‹ ì²­ ë‚´ì—­ì€ í…ìŠ¤íŠ¸ë¡œ ì¶”ê°€
        
        if(ledger.length === 0 && apps.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#999;">í™œë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        // ì…ê¸ˆ ë‚´ì—­ ë Œë”ë§
        ledger.forEach(item => {
            html += `
            <div class="timeline-item">
                <div class="timeline-date">${item.deposit_date ? item.deposit_date.substring(0,10) : 'ë‚ ì§œë¯¸ìƒ'}</div>
                <div class="timeline-content">
                    <h4>ì…ê¸ˆ í™•ì¸</h4>
                    <p>${Number(item.amount).toLocaleString()}ì› (${item.note || 'ì¶œìê¸ˆ'})</p>
                </div>
            </div>`;
        });
        
        // ì‹ ì²­ ë‚´ì—­ ë Œë”ë§ (ì§„í–‰ì¤‘ì¸ ê²ƒ)
        apps.forEach(app => {
            let statusColor = app.status === 'pending' ? '#ff9800' : '#4caf50';
            let statusText = app.status === 'pending' ? 'ê²€í† ì¤‘' : 'ì²˜ë¦¬ë¨';
            let typeText = app.type === 'extra' ? 'ì¶”ê°€ì¶œì' : (app.type === 'reduction' ? 'ê°ì' : 'íƒˆí‡´');

            html += `
            <div class="timeline-item" style="border-left-color: ${statusColor};">
                <div class="timeline-date">${app.created_at.substring(0,10)}</div>
                <div class="timeline-content">
                    <h4 style="color:${statusColor}">[ì‹ ì²­] ${typeText}</h4>
                    <p>${Number(app.amount).toLocaleString()}ì› - ${statusText}</p>
                </div>
            </div>`;
        });

        list.innerHTML = html;
    }

    // =========================================================================
    // 4. íƒ­ ë° ì‹ ì²­ ê¸°ëŠ¥
    // =========================================================================
    function toggleTab(type, btn) {
        document.getElementById('tabPlaceholder').classList.add('hidden');
        ['tabExtra', 'tabReduction', 'tabWithdraw', 'tabCert'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));

        document.getElementById('tab' + type.charAt(0).toUpperCase() + type.slice(1)).classList.remove('hidden');
        btn.classList.add('active');
    }

    async function submitApplication(type) {
        let amount = 0, reason = '';
        if(type === 'extra') {
            amount = document.getElementById('exAmount').value;
            if(!amount || amount < 10000) return showAlert('1ë§Œì› ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.');
        } else if(type === 'reduction') {
            amount = document.getElementById('redAmount').value;
            if(!amount) return showAlert('ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.');
        } else if(type === 'withdraw') {
            reason = document.getElementById('wdReason').value;
            if(!reason) return showAlert('ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        }

        if(!confirm('ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        showLoading(true);

        const { error } = await _supabase.from('coop_applications').insert({
            member_uid: curAuth.id,
            member_id: curMem.member_id,
            name: curMem.name,
            type: type,
            amount: amount || 0,
            reason: reason
        });

        showLoading(false);
        if(error) showAlert('ì‹¤íŒ¨: ' + error.message);
        else {
            showAlert('ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.');
            refreshDashboard();
        }
    }

    function downloadCert() {
        if(!window.jspdf) return showAlert('PDF ëª¨ë“ˆ ì˜¤ë¥˜');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(20);
        doc.text("Certificate", 105, 30, { align: "center" });
        doc.setFontSize(12);
        doc.text(`Name: ${curMem.name}`, 20, 50);
        doc.text(`ID: ${curMem.member_id}`, 20, 60);
        doc.text(`Amount: ${curMem.pledge_amount} KRW`, 20, 70);
        
        doc.save('certificate.pdf');
    }

    // ëª¨ë°”ì¼ ë„¤ë¹„ê²Œì´ì…˜ í† ê¸€ (style.css ë¡œì§ ëŒ€ì‘)
    const mobileNavToggle = document.querySelector('.mobile-nav-toggle');
    const navbarMobile = document.querySelector('.navbar-mobile');
    if (mobileNavToggle) {
        mobileNavToggle.addEventListener('click', function(e) {
            navbarMobile.classList.toggle('active');
            this.classList.toggle('bi-list');
            this.classList.toggle('bi-x');
        });
    }

</script>
</body>
</html>
