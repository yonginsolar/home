<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¡°í•©ì› ê´€ë¦¬ - ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•©</title>

    <link rel="icon" type="image/png" href="https://ifdqlwxgqgsvnawmhlfc.supabase.co/storage/v1/object/public/assets/favicon.png">
  
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.css" rel="stylesheet">
  <link href="https://webfontworld.github.io/gmarket/GmarketSans.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="cert_generator.js"></script>
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <script src="badges.js"></script>

  <link href="style.css" rel="stylesheet">
  
 <style>
    /* [í•„ìˆ˜ ìœ í‹¸ë¦¬í‹°] í™”ë©´ ì œì–´ìš© (ìµœìš°ì„  ì ìš©) */
    .hidden { display: none !important; }
    
    /* [ê¸°ë³¸ ì„¤ì •] í°íŠ¸ ë° ë°”ë”” */
    body {
        font-family: 'Pretendard', sans-serif;
        background-color: #f8f9fa;
        padding-top: 80px; /* í—¤ë” ë†’ì´ë§Œí¼ ë„ì›€ */
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }

    /* [í—¤ë”] ê·œì •ì§‘ ìŠ¤íƒ€ì¼ ì˜¤ë²„ë¼ì´ë“œ (ê²€ì€ìƒ‰ ë°°ê²½ ê°•ì œ) */
    #header {
        background-color: #000 !important; /* style.cssë³´ë‹¤ ìš°ì„ ìˆœìœ„ ë†’ì„ */
        padding: 15px 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .logo h1 a {
        font-family: 'GmarketSans', sans-serif;
        font-weight: 700;
        font-size: 20px;
        text-decoration: none;
        color: #fff !important;
    }
    .header-link {
        color: #fff;
        text-decoration: none;
        margin-left: 20px;
        font-size: 1.2rem;
        cursor: pointer;
        transition: 0.3s;
    }
    .header-link:hover { color: #ff9800; }

    /* [í‘¸í„°] í•˜ë‹¨ ê³ ì • */
    #footer {
        margin-top: auto;
        background: #111; 
        color: #fff;
    }

    /* [ë¡œê·¸ì¸ ì„¹ì…˜] ì „ìš© ìŠ¤íƒ€ì¼ */
    .signup-wrapper {
        background: #fff;
        padding: 40px 30px;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        max-width: 500px;
        margin: 40px auto;
        border: 1px solid #eee;
    }
    .form-title {
        font-family: 'GmarketSans';
        font-weight: 700;
        text-align: center;
        margin-bottom: 30px;
        color: #333;
    }

    /* [ëª¨ë‹¬] ì»¤ìŠ¤í…€ ë””ìì¸ (Depth Effect) */
    .custom-modal-overlay {
        z-index: 1050;
        display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
        background: rgba(0,0,0,0.4);
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        justify-content: center; align-items: center;
        transition: all 0.3s ease;
        backdrop-filter: blur(2px);
    }
    .custom-modal-box {
        background: #fff;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        width: 90%; max-width: 400px;
        text-align: center;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        transform: scale(1);
        opacity: 1;
    }
    /* ë’¤ë¡œ ë°€ë ¤ë‚œ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .custom-modal-overlay.modal-depth-back {
        z-index: 1040;
        background: rgba(0,0,0,0.6);
    }
    .custom-modal-overlay.modal-depth-back .custom-modal-box {
        transform: scale(0.9) translateY(10px);
        opacity: 0.6;
    }
    /* ìµœìƒìœ„ ëª¨ë‹¬ */
    #customModalOverlay { z-index: 2000 !important; }

    /* [ê²Œì‹œíŒ] ìŠ¤í¬ë¡¤ë°” & ë†’ì´ ì œí•œ */
    #boardList {
        max-height: 500px;
        overflow-y: auto;
        scrollbar-width: thin;
    }

    /* [ëŒ€ì‹œë³´ë“œ] ì¹´ë“œ ìŠ¤íƒ€ì¼ (style.cssì— ì—†ëŠ” ì „ìš© ë””ìì¸) */
    .dashboard-card {
        background: #fff;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        border: 1px solid #f0f0f0;
        height: 100%;
    }
    .count-icon {
        font-size: 2.5rem;
        color: #2E7D32;
        margin-bottom: 10px;
    }
    .count-title {
        color: #666; font-size: 0.9rem; margin-bottom: 5px;
    }
    .count-val {
        font-family: 'GmarketSans';
        font-weight: 700;
        font-size: 1.5rem;
        color: #333;
    }
    .text-green { color: #2E7D32 !important; }

    /* [íƒ€ì„ë¼ì¸] í™œë™ ë‚´ì—­ ìŠ¤íƒ€ì¼ */
    .timeline-item {
        padding: 0 0 20px 20px;
        border-left: 2px solid #e0e0e0;
        position: relative;
    }
    .timeline-item::before {
        content: "";
        position: absolute;
        width: 12px; height: 12px;
        border-radius: 50%;
        left: -7px; top: 5px;
        background: #fff;
        border: 2px solid #2E7D32;
    }
    .timeline-date {
        font-size: 0.8rem; color: #999; margin-bottom: 3px;
    }
    .timeline-content h5 {
        font-size: 1rem; font-weight: 600; margin: 0; color: #333;
    }
    .timeline-content p {
        font-size: 0.9rem; color: #666; margin: 0;
    }

    /* [ë©”ë‰´ íƒ­] ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .menu-btn {
        width: 100%;
        text-align: left;
        padding: 15px;
        margin-bottom: 10px;
        border: 1px solid #eee;
        background: #fff;
        border-radius: 10px;
        font-weight: 600;
        color: #555;
        transition: all 0.2s;
        display: flex; justify-content: space-between; align-items: center;
    }
    .menu-btn:hover {
        background: #f8f9fa; border-color: #2E7D32; color: #2E7D32;
    }
    .menu-btn.active {
        background: #2E7D32; color: #fff; border-color: #2E7D32;
    }

    /* [ë¡œë”©] ì˜¤ë²„ë ˆì´ */
    #loadingOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.95);
        z-index: 9999;
        display: none; /* JSê°€ ì œì–´í•¨ */
        flex-direction: column; justify-content: center; align-items: center;
    }

    /* [ê³µì§€ì‚¬í•­] ë¯¸ë‹ˆ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .notice-mini-item {
        padding: 8px 0;
        border-bottom: 1px solid #eee;
        font-size: 0.9rem;
        cursor: pointer;
    }
    .notice-mini-item:last-child { border-bottom: none; }
    .notice-mini-item:hover { background-color: #f8f9fa; }

    /* [ë°°ì§€] ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    #badgeContainer { min-height: 50px; }

   #loginSection.hidden,
#dashboardSection.hidden {
  display: none !important;
}
</style>
</head>

<body>

  <header id="header" class="fixed-top">
    <div class="container d-flex align-items-center justify-content-between">
      
      <div class="logo">
        <h1><a href="index.html">ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•©</a></h1>
      </div>

      <div class="d-flex align-items-center">
          <a href="index.html" class="header-link" title="ë©”ì¸ìœ¼ë¡œ ì´ë™">
              <i class="bi bi-house-door"></i>
          </a>
          <a href="#" onclick="logout()" id="headerLogoutBtn" class="header-link hidden" title="ë¡œê·¸ì•„ì›ƒ">
              <i class="bi bi-box-arrow-right"></i>
          </a>
      </div>

    </div>
  </header>

  <div id="loadingOverlay">
      <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;"></div>
      <div class="mt-3 fw-bold text-secondary" id="loadingMsg">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
  </div>

<main class="container py-4">
    
    <div id="loginSection" class="hidden">
        <div class="signup-wrapper">
            <h2 class="form-title">ì¡°í•©ì› ê³µê°„</h2>
            
            <div class="alert alert-light border d-flex align-items-center" role="alert">
                <i class="bi bi-info-circle-fill text-success fs-4 me-3"></i>
                <div>
                    ê°€ì… ì‹œ ë“±ë¡í•œ <b>ì´ë©”ì¼</b>ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>
                    <small class="text-muted">ì…ë ¥í•˜ì‹  ë©”ì¼ë¡œ ë¡œê·¸ì¸ ë§í¬ë¥¼ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.</small>
                </div>
            </div>

<div class="mb-3">
    <label class="form-label fw-bold small text-secondary">ì´ë©”ì¼ ì£¼ì†Œ</label>
    <div class="input-group">
        <input type="email" id="emailInput" class="form-control form-control-lg" placeholder="example@email.com" onkeyup="if(event.key==='Enter') sendMagicLink()">
        <button class="btn btn-dark" type="button" onclick="sendMagicLink()">ë§í¬ ë°›ê¸°</button>
    </div>
    
    <div class="text-end mt-2">
        <span class="small text-muted me-1">ê°€ì…í•œ ì´ë©”ì¼ì´ ê¸°ì–µë‚˜ì§€ ì•Šë‚˜ìš”?</span>
        <a href="#" class="small fw-bold text-decoration-none text-success" onclick="openFindEmailModal()">
            <i class="bi bi-search"></i> ì´ë©”ì¼ ì°¾ê¸°
        </a>
    </div>
</div>

            <div id="sentMsgBox" class="text-center hidden mt-4 p-4 bg-light rounded">
                <i class="bi bi-envelope-check text-success" style="font-size: 3rem;"></i>
                <h4 class="fw-bold mt-2">ë©”ì¼í•¨ì„ í™•ì¸í•´ì£¼ì„¸ìš”!</h4>
                <p class="text-muted mb-3">
                    <span id="targetEmail" class="fw-bold text-dark"></span>(ìœ¼)ë¡œ<br>
                    ë¡œê·¸ì¸ ë§í¬ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.
                </p>
                <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">ì´ë©”ì¼ ë‹¤ì‹œ ì…ë ¥í•˜ê¸°</button>
            </div>

            <div class="mt-4 pt-4 border-top">
                <button class="btn btn-warning w-100 fw-bold py-3" onclick="startKakaoLogin()">
                    <i class="bi bi-chat-fill me-2"></i> ì¹´ì¹´ì˜¤ë¡œ ë°”ë¡œ ì‹œì‘í•˜ê¸°
                </button>
                <div class="text-center mt-2">
                    <small class="text-muted">(ê¸°ì¡´ì— ì¹´ì¹´ì˜¤ë¥¼ ì—°ë™í•œ ì¡°í•©ì›ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤)</small>
                </div>
            </div>
        </div>
    </div>

    <div id="dashboardSection" class="hidden">
        
        <div id="birthdayBanner" onclick="fireConfetti()">
            ğŸ‰ <span id="birthdayMsgName"></span>ë‹˜, ìƒì¼ì„ ì§„ì‹¬ìœ¼ë¡œ ì¶•í•˜í•©ë‹ˆë‹¤! (í´ë¦­í•˜ë©´ í­ì£½ì´ í„°ì ¸ìš”!) ğŸ‚
        </div>

      <!-- [ì¶”ê°€] ì¡°í•©ì› ìƒíƒœ ë°°ì§€ (ëŒ€ì‹œë³´ë“œ ìƒë‹¨) -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <div class="small text-muted">
    <i class="bi bi-info-circle me-1"></i> ìƒíƒœ
  </div>
  <span id="memberStatusBadge" class="badge rounded-pill bg-secondary">-</span>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center">
        <h5 class="fw-bold m-0 me-2"><i class="bi bi-person-lines-fill me-2"></i>ë‚´ ì •ë³´</h5>
        
        <div class="dropdown hidden" id="profileSwitcher">
            <button class="btn btn-sm btn-outline-primary dropdown-toggle fw-bold" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-arrow-repeat"></i> <span id="currentProfileName">ë‚˜(ê°œì¸)</span>
            </button>
            <ul class="dropdown-menu shadow" id="profileListMenu">
                </ul>
        </div>
    </div>
</div>

    <div>
        <button class="btn btn-sm btn-outline-secondary" id="btnEditProfile" onclick="toggleEditMode(true)">ì •ë³´ ìˆ˜ì •</button>
        <button class="btn btn-sm btn-success hidden" id="btnSaveProfile" onclick="saveProfile()">ì €ì¥</button>
        <button class="btn btn-sm btn-light hidden" id="btnCancelEdit" onclick="toggleEditMode(false)">ì·¨ì†Œ</button>
    </div>
            
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="small text-muted">ì´ë¦„</label>
                    <div class="fw-bold" id="infoName">-</div>
                </div>
                <div class="col-md-6">
                    <label class="small text-muted">ìƒë…„ì›”ì¼</label>
                    <div class="fw-bold" id="infoBirth">-</div>
                </div>
                <div class="col-md-6">
                    <label class="small text-muted">ì´ë©”ì¼ (ë³€ê²½ë¶ˆê°€)</label>
                    <div class="fw-bold text-secondary" id="infoEmail">-</div>
                </div>

<div class="col-md-6"> <label class="small text-muted">ì „í™”ë²ˆí˜¸</label>
    
    <div id="viewPhoneBox" class="fw-bold p-1 border-bottom" style="min-height: 30px;">-</div>

    <input type="text" id="editPhone" class="readonly-text" style="display:none;" 
           oninput="autoHyphen(this)" maxlength="13" placeholder="010-0000-0000">
</div>

                <div class="col-12">
                    <label class="small text-muted">ì£¼ì†Œ</label>
                    
                    <div id="viewAddressBox" class="fw-bold p-1 border-bottom" style="min-height: 30px;"></div>
                    
                    <div id="editAddressBox" class="addr-edit-group" style="display:none;">
                        <div class="d-flex gap-2 mb-2"> 
                            <input type="text" id="editAddrMain" class="form-control" placeholder="ì£¼ì†Œ ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”" readonly onclick="execDaumPostcode()" style="background-color:#fff;">
                            <button class="btn btn-secondary" type="button" onclick="execDaumPostcode()" style="white-space:nowrap;">ì£¼ì†Œ ê²€ìƒ‰</button>
                        </div>
                        <input type="text" id="editAddrDetail" class="form-control" placeholder="ìƒì„¸ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                </div>

<div class="col-12 border-top pt-2 mt-2">
    <label class="small text-success fw-bold">í™˜ê¸‰/ë°°ë‹¹ ê³„ì¢Œ</label>
    
    <div id="viewBankBox" class="fw-bold p-1 border-bottom" style="min-height: 30px;">-</div>

    <div id="editBankBox" class="row g-2" style="display:none;">
        <div class="col-4">
            <input type="text" id="editBankName" class="readonly-text" placeholder="ì€í–‰ëª…" readonly>
        </div>
        <div class="col-8">
            <input type="text" id="editAccountNo" class="readonly-text" placeholder="ê³„ì¢Œë²ˆí˜¸" readonly
                   oninput="this.value = this.value.replace(/[^0-9]/g, '')">
        </div>
        <div class="col-12">
            <input type="text" id="editHolder" class="readonly-text" placeholder="ì˜ˆê¸ˆì£¼" readonly>
        </div>
        <small class="text-muted" style="font-size:0.8rem;">* ê³„ì¢Œë²ˆí˜¸ë¥¼ ìˆ˜ì •í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ì¡´ ì •ë³´ê°€ ìœ ì§€ë©ë‹ˆë‹¤.<br>* ë³¸ì¸ ëª…ì˜ì˜ ê³„ì¢Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</small>
    </div>
</div>

        </div>


  
        <div class="row g-3 mb-4" id="assetSummaryRow">
            <div class="col-md-6 col-lg-4">
                <div class="dashboard-card text-center">
                    <i class="bi bi-person-badge count-icon" style="font-size: 2.5rem; color: #2E7D32; margin-bottom: 10px;"></i>
                    <div class="count-title" style="color: #666; font-size: 0.9rem;">ì¡°í•©ì› ë²ˆí˜¸</div>
                    <div class="count-val" id="sumId" style="font-family: 'GmarketSans'; font-weight: 700; font-size: 1.5rem; color: #333;">-</div>
                </div>
            </div>
            <div class="col-md-6 col-lg-4">
                <div class="dashboard-card text-center">
                    <i class="bi bi-piggy-bank count-icon" style="font-size: 2.5rem; color: #2E7D32; margin-bottom: 10px;"></i>
                    <div class="count-title" style="color: #666; font-size: 0.9rem;">ì´ ë‚©ì… ì¶œìê¸ˆ</div>
                    <div class="count-val text-green" id="sumTotal" style="font-family: 'GmarketSans'; font-weight: 700; font-size: 1.5rem; color: #2E7D32;">0ì›</div>
                </div>
            </div>
<div class="col-md-12 col-lg-4">
    <div class="dashboard-card p-3">
        <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2">
            <h6 class="fw-bold m-0 text-success"><i class="bi bi-megaphone-fill me-2"></i>ìµœê·¼ ê³µì§€</h6>
            <button class="btn btn-sm btn-light text-muted" onclick="loadBoard('notice')" style="font-size:0.75rem;">ë”ë³´ê¸°</button>
        </div>
        <div id="miniNoticeList" style="min-height: 100px;">
            <p class="text-center text-muted small py-3">ë¡œë”© ì¤‘...</p>
        </div>
    </div>
</div>
        </div>

      <div class="dashboard-card mb-4">
    <h5 class="fw-bold mb-3 border-bottom pb-2">ë‚˜ì˜ ë±ƒì§€ ì»¬ë ‰ì…˜</h5>
    <div id="badgeContainer" class="py-2">
        <span class="spinner-border spinner-border-sm"></span> ë¡œë”© ì¤‘...
    </div>
</div>

        <div class="row g-4 mb-4">
            <div class="col-lg-5">
                <div class="dashboard-card">
                    <h5 class="fw-bold mb-3 border-bottom pb-2">ì—…ë¬´ ì‹ ì²­</h5>
                    
                    <div class="d-grid gap-2">
                        <button class="menu-btn" onclick="toggleTab('extra', this)"><span><i class="bi bi-plus-circle me-2"></i>ì¶”ê°€ ì¶œì</span><i class="bi bi-chevron-right"></i></button>
                        <button class="menu-btn" onclick="toggleTab('reduction', this)"><span><i class="bi bi-dash-circle me-2"></i>ê°ì ì‹ ì²­</span><i class="bi bi-chevron-right"></i></button>
                        <button class="menu-btn" onclick="toggleTab('withdraw', this)"><span><i class="bi bi-box-arrow-left me-2"></i>íƒˆí‡´ ì‹ ì²­</span><i class="bi bi-chevron-right"></i></button>
                        <button class="menu-btn" onclick="toggleTab('cert', this)"><span><i class="bi bi-file-earmark-pdf me-2"></i>ì¦ëª…ì„œ ë°œê¸‰</span><i class="bi bi-chevron-right"></i></button>
                    </div>

                    <div id="actionArea" class="mt-4 bg-light p-3 rounded">
                        <div id="tabPlaceholder" class="text-center text-muted small py-3">ë©”ë‰´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>

                        <div id="tabExtra" class="hidden">
                            <h6 class="fw-bold mb-3">ì¶”ê°€ ì¶œì ì‹ ì²­</h6>
                            <div class="mb-3">
                                <label class="form-label small">ì•½ì • ê¸ˆì•¡ (1ë§Œì› ë‹¨ìœ„)</label>
                                <input type="number" id="exAmount" class="form-control" placeholder="ê¸ˆì•¡ ì…ë ¥" step="10000">
                            </div>
                            <button class="btn btn-success w-100 fw-bold" onclick="submitApplication('extra')">ì‹ ì²­í•˜ê¸°</button>
                        </div>

                        <div id="tabReduction" class="hidden">
                            <h6 class="fw-bold mb-3">ê°ì ì‹ ì²­</h6>
                            <div class="alert alert-warning small py-2"><i class="bi bi-exclamation-triangle me-1"></i> ìµœì†Œ 10ë§Œì› ì´ìƒì˜ ì¶œìê¸ˆì€ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.</div>
                            <div class="mb-3">
                                <label class="form-label small">í™˜ê¸‰ ìš”ì²­ì•¡</label>
                                <input type="number" id="redAmount" class="form-control" placeholder="ê¸ˆì•¡ ì…ë ¥">
                                <span id="redLimitDisplay" class="limit-text"></span>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="checkRedAgree">
                                <label class="form-check-label small" for="checkRedAgree">
                                    ê°ìëŠ” ë‹¤ìŒë…„ë„ ì´íšŒ ìŠ¹ì¸ í›„ ì²˜ë¦¬ë˜ë©°,<br>ìì‚° ìƒí™©ì— ë”°ë¼ ì¡°ì •ë  ìˆ˜ ìˆìŒì„ í™•ì¸í•©ë‹ˆë‹¤.
                                </label>
                            </div>
                            <button class="btn btn-success w-100 fw-bold" onclick="submitApplication('reduction')">ì‹ ì²­í•˜ê¸°</button>
                        </div>

                        <div id="tabWithdraw" class="hidden">
                            <h6 class="fw-bold text-danger mb-3">íƒˆí‡´ ì‹ ì²­</h6>
                            <div class="mb-3">
                                <label class="form-label small">íƒˆí‡´ ì‚¬ìœ </label>
                                <textarea id="wdReason" class="form-control" rows="3" placeholder="ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"></textarea>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="checkWdAgree">
                                <label class="form-check-label small text-danger fw-bold" for="checkWdAgree">
                                    íƒˆí‡´ ì‹œ ì¶œìê¸ˆì€ ë‹¤ìŒë…„ë„ ì´íšŒ ìŠ¹ì¸ í›„<br>í™˜ê¸‰ë¨ì„ í™•ì¸í•˜ì˜€ìŠµë‹ˆë‹¤.
                                </label>
                            </div>
                            <button class="btn btn-dark w-100 fw-bold" onclick="submitApplication('withdraw')">íƒˆí‡´ ì‹ ì²­</button>
                        </div>

                        <div id="tabCert" class="hidden text-center py-3">
                            <h6 class="fw-bold">ì¶œì ì¦ëª…ì„œ</h6>
                            <p class="small text-muted">í˜„ì¬ ë‚©ì…ëœ ì¶œìê¸ˆì„ ê¸°ì¤€ìœ¼ë¡œ<br>PDF ì¦ëª…ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
                            <button class="btn btn-outline-success w-100 fw-bold" onclick="downloadCert()">
                                <i class="bi bi-download me-2"></i>ë‹¤ìš´ë¡œë“œ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-7">
                <div class="dashboard-card">
                    <h5 class="fw-bold mb-4 border-bottom pb-2">ìµœê·¼ í™œë™ ë‚´ì—­</h5>
                    <div id="timelineList" style="max-height: 600px; overflow-y: auto;">
                        <p class="text-center text-muted py-5">ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                </div>
            </div>
        </div>

<div class="dashboard-card mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
        <div class="d-flex gap-2 align-items-center">
            <h5 class="fw-bold m-0"><i class="bi bi-chat-dots-fill me-2"></i>ììœ ê²Œì‹œíŒ</h5>
            </div>
        <button class="btn btn-sm btn-dark" id="btnWritePost" onclick="openWriteModal()">
            <i class="bi bi-pencil-square"></i> ê¸€ì“°ê¸°
        </button>
    </div>
    <div id="boardList" style="min-height: 200px;"></div>
</div>

        <div class="dashboard-card mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold m-0"><i class="bi bi-people-fill me-2"></i>ê°€ì¡±/ì§ì› ê³„ì • ê´€ë¦¬</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="openAddFamilyModal()">+ ì¶”ê°€</button>
            </div>
            <div id="familyListArea">
                <p class="text-muted small text-center py-3">ë“±ë¡ëœ êµ¬ì„±ì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </div>

    </div> </main>
  

  <footer id="footer"></footer>
  <script src="assets/js/home_patch_note.js"></script>

  <div id="customModalOverlay" class="custom-modal-overlay">
    <div class="custom-modal-box">
        <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“¢</div>
        <p id="customModalMsg" style="white-space: pre-wrap; margin-bottom: 20px; font-weight: 500; font-size: 1.1rem; color:#333;"></p>
        <div class="custom-modal-btn-group">
            <button id="btnModalNo" class="btn-modal btn-modal-no" onclick="closeCustomModal()">ì·¨ì†Œ</button>
            <button id="btnModalYes" class="btn-modal btn-modal-yes">í™•ì¸</button>
        </div>
    </div>
</div>

  <div id="findEmailModalOverlay" class="custom-modal-overlay">
    <div class="custom-modal-box" style="text-align:left; max-width:400px;">
        <h5 class="fw-bold mb-3"><i class="bi bi-person-badge me-2"></i>ì´ë©”ì¼ ì°¾ê¸°</h5>
        <p class="small text-muted mb-4">
            ê°€ì… ì‹œ ë“±ë¡í•œ <b>ì´ë¦„</b>ê³¼ <b>íœ´ëŒ€í° ë²ˆí˜¸</b>ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>
            ì¼ì¹˜í•˜ëŠ” ì •ë³´ê°€ ìˆìœ¼ë©´ ì´ë©”ì¼ì˜ ì¼ë¶€ë¥¼ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.
        </p>
        
        <div class="mb-3">
            <label class="form-label small fw-bold">ì´ë¦„</label>
            <input type="text" id="findEmailName" class="form-control" placeholder="í™ê¸¸ë™">
        </div>

        <div class="mb-4">
            <label class="form-label small fw-bold">íœ´ëŒ€í° ë²ˆí˜¸</label>
            <input type="tel" id="findEmailPhone" class="form-control" 
                   placeholder="010-0000-0000" maxlength="13" 
                   oninput="autoHyphen(this)"> </div>

        <div class="d-grid gap-2">
            <button class="btn btn-success fw-bold" onclick="tryFindEmail()">ì´ë©”ì¼ í™•ì¸</button>
            <button class="btn btn-light btn-sm" onclick="document.getElementById('findEmailModalOverlay').style.display='none'">ë‹«ê¸°</button>
        </div>
    </div>
</div>

  <div id="writeModalOverlay" class="custom-modal-overlay">
    <div class="custom-modal-box" style="text-align:left; max-width:500px;">
        <h5 class="fw-bold mb-3">ê²Œì‹œê¸€ ì‘ì„±</h5>
        <div class="mb-2">
            <input type="text" id="writeTitle" class="form-control" placeholder="ì œëª©">
        </div>
        <div class="mb-2">
            <textarea id="writeContent" class="form-control" rows="5" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        </div>
        <div class="mb-3">
            <label class="small text-muted">ì²¨ë¶€íŒŒì¼ (URL ì…ë ¥)</label>
            <input type="text" id="writeFile" class="form-control form-control-sm" placeholder="https://...">
        </div>
        <div class="custom-modal-btn-group">
            <button class="btn-modal btn-modal-no" onclick="document.getElementById('writeModalOverlay').style.display='none'">ì·¨ì†Œ</button>
            <button class="btn-modal btn-modal-yes" onclick="submitPost()">ë“±ë¡</button>
        </div>
    </div>
</div>

<div id="familyModalOverlay" class="custom-modal-overlay">
    <div class="custom-modal-box" style="text-align:left; max-width:500px;">
        
        <ul class="nav nav-pills nav-fill mb-4" id="famModalTabs">
            <li class="nav-item">
                <button class="nav-link active fw-bold small" onclick="switchFamTab('new')">ğŸ‘¶ ìë…€/ê°€ì¡± ì‹ ê·œ ë“±ë¡</button>
            </li>
            <li class="nav-item">
                <button class="nav-link fw-bold small" onclick="switchFamTab('connect')">ğŸ¤ ê¸°ì¡´ ê³„ì • ì—°ê²° (ì‹ ì²­)</button>
            </li>
        </ul>

<div id="famTabNew">
    <div class="alert alert-light border small mb-3">
        <i class="bi bi-info-circle-fill me-1"></i>
        ë§Œ 19ì„¸ ë¯¸ë§Œ ë¯¸ì„±ë…„ ìë…€ë§Œ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
       </div>
    
    <div class="row g-2 mb-2">
        <div class="col-8">
            <label class="small text-muted fw-bold">ì´ë¦„ <span class="text-danger">*</span></label>
            <input type="text" id="newFamName" class="form-control form-control-sm" placeholder="ì´ë¦„">
        </div>
        <div class="col-4">
            <label class="small text-muted fw-bold">ì¡°í•©ì›ë²ˆí˜¸ (ìë™)</label>
            <input type="text" id="newFamId" class="form-control form-control-sm bg-light" placeholder="ìƒì„±ë¨" readonly>
        </div>
    </div>

    <div class="mb-2">
        <label class="small text-muted fw-bold">ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ <span class="text-danger">*</span></label>
        <div class="input-group input-group-sm">
            <input type="text" id="newFamRrn1" class="form-control" maxlength="6" placeholder="ìƒë…„ì›”ì¼(6)" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
            <span class="input-group-text">-</span>
            <input type="password" id="newFamRrn2" class="form-control" maxlength="7" placeholder="ë’·ìë¦¬(7)" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
        </div>
    </div>

    <div class="mb-2">
        <label class="small text-muted fw-bold">ë²•ì •ëŒ€ë¦¬ì¸(ë‚˜)ê³¼ì˜ ê´€ê³„ <span class="text-danger">*</span></label>
        <div class="d-flex gap-2">
            <select id="newFamRelSelect" class="form-select form-select-sm" onchange="toggleFamilyRelationInput()">
                <option value="ë¶€">ë¶€ (ì•„ë²„ì§€)</option>
                <option value="ëª¨">ëª¨ (ì–´ë¨¸ë‹ˆ)</option>
                <option value="ì§ì ‘ì…ë ¥">ê¸°íƒ€ (ì§ì ‘ì…ë ¥)</option>
            </select>
            <input type="text" id="newFamRelInput" class="form-control form-control-sm hidden" placeholder="ê´€ê³„ ì…ë ¥">
        </div>
    </div>

    <div class="mb-2">
        <label class="small text-muted fw-bold">ì´ˆê¸° ì¶œìê¸ˆ (í•„ìˆ˜)</label>
        <input type="number" id="newFamCapital" class="form-control form-control-sm" placeholder="ìµœì†Œ 100,000ì›" step="10000">
        <div class="form-text x-small text-secondary">ìµœì†Œ 10ë§Œì› ì´ìƒ, 1ë§Œì› ë‹¨ìœ„ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
    </div>

    <div class="p-2 bg-light rounded border mb-3">
        <label class="small text-success fw-bold mb-1"><i class="bi bi-bank me-1"></i>ë°°ë‹¹ê¸ˆ ìˆ˜ë ¹ ê³„ì¢Œ (ë³¸ì¸ ëª…ì˜)</label>
        <div class="row g-1">
            <div class="col-4">
                <input type="text" id="newFamBank" class="form-control form-control-sm" placeholder="ì€í–‰ëª…">
            </div>
            <div class="col-8">
                <input type="text" id="newFamAcc" class="form-control form-control-sm" placeholder="ê³„ì¢Œë²ˆí˜¸ (-ì—†ì´)">
            </div>
        </div>
    </div>

    <button class="btn btn-primary w-100 btn-sm fw-bold py-2" onclick="submitNewChild()">
        <i class="bi bi-file-earmark-check me-1"></i>ì •ë³´ í™•ì¸ ë° ë™ì˜ì„œ ì‘ì„±
    </button>
</div>

        <div id="famTabConnect" class="hidden">
            <div class="alert alert-warning border small mb-3">
                <i class="bi bi-exclamation-circle-fill me-1"></i>
                ì´ë¯¸ ê°€ì…ëœ ê°œì¸/ë‹¨ì²´ì—ê²Œ <b>"ë‚´ ê³„ì •ì„ ê´€ë¦¬í•´ë‹¬ë¼"</b>ê³  ìš”ì²­í•©ë‹ˆë‹¤.<br>
                (ìƒëŒ€ë°©ì´ ìŠ¹ë‚™í•´ì•¼ ì—°ê²°ë©ë‹ˆë‹¤.)
            </div>

            <div class="input-group mb-3">
                <input type="text" id="searchConnectInput" class="form-control" placeholder="ì´ë¦„, ì´ë©”ì¼, ë˜ëŠ” ì‚¬ì—…ìë²ˆí˜¸">
                <button class="btn btn-dark" onclick="searchTargetMember()">ê²€ìƒ‰</button>
            </div>

            <div id="connectResultArea" class="border rounded p-2 bg-light" style="height: 150px; overflow-y: auto;">
                <p class="text-center text-muted small py-4">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            </div>
        </div>

        <div class="text-end mt-3 border-top pt-2">
            <button class="btn btn-link text-secondary text-decoration-none btn-sm" onclick="document.getElementById('familyModalOverlay').style.display='none'">ë‹«ê¸°</button>
        </div>
    </div>
</div>

  <div id="boardViewModal" class="custom-modal-overlay">
    <div class="custom-modal-box" style="width: 90%; max-width: 600px; text-align: left;">
        
        <div class="post-view-header">
            <h5 id="viewTitle" class="fw-bold m-0 text-break">ì œëª© ë¡œë”©ì¤‘...</h5>
            <div class="post-view-meta mt-2">
                <span><i class="bi bi-person-circle me-1"></i><span id="viewAuthor">ì‘ì„±ì</span></span>
                <span id="viewDate">0000.00.00</span>
            </div>
        </div>

        <div id="viewContent" class="post-view-content mb-3">
            ë‚´ìš© ë¡œë”©ì¤‘...
        </div>

        <div id="viewFiles" class="mb-3 border-top pt-3"></div>

        <div class="d-flex justify-content-between border-top pt-3">
            <button class="btn btn-outline-secondary btn-sm" onclick="reportPost()">ğŸš¨ ì‹ ê³ </button>
            
            <div id="viewBtnGroup">
                <button class="btn btn-dark btn-sm" onclick="document.getElementById('boardViewModal').style.display='none'">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<div id="manualMatchModal" class="custom-modal-overlay">
    <div class="custom-modal-box" style="text-align: left;">
        <h5 class="fw-bold mb-3">ğŸ“¢ ì¡°í•©ì› ì°¾ê¸°</h5>
        <p class="small text-muted mb-3">
            ì¹´ì¹´ì˜¤ ì •ë³´ë¡œ ê°€ì… ì •ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>
            ê¸°ì¡´ì— ë“±ë¡í•œ <b>ì´ë¦„</b>ê³¼ <b>ì—°ë½ì²˜</b>ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
        </p>
        
        <div class="mb-3">
            <label class="form-label small fw-bold">ì´ë¦„</label>
            <input type="text" id="manualName" class="form-control" placeholder="í™ê¸¸ë™">
        </div>

        <div class="mb-2">
            <label class="form-label small fw-bold d-block">ì°¾ì„ ì •ë³´ ì„ íƒ</label>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="contactType" id="typePhone" value="phone" checked onchange="toggleContactInput()">
                <label class="form-check-label small" for="typePhone">ì „í™”ë²ˆí˜¸</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="contactType" id="typeEmail" value="email" onchange="toggleContactInput()">
                <label class="form-check-label small" for="typeEmail">ì´ë©”ì¼</label>
            </div>
        </div>

        <div id="inputGroupPhone" class="mb-4">
            <input type="tel" id="manualPhone" class="form-control" 
                   placeholder="010-1234-5678" maxlength="13"
                   oninput="autoHyphen(this)">
            <div class="form-text x-small text-muted">ìˆ«ìë§Œ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ -ê°€ ë¶™ìŠµë‹ˆë‹¤.</div>
        </div>

        <div id="inputGroupEmail" class="mb-4 hidden">
            <input type="email" id="manualEmail" class="form-control" placeholder="example@email.com">
        </div>

        <div class="d-grid gap-2">
            <button class="btn btn-success fw-bold" onclick="tryManualLink()">ë‚´ ì •ë³´ ì°¾ê¸° & ì—°ê²°</button>
            <button class="btn btn-light btn-sm text-secondary" onclick="manualMatchFail()">ì°¾ì„ ìˆ˜ ì—†ë‚˜ìš”? (ë¬¸ì˜í•˜ê¸°)</button>
        </div>
    </div>
</div>


  <div id="noticeListModal" class="custom-modal-overlay">
    <div class="custom-modal-box" style="width: 90%; max-width: 500px; text-align: left; height: 80vh; display: flex; flex-direction: column;">
        
        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
            <h5 class="fw-bold m-0"><i class="bi bi-megaphone-fill me-2 text-danger"></i>ê³µì§€ì‚¬í•­</h5>
            <button type="button" class="btn-close" onclick="document.getElementById('noticeListModal').style.display='none'"></button>
        </div>

        <div class="mb-3">
            <div class="input-group">
                <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                <input type="text" id="noticeSearchInput" class="form-control" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë°°ë‹¹, ì´íšŒ)" onkeyup="filterNoticeList()">
            </div>
        </div>

        <div id="noticeListResult" style="flex: 1; overflow-y: auto; min-height: 0;">
            <p class="text-center text-muted py-5">ë°ì´í„° ë¡œë”© ì¤‘...</p>
        </div>

        <div class="mt-3 text-end border-top pt-2">
            <button class="btn btn-dark w-100" onclick="document.getElementById('noticeListModal').style.display='none'">ë‹«ê¸°</button>
        </div>
    </div>
</div>
  
  
<div id="layer" style="display:none;position:fixed;overflow:hidden;z-index:9999;-webkit-overflow-scrolling:touch;">
  <img src="//t1.daumcdn.net/postcode/resource/images/close.png" id="btnCloseLayer" style="cursor:pointer;position:absolute;right:-3px;top:-3px;z-index:1" onclick="closeDaumPostcode()" alt="ë‹«ê¸° ë²„íŠ¼">
</div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="footer.js"></script>

 <script>
    // =========================================================================
    // 1. Supabase ì„¤ì •
    // =========================================================================
    const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
    
    let _supabase = null;
    let curMem = null;
    let curAuth = null;
   let currentBoardLimit = 20;
let isBoardLoading = false;

    try {
        _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch (e) {
        console.error("Supabase Init Error", e);
        alert("ì‹œìŠ¤í…œ ì—°ê²° ì˜¤ë¥˜");
    }


   // [ì‹ ê·œ] ì¹œì ˆí•œ ì—ëŸ¬ ë©”ì‹œì§€ ë³€í™˜ê¸°
function translateAuthError(errorMsg) {
    if (!errorMsg) return 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
    
    const msg = errorMsg.toLowerCase();
    
    if (msg.includes('invalid login credentials') || msg.includes('user not found')) {
        return 'ê°€ì…ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì´ê±°ë‚˜ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
    }
    if (msg.includes('rate limit') || msg.includes('too many requests')) {
        return 'ë„ˆë¬´ ë§ì€ ìš”ì²­ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„(ì•½ 1ë¶„ ë’¤) ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    }
    if (msg.includes('validation failed') || msg.includes('email')) {
        return 'ì´ë©”ì¼ ì£¼ì†Œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ì˜ˆ: user@example.com)';
    }
    if (msg.includes('security code')) {
        return 'ë³´ì•ˆ ì½”ë“œê°€ ë§Œë£Œë˜ì—ˆê±°ë‚˜ í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.';
    }
    
    // ê·¸ ì™¸ ë²ˆì—­ ì•ˆ ëœ ì—ëŸ¬ëŠ” ì›ë¬¸ + ì•ˆë‚´ í‘œì‹œ
    return 'ì‹œìŠ¤í…œ ì˜¤ë¥˜: ' + errorMsg + '\n(ì§€ì†ë˜ë©´ ì‚¬ë¬´êµ­ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”)';
}
   
    function showLoading(show, msg) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        if(msg) document.getElementById('loadingMsg').innerText = msg;
    }

// [ìˆ˜ì • 1] ì´ˆê¸°í™” ë¡œì§: ë³´ì•ˆ ê°•í™” ë° í™”ë©´ ê²¹ì¹¨ ì›ì²œ ì°¨ë‹¨
// [ìˆ˜ì •] ì´ˆê¸°í™” ë¡œì§: ì„¸ì…˜ ìƒíƒœì— ë”°ë¼ showOnlyë¡œ ëª…í™•í•˜ê²Œ ë¶„ê¸°
window.addEventListener('DOMContentLoaded', async () => {
    // 1. ë¡œë”©ë°” í‘œì‹œ (HTMLì— ì´ë¯¸ hidden í´ë˜ìŠ¤ê°€ ë°•í˜€ìˆìœ¼ë¯€ë¡œ í™”ë©´ì€ ë°±ì§€ ìƒíƒœì„)
    if (typeof showLoading === 'function') showLoading(true, 'ì‹œìŠ¤í…œ ë³´ì•ˆ í™•ì¸ ì¤‘...');

    // 2. Supabase ì—°ê²° ì²´í¬
    if(!_supabase) {
        if (typeof showLoading === 'function') showLoading(false);
        alert("ì‹œìŠ¤í…œ ì˜¤ë¥˜: DB ì—°ê²° ì‹¤íŒ¨");
        return;
    }

    // 3. ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€
    _supabase.auth.onAuthStateChange((event, session) => {
        // ë¡œë”©ë°” ë„ê¸° (ê²°ì • ë‚¬ìŒ)
        if (typeof showLoading === 'function') showLoading(false);

        if (session) {
            // [ë¡œê·¸ì¸ ìƒíƒœ] -> ë°ì´í„° ë¡œë“œ ì‹œì‘
            // ì£¼ì˜: ì—¬ê¸°ì„œ ë°”ë¡œ showOnly('dashboardSection') í•˜ì§€ ì•ŠìŒ.
            // ë°ì´í„°ê°€ í…… ë¹ˆ í™”ë©´ì´ ë³´ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ loadDashboardData ì™„ë£Œ í›„ ë³´ì—¬ì¤Œ.
            handleLoginSuccess(session.user);
        } else {
            // [ë¹„ë¡œê·¸ì¸ ìƒíƒœ] -> ë¡œê·¸ì¸ í™”ë©´ ì¦‰ì‹œ ë…¸ì¶œ
            console.log("ì¸ì¦ ì„¸ì…˜ ì—†ìŒ: ë¡œê·¸ì¸ í™”ë©´ ì´ë™");
            showOnly('loginSection'); 
        }
    });
});

    // =========================================================================
    // 2. ë¡œê·¸ì¸ & ë°ì´í„° ë¡œë“œ
    // =========================================================================
// [ìˆ˜ì • 2] ë§¤ì§ë§í¬ ë°œì†¡: ì—ëŸ¬ ë©”ì‹œì§€ ë²ˆì—­ ì ìš©
async function sendMagicLink() {
    const email = document.getElementById('emailInput').value.trim();
    if(!email.includes('@')) return showModal('ì´ë©”ì¼ ì£¼ì†Œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\n(@ê°€ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤)');
    
    showLoading(true, 'ë³´ì•ˆ ì—°ê²° ì´ˆê¸°í™” ë° ë©”ì¼ ë°œì†¡ ì¤‘...');
    
    // 1. ê¸°ì¡´ ì„¸ì…˜ ë¡œê·¸ì•„ì›ƒ
    await _supabase.auth.signOut();

    // 2. ë¡œê·¸ì¸ ë§í¬ ë°œì†¡
    const { error } = await _supabase.auth.signInWithOtp({
        email: email,
        options: { shouldCreateUser: false, emailRedirectTo: window.location.href } 
        // ì£¼ì˜: shouldCreateUser: falseë¡œ ì„¤ì •í•˜ì—¬ ë¯¸ê°€ì…ìê°€ ë¡œê·¸ì¸ ì‹œë„ ì‹œ ì—ëŸ¬ê°€ ë‚˜ë„ë¡ ìœ ë„í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
        // í˜„ì¬ ì •ì±…(ê°€ì…ëœ ì´ë©”ì¼ë§Œ)ì— ë§ê²Œ false ê¶Œì¥. ë§Œì•½ ëˆ„êµ¬ë‚˜ ê°€ì… ê°€ëŠ¥í•˜ë‹¤ë©´ true.
    });
    
    showLoading(false);

    if(error) {
        // â˜… ì—¬ê¸°ê°€ ë³€ê²½ëœ ë¶€ë¶„ì…ë‹ˆë‹¤.
        const friendlyMsg = translateAuthError(error.message);
        showModal(friendlyMsg);
    }
    else {
        document.getElementById('sentMsgBox').classList.remove('hidden');
        document.getElementById('targetEmail').innerText = email;
    }
}

// [ìˆ˜ì •] ë¡œê·¸ì¸ ì„±ê³µ í›„ ì²˜ë¦¬ (ìë™ ì‹¤íŒ¨ ì‹œ -> ìˆ˜ë™ ëª¨ë‹¬ ë„ì›€)
async function handleLoginSuccess(user) {
    curAuth = user;
    showLoading(true, 'ì •ë³´ í™•ì¸ ì¤‘...');
    
    // 1. ìë™ ë§¤ì¹­ ì‹œë„
    const { data: claimRes, error: claimErr } = await _supabase.rpc('claim_member_profile');
    
    showLoading(false);

    // [í•µì‹¬ ë³€ê²½] ì‹¤íŒ¨í–ˆë‹¤ê³  ë°”ë¡œ ì«“ì•„ë‚´ì§€ ì•ŠìŒ!
    if (claimErr || !claimRes.success) {
        console.log("ìë™ ë§¤ì¹­ ì‹¤íŒ¨, ìˆ˜ë™ ë§¤ì¹­ ëª¨ë‹¬ ì˜¤í”ˆ");
        // ë¡œê·¸ì•„ì›ƒ í•˜ì§€ ì•Šê³ , ëª¨ë‹¬ì„ ë„ì›€
        document.getElementById('manualMatchModal').style.display = 'flex';
        return; 
    }

    // ì„±ê³µ ì‹œ ëŒ€ì‹œë³´ë“œ ë¡œë“œ
    document.getElementById('headerLogoutBtn').classList.remove('hidden');
    
    // [1] ëŒ€ì‹œë³´ë“œ ë°ì´í„° ìš°ì„  ë¡œë“œ (curMem ì „ì—­ ë³€ìˆ˜ê°€ ì—¬ê¸°ì„œ ì„¸íŒ…ë¨)
    await loadDashboardData(user.id);

    // [2] ê´€ë¦¬ ê°€ëŠ¥í•œ í”„ë¡œí•„(ë‹¨ì²´/ê°€ì¡±) ëª©ë¡ ë¡œë“œ (ëˆ„ë½ë˜ì—ˆë˜ ë¶€ë¶„)
    // -> ì´ í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ì–´ì•¼ ìƒë‹¨ì— ë“œë¡­ë‹¤ìš´(í”„ë¡œí•„ ìŠ¤ìœ„ì²˜)ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
    // -> loadDashboardData ì™„ë£Œ í›„ í˜¸ì¶œí•´ì•¼ í˜„ì¬ í”„ë¡œí•„ì— 'Active' ì²´í¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
    if (typeof loadManagedProfiles === 'function') {
        await loadManagedProfiles(user.id);
    }
}

// [ì‹ ê·œ] ì „í™”ë²ˆí˜¸ ìë™ í•˜ì´í”ˆ & ìˆ«ì ì´ì™¸ ì°¨ë‹¨
function autoHyphen(target) {
    // 1. ìˆ«ìë§Œ ë‚¨ê¸°ê¸° (ê³µë°±, ë¬¸ì ì œê±°)
    let raw = target.value.replace(/[^0-9]/g, '');
    
    // 2. 01012341234 -> 010-1234-1234 í¬ë§·íŒ…
    let formatted = '';
    if (raw.length < 4) {
        formatted = raw;
    } else if (raw.length < 7) {
        formatted = raw.substr(0, 3) + '-' + raw.substr(3);
    } else if (raw.length < 11) {
        formatted = raw.substr(0, 3) + '-' + raw.substr(3, 3) + '-' + raw.substr(6);
    } else {
        // 11ìë¦¬ê¹Œì§€ë§Œ ì²˜ë¦¬ (ê·¸ ì´ìƒì€ ì˜ë¼ëƒ„)
        raw = raw.substr(0, 11);
        formatted = raw.substr(0, 3) + '-' + raw.substr(3, 4) + '-' + raw.substr(7);
    }
    
    target.value = formatted;
}

// [ì‹ ê·œ] ë¼ë””ì˜¤ ë²„íŠ¼ì— ë”°ë¼ ì…ë ¥ì°½ êµì²´
function toggleContactInput() {
    const isPhone = document.getElementById('typePhone').checked;
    const phoneGroup = document.getElementById('inputGroupPhone');
    const emailGroup = document.getElementById('inputGroupEmail');

    if (isPhone) {
        phoneGroup.classList.remove('hidden');
        emailGroup.classList.add('hidden');
        document.getElementById('manualPhone').focus();
    } else {
        phoneGroup.classList.add('hidden');
        emailGroup.classList.remove('hidden');
        document.getElementById('manualEmail').focus();
    }
}

// [ìˆ˜ì •] ìˆ˜ë™ ë§¤ì¹­ ì‹¤í–‰ í•¨ìˆ˜ (Alert ì œê±° -> showModal ì ìš©)
async function tryManualLink() {
    const name = document.getElementById('manualName').value.trim();
    const isPhone = document.getElementById('typePhone').checked;
    
    let contact = '';
    
    // [ìœ íš¨ì„± ê²€ì‚¬] alert ëŒ€ì‹  showModal ì‚¬ìš©
    if (isPhone) {
        contact = document.getElementById('manualPhone').value.trim();
        if (contact.length < 12) return showModal("ì „í™”ë²ˆí˜¸ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ìˆ«ìë§Œ ì…ë ¥í•˜ë©´ ë©ë‹ˆë‹¤)");
    } else {
        contact = document.getElementById('manualEmail').value.trim();
        if (!contact.includes('@')) return showModal("ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
    }

    if (!name) return showModal("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    // ë¡œë”© ì‹œì‘
    showLoading(true, 'ì¡°í•©ì› ëª…ë¶€ ê²€ìƒ‰ ì¤‘...');

    // ìˆ˜ë™ ë§¤ì¹­ RPC í˜¸ì¶œ
    const { data, error } = await _supabase.rpc('manual_claim_member', {
        p_name: name,
        p_contact: contact
    });

    showLoading(false);

    if (error) {
        showModal("ì˜¤ë¥˜ ë°œìƒ: " + error.message);
    } else if (data.success) {
        // [ì„±ê³µ] ëª¨ë‹¬ ë‹«ê³  -> í™˜ì˜ ë©”ì‹œì§€ ëª¨ë‹¬ ë„ì›€ -> í™•ì¸ ëˆ„ë¥´ë©´ ëŒ€ì‹œë³´ë“œ ë¡œë“œ
        document.getElementById('manualMatchModal').style.display = 'none';
        
        // â˜… í™˜ì˜ ì•ŒëŸ¿ì„ ëª¨ë‹¬ë¡œ ë³€ê²½
        // showConfirmModalì„ ì‘ìš©í•´ì„œ 'í™•ì¸' ë²„íŠ¼ë§Œ ìˆëŠ” í™˜ì˜ì°½ìœ¼ë¡œ ì”€
        // (ë˜ëŠ” showModalì„ ì“°ê³  ì½œë°±ì´ í•„ìš”í•˜ë©´ ì»¤ìŠ¤í…€í•´ì•¼ í•˜ì§€ë§Œ, 
        //  ì—¬ê¸°ì„œëŠ” showModal í›„ ë°”ë¡œ ë¡œë“œí•´ë„ ì‚¬ìš©ìê°€ ì¸ì§€í•¨)
        
        showModal("ğŸ‰ ë°˜ê°‘ìŠµë‹ˆë‹¤! ì •ë³´ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.\nê³„ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.");
        
        // ì—°ê²°ëìœ¼ë‹ˆ ëŒ€ì‹œë³´ë“œ ë¡œë“œ (ëª¨ë‹¬ ë’¤ì—ì„œ ë¡œë“œë¨)
        document.getElementById('headerLogoutBtn').classList.remove('hidden');
        await loadDashboardData(curAuth.id);
        
    } else {
        // [ì‹¤íŒ¨]
        showModal("ì¼ì¹˜í•˜ëŠ” ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.\nì´ë¦„ì´ë‚˜ ì—°ë½ì²˜ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
    }
}

// [ìˆ˜ì •] ìˆ˜ë™ ë§¤ì¹­ í¬ê¸° (Alert ì œê±°)
async function manualMatchFail() {
    await _supabase.auth.signOut();
    document.getElementById('manualMatchModal').style.display = 'none';
    showModal("ê°€ì… ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì‚¬ë¬´êµ­ìœ¼ë¡œ ë¬¸ì˜í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
}

   // [ì‹ ê·œ] ë·°(view_member_list)ì—ì„œ ë§ˆìŠ¤í‚¹ ëœ ê³„ì¢Œ ì •ë³´ë§Œ ì¡°íšŒí•˜ëŠ” í•¨ìˆ˜
async function fetchMaskedBankInfo(uuid) {
    try {
        // Step 1ì—ì„œ ë·°ë¥¼ ì¬ì •ì˜í–ˆìœ¼ë¯€ë¡œ 'id' ì»¬ëŸ¼(UUID) ì‚¬ìš© ê°€ëŠ¥
        const { data, error } = await _supabase
            .from('view_member_list')
            .select('account_number')
            .eq('id', uuid)
            .maybeSingle();

        if (error) {
            console.warn("ë·° ì¡°íšŒ ê²½ê³ :", error.message);
            return null;
        }
        return data ? data.account_number : null;
    } catch (e) { return null; }
}
// [ìˆ˜ì • 3] ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ: ì¸ì¦ ì˜ˆì™¸ ì²˜ë¦¬ ë° ìŠ¤í‚¤ë§ˆ ì •í•©ì„± í™•ë³´
// [ìˆ˜ì •] ë°ì´í„° ë¡œë“œ ì™„ë£Œ í›„ í™”ë©´ ë…¸ì¶œ
async function loadDashboardData(uuid) {
    try {
        // 1. ë©¤ë²„ ê¸°ë³¸ ì •ë³´ ì¡°íšŒ
        const { data: member, error: memErr } = await _supabase
            .from('coop_members')
            .select('*')
            .eq('id', uuid)
            .single();

        if (memErr || !member) {
            console.error("ë©¤ë²„ ì¡°íšŒ ì‹¤íŒ¨:", memErr);
            if (memErr && (memErr.code === 'PGRST301' || memErr.message.includes('Auth') || memErr.status === 403)) {
                alert("ë³´ì•ˆì„ ìœ„í•´ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                logout(); 
                return;
            }
            throw new Error('íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        // ë§ˆìŠ¤í‚¹ ê³„ì¢Œ ì ìš©
        const maskedAcc = await fetchMaskedBankInfo(uuid);
        if (maskedAcc) member.account_number = maskedAcc; 
        curMem = member; 

        // 2. ìì‚° ì •ë³´ ë¡œë“œ
        let assets = { total_capital: 0, total_donation: 0, dividend_capital: 0, dividend_usage: 0, current_points: 0 };
        const { data: assetData } = await _supabase
            .from('view_my_assets')
            .select('*')
            .eq('member_uid', uuid)
            .maybeSingle(); 

        if (assetData) assets = assetData;
        curMem.total_capital = assets.total_capital;

        // 3. ì…ê¸ˆ ë° ì‹ ì²­ ë‚´ì—­, ê¶Œí•œ ë¡œë“œ
        const { data: ledger } = await _supabase.from('ref_members').select('*').eq('member_id', curMem.member_id).order('deposit_date', { ascending: false });
        const { data: apps } = await _supabase.from('coop_applications').select('*').eq('member_uid', uuid).order('created_at', { ascending: false });
        const { data: officials } = await _supabase.from('coop_officials').select('category').eq('member_id', curMem.member_id);
        const myRoles = officials ? officials.map(r => r.category) : [];

        // 4. ë Œë”ë§ (ë°ì´í„°ë¥¼ HTMLì— ê½‚ì•„ë„£ê¸°)
        renderDashboard(curMem, apps || [], ledger || [], assets, myRoles);
        
        // [ë¶€ê°€ ê¸°ëŠ¥ ë¡œë“œ]
        if(curMem.rrn_display) checkBirthday(curMem.rrn_display, curMem.name);
        if (typeof loadFamilyList === 'function') loadFamilyList(uuid);
        if (typeof loadMiniNotices === 'function') loadMiniNotices();
        if (typeof checkIncomingConnects === 'function') checkIncomingConnects();
        loadBoard('free', null, 20); 

        if (typeof Badges !== 'undefined') {
            Badges.render('badgeContainer', uuid, _supabase);
            Badges.checkAnniversary(curMem, _supabase);
        }

        // [í•µì‹¬ ìˆ˜ì •] ëª¨ë“  ë°ì´í„° ì„¸íŒ…ì´ ëë‚œ ì´ ì‹œì ì— ëŒ€ì‹œë³´ë“œë¥¼ ë³´ì—¬ì¤Œ
        showOnly('dashboardSection');

    } catch (e) {
        console.error("Dashboard Load Error:", e);
        showLoading(false);
        showModal('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ' + e.message);
        // ì—ëŸ¬ ë°œìƒ ì‹œ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ëŒë¦¬ê±°ë‚˜ ë¹ˆ í™”ë©´ ìœ ì§€
        showOnly('loginSection');
    } finally {
        showLoading(false);
    }
}



    // =========================================================================
    // 3. ë Œë”ë§ & ë‚´ ì •ë³´ ìˆ˜ì • (toggleEditMode í¬í•¨)
    // =========================================================================

// [ìµœì¢… ìˆ˜ì •] ì‚¬ìš©ìë‹˜ ì›ë³¸ ë¡œì§ ë³µêµ¬ + í™”ë©´ ê²¹ì¹¨ í•´ê²°(1~3ë²ˆ ì¤„)
// [ìµœì¢… ìˆ˜ì •] ë‹¨ì²´ ê³„ì •ì€ ìƒë…„ì›”ì¼ í‘œì‹œ ìˆ¨ê¹€ + ê°œì¸ë§Œ rrn_displayë¡œ í‘œì‹œ
// [ìˆ˜ì •] ì‚¬ìš©ìë‹˜ ì›ë³¸ ë¡œì§ ë³µêµ¬ + ì´ë©”ì¼ í‘œì‹œ ë¡œì§ ê°œì„  (DB ì •ë³´ ìš°ì„ )
function renderDashboard(member, apps, ledger, assets, myRoles) {
    // [ì¶”ê°€] ìƒíƒœ ë°°ì§€ í‘œì‹œ (ìƒë‹¨ ë…¸ì¶œ)
    renderMemberStatusBadge(member?.status);

    // 1) ë‹¨ì²´ ì—¬ë¶€ íŒë‹¨
    const isOrg =
        member?.member_type === 'ë‹¨ì²´' ||
        member?.member_type === 'organization' ||
        member?.join_category === 'ë‹¨ì²´';

    // 2) ìƒë…„ì›”ì¼ UI ë°•ìŠ¤ ì œì–´
    const birthEl = document.getElementById('infoBirth');
    const birthBox = birthEl ? birthEl.closest('.col-md-6') : null;

    if (isOrg) {
        // ë‹¨ì²´: ìƒë…„ì›”ì¼ ìˆ¨ê¹€
        if (birthBox) birthBox.classList.add('hidden');
        setText('infoBirth', '-');
    } else {
        // ê°œì¸: ìƒë…„ì›”ì¼ í‘œì‹œ
        if (birthBox) birthBox.classList.remove('hidden');
        setText('infoBirth', formatBirthDate(member.rrn_display));
    }

    // 3) [í•µì‹¬ ìˆ˜ì •] ê¸°ë³¸ ì •ë³´ ë§¤í•‘
    setText('infoName', member.name);
    
    // â˜… ìˆ˜ì •ëœ ë¶€ë¶„: DBì— ì €ì¥ëœ ì´ë©”ì¼ì„ ìš°ì„  í‘œì‹œí•˜ê³ , ì—†ìœ¼ë©´ ë¡œê·¸ì¸ ì´ë©”ì¼ í‘œì‹œ
    setText('infoEmail', member.email || curAuth.email);

    setVal('editPhone', member.phone);
    setVal('editBankName', member.bank_name);
    setVal('editAccountNo', member.account_number);
    setVal('editHolder', member.account_holder);
  setText('viewPhoneBox', member.phone);

    setText('viewAddressBox', member.address);
    setVal('editAddrMain', member.address);
    setVal('editAddrDetail', '');
  const bankText = (member.bank_name || '') + ' ' + (member.account_number || '') + ' (' + (member.account_holder || '') + ')';
    setText('viewBankBox', bankText.trim() === '()' ? '-' : bankText); // ë°ì´í„° ì—†ìœ¼ë©´ '-'

    // 4) ìì‚° í˜„í™© ì¹´ë“œ (ë™ì  ìƒì„±)
    const assetRow = document.getElementById('assetSummaryRow');
    while (assetRow.children.length > 3) {
        assetRow.removeChild(assetRow.lastChild);
    }

    setText('sumId', member.member_id);
    setText('sumTotal', Number(assets.total_capital).toLocaleString() + 'ì›');

    if (assets.total_donation > 0) addAssetCard(assetRow, 'ê¸°ë¶€ê¸ˆ', assets.total_donation);
    
    const totalDiv = (assets.dividend_capital || 0) + (assets.dividend_usage || 0);
    if (totalDiv > 0) addAssetCard(assetRow, 'ë°°ë‹¹ê¸ˆ(ì¶œì+ì´ìš©)', totalDiv);
    
    if (assets.current_points > 0) addAssetCard(assetRow, 'í¬ì¸íŠ¸', assets.current_points, 'P');

    // 5) ê²Œì‹œíŒ íƒ­ ê¶Œí•œ ì²˜ë¦¬
    const tabExec = document.getElementById('tabExec');
    const tabElec = document.getElementById('tabElec');
    if (myRoles.includes('executive') && tabExec) tabExec.classList.remove('hidden');
    if (myRoles.includes('election_comm') && tabElec) tabElec.classList.remove('hidden');

    // 6) íƒ€ì„ë¼ì¸ ë Œë”ë§
    renderTimeline(ledger, apps);
}



// [í—¬í¼] ìì‚° ì¹´ë“œ ì¶”ê°€ (ì‚¬ìš©ìë‹˜ ì›ë³¸ ìŠ¤íƒ€ì¼: col-6 col-md-3 ìœ ì§€)
function addAssetCard(row, title, val, unit='ì›') {
    const col = document.createElement('div');
    col.className = 'col-6 col-md-3';
    col.innerHTML = `
        <div class="dashboard-card text-center p-3">
            <small class="text-muted d-block mb-1">${title}</small>
            <div class="fw-bold fs-5 text-primary">${Number(val).toLocaleString()}${unit}</div>
        </div>`;
    row.appendChild(col);
}




    // [í—¬í¼] ìƒë…„ì›”ì¼ í¬ë§·íŒ…
    function formatBirthDate(rrn) {
        if (!rrn || rrn.length < 6) return '-';
        const yy = rrn.substring(0, 2);
        const mm = rrn.substring(2, 4);
        const dd = rrn.substring(4, 6);
        
        // ì„±ë³„ ì½”ë“œ í™•ì¸ (ì—†ìœ¼ë©´ 1900ë…„ëŒ€ë¡œ ê°€ì •)
        let prefix = '19';
        if (rrn.includes('-')) {
            const gender = rrn.split('-')[1].charAt(0);
            if (gender === '3' || gender === '4') prefix = '20';
        }
        
        return `${prefix}${yy}ë…„ ${Number(mm)}ì›” ${Number(dd)}ì¼`;
    }

    // =========================================================================
    // 4. ì‹ ì²­ ë° íƒ€ì„ë¼ì¸
    // =========================================================================
// [ìˆ˜ì •] ìµœê·¼ í™œë™ ë‚´ì—­: "ìµœì‹ ì´ ìœ„"ë¡œ ì •ë ¬í•´ì„œ ë Œë”ë§
function renderTimeline(ledger, apps) {
    const list = document.getElementById('timelineList');

    // ë‘˜ ë‹¤ ë¹„ì—ˆìœ¼ë©´ ì¢…ë£Œ
    if ((!ledger || ledger.length === 0) && (!apps || apps.length === 0)) {
        list.innerHTML = '<div class="text-center text-muted py-5">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    // 1) ì…ê¸ˆ/ì‹ ì²­ì„ ê°™ì€ í¬ë§·ìœ¼ë¡œ í•©ì³ì„œ "ë‚ ì§œ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ" ì •ë ¬
    const items = [];

    (ledger || []).forEach(item => {
        items.push({
            kind: 'ledger',
            ts: item.deposit_date ? new Date(item.deposit_date).getTime() : 0,
            raw: item
        });
    });

    (apps || []).forEach(app => {
        items.push({
            kind: 'app',
            ts: app.created_at ? new Date(app.created_at).getTime() : 0,
            raw: app
        });
    });

    // ìµœì‹ ì´ ìœ„ë¡œ
    items.sort((a, b) => b.ts - a.ts);

    // 2) ë Œë”ë§
    let html = '';
    const typeMap = { 'extra': 'ì¶”ê°€ì¶œì', 'reduction': 'ê°ìì‹ ì²­', 'withdraw': 'íƒˆí‡´ì‹ ì²­', 'connect': 'ê³„ì •ì—°ê²°' };

    items.forEach(it => {
        if (it.kind === 'ledger') {
            const item = it.raw;
            const date = item.deposit_date ? String(item.deposit_date).substring(0, 10) : '-';
            html += `
                <div class="timeline-item">
                    <div class="timeline-date">${date}</div>
                    <div class="timeline-content">
                        <h5>ì…ê¸ˆ í™•ì¸</h5>
                        <p class="text-success fw-bold">+${Number(item.amount || 0).toLocaleString()}ì›</p>
                    </div>
                </div>`;
            return;
        }

        // app
        const app = it.raw;
        const date = app.created_at ? String(app.created_at).substring(0, 10) : '-';
        const appType = typeMap[app.type] || app.type;

        let statusBadge = '';
        let actionBtn = '';

        if (app.status === 'pending') {
            statusBadge = '<span class="badge bg-warning text-dark">ê²€í† ì¤‘</span>';
            actionBtn = `<button class="btn btn-sm btn-outline-danger ms-2" style="font-size:0.7rem; padding:2px 6px;" onclick="cancelApp(${app.id})">ì·¨ì†Œ</button>`;
        } else if (app.status === 'approved') {
            statusBadge = '<span class="badge bg-success">ìŠ¹ì¸ë¨</span>';
        } else if (app.status === 'cancelled') {
            statusBadge = '<span class="badge bg-secondary">ì·¨ì†Œë¨</span>';
        } else {
            statusBadge = '<span class="badge bg-danger">ë°˜ë ¤ë¨</span>';
        }

        // connect íƒ€ì… ìƒì„¸ í…ìŠ¤íŠ¸ ì²˜ë¦¬
        let detailText = '';
        if (app.type === 'connect') {
            if (app.status === 'pending') {
                detailText = `<span class="text-primary small">â³ ${app.reason ? 'ì—°ê²° ìš”ì²­ì¤‘' : ''}</span>`;
            } else if (app.status === 'approved') {
                detailText = `<span class="text-success small">âœ… ì—°ê²° ì™„ë£Œ</span>`;
            } else {
                detailText = `<span class="text-muted small">ì¢…ë£Œëœ ìš”ì²­</span>`;
            }
        } else {
            detailText = `${Number(app.amount || 0).toLocaleString()}ì›`;
        }

        html += `
            <div class="timeline-item" style="border-left-color: #ff9800;">
                <div class="timeline-date">${date}</div>
                <div class="timeline-content">
                    <div class="d-flex justify-content-between align-items-center">
                        <div><span class="fw-bold">[ì‹ ì²­] ${appType}</span> ${statusBadge}</div>
                        ${actionBtn}
                    </div>
                    <p>${detailText}</p>
                </div>
            </div>`;
    });

    list.innerHTML = html;
}


async function cancelApp(appId) {
        // confirm -> showConfirmModal
        showConfirmModal('ì‹ ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async function() {
            showLoading(true);
            const { error } = await _supabase
                .from('coop_applications')
                .update({ status: 'cancelled' })
                .eq('id', appId);

            showLoading(false);
            if(error) showModal('ì·¨ì†Œ ì‹¤íŒ¨: ' + error.message);
            else {
                showModal('ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadDashboardData(curAuth.id);
            }
        });
    }

    // ì‹ ì²­ ë¡œì§ (Submit)
async function submitApplication(type) {
        let amount = 0, reason = '';
        const totalCap = Number(curMem.total_capital || 0);

        if(type === 'extra') {
            amount = Number(document.getElementById('exAmount').value);
            if(amount < 10000) return showModal('1ë§Œì› ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        } 
        else if(type === 'reduction') {
            amount = Number(document.getElementById('redAmount').value);
            if(amount <= 0) return showModal('ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            if(totalCap - amount < 100000) return showModal(`ì”ì•¡ 10ë§Œì› ì´ìƒ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.\n(í˜„ì¬: ${totalCap.toLocaleString()}ì›)`);
            if(!document.getElementById('checkRedAgree').checked) return showModal('ì•ˆë‚´ ì‚¬í•­ì— ë™ì˜í•´ì£¼ì„¸ìš”.');
        } 
        else if(type === 'withdraw') {
            reason = document.getElementById('wdReason').value;
            if(!reason) return showModal('ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            if(!document.getElementById('checkWdAgree').checked) return showModal('ë™ì˜ í•­ëª©ì— ì²´í¬í•´ì£¼ì„¸ìš”.');
        }

        // confirm -> showConfirmModal
        showConfirmModal('ì‹ ì²­ì„œë¥¼ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async function() {
            showLoading(true);
            const { error } = await _supabase.from('coop_applications').insert({
                member_uid: curAuth.id,
                member_id: curMem.member_id,
                name: curMem.name,
                type: type,
                amount: amount,
                reason: reason,
                status: 'pending'
            });

            showLoading(false);
            if(error) showModal('ì˜¤ë¥˜: ' + error.message);
            else {
                showModal('ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.');
                // ì´ˆê¸°í™”
                document.getElementById('exAmount').value = '';
                document.getElementById('redAmount').value = '';
                document.getElementById('wdReason').value = '';
                if(document.getElementById('checkRedAgree')) document.getElementById('checkRedAgree').checked = false;
                if(document.getElementById('checkWdAgree')) document.getElementById('checkWdAgree').checked = false;
                
                loadDashboardData(curAuth.id);
            }
        });
    }

// [ìˆ˜ì •] í”„ë¡œí•„ ì €ì¥ (ì£¼ì†Œ í•©ì¹˜ê¸° + ëª¨ë‹¬ í™•ì¸)
// [ìˆ˜ì •] í”„ë¡œí•„ ì €ì¥ (ì „í™”ë²ˆí˜¸ ì¤‘ë³µ ì²´í¬ ë° ìœ íš¨ì„± ê²€ì‚¬ ì¶”ê°€)
async function saveProfile() {
    // 1. ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
    const phone = document.getElementById('editPhone').value.trim();
    const mainAddr = document.getElementById('editAddrMain').value;
    const detailAddr = document.getElementById('editAddrDetail').value;
    const fullAddr = (mainAddr + ' ' + detailAddr).trim();
    const bank = document.getElementById('editBankName').value;
    const accNo = document.getElementById('editAccountNo').value; // ìˆ«ìë§Œ ë“¤ì–´ì˜´ (HTML ì œì–´)
    const holder = document.getElementById('editHolder').value;

    // 2. [ê²€ì¦] ì „í™”ë²ˆí˜¸ ìœ íš¨ì„± ì²´í¬
    if (phone.length < 12) {
        return showModal('ì „í™”ë²ˆí˜¸ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ì˜ˆ: 010-1234-5678)');
    }

    // 3. [ê²€ì¦] ì „í™”ë²ˆí˜¸ ì¤‘ë³µ ì²´í¬ (DB ì¡°íšŒ)
    // ì„¤ëª…: ë‚´ í˜„ì¬ ë²ˆí˜¸ì™€ ë‹¤ë¥´ë‹¤ë©´, ë‹¤ë¥¸ ì‚¬ëŒì´ ì“°ê³  ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    if (phone !== curMem.phone) {
        showLoading(true, 'ì¤‘ë³µ ê²€ì‚¬ ì¤‘...');
        
        try {
            const { data: existing, error: checkErr } = await _supabase
                .from('coop_members')
                .select('id')
                .eq('phone', phone)      // ì…ë ¥í•œ ë²ˆí˜¸ì™€ ê°™ê³ 
                .neq('id', curAuth.id)   // ë‚´ IDëŠ” ì•„ë‹Œ ê²ƒ (ë‚˜ ìì‹  ì œì™¸)
                .maybeSingle();          // í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ê°€ì ¸ì˜´

            showLoading(false);

            if (checkErr) {
                console.error(checkErr);
                return showModal('ì¤‘ë³µ ê²€ì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }

            if (existing) {
                return showModal('ì´ë¯¸ ë“±ë¡ëœ ì „í™”ë²ˆí˜¸ì…ë‹ˆë‹¤.\nì¤‘ë³µ ê°€ì…ì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.');
            }

        } catch (e) {
            showLoading(false);
            return showModal('ì‹œìŠ¤í…œ ì˜¤ë¥˜: ' + e.message);
        }
    }

    // 4. ì €ì¥ ì§„í–‰ (ê¸°ì¡´ ë¡œì§)
    showConfirmModal('ì •ë³´ë¥¼ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async function() {
        showLoading(true, 'ì €ì¥ ì¤‘...');

        const { error } = await _supabase.rpc('update_my_profile', {
            p_phone: phone,
            p_address: fullAddr,
            p_bank_name: bank,
            p_account_number: accNo,
            p_account_holder: holder
        });

        showLoading(false);

        if (error) {
            showModal('ìˆ˜ì • ì‹¤íŒ¨: ' + error.message);
        } else {
            showModal('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            toggleEditMode(false);
            // ë°ì´í„° ê°±ì‹ ì„ ìœ„í•´ ëŒ€ì‹œë³´ë“œ ë¦¬ë¡œë“œ
            loadDashboardData(curAuth.id);
        }
    });
}

// [ìˆ˜ì •] íƒ­ ì „í™˜ (ê°ì í•œë„ ì²´í¬ ë¡œì§ í¬í•¨)
function toggleTab(type, btn) {
        document.getElementById('tabPlaceholder').classList.add('hidden');
        ['tabExtra', 'tabReduction', 'tabWithdraw', 'tabCert'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        document.getElementById('tab' + type.charAt(0).toUpperCase() + type.slice(1)).classList.remove('hidden');

        if(type === 'reduction') {
            const total = Number(curMem.total_capital || 0);
            const limit = total - 100000;
            const display = document.getElementById('redLimitDisplay');
            const input = document.getElementById('redAmount');
            
            if(limit <= 0) {
                display.innerText = "í˜„ì¬ ê°ì ì‹ ì²­ ë¶ˆê°€ (ì”ì•¡ ë¶€ì¡±)";
                input.disabled = true;
                input.placeholder = "ì‹ ì²­ ë¶ˆê°€";
            } else {
                display.innerText = `ìµœëŒ€ ì‹ ì²­ ê°€ëŠ¥: ${limit.toLocaleString()}ì›`;
                input.disabled = false;
                input.placeholder = `ìµœëŒ€ ${limit.toLocaleString()}`;
                
                input.oninput = function() {
                    if(Number(this.value) > limit) {
                        this.value = limit;
                        showModal(`ìµœëŒ€ ${limit.toLocaleString()}ì›ê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`); // alert -> showModal
                    }
                };
            }
        }
    }

async function downloadCert() {
    if(!curMem) return;
    showLoading(true, 'ì¦ì„œ ë°œê¸‰ ì¤‘...');
    
    try {
        // 1. ë‚©ì… ì´ì•¡ ê³„ì‚°
        const { data: pay } = await _supabase.from('ref_members').select('amount').eq('member_id', curMem.member_id);
        const ledgerTotal = pay ? pay.reduce((a,c)=>a+Number(c.amount),0) : 0;
        
        // 2. ìµœì¢… ê¸ˆì•¡ (ë³€ìˆ˜ëª… í†µì¼: finalTotal)
        const finalTotal = Math.max(ledgerTotal, Number(curMem.total_capital || 0));
        
        if(finalTotal === 0) { 
            showLoading(false); 
            return showModal('ë‚©ì…ëœ ì¶œìê¸ˆì´ ì—†ì–´ ì¦ëª…ì„œë¥¼ ë°œê¸‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); 
        }

        // 3. RPC í˜¸ì¶œ (p_amountì— finalTotal ì „ë‹¬)
        // coop_certificates í…Œì´ë¸”ì— insert ê¶Œí•œì´ ìˆì–´ì•¼ í•¨
        const { data: cert, error } = await _supabase.rpc('issue_certificate', { 
            p_member_id: curMem.member_id, 
            p_amount: finalTotal 
        });

        if (error) throw error;

        // 4. PDF ìƒì„± (cert_generator.js í™œìš©)
        const { data: info } = await _supabase.from('ref_company_info').select('value').eq('key', 'chairman_name').single();
        await generateContributionCert(curMem, finalTotal, cert.cert_number, info?info.value:"ì´ì‚¬ì¥", _supabase);
        
        showLoading(false);

    } catch(e) { 
        console.error(e); 
        showLoading(false); 
        showModal('ì¦ëª…ì„œ ë°œê¸‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + (e.message || '')); 
    }
}

    function logout() { 
        showConfirmModal('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
            _supabase.auth.signOut().then(() => location.reload());
        }); 
    }


// [ìˆ˜ì •] ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í•¨ìˆ˜ (ì „í™”ë²ˆí˜¸ ìš”ì²­ ì¶”ê°€)
async function startKakaoLogin() {
    try {
        showLoading(true, 'ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...');

        const { data, error } = await _supabase.auth.signInWithOAuth({
            provider: 'kakao',
            options: {
                redirectTo: 'https://yonginsolar.github.io/home/membermanage.html', // ì•„ê¹Œ ê³ ì¹œ ê³ ì • ì£¼ì†Œ
                // [í•µì‹¬ ì¶”ê°€] ì¹´ì¹´ì˜¤ì—ê²Œ ì „í™”ë²ˆí˜¸(phone_number)ì™€ ì´ë©”ì¼ ê¶Œí•œì„ ìš”ì²­í•¨
                scopes: 'account_email phone_number' 
            }
        });

        if (error) throw error;
        
    } catch (e) {
        console.error("Kakao Login Error:", e);
        showLoading(false);
        showModal('ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì—°ê²° ì‹¤íŒ¨:\n' + e.message);
    }
}
    
    // [í—¬í¼] ì•ˆì „í•œ ê°’ ì„¤ì •
    function setText(id, txt) { const el=document.getElementById(id); if(el) el.innerText = txt || '-'; }
    function setVal(id, val) { const el=document.getElementById(id); if(el) el.value = val || ''; }

   // [ì¶”ê°€] ëª¨ë‹¬ ì œì–´ í•¨ìˆ˜
function showModal(msg) {
    document.getElementById('customModalMsg').innerText = msg;
    document.getElementById('btnModalNo').style.display = 'none'; // ì·¨ì†Œë²„íŠ¼ ìˆ¨ê¹€
    document.getElementById('btnModalYes').onclick = closeCustomModal;
    document.getElementById('customModalOverlay').style.display = 'flex';
}

// [ì‹ ê·œ] ëª¨ë‹¬ ê²¹ì¹¨ íš¨ê³¼ ì œì–´
function setModalDepth(isPushBack) {
    const overlays = document.querySelectorAll('.custom-modal-overlay');
    // í˜„ì¬ ì—´ë ¤ìˆëŠ”(display:flex) ëª¨ë‹¬ ì¤‘, ìµœìƒìœ„(í™•ì¸ì°½)ê°€ ì•„ë‹Œ ê²ƒë“¤ì„ ì°¾ìŒ
    overlays.forEach(el => {
        if(el.id !== 'customModalOverlay' && el.style.display === 'flex') {
            if(isPushBack) el.classList.add('modal-depth-back');
            else el.classList.remove('modal-depth-back');
        }
    });
}

// ê¸°ì¡´ showConfirmModal ìˆ˜ì • (Depth ì ìš©)
function showConfirmModal(msg, yesCallback) {
    setModalDepth(true); // ê¸°ì¡´ ëª¨ë‹¬ ë’¤ë¡œ ë°€ê¸°
    document.getElementById('customModalMsg').innerText = msg;
    document.getElementById('btnModalNo').style.display = 'block';
    
    const overlay = document.getElementById('customModalOverlay');
    overlay.style.display = 'flex';
    
    document.getElementById('btnModalYes').onclick = function() {
        overlay.style.display = 'none';
        setModalDepth(false); // ë³µêµ¬
        if(yesCallback) yesCallback();
    };
    document.getElementById('btnModalNo').onclick = function() {
        overlay.style.display = 'none';
        setModalDepth(false); // ë³µêµ¬
    };
}

function closeCustomModal() {
    document.getElementById('customModalOverlay').style.display = 'none';
}

   // =========================================================================
    // [1] ë Œë”ë§ í•¨ìˆ˜ (ì£¼ì†Œì°½ ì´ˆê¸°ê°’ ì„¸íŒ… í¬í•¨)
    // =========================================================================


    // =========================================================================
    // [2] ìˆ˜ì • ëª¨ë“œ í† ê¸€ (ì£¼ì†Œì°½ 1ë‹¨ â†” 2ë‹¨ ì „í™˜ í¬í•¨)
    // =========================================================================
function toggleEditMode(isEdit) {
    // 1. ì œì–´í•  ìš”ì†Œë“¤ ê°€ì ¸ì˜¤ê¸°
    const inputs = document.querySelectorAll('.readonly-text'); // input íƒœê·¸ë“¤
    
    // ì£¼ì†Œ ê´€ë ¨
    const viewAddr = document.getElementById('viewAddressBox');
    const editAddr = document.getElementById('editAddressBox');
    
    // [ì¶”ê°€] ì „í™”ë²ˆí˜¸ ê´€ë ¨
    const viewPhone = document.getElementById('viewPhoneBox');
    const editPhone = document.getElementById('editPhone');

    // [ì¶”ê°€] ê³„ì¢Œë²ˆí˜¸ ê´€ë ¨
    const viewBank = document.getElementById('viewBankBox');
    const editBank = document.getElementById('editBankBox');

    // ê³„ì¢Œë²ˆí˜¸ ì…ë ¥ì°½ (ì´ˆê¸°í™”ìš©)
    const accInput = document.getElementById('editAccountNo');

    if (isEdit) {
        // [ìˆ˜ì • ëª¨ë“œ ì§„ì…]
        
        // ë²„íŠ¼ ì œì–´
        document.getElementById('btnEditProfile').classList.add('hidden');
        document.getElementById('btnSaveProfile').classList.remove('hidden');
        document.getElementById('btnCancelEdit').classList.remove('hidden');
        
        // Input ì†ì„± ë³€ê²½ (ì…ë ¥ ê°€ëŠ¥í•˜ê²Œ)
        inputs.forEach(el => {
            el.readOnly = false;
            el.classList.add('editable-input');
            el.classList.remove('readonly-text');
        });

        // ê³„ì¢Œë²ˆí˜¸ UX (ì…ë ¥ì°½ ë¹„ìš°ê¸°)
        accInput.value = ''; 
        accInput.placeholder = 'ë³€ê²½ ì‹œì—ë§Œ ì…ë ¥í•˜ì„¸ìš” (ê¸°ì¡´ ìœ ì§€)';

        // [í•µì‹¬] í™”ë©´ ì „í™˜ (View ìˆ¨ê¹€ -> Edit ë³´ì„)
        viewAddr.style.display = 'none';
        editAddr.style.display = 'block';

        viewPhone.style.display = 'none';
        editPhone.style.display = 'block';

        viewBank.style.display = 'none';
        editBank.style.display = 'flex'; // row í´ë˜ìŠ¤ì´ë¯€ë¡œ flex ê¶Œì¥

        // ìƒì„¸ì£¼ì†Œ ë“± edit-mode-only í´ë˜ìŠ¤ ë³´ì´ê¸°
        document.querySelectorAll('.edit-mode-only').forEach(el => el.style.display = 'block');

    } else {
        // [ì·¨ì†Œ / ë·° ëª¨ë“œ ë³µê·€]
        
        // ë°ì´í„° ì›ë³µ (ë¦¬ë¡œë“œ)
        loadDashboardData(curAuth.id);
        
        // ë²„íŠ¼ ì œì–´
        document.getElementById('btnEditProfile').classList.remove('hidden');
        document.getElementById('btnSaveProfile').classList.add('hidden');
        document.getElementById('btnCancelEdit').classList.add('hidden');
        
        // Input ì†ì„± ë³€ê²½ (ì½ê¸° ì „ìš©)
        inputs.forEach(el => {
            el.readOnly = true;
            el.classList.remove('editable-input');
            el.classList.add('readonly-text');
        });

        // [í•µì‹¬] í™”ë©´ ì „í™˜ (Edit ìˆ¨ê¹€ -> View ë³´ì„)
        viewAddr.style.display = 'block';
        editAddr.style.display = 'none';

        viewPhone.style.display = 'block';
        editPhone.style.display = 'none';

        viewBank.style.display = 'block';
        editBank.style.display = 'none';

        document.querySelectorAll('.edit-mode-only').forEach(el => el.style.display = 'none');
    }
}

    // =========================================================================
    // [3] ë‹¤ìŒ ì£¼ì†Œ ì°¾ê¸° (ê²€ìƒ‰ ê²°ê³¼ë¥¼ 2ë‹¨ ì£¼ì†Œì°½ì— ë¶„ë°°)
    // =========================================================================
    function execDaumPostcode() {
        var element_layer = document.getElementById('layer');

        new daum.Postcode({
            oncomplete: function(data) {
                // ê²€ìƒ‰ ê²°ê³¼ í•­ëª©ì„ ì¡°í•©
                var addr = ''; // ì£¼ì†Œ ë³€ìˆ˜
                var extraAddr = ''; // ì°¸ê³ í•­ëª© ë³€ìˆ˜

                // ì‚¬ìš©ìê°€ ì„ íƒí•œ ì£¼ì†Œ íƒ€ì…ì— ë”°ë¼ í•´ë‹¹ ì£¼ì†Œ ê°’ì„ ê°€ì ¸ì˜¨ë‹¤.
                if (data.userSelectedType === 'R') { // ë„ë¡œëª… ì£¼ì†Œ
                    addr = data.roadAddress;
                } else { // ì§€ë²ˆ ì£¼ì†Œ
                    addr = data.jibunAddress;
                }

                // ê±´ë¬¼ëª…ì´ ìˆê³  ê³µë™ì£¼íƒì¼ ê²½ìš° ì¶”ê°€
                if(data.userSelectedType === 'R'){
                    if(data.bname !== '' && /[ë™|ë¡œ|ê°€]$/g.test(data.bname)){
                        extraAddr += data.bname;
                    }
                    if(data.buildingName !== '' && data.apartment === 'Y'){
                        extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    if(extraAddr !== ''){
                        addr += ' (' + extraAddr + ')';
                    }
                }

                // â˜… ê°’ ë„£ê¸°: ê²€ìƒ‰ëœ ì£¼ì†ŒëŠ” ë©”ì¸ ì°½ì—, ì»¤ì„œëŠ” ìƒì„¸ ì£¼ì†Œì°½ìœ¼ë¡œ
                document.getElementById('editAddrMain').value = addr;
                document.getElementById('editAddrDetail').value = ''; // ìƒì„¸ì£¼ì†Œ ì´ˆê¸°í™”
                document.getElementById('editAddrDetail').focus();    // ìƒì„¸ì£¼ì†Œë¡œ í¬ì»¤ìŠ¤ ì´ë™

                // ë ˆì´ì–´ ë‹«ê¸°
                element_layer.style.display = 'none';
            },
            width : '100%',
            height : '100%',
            maxSuggestItems : 5
        }).embed(element_layer);

        // ë ˆì´ì–´ ë³´ì´ê¸°
        element_layer.style.display = 'block';

        // ë ˆì´ì–´ ìœ„ì¹˜ ì¡°ì • (í™”ë©´ ì¤‘ì•™)
        initLayerPosition();
    }

    // (ë³´ì¡°) ë ˆì´ì–´ ìœ„ì¹˜ ì¡ëŠ” í•¨ìˆ˜
    function initLayerPosition(){
        var element_layer = document.getElementById('layer');
        var width = 300; 
        var height = 400;
        var borderWidth = 5;

        // ìœ„ì—ì„œ ì„ ì–¸í•œ ê°’ë“¤ì„ ì‹¤ì œ elementì— ë„£ìŒ
        element_layer.style.width = width + 'px';
        element_layer.style.height = height + 'px';
        element_layer.style.border = borderWidth + 'px solid';
        
        // ì‹¤í–‰ë˜ëŠ” ìˆœê°„ì˜ í™”ë©´ ë„ˆë¹„ì™€ ë†’ì´ ê°’ì„ ê°€ì ¸ì™€ì„œ ì¤‘ì•™ì— ëœ° ìˆ˜ ìˆë„ë¡ ìœ„ì¹˜ë¥¼ ê³„ì‚°
        element_layer.style.left = (((window.innerWidth || document.documentElement.clientWidth) - width)/2 - borderWidth) + 'px';
        element_layer.style.top = (((window.innerHeight || document.documentElement.clientHeight) - height)/2 - borderWidth) + 'px';
    }

    // (ë³´ì¡°) ë‹«ê¸° ë²„íŠ¼ìš© í•¨ìˆ˜
    function closeDaumPostcode() {
        document.getElementById('layer').style.display = 'none';
    }

   // ==========================================
    // [ì¶”ê°€] 1. ìƒì¼ ì¶•í•˜ ë¡œì§
    // ==========================================
    function checkBirthday(rrn, name) {
        if(!rrn || rrn.length < 4) return;
        const today = new Date();
        const mm = String(today.getMonth()+1).padStart(2,'0');
        const dd = String(today.getDate()).padStart(2,'0');
        const userBirthMMDD = rrn.substring(2, 6); // ì£¼ë¯¼ë²ˆí˜¸ 3~6ë²ˆì§¸ (MMDD)

        if(userBirthMMDD === mm + dd) {
            // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ì²´í¬ (ìƒˆë¡œê³ ì¹¨ ì‹œ ê³„ì† í„°ì§€ëŠ” ê²ƒ ë°©ì§€)
            if(!sessionStorage.getItem('birthdayShown')) {
                fireConfetti();
                sessionStorage.setItem('birthdayShown', 'true');
            }
            const banner = document.getElementById('birthdayBanner');
            document.getElementById('birthdayMsgName').innerText = name;
            banner.style.display = 'block';
        }
    }
    function fireConfetti() {
        if(window.confetti) {
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }
    }

    // ==========================================
    // [ì¶”ê°€] 2. ê°€ì¡±/ì§ì› ê´€ë¦¬
    // ==========================================
// ==========================================
// [ê°€ì¡±/ë‹¨ì²´ ê´€ë¦¬] ì‹ ê·œ ìƒì„± & ì—°ê²° ì‹ ì²­ ë¡œì§
// ==========================================

// [ìˆ˜ì •] ëª¨ë‹¬ ì—´ê¸°: ì—­í• ë³„ íƒ­ ì œì–´ + ì—°ê²° ìƒíƒœ DB ì¡°íšŒ ì¶”ê°€
async function openAddFamilyModal() {
    // 1. ê¸°ë³¸ UI ì´ˆê¸°í™” (ê¸°ì¡´ ìœ ì§€)
    document.getElementById('familyModalOverlay').style.display = 'flex';
    document.getElementById('newFamName').value = '';
    document.getElementById('newFamId').value = 'ìë™ ìƒì„± ì˜ˆì •';
    
    // 2. [ì¶”ê°€] íƒ­ ë²„íŠ¼ ì œì–´ (ë‹¨ì²´ëŠ” ìë…€ íƒ­ ìˆ¨ê¹€)
    const tabNewBtn = document.querySelectorAll('#famModalTabs .nav-item')[0]; // ìë…€ íƒ­
    const isGroup = (curMem.member_type === 'ë‹¨ì²´' || curMem.member_type === 'organization');

    if (isGroup) {
        tabNewBtn.style.display = 'none'; // ìë…€ íƒ­ ìˆ¨ê¹€
        switchFamTab('connect');          // ê°•ì œë¡œ 'ì—°ê²°' íƒ­ìœ¼ë¡œ ì´ë™
    } else {
        tabNewBtn.style.display = 'block'; // ê°œì¸ì€ ìë…€ íƒ­ ë³´ì„
        switchFamTab('new');               // ê¸°ë³¸ì€ 'ìë…€' íƒ­
    }

    // 3. [ì¶”ê°€] ì—°ê²° ìƒíƒœ í™•ì¸ (ë¹„ë™ê¸° ë¡œì§)
    // ì—°ê²° íƒ­ ì˜ì—­ì— ë¡œë”© í‘œì‹œ
    const connArea = document.getElementById('famTabConnect');
    // ê¸°ì¡´ì— ìˆë˜ ê²€ìƒ‰ì°½ ëŒ€ì‹  ë¡œë”©ë°”ë¥¼ ì ê¹ ë„ì›ë‹ˆë‹¤.
    connArea.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-success mb-2"></div><br><small>ì—°ê²° ì •ë³´ë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...</small></div>';

    try {
        let isConnected = false;
        let targetInfo = null; // ì—°ê²°ëœ ìƒëŒ€ë°© ì •ë³´ (ì´ë¦„, ID)

        if (isGroup) {
            // [ë‹¨ì²´ ì…ì¥] ë‚˜ë¥¼ ê´€ë¦¬í•˜ëŠ” ë¶€ëª¨(manager_id)ê°€ ìˆëŠ”ê°€?
            if (curMem.manager_id) {
                const { data: parent } = await _supabase.from('coop_members')
                    .select('name').eq('id', curMem.manager_id).single();
                
                isConnected = true;
                targetInfo = { name: parent ? parent.name : 'ì•Œ ìˆ˜ ì—†ìŒ', id: curMem.manager_id };
            }
        } else {
            // [ê°œì¸ ì…ì¥] ë‚´ê°€ ê´€ë¦¬í•˜ëŠ” "ë‹¨ì²´"ê°€ ìˆëŠ”ê°€? (1:1 ì›ì¹™ ì²´í¬)
            const { data: group } = await _supabase.from('coop_members')
                .select('id, name')
                .eq('manager_id', curAuth.id)
                .eq('member_type', 'ë‹¨ì²´') // ë‹¨ì²´ë§Œ ì²´í¬ (ìë…€ëŠ” ì—¬ëŸ¬ ëª…ì´ì–´ë„ ë¨)
                .maybeSingle(); // í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ê°€ì ¸ì˜´
            
            if (group) {
                isConnected = true;
                targetInfo = { name: group.name, id: group.id };
            }
        }

        // 4. ìƒíƒœì— ë”°ë¼ í™”ë©´ ê·¸ë¦¬ê¸° (ë‹¤ìŒ í•¨ìˆ˜ í˜¸ì¶œ)
        renderConnectTabUI(connArea, isConnected, targetInfo, isGroup);

    } catch (e) {
        console.error("Connection Check Error:", e);
        connArea.innerHTML = '<div class="text-center text-danger py-3">ì •ë³´ í™•ì¸ ì‹¤íŒ¨<br>ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>';
    }
}

// [ì‹ ê·œ] ì—°ê²° íƒ­ UI ë Œë”ë§ (ê²€ìƒ‰ì°½ vs í•´ì œí™”ë©´ ë¶„ê¸°)
function renderConnectTabUI(container, isConnected, targetInfo, amIGroup) {
    if (isConnected) {
        // [Case A] ì´ë¯¸ ì—°ê²°ë¨: ê²€ìƒ‰ì°½ ìˆ¨ê¹€ + í•´ì œ ë²„íŠ¼ ë…¸ì¶œ
        const msg = amIGroup 
            ? `í˜„ì¬ <b>'${targetInfo.name}'</b> ë‹˜ì´<br>ì´ ê³„ì •ì„ ê´€ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.`
            : `í˜„ì¬ <b>'${targetInfo.name}'</b> (ë‹¨ì²´)ë¥¼<br>ê´€ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.`;

        container.innerHTML = `
            <div class="text-center py-4 bg-light rounded border">
                <div class="mb-3 text-success">
                    <i class="bi bi-link-45deg" style="font-size: 3rem;"></i>
                </div>
                <h6 class="fw-bold mb-3">ì—°ê²°ëœ ê³„ì •</h6>
                <p class="text-muted mb-4 small">${msg}</p>
                
                <button class="btn btn-outline-danger btn-sm fw-bold px-4" onclick="disconnectRelation('${targetInfo.id}', ${amIGroup})">
                    <i class="bi bi-x-circle me-1"></i> ì—°ê²° í•´ì œ
                </button>
            </div>
        `;
    } else {
        // [Case B] ì—°ê²° ì•ˆ ë¨: ê¸°ì¡´ ê²€ìƒ‰ì°½ UI ë³µì›
        const guideMsg = amIGroup 
            ? 'ê³„ì •ì„ ê´€ë¦¬í•´ì¤„ <b>ëŒ€í‘œì(ê°œì¸)</b>ë¥¼ ì°¾ìœ¼ì„¸ìš”.' 
            : 'ê´€ë¦¬í•  <b>ë‹¨ì²´ ê³„ì •</b>ì„ ì—°ê²°í•˜ì„¸ìš”.';

        container.innerHTML = `
            <div class="alert alert-warning border small mb-3">
                <i class="bi bi-info-circle-fill me-1"></i> ${guideMsg}
            </div>

            <div class="input-group mb-3">
                <input type="text" id="searchConnectInput" class="form-control" placeholder="ì´ë¦„, ì´ë©”ì¼, ì‚¬ì—…ìë²ˆí˜¸">
                <button class="btn btn-dark" onclick="searchTargetMember()">ê²€ìƒ‰</button>
            </div>

            <div id="connectResultArea" class="border rounded p-2 bg-white" style="height: 150px; overflow-y: auto;">
                <p class="text-center text-muted small py-4">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            </div>
        `;
    }
}

   // [ì‹ ê·œ] ì—°ê²° í•´ì œ ë¡œì§ (ê°œì¸/ë‹¨ì²´ ê³µìš©)
async function disconnectRelation(targetId, amIGroup) {
    const confirmMsg = amIGroup 
        ? "ê´€ë¦¬ì ì—°ê²°ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ì œ ìŠ¤ìŠ¤ë¡œ ê³„ì •ì„ ê´€ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤." 
        : "ë‹¨ì²´ ê´€ë¦¬ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";

    // ê¸°ì¡´ showConfirmModal ì‚¬ìš©
    showConfirmModal(confirmMsg, async () => {
        showLoading(true, 'í•´ì œ ì²˜ë¦¬ ì¤‘...');
        
        let error = null;

        if (amIGroup) {
            // [ë‹¨ì²´ ì…ì¥] ë‚´ ë¨¸ë¦¬ ìœ„ì˜ manager_id ì‚­ì œ
            // (RLS ì •ì±…ì— ë”°ë¼ ìê¸° ìì‹  ì—…ë°ì´íŠ¸ëŠ” ë³´í†µ í—ˆìš©ë¨)
            const { error: err } = await _supabase.from('coop_members')
                .update({ manager_id: null })
                .eq('id', curAuth.id); // ë‚´ ID ê¸°ì¤€
            error = err;
        } else {
            // [ê°œì¸ ì…ì¥] ë‚´ê°€ ê´€ë¦¬í•˜ë˜ ë‹¨ì²´ì˜ manager_id ì‚­ì œ
            const { error: err } = await _supabase.from('coop_members')
                .update({ manager_id: null })
                .eq('id', targetId); // ë‹¨ì²´ì˜ UUID ê¸°ì¤€
            error = err;
        }

        showLoading(false);

        if (error) {
            showModal('í•´ì œ ì‹¤íŒ¨: ' + error.message);
        } else {
            showModal('ì—°ê²°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            document.getElementById('familyModalOverlay').style.display = 'none'; // ëª¨ë‹¬ ë‹«ê¸°
            
            // ë°ì´í„° ê°±ì‹  (ëŒ€ì‹œë³´ë“œ ë° í”„ë¡œí•„ ëª©ë¡)
            await loadDashboardData(curAuth.id);
            if (typeof loadManagedProfiles === 'function') {
                await loadManagedProfiles(curAuth.id);
            }
        }
    });
}
   
// 2. íƒ­ ì „í™˜
function switchFamTab(tabName) {
    const tabNew = document.getElementById('famTabNew');
    const tabConn = document.getElementById('famTabConnect');
    const btns = document.querySelectorAll('#famModalTabs .nav-link');

    if(tabName === 'new') {
        tabNew.classList.remove('hidden');
        tabConn.classList.add('hidden');
        btns[0].classList.add('active');
        btns[1].classList.remove('active');
    } else {
        tabNew.classList.add('hidden');
        tabConn.classList.remove('hidden');
        btns[0].classList.remove('active');
        btns[1].classList.add('active');
    }
}

// [ìˆ˜ì •] 1ì°¨ ê²€ì¦ ë° ë™ì˜ì„œ ëª¨ë‹¬ í˜¸ì¶œ
function submitNewChild() {
    // 1. ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
    const name = document.getElementById('newFamName').value;
    const rrn1 = document.getElementById('newFamRrn1').value;
    const rrn2 = document.getElementById('newFamRrn2').value;
    const capitalStr = document.getElementById('newFamCapital').value;
    const capital = Number(capitalStr);
    
    // ê´€ê³„ ê°’ ê²°ì •
    const relSelect = document.getElementById('newFamRelSelect').value;
    const relInput = document.getElementById('newFamRelInput').value.trim();
    const relationship = (relSelect === 'ì§ì ‘ì…ë ¥') ? relInput : relSelect;

    // 2. [ê²€ì¦] í•„ìˆ˜ ì…ë ¥
    if(!name || rrn1.length !== 6 || rrn2.length < 1 || !relationship) {
        return showModal('í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    }

    // 3. [ê²€ì¦] ë¯¸ì„±ë…„ì ì—¬ë¶€
    if (!isMinor(rrn1, rrn2)) {
        return showModal('ê°€ì¡±(ìë…€) ì‹ ê·œ ë“±ë¡ì€\në¯¸ì„±ë…„ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    }

    // 4. [ê²€ì¦] ì¶œìê¸ˆ (10ë§Œì› ì´ìƒ & 1ë§Œì› ë‹¨ìœ„)
    if (capital < 100000) {
        return showModal('ì´ˆê¸° ì¶œìê¸ˆì€ ìµœì†Œ 100,000ì› ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
    }
    if (capital % 10000 !== 0) {
        return showModal('ì¶œìê¸ˆì€ 1ë§Œì› ë‹¨ìœ„ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    }

    // 5. ë™ì˜ì„œ ëª¨ë‹¬ ë„ìš°ê¸° (ë°ì´í„° ì „ë‹¬)
    openConsentModal({
        name, rrn1, rrn2, capital, relationship,
        bank: document.getElementById('newFamBank').value,
        acc: document.getElementById('newFamAcc').value
    });
}

// 4. [íƒ­2] ì—°ê²° ëŒ€ìƒ ê²€ìƒ‰
// [ìˆ˜ì •] ì—°ê²° ëŒ€ìƒ ê²€ìƒ‰ (RPC ì‚¬ìš©, ë¬¸ë²• ì—ëŸ¬ ìˆ˜ì •ë¨)
async function searchTargetMember() {
    const keyword = document.getElementById('searchConnectInput').value.trim();
    if(keyword.length < 2) return showModal('ê²€ìƒ‰ì–´ë¥¼ 2ê¸€ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.');

    const area = document.getElementById('connectResultArea');
    area.innerHTML = '<p class="text-center text-muted small py-3">ê²€ìƒ‰ ì¤‘...</p>';

    // 1. RPC í˜¸ì¶œ (ì²´ì´ë‹ ì—†ì´ ë‹¨ë… ì‹¤í–‰)
    const { data: list, error } = await _supabase.rpc('search_profiles_for_connect', { keyword: keyword });

    if (error) {
        console.error(error);
        area.innerHTML = '<p class="text-center text-danger small py-3">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
        return;
    }

    area.innerHTML = '';
    
    // 2. ë‚˜ ìì‹  ì œì™¸ í•„í„°ë§ (JSì—ì„œ ì²˜ë¦¬)
    // (curMemì´ ë¡œë“œëœ ìƒíƒœì—¬ì•¼ í•¨)
    const myId = curMem ? curMem.id : null;
    const filteredList = list ? list.filter(m => m.id !== myId) : [];

    if(filteredList.length === 0) {
        area.innerHTML = '<p class="text-center text-muted small py-3">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }

    let html = '<ul class="list-group list-group-flush small">';
    filteredList.forEach(m => {
        const typeBadge = m.member_type === 'ë‹¨ì²´' ? '<span class="badge bg-info">ë‹¨ì²´</span>' : '<span class="badge bg-secondary">ê°œì¸</span>';
        // ì´ë©”ì¼ ë§ˆìŠ¤í‚¹ (ì„ íƒ ì‚¬í•­)
        const emailDisplay = m.email || 'ì´ë©”ì¼ ì—†ìŒ';
        
        html += `
            <li class="list-group-item d-flex justify-content-between align-items-center p-2">
                <div>
                    ${typeBadge} <b>${m.name}</b>
                    <br><span class="text-muted x-small">${emailDisplay}</span>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="requestConnect('${m.id}', '${m.name}')">
                    ì—°ê²° ì‹ ì²­
                </button>
            </li>`;
    });
    html += '</ul>';
    area.innerHTML = html;
}

// 5. [íƒ­2] ì—°ê²° ì‹ ì²­ (Propose) -> coop_applications í…Œì´ë¸” í™œìš©
// [ìˆ˜ì •] ì—°ê²° ì‹ ì²­ í•¨ìˆ˜ (ëª¨ë‹¬ ë‹«ê¸° -> í™”ë©´ ìŠ¤í¬ë¡¤ -> ì¸ë¼ì¸ ë©”ì‹œì§€ í‘œì‹œ)
async function requestConnect(targetUuid, targetName) {
    
    // confirm ëª¨ë‹¬ì€ ìœ ì§€ (ì‚¬ìš©ì ì‹¤ìˆ˜ ë°©ì§€)
    showConfirmModal(`'${targetName}' ë‹˜ê³¼ ì—°ê²°ì„ ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async () => {
        showLoading(true);

        const { error } = await _supabase.from('coop_applications').insert({
            member_uid: curAuth.id,
            member_id: curMem.member_id,
            name: curMem.name,
            type: 'connect', 
            reason: `Target: ${targetUuid}`,
            amount: 0,
            status: 'pending'
        });

        showLoading(false);

        if(error) {
            showModal('ì‹ ì²­ ì‹¤íŒ¨: ' + error.message);
        } else {
            // 1. ê°€ì¡± ëª¨ë‹¬ ì¦‰ì‹œ ë‹«ê¸°
            document.getElementById('familyModalOverlay').style.display = 'none';
            
            // 2. ë°ì´í„° ê°±ì‹  (ë¹„ë™ê¸°)
            await loadDashboardData(curAuth.id);

            // 3. [UX] ì‹ ì²­ì„œ ì˜ì—­ìœ¼ë¡œ ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤ ì´ë™
            const actionArea = document.getElementById('actionArea');
            actionArea.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // 4. [UX] ì‹ ì²­ì„œ ìƒë‹¨ì— ì„±ê³µ ë©”ì‹œì§€ ê½‚ê¸° (Alert ì•„ë‹˜)
            showInlineFeedback(`âœ… '${targetName}' ë‹˜ì—ê²Œ ì—°ê²° ì‹ ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.`);
        }
    });
}

// [ì‹ ê·œ] ì¸ë¼ì¸ í”¼ë“œë°± ë©”ì‹œì§€ (ì•ŒëŸ¿ ì•„ë‹˜, ë””ìì¸ëœ ë°•ìŠ¤)
function showInlineFeedback(msg) {
    const area = document.getElementById('actionArea');
    
    // ê¸°ì¡´ì— ë– ìˆëŠ” ë©”ì‹œì§€ê°€ ìˆë‹¤ë©´ ì œê±° (ì¤‘ë³µ ë°©ì§€)
    const oldMsg = document.getElementById('tempFeedbackMsg');
    if(oldMsg) oldMsg.remove();

    // ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ë°•ìŠ¤ ìƒì„±
    const div = document.createElement('div');
    div.id = 'tempFeedbackMsg';
    // ìŠ¤íƒ€ì¼: ì—°í•œ ì´ˆë¡ ë°°ê²½, ì§™ì€ ì´ˆë¡ ê¸€ì”¨, ê¹”ë”í•œ í…Œë‘ë¦¬
    div.style.cssText = `
        background-color: #f1f8e9; 
        color: #2e7d32; 
        padding: 15px; 
        border-radius: 8px; 
        margin-bottom: 20px; 
        font-weight: 600; 
        text-align: center; 
        border: 1px solid #c5e1a5;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        animation: fadeIn 0.5s;
    `;
    div.innerHTML = msg;

    // actionAreaì˜ ìµœìƒë‹¨(ì²«ë²ˆì§¸ ìì‹)ìœ¼ë¡œ ì‚½ì…
    area.prepend(div);

    // 4ì´ˆ í›„ ìë™ ì‚­ì œ (Fade out íš¨ê³¼ê°€ í•„ìš”í•˜ë©´ CSS ì¶”ê°€ í•„ìš”í•˜ì§€ë§Œ, ê¸°ëŠ¥ì ìœ¼ë¡œëŠ” ì œê±°ê°€ í™•ì‹¤í•¨)
    setTimeout(() => {
        if(div) div.remove();
    }, 4000);
}

    async function loadFamilyList(managerUid) {
        // manager_idê°€ ë‚´ UUIDì¸ ë©¤ë²„ ì¡°íšŒ
        const { data: fams } = await _supabase
            .from('coop_members')
            .select('*')
            .eq('manager_id', managerUid);
        
        const area = document.getElementById('familyListArea');
        if(!fams || fams.length === 0) {
            area.innerHTML = '<p class="text-muted small text-center py-3">ë“±ë¡ëœ êµ¬ì„±ì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        let html = '<ul class="list-group list-group-flush">';
        fams.forEach(f => {
            html += `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <span class="fw-bold">${f.name}</span>
                    <small class="text-muted ms-2">${f.member_id || 'ìŠ¹ì¸ ëŒ€ê¸°ì¤‘'}</small>
                </div>
                <span class="badge bg-light text-dark border">${f.join_category}</span>
            </li>`;
        });
        html += '</ul>';
        area.innerHTML = html;
    }

    async function submitFamily() {
        const name = document.getElementById('famName').value;
        const rrn1 = document.getElementById('famRrn1').value;
        const rrn2 = document.getElementById('famRrn2').value;
        const phone = document.getElementById('famPhone').value;

        if(!name || rrn1.length !== 6 || rrn2.length !== 1) return showModal('ì •ë³´ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');

        showConfirmModal(`${name}ë‹˜ì„ êµ¬ì„±ì›ìœ¼ë¡œ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async () => {
            showLoading(true);
            
            // ë¶€ëª¨ ì •ë³´ ë³µì‚¬ + í•„ìˆ˜ê°’ ì„¤ì •
            const { error } = await _supabase.from('coop_members').insert({
                manager_id: curAuth.id, // ë¶€ëª¨ UUID ì—°ê²°
                name: name,
                rrn_display: `${rrn1}-${rrn2}******`, // ë§ˆìŠ¤í‚¹ ì €ì¥
                phone: phone,
                address: curMem.address, // ì£¼ì†ŒëŠ” ë¶€ëª¨ì™€ ë™ì¼í•˜ë‹¤ê³  ê°€ì •
                join_category: 'ê°€ì¡±', // ë˜ëŠ” ë‹¨ì²´ë©´ 'ì§ì›' (UIì—ì„œ ì„ íƒí•˜ê²Œ í•˜ê±°ë‚˜ ìë™ì²˜ë¦¬)
                status: 'active' // ì¦‰ì‹œ í™œì„±í™” (ë˜ëŠ” pending)
            });

            showLoading(false);
            if(error) showModal('ë“±ë¡ ì‹¤íŒ¨: ' + error.message);
            else {
                showModal('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                document.getElementById('familyModalOverlay').style.display = 'none';
                loadFamilyList(curAuth.id);
            }
        });
    }


// ==========================================
    // [ê²Œì‹œíŒ ë¡œì§] ê³µì§€ì‚¬í•­(Notices) vs ê²Œì‹œíŒ(Boards) ë¶„ê¸° ì²˜ë¦¬
    // ==========================================
    let currentBoardCat = 'notice';

// [ìˆ˜ì • 4] ê²Œì‹œíŒ ë¡œë“œ: ì—†ëŠ” ì¹¼ëŸ¼(status) ì°¸ì¡° ì œê±°ë¡œ 400 ì—ëŸ¬ í•´ê²°
async function loadBoard(category, btn, limit = 20) {
    if (limit === 20) currentBoardLimit = 20;
    
    currentBoardCat = category;
    if(btn) {
        document.querySelectorAll('.board-tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    // ê³µì§€ì‚¬í•­ ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
    if(category === 'notice' && !btn) {
        if(typeof openNoticeListModal === 'function') openNoticeListModal();
        return;
    }

    const btnWrite = document.getElementById('btnWritePost');
    if(btnWrite) btnWrite.classList.toggle('hidden', category === 'notice');

    const listArea = document.getElementById('boardList');
    if(limit === 20) listArea.innerHTML = '<div class="text-center py-5 text-muted">ë¡œë”©ì¤‘...</div>';

    // ë°ì´í„° ì¡°íšŒ
    const tableName = (category === 'notice') ? 'coop_notices' : 'coop_boards';
    
    // [í•µì‹¬ ìˆ˜ì •] .eq('status', 'published') ì‚­ì œë¨ -> ëª¨ë“  ê¸€ ì¡°íšŒ
    const { data: posts, error } = await _supabase
        .from(tableName)
        .select('*')
        .order('created_at', { ascending: false })
        .range(0, limit - 1);

    if(error || !posts || posts.length === 0) {
        if (error) console.error("ê²Œì‹œíŒ ë¡œë“œ ì‹¤íŒ¨:", error); // ë””ë²„ê¹…ìš© ë¡œê·¸
        if(limit === 20) listArea.innerHTML = '<div class="text-center py-5 text-muted">ë“±ë¡ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    let html = '';
    posts.forEach(p => {
        const date = p.created_at.substring(0,10);
        // HTML íƒœê·¸ ì œê±° (ë³´ì•ˆ)
        const rawContent = p.content || '';
        const safeContent = rawContent.replace(/<[^>]*>?/gm, '');

        html += `
        <div class="board-list-item p-3 border-bottom" onclick="viewPost(${p.id}, '${category}')" style="cursor:pointer;">
            <div class="d-flex justify-content-between">
                <span class="fw-bold text-dark text-truncate">${p.title}</span>
                <small class="text-muted">${date}</small>
            </div>
            <div class="small text-secondary text-truncate mt-1">${safeContent}</div>
        </div>`;
    });

    html += `<div class="text-center py-3">
                <button class="btn btn-sm btn-outline-secondary rounded-pill px-4" onclick="loadMoreBoard()">ë” ë³´ê¸° (+20)</button>
             </div>`;
             
    listArea.innerHTML = html;
}

// [ì‹ ê·œ] ë”ë³´ê¸° ì‹¤í–‰ í•¨ìˆ˜
function loadMoreBoard() {
    currentBoardLimit += 20;
    // í˜„ì¬ ì¹´í…Œê³ ë¦¬ ìœ ì§€í•˜ë©° ê°¯ìˆ˜ë§Œ ëŠ˜ë¦¼
    loadBoard(currentBoardCat, null, currentBoardLimit);
}



    // [ê¸€ì“°ê¸°] ëª¨ë‹¬ ì—´ê¸°
    function openWriteModal() {
        document.getElementById('writeTitle').value = '';
        document.getElementById('writeContent').value = '';
        document.getElementById('writeFile').value = '';
        document.getElementById('writeModalOverlay').style.display = 'flex';
    }

    // [ê¸€ì“°ê¸°] ë“±ë¡ (ììœ /ì„ì› ê²Œì‹œíŒìš©)
    async function submitPost() {
        const title = document.getElementById('writeTitle').value;
        const content = document.getElementById('writeContent').value;
        const fileUrl = document.getElementById('writeFile').value; // ì„ì‹œ íŒŒì¼ URL ì…ë ¥

        if(!title || !content) return showModal('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

        showConfirmModal('ê²Œì‹œê¸€ì„ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async () => {
            showLoading(true);
            
            // íŒŒì¼ ë°°ì—´ ì²˜ë¦¬
            const files = fileUrl ? [fileUrl] : [];

            const { error } = await _supabase.from('coop_boards').insert({
                category: currentBoardCat, // í˜„ì¬ ë³´ê³  ìˆëŠ” íƒ­ì˜ ì¹´í…Œê³ ë¦¬ (free, executive ë“±)
                title: title,
                content: content,
                files: files,
                author_name: curMem.name // ì‘ì„±ì ì´ë¦„ ê¸°ë¡
            });

            showLoading(false);
            if(error) showModal('ë“±ë¡ ì‹¤íŒ¨: ' + error.message);
            else {
                showModal('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                document.getElementById('writeModalOverlay').style.display = 'none';
                loadBoard(currentBoardCat); // ëª©ë¡ ê°±ì‹ 
            }
        });
    }

    // [ê¸€ë³´ê¸°] ìƒì„¸ ì¡°íšŒ (í…Œì´ë¸” ë¶„ê¸° ì²˜ë¦¬ í¬í•¨)
// [ê¸€ë³´ê¸°] ìƒì„¸ ì¡°íšŒ ë° ë²„íŠ¼ ê¶Œí•œ ì²˜ë¦¬
// [ìˆ˜ì •] ê²Œì‹œê¸€ ìƒì„¸ ë³´ê¸° í•¨ìˆ˜ (ì˜¤ë¥˜ ë°©ì§€ ë° ê¶Œí•œ ì²˜ë¦¬ ê°•í™”)
async function viewPost(id, category) {
    const tableName = (category === 'notice') ? 'coop_notices' : 'coop_boards';
    
    // 1. ì¡°íšŒ
    const { data: post, error } = await _supabase.from(tableName).select('*').eq('id', id).single();
    if(error || !post) return showModal('ê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');

    // 2. ë°”ì¸ë”© (ì•ˆì „í•˜ê²Œ ID í™•ì¸)
      
    setText('viewTitle', post.title);
    setText('viewAuthor', post.author_name || 'ìµëª…');
    setText('viewDate', post.created_at ? post.created_at.substring(0,16).replace('T', ' ') : '-');
    setText('viewContent', post.content || '');

    // 3. ì²¨ë¶€íŒŒì¼
    const files = post.file_urls || post.files || [];
    const fileArea = document.getElementById('viewFiles');
    if(fileArea) {
        fileArea.innerHTML = '';
        files.forEach((f, i) => {
            fileArea.innerHTML += `<a href="${f}" target="_blank" class="btn btn-sm btn-outline-primary me-2"><i class="bi bi-download"></i> íŒŒì¼ ${i+1}</a>`;
        });
    }

    // 4. ë²„íŠ¼ ê¶Œí•œ (ì‘ì„±ì í™•ì¸)
    const writerId = post.author_id; // â˜… DB ì¹¼ëŸ¼ í™•ì¸ í•„ìš” (author_id)
    const isMine = (curAuth && writerId && curAuth.id === writerId);
    
    // í˜„ì¬ ë³´ê³  ìˆëŠ” ê¸€ ID ì „ì—­ ì €ì¥ (ì‹ ê³ /ì‚­ì œìš©)
    window.currentPostId = id; 

    const btnGroup = document.getElementById('viewBtnGroup');
    if(btnGroup) {
        let html = `<button class="btn btn-dark btn-sm" onclick="document.getElementById('boardViewModal').style.display='none'">ë‹«ê¸°</button>`;
        
        // ê³µì§€ì‚¬í•­ ì•„ë‹ˆê³  ë‚´ ê¸€ì´ë©´ ìˆ˜ì •/ì‚­ì œ ë…¸ì¶œ
        if(category !== 'notice' && isMine) {
            html = `
                <button class="btn btn-warning btn-sm me-1" onclick="showModal('ìˆ˜ì • ì¤€ë¹„ì¤‘')">ìˆ˜ì •</button>
                <button class="btn btn-danger btn-sm me-1" onclick="deletePost('${post.id}')">ì‚­ì œ</button>
                ${html}
            `;
        }
        btnGroup.innerHTML = html;
    }

    // 5. ëª¨ë‹¬ ì—´ê¸°
    document.getElementById('boardViewModal').style.display = 'flex';
}

// [ì‹ ê·œ] ê²Œì‹œê¸€ ì‹ ê³  í•¨ìˆ˜
function reportPost() {
    showConfirmModal('ì´ ê²Œì‹œê¸€ì„ ê´€ë¦¬ìì—ê²Œ ì‹ ê³ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
        // ì‹¤ì œ DB ë¡œì§ì€ ì¶”í›„ êµ¬í˜„ (í˜„ì¬ëŠ” UIë§Œ ì‘ë™)
        showModal('ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nê´€ë¦¬ìê°€ ê²€í†  í›„ ì¡°ì¹˜í•©ë‹ˆë‹¤.');
        document.getElementById('boardViewModal').style.display = 'none';
    });
}
   // ==========================================
// [ì‹ ê·œ ê¸°ëŠ¥] í”„ë¡œí•„ ì „í™˜ (Context Switching)
// ==========================================

// 1. ê´€ë¦¬ ê°€ëŠ¥í•œ í”„ë¡œí•„ ëª©ë¡ ë¡œë“œ ë° UI ìƒì„±
// [ë””ë²„ê¹…ìš©] ê´€ë¦¬ ê°€ëŠ¥í•œ í”„ë¡œí•„ ëª©ë¡ ë¡œë“œ ë° UI ìƒì„±
async function loadManagedProfiles(myAuthId) {
    const switcher = document.getElementById('profileSwitcher');
    const menu = document.getElementById('profileListMenu');
    
    console.log("ğŸ” [Debug] ê´€ë¦¬ í”„ë¡œí•„ ì¡°íšŒ ì‹œì‘. ë‚´ ID:", myAuthId);

    // (1) ë³¸ì¸ ê³„ì • ì •ë³´
    const { data: me, error: errMe } = await _supabase.from('coop_members').select('id, name, member_type').eq('id', myAuthId).single();
    if(errMe) console.error("âŒ ë‚´ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:", errMe);

    // (2) ë‚´ê°€ ê´€ë¦¬ìì¸ ê³„ì •ë“¤ ê°€ì ¸ì˜¤ê¸° (manager_idê°€ ë‚˜ì¸ ê²½ìš°)
    const { data: subProfiles, error: errSub } = await _supabase
        .from('coop_members')
        .select('id, name, member_type')
        .eq('manager_id', myAuthId); // â˜… ì—¬ê¸°ê°€ í•µì‹¬

    if(errSub) console.error("âŒ ì„œë¸Œ ê³„ì • ì¡°íšŒ ì—ëŸ¬:", errSub);
    console.log("ğŸ” [Debug] ì¡°íšŒëœ ê´€ë¦¬ ê³„ì • ê°œìˆ˜:", subProfiles ? subProfiles.length : 0);

    // ê´€ë¦¬í•  ê³„ì •ì´ ì—†ìœ¼ë©´ ìŠ¤ìœ„ì²˜ ìˆ¨ê¹€ (ì—¬ê¸°ì— ê±¸ë¦¬ëŠ”ì§€ í™•ì¸ í•„ìš”)
    if (!subProfiles || subProfiles.length === 0) {
        console.warn("âš ï¸ ê´€ë¦¬í•  ê³„ì •ì´ 0ê°œë¼ ë“œë¡­ë‹¤ìš´ì„ ìˆ¨ê¹ë‹ˆë‹¤.");
        switcher.classList.add('hidden');
        return;
    }

    // (3) ë¦¬ìŠ¤íŠ¸ ë§Œë“¤ê¸°
    menu.innerHTML = '';
    const allProfiles = [me, ...subProfiles]; 

    allProfiles.forEach(p => {
        if(!p) return;
        const isMe = p.id === myAuthId;
        const badge = p.member_type === 'ë‹¨ì²´' ? '<span class="badge bg-info ms-1">ë‹¨ì²´</span>' : '';
        const activeClass = (curMem && curMem.id === p.id) ? 'active' : ''; 

        menu.innerHTML += `
            <li>
                <button class="dropdown-item d-flex justify-content-between align-items-center ${activeClass}" onclick="switchProfile('${p.id}', '${p.name}')">
                    <span>${p.name} ${isMe ? '(ë‚˜)' : ''}</span>
                    ${badge}
                </button>
            </li>`;
    });

    // ìŠ¤ìœ„ì²˜ ë…¸ì¶œ (hidden í´ë˜ìŠ¤ ì œê±°)
    console.log("âœ… ë“œë¡­ë‹¤ìš´ ë©”ë‰´ í™œì„±í™” ì™„ë£Œ");
    switcher.classList.remove('hidden');
}

// 2. í”„ë¡œí•„ ì „í™˜ ì‹¤í–‰
async function switchProfile(targetUuid, targetName) {
    if(curMem && curMem.id === targetUuid) return; // ì´ë¯¸ ì„ íƒëœ í”„ë¡œí•„ì´ë©´ ë¬´ì‹œ

    showLoading(true, `${targetName} ë‹˜ìœ¼ë¡œ ì „í™˜ ì¤‘...`);
    
    // â˜… í•µì‹¬: ë¡œê·¸ì•„ì›ƒ ì—†ì´, ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ë§Œ ëŒ€ìƒ UUIDë¡œ ë‹¤ì‹œ í˜¸ì¶œ
    // curAuth(ë¡œê·¸ì¸ëœ ì •ë³´)ëŠ” ìœ ì§€ë˜ê³ , curMem(í™”ë©´ ë°ì´í„°)ë§Œ êµì²´ë¨
    await loadDashboardData(targetUuid);
    
    // ìŠ¤ìœ„ì²˜ UI ë‹¤ì‹œ ê·¸ë¦¬ê¸° (Active ìƒíƒœ ë³€ê²½ì„ ìœ„í•´)
    await loadManagedProfiles(curAuth.id);
    
    showModal(`'${targetName}' ê³„ì •ìœ¼ë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nì´ì œ ì´ ëª…ì˜ë¡œ í™œë™í•©ë‹ˆë‹¤.`);
}
   // [ì¶”ê°€] ì‚­ì œ í•¨ìˆ˜
async function deletePost(id) {
    showConfirmModal('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async () => {
        const { error } = await _supabase.from('coop_boards').delete().eq('id', id);
        if(error) showModal('ì‚­ì œ ì‹¤íŒ¨');
        else {
            showModal('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            document.getElementById('boardViewModal').style.display = 'none';
            loadBoard(currentBoardCat); // ëª©ë¡ ê°±ì‹ 
        }
    });
}
   // [ì‹ ê·œ] ìƒë‹¨ ë¯¸ë‹ˆ ê³µì§€ì‚¬í•­ ë¡œë“œ
async function loadMiniNotices() {
    const listArea = document.getElementById('miniNoticeList');
    try {
        const { data: notices, error } = await _supabase
            .from('coop_notices')
            .select('id, title, created_at')
            .order('created_at', { ascending: false })
            .limit(3); // 3ê°œë§Œ

        if (error) throw error;
        
        if (!notices || notices.length === 0) {
            listArea.innerHTML = '<p class="text-center text-muted small py-3">ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        let html = '';
        notices.forEach(n => {
            const date = n.created_at.substring(5, 10); // MM-DD
            html += `
                <div class="notice-mini-item d-flex justify-content-between" onclick="viewPost(${n.id}, 'notice')">
                    <span class="text-truncate" style="max-width: 70%;">${n.title}</span>
                    <span class="text-muted small">${date}</span>
                </div>`;
        });
        listArea.innerHTML = html;
    } catch (e) {
        console.error(e);
        listArea.innerHTML = '<p class="text-center text-danger small">ë¡œë“œ ì‹¤íŒ¨</p>';
    }
}
   // [ì‹ ê·œ] ë‚˜ì—ê²Œ ì˜¨ ì—°ê²° ìš”ì²­ í™•ì¸ ë° ë Œë”ë§
async function checkIncomingConnects() {
    // 1. RPC í˜¸ì¶œ (Step 1ì—ì„œ ìˆ˜ì •í•œ í•¨ìˆ˜)
    const { data: requests, error } = await _supabase.rpc('get_my_pending_connects');
    
    // 2. ì—ëŸ¬ ë° ë°ì´í„° ì²´í¬
    if (error) {
        console.error("ì—°ê²° ìš”ì²­ ì¡°íšŒ ì‹¤íŒ¨:", error);
        return;
    }
    // requestsê°€ nullì´ê±°ë‚˜ ë¹ˆ ë°°ì—´ì´ë©´ ì¢…ë£Œ
    if (!requests || requests.length === 0) return;

    // 3. ì•Œë¦¼ UI ìƒì„±
    const container = document.getElementById('dashboardSection');
    const existingAlert = document.getElementById('connectRequestAlert');
    if(existingAlert) existingAlert.remove();

    const alertDiv = document.createElement('div');
    alertDiv.id = 'connectRequestAlert';
    alertDiv.className = 'alert alert-primary border-primary d-flex flex-column gap-2 mb-4 shadow-sm';
    alertDiv.style.backgroundColor = '#e3f2fd';

    let html = `<div class="d-flex align-items-center text-primary fw-bold">
                    <i class="bi bi-link-45deg fs-3 me-2"></i>
                    ê³„ì • ì—°ê²° ìš”ì²­ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤!
                </div>`;

    // JSON ë°°ì—´ ìˆœíšŒ
    requests.forEach(req => {
        html += `
            <div class="bg-white p-3 rounded border d-flex justify-content-between align-items-center mt-2">
                <div>
                    <span class="fw-bold text-dark">${req.requester_name}</span> ë‹˜ì´
                    <br><small class="text-muted">ë‚´ ê³„ì •ì„ ê´€ë¦¬í•˜ê¸¸ ì›í•©ë‹ˆë‹¤.</small>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-danger" onclick="answerConnect(${req.app_id}, 'reject')">ê±°ì ˆ</button>
                    <button class="btn btn-sm btn-primary fw-bold" onclick="answerConnect(${req.app_id}, 'approve')">ìˆ˜ë½</button>
                </div>
            </div>`;
    });

    alertDiv.innerHTML = html;

    // 4. ì‚½ì… ìœ„ì¹˜: ìƒì¼ ë°°ë„ˆ ë‹¤ìŒ
    const banner = document.getElementById('birthdayBanner');
    if(banner && banner.nextSibling) {
        container.insertBefore(alertDiv, banner.nextSibling);
    } else {
        container.prepend(alertDiv);
    }
}

// [ì‹ ê·œ] ì—°ê²° ìš”ì²­ ì‘ë‹µ (ìˆ˜ë½/ê±°ì ˆ)
// [ìˆ˜ì •] ì—°ê²° ìš”ì²­ ì‘ë‹µ
async function answerConnect(appId, decision) {
    const actionText = (decision === 'approve') ? 'ìˆ˜ë½' : 'ê±°ì ˆ';
    
    // ëª¨ë‹¬ ëìŠ¤ íš¨ê³¼ ì ìš©
    setModalDepth(true); 

    showConfirmModal(`ì •ë§ ${actionText}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async () => {
        showLoading(true);
        const { error } = await _supabase.rpc('answer_connect_request', {
            p_app_id: appId, p_decision: decision
        });
        showLoading(false);

        if (error) showModal('ì˜¤ë¥˜: ' + error.message);
        else {
            showModal(`${actionText}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            
            // â˜… 1ë²ˆ í•´ê²°: ìŠ¹ì¸í–ˆë‹¤ë©´ ë‚´ê°€ ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” í”„ë¡œí•„ ëª©ë¡ì„ ê°±ì‹ í•´ì•¼ í•¨
            if(decision === 'approve') {
                await loadManagedProfiles(curAuth.id);
            }
            
            // ì•Œë¦¼ ì œê±° ë° ë°ì´í„° ê°±ì‹ 
            loadDashboardData(curAuth.id); 
            const alertDiv = document.getElementById('connectRequestAlert');
            if(alertDiv) alertDiv.remove();
        }
        setModalDepth(false); // ëìŠ¤ ë³µêµ¬
    });
}
// [ìˆ˜ì •] í™”ë©´ ì „í™˜ ìœ í‹¸ë¦¬í‹°: style ì œì–´ ë°©ì‹ íê¸° -> classList ì œì–´ ë°©ì‹ ë„ì…
function showOnly(sectionId) {
    // ì œì–´í•  ëŒ€ìƒ ì„¹ì…˜ ID ëª©ë¡ (ëª…ì‹œì ìœ¼ë¡œ ì§€ì •í•˜ì—¬ ì•ˆì „ì„± í™•ë³´)
    const sections = ['loginSection', 'dashboardSection'];

    sections.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;

        if (id === sectionId) {
            // [í•µì‹¬] !importantê°€ ê±¸ë¦° hidden í´ë˜ìŠ¤ë¥¼ 'ì œê±°'í•´ì•¼ë§Œ í™”ë©´ì´ ë³´ì„
            el.classList.remove('hidden'); 
        } else {
            // ë³´ì´ë©´ ì•ˆ ë˜ëŠ” ì„¹ì…˜ì€ hidden í´ë˜ìŠ¤ 'ì¶”ê°€'
            el.classList.add('hidden');
        }
    });
}
   // [ì‹ ê·œ] ì¡°í•©ì› ìƒíƒœ ë°°ì§€ ë Œë”ë§ (ë…¸ì¶œë§Œ)
// [ì‹ ê·œ] ì¡°í•©ì› ìƒíƒœ ë°°ì§€ ë Œë”ë§ (ë…¸ì¶œë§Œ)
function renderMemberStatusBadge(statusRaw) {
    const el = document.getElementById('memberStatusBadge');
    if (!el) return;

    const raw = (statusRaw || '').toString().trim();
    const lower = raw.toLowerCase();

    // í‘œì‹œ í…ìŠ¤íŠ¸(ì˜ë¬¸/ë‚´ë¶€ê°’ì´ ì™€ë„ í•œêµ­ì–´ë¡œ ë³´ì´ê²Œ)
    let label = raw || 'ë¯¸ì„¤ì •';

    // ìƒ‰ìƒ í´ë˜ìŠ¤
    let cls = 'badge rounded-pill bg-secondary';

    // ì •ìƒ(íŒŒë‘)
    if (raw === 'ì •ìƒ' || lower === 'active' || lower === 'normal') {
        cls = 'badge rounded-pill bg-primary';
        label = 'ì •ìƒ';
    }
    // ìŠ¹ì¸ëŒ€ê¸°(ë…¸ë‘)
    else if (raw === 'ìŠ¹ì¸ëŒ€ê¸°' || lower === 'pending' || lower === 'approval_pending' || lower === 'waiting') {
        cls = 'badge rounded-pill bg-warning text-dark';
        label = 'ìŠ¹ì¸ëŒ€ê¸°';
    }
    // íƒˆí‡´/ì œëª…(ë¹¨ê°•)
    else if (raw === 'íƒˆí‡´' || raw === 'ì œëª…' || lower === 'withdrawn' || lower === 'expelled' || lower === 'removed') {
        cls = 'badge rounded-pill bg-danger';
        label = (raw === 'ì œëª…' || lower === 'expelled' || lower === 'removed') ? 'ì œëª…' : 'íƒˆí‡´';
    }

    el.className = cls;
    el.innerText = label;
}

// [ì‹ ê·œ] ê´€ê³„ 'ì§ì ‘ì…ë ¥' ì„ íƒ ì‹œ ì…ë ¥ì°½ í† ê¸€
function toggleFamilyRelationInput() {
    const select = document.getElementById('newFamRelSelect');
    const input = document.getElementById('newFamRelInput');
    
    if (select.value === 'ì§ì ‘ì…ë ¥') {
        input.classList.remove('hidden');
        input.focus();
    } else {
        input.classList.add('hidden');
        input.value = ''; // ê°’ ì´ˆê¸°í™”
    }
}

// [ì‹ ê·œ] ë¯¸ì„±ë…„ì íŒë³„ ë¡œì§ (ë§Œ 19ì„¸ ë¯¸ë§Œ = true)
function isMinor(rrn1, rrn2Char) {
    if(!rrn1 || !rrn2Char) return false;
    
    const yy = parseInt(rrn1.substring(0, 2));
    const mm = parseInt(rrn1.substring(2, 4)) - 1; // ì›”(0~11)
    const dd = parseInt(rrn1.substring(4, 6));
    const gender = parseInt(rrn2Char.substring(0, 1));

    let fullYear;
    // 1900ë…„ëŒ€: 1, 2, 5, 6 / 2000ë…„ëŒ€: 3, 4, 7, 8
    if ([1, 2, 5, 6].includes(gender)) fullYear = 1900 + yy;
    else if ([3, 4, 7, 8].includes(gender)) fullYear = 2000 + yy;
    else return false; // ì„±ë³„ì½”ë“œ ì˜¤ë¥˜ ì‹œ false ì²˜ë¦¬

    const birthDate = new Date(fullYear, mm, dd);
    const today = new Date();
    
    // ë§Œ ë‚˜ì´ ê³„ì‚°
    let age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }

    return age < 19; 
}

// [ì‹ ê·œ] ë™ì˜ì„œ ëª¨ë‹¬ ì—´ê¸° & ìµœì¢… ê°€ì… ì²˜ë¦¬
let tempChildData = null; // ë°ì´í„°ë¥¼ ì ì‹œ ë‹´ì•„ë‘˜ ë³€ìˆ˜

function openConsentModal(data) {
    tempChildData = data; // ë°ì´í„° ì„ì‹œ ì €ì¥
    
    // ëª¨ë‹¬ ë‚´ìš© ìƒì„± (PDF í…ìŠ¤íŠ¸ + ì²´í¬ë°•ìŠ¤)
    // ì²´í¬ë°•ìŠ¤ ë¼ë²¨ì€ ìš”ì²­í•˜ì‹  ëŒ€ë¡œ ê¸¸ê²Œ, ë‚´ìš©ì€ ìˆ˜ì •í•´ì„œ ì“°ì‹œë©´ ë©ë‹ˆë‹¤.
    const content = `
        <div class="text-start bg-light p-3 rounded border mb-3" style="max-height: 300px; overflow-y: auto; font-size: 0.9rem; line-height: 1.6;">
            <h6 class="fw-bold text-center mb-3">[ë¯¸ì„±ë…„ì ì¡°í•©ì› ê°€ì… ë²•ì •ëŒ€ë¦¬ì¸ ë™ì˜ì„œ]</h6>
            
            <p>1. <b>ê°€ì… ë™ì˜:</b> ë³¸ì¸ì€ ì‹ ì²­ì¸(${data.name})ì˜ ë²•ì •ëŒ€ë¦¬ì¸ìœ¼ë¡œì„œ ê·€ í˜‘ë™ì¡°í•© ê°€ì…ì— ë™ì˜í•©ë‹ˆë‹¤.</p>
            <p>2. <b>ë‚´ìš© í™•ì¸:</b> ë³¸ì¸ì€ ì‹ ì²­ì¸ì´ ì¡°í•©ì› ê°€ì…ìœ¼ë¡œ ë°œìƒí•˜ëŠ” ê¶Œë¦¬ì™€ ì˜ë¬´, ì¶œìê¸ˆ ë‚©ì…, ì´ìš©ê³  ë°°ë‹¹, ì†ì‹¤ ë°œìƒ ì‹œ ì±…ì„, ì´íšŒ ì˜ê²°ê¶Œ ë“±ì— ëŒ€í•´ ì˜ ì•Œê³  ìˆìŒì„ í™•ì¸í•©ë‹ˆë‹¤.</p>
            <p>3. <b>ê°œì¸ì •ë³´ í™œìš©:</b> ìœ„ ë™ì˜ì„œì™€ ê´€ë ¨í•´ ì¡°í•©ì— ê°€ì…ë˜ì–´ ìˆì§€ ì•Šì€ ë²•ì •ëŒ€ë¦¬ì¸ì˜ ê°œì¸ì •ë³´ í™œìš©ì— ë™ì˜í•©ë‹ˆë‹¤.</p>
            <hr>
            <p class="small text-muted">ìˆ˜ì§‘ í•­ëª©: ì´ë¦„, ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸, ì „í™”ë²ˆí˜¸, ì´ë©”ì¼, ì£¼ì†Œ, ê´€ê³„<br>ë³´ìœ  ê¸°ê°„: ìˆ˜ì§‘Â·ì´ìš© ëª©ì  ë‹¬ì„± ì‹œê¹Œì§€. ë‹¨, ê´€ë ¨ ë²•ë ¹ì˜ ê·œì •ì— ì˜í•˜ì—¬ ê°œì¸ì •ë³´ë¥¼ ë³´ìœ í•  í•„ìš”ê°€ ìˆëŠ” ê²½ìš°, í•´ë‹¹ ë²•ë ¹ì—ì„œ ì •í•œ ê¸°ê°„ê¹Œì§€.</p>
        </div>
        
        <div class="form-check mb-2 text-start">
            <input class="form-check-input" type="checkbox" id="consentCheck1">
            <label class="form-check-label small fw-bold" for="consentCheck1">
                (í•„ìˆ˜) ìœ„ 1, 2, 3ë²ˆì˜ ë™ì˜ì„œ ë‚´ìš©ì„ ëª¨ë‘ í™•ì¸í•˜ì˜€ìœ¼ë©°, ë²•ì •ëŒ€ë¦¬ì¸ìœ¼ë¡œì„œ ì‹ ì²­ì¸ì˜ ê°€ì…ì— ë™ì˜í•©ë‹ˆë‹¤.
            </label>
        </div>
        <div class="form-check mb-3 text-start">
            <input class="form-check-input" type="checkbox" id="consentCheck2">
            <label class="form-check-label small fw-bold text-primary" for="consentCheck2">
                (í•„ìˆ˜) ì£¼ë¯¼ë“±ë¡ë“±ë³¸ ë° ì‹ ë¶„ì¦ ì‚¬ë³¸ ë“± ì¦ë¹™ ì„œë¥˜ëŠ” ì¶”í›„ ì‚¬ë¬´êµ­ì˜ ìš”ì²­ì´ ìˆì„ ì‹œ ë³„ë„ë¡œ ì œì¶œí•˜ê² ìŠµë‹ˆë‹¤.
            </label>
        </div>
    `;

    // ê¸°ì¡´ ëª¨ë‹¬ ì¬í™œìš©
    const overlay = document.getElementById('customModalOverlay');
    document.getElementById('customModalMsg').innerHTML = content;
    
    // ë²„íŠ¼ ì»¤ìŠ¤í…€
    const btnYes = document.getElementById('btnModalYes');
    const btnNo = document.getElementById('btnModalNo');
    
    btnNo.style.display = 'inline-block';
    btnNo.innerText = 'ì·¨ì†Œ';
    btnNo.onclick = () => { overlay.style.display = 'none'; };

    btnYes.innerText = 'ë™ì˜ ë° ê°€ì…ì™„ë£Œ';
    btnYes.onclick = executeChildJoin; // í´ë¦­ ì‹œ ì‹¤í–‰í•  í•¨ìˆ˜ ì—°ê²°

    overlay.style.display = 'flex';
}

// [ì‹ ê·œ] ìµœì¢… DB ì €ì¥ í•¨ìˆ˜
async function executeChildJoin() {
    const chk1 = document.getElementById('consentCheck1');
    const chk2 = document.getElementById('consentCheck2');

    if (!chk1.checked || !chk2.checked) {
        // ì—¬ê¸°ì„œ alert ëŒ€ì‹  ê¸°ì¡´ í…ìŠ¤íŠ¸ë‚˜ ìŠ¤íƒ€ì¼ë¡œ ê²½ê³ ë¥¼ ì¤„ ìˆ˜ë„ ìˆì§€ë§Œ,
        // ê°„ë‹¨íˆ ë¸Œë¼ìš°ì € ì•Œë¦¼ìœ¼ë¡œ ë§‰ìŠµë‹ˆë‹¤. (ëª¨ë‹¬ ìœ„ì— ëª¨ë‹¬ ë„ìš°ê¸° ë³µì¡í•¨ ë°©ì§€)
        alert('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì— ë™ì˜ ì²´í¬í•´ì£¼ì„¸ìš”.'); 
        return;
    }

    if (!tempChildData) return;

    // ë¡œë”© ì‹œì‘ (ëª¨ë‹¬ ë‹«ê³  ë¡œë”©)
    document.getElementById('customModalOverlay').style.display = 'none';
    showLoading(true, 'ê°€ì… ì²˜ë¦¬ ì¤‘...');

    const params = {
        p_manager_id: curAuth.id, // ë¶€ëª¨ UUID
        p_name: tempChildData.name,
        p_rrn_display: `${tempChildData.rrn1}-${tempChildData.rrn2}******`,
        p_phone: null,   // ìë…€ í°ë²ˆí˜¸ ì—†ìŒ (ë…ë¦½ ì‹œ ì…ë ¥)
        p_address: curMem.address, // ë¶€ëª¨ ì£¼ì†Œ ìƒì†
        p_initial_capital: tempChildData.capital,
        p_bank_name: tempChildData.bank,
        p_account_number: tempChildData.acc,
        p_account_holder: tempChildData.name
        // p_relationship ë“±ì€ RPCê°€ ì§€ì›í•œë‹¤ë©´ ì¶”ê°€, ì•„ë‹ˆë©´ DB íŠ¸ë¦¬ê±°ê°€ ì²˜ë¦¬í•œë‹¤ê³  ê°€ì •
    };

    // RPC í˜¸ì¶œ
    const { data, error } = await _supabase.rpc('create_full_child_member', params);

    showLoading(false);
    
    if (error) {
        showModal('ê°€ì… ì‹¤íŒ¨: ' + error.message);
    } else {
        showModal('ğŸ‰ ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n(ì¶œìê¸ˆ ì…ê¸ˆ ë° ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì •ì‹ ì¡°í•©ì›ì´ ë©ë‹ˆë‹¤.)');
        document.getElementById('familyModalOverlay').style.display = 'none';
        
        // ëª©ë¡ ê°±ì‹ 
        loadDashboardData(curAuth.id);
        if (typeof loadManagedProfiles === 'function') {
            loadManagedProfiles(curAuth.id);
        }
    }
}

   // [ì „ì—­ ë³€ìˆ˜ ì¶”ê°€] ê³µì§€ì‚¬í•­ ë°ì´í„° ìºì‹±ìš© (ìŠ¤í¬ë¦½íŠ¸ ìƒë‹¨ ë³€ìˆ˜ ì„ ì–¸ë¶€ì— ë‘ê±°ë‚˜, í•¨ìˆ˜ ê·¼ì²˜ì— ë‘ì„¸ìš”)
let cachedNoticeList = [];

// [ìˆ˜ì •] ê³µì§€ì‚¬í•­ ì „ì²´ë³´ê¸° ëª¨ë‹¬ ì—´ê¸° (DB ì¡°íšŒ + ê²€ìƒ‰ ì´ˆê¸°í™”)
async function openNoticeListModal() {
    const modal = document.getElementById('noticeListModal');
    const listArea = document.getElementById('noticeListResult');
    const searchInput = document.getElementById('noticeSearchInput');

    // 1. ëª¨ë‹¬ ì´ˆê¸°í™” ë° í‘œì‹œ
    searchInput.value = ''; // ê²€ìƒ‰ì°½ ë¹„ìš°ê¸°
    listArea.innerHTML = '<div class="d-flex justify-content-center py-5"><div class="spinner-border text-danger" role="status"></div></div>';
    modal.style.display = 'flex';

    try {
        // 2. ë°ì´í„° ì¡°íšŒ (ìµœì‹ ìˆœ 100ê°œ ì œí•œ)
        // status ì»¬ëŸ¼ í•„í„° ì—†ì´ ëª¨ë“  ê³µì§€ ì¡°íšŒ (Step 1 ë…¼ë¦¬ ì ìš©)
        const { data: notices, error } = await _supabase
            .from('coop_notices')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(100);

        if (error) throw error;

        // 3. ë°ì´í„° ìºì‹± ë° ë Œë”ë§
        cachedNoticeList = notices || [];
        renderNoticeItems(cachedNoticeList);

    } catch (e) {
        console.error(e);
        listArea.innerHTML = `<div class="text-center text-danger py-4">
            <i class="bi bi-exclamation-triangle mb-2 d-block fs-2"></i>
            ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br><small>${e.message}</small>
        </div>`;
    }
}

// [ì‹ ê·œ] ê²€ìƒ‰ì–´ í•„í„°ë§ í•¨ìˆ˜ (onkeyup ì´ë²¤íŠ¸ ì—°ê²°)
function filterNoticeList() {
    const keyword = document.getElementById('noticeSearchInput').value.toLowerCase().trim();
    
    // ìºì‹œëœ ë°ì´í„°ì—ì„œ ì œëª©ì´ë‚˜ ë‚´ìš©ì— í‚¤ì›Œë“œê°€ í¬í•¨ëœ ê²ƒë§Œ í•„í„°ë§
    const filtered = cachedNoticeList.filter(n => {
        const title = (n.title || '').toLowerCase();
        const content = (n.content || '').toLowerCase();
        return title.includes(keyword) || content.includes(keyword);
    });

    renderNoticeItems(filtered);
}

// [ì‹ ê·œ] ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ í—¬í¼ í•¨ìˆ˜
function renderNoticeItems(list) {
    const listArea = document.getElementById('noticeListResult');
    
    if (!list || list.length === 0) {
        listArea.innerHTML = '<div class="text-center text-muted py-5">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    let html = '<div class="list-group list-group-flush">';
    list.forEach(n => {
        const date = n.created_at ? n.created_at.substring(0, 10) : '-';
        // HTML íƒœê·¸ ì œê±° (ë¯¸ë¦¬ë³´ê¸°ìš©)
        const rawContent = n.content || '';
        const safeContent = rawContent.replace(/<[^>]*>?/gm, '').substring(0, 50) + (rawContent.length > 50 ? '...' : '');

        // í´ë¦­ ì‹œ ê¸°ì¡´ viewPost í•¨ìˆ˜ í˜¸ì¶œ (ì¹´í…Œê³ ë¦¬ 'notice' ì „ë‹¬)
        // setModalDepth(true)ë¥¼ ì¶”ê°€í•˜ì—¬ ëª©ë¡ ëª¨ë‹¬ì„ ë’¤ë¡œ ì‚´ì§ ë°€ì–´ì£¼ëŠ” íš¨ê³¼ ì ìš©
        html += `
            <button class="list-group-item list-group-item-action py-3" onclick="setModalDepth(true); viewPost(${n.id}, 'notice')">
                <div class="d-flex w-100 justify-content-between mb-1">
                    <h6 class="mb-1 fw-bold text-break">${n.title}</h6>
                    <small class="text-muted text-nowrap ms-2">${date}</small>
                </div>
                <small class="text-secondary">${safeContent}</small>
            </button>
        `;
    });
    html += '</div>';
    listArea.innerHTML = html;
}

   // [ì‹ ê·œ] ì´ë©”ì¼ ì°¾ê¸° ëª¨ë‹¬ ì—´ê¸°
function openFindEmailModal() {
    // ì…ë ¥ì°½ ì´ˆê¸°í™”
    document.getElementById('findEmailName').value = '';
    document.getElementById('findEmailPhone').value = '';
    document.getElementById('findEmailModalOverlay').style.display = 'flex';
}

// [ì‹ ê·œ] ì´ë©”ì¼ ì°¾ê¸° ì‹¤í–‰
async function tryFindEmail() {
    const name = document.getElementById('findEmailName').value.trim();
    const phone = document.getElementById('findEmailPhone').value.trim();

    // 1. ìœ íš¨ì„± ê²€ì‚¬ (ì „í™”ë²ˆí˜¸ 12ìë¦¬ ì´ìƒ: 010-XXXX-XXXX)
    if (!name || phone.length < 12) {
        // ê¸°ì¡´ ì•ŒëŸ¿ ëŒ€ì‹  ëª¨ë‹¬ ì‚¬ìš© (depth ì²˜ë¦¬ ì ìš©)
        setModalDepth(true); 
        return showModal('ì´ë¦„ê³¼ íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    }

    showLoading(true, 'ì •ë³´ í™•ì¸ ì¤‘...');

    try {
        // 2. RPC í˜¸ì¶œ (ë³´ì•ˆ í•¨ìˆ˜)
        const { data, error } = await _supabase.rpc('find_member_email', {
            p_name: name,
            p_phone: phone
        });

        showLoading(false);

        if (error) {
            throw error;
        }

        // 3. ê²°ê³¼ ì²˜ë¦¬
        if (data && data.success) {
            // ì°¾ìŒ
            document.getElementById('findEmailModalOverlay').style.display = 'none';
            showModal(`íšŒì›ë‹˜ì˜ ì´ë©”ì¼ ì£¼ì†Œ íŒíŠ¸ì…ë‹ˆë‹¤.\n\nğŸ“§ ${data.masked_email}\n\nìœ„ ì£¼ì†Œë¡œ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.`);
        } else {
            // ëª» ì°¾ìŒ (ë³´ì•ˆìƒ ëª¨í˜¸í•˜ê²Œ ë©”ì‹œì§€ ì²˜ë¦¬)
            setModalDepth(true);
            showModal('ì¼ì¹˜í•˜ëŠ” ê°€ì… ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì´ë¦„ì´ë‚˜ ì „í™”ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
        }

    } catch (e) {
        showLoading(false);
        console.error(e);
        setModalDepth(true);
        showModal('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
    }
}

</script>
</body>
</html>
