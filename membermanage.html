<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>조합원 관리 - 용인모두의햇빛협동조합</title>

    <link rel="icon" type="image/png" href="https://ifdqlwxgqgsvnawmhlfc.supabase.co/storage/v1/object/public/assets/favicon.png">
  
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.css" rel="stylesheet">
  <link href="https://webfontworld.github.io/gmarket/GmarketSans.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
   
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="cert_generator.js"></script>
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <script src="badges.js"></script>
 
  <link href="style.css" rel="stylesheet">
  
 <style>
   
    /* [필수 유틸리티] 화면 제어용 (최우선 적용) */
    .hidden { display: none !important; }
    
    /* [기본 설정] 폰트 및 바디 */
    body {
        font-family: 'Pretendard', sans-serif;
        background-color: #f8f9fa;
        padding-top: 80px; /* 헤더 높이만큼 띄움 */
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }

    /* [헤더] 규정집 스타일 오버라이드 (검은색 배경 강제) */
    #header {
        background-color: #000 !important; /* style.css보다 우선순위 높임 */
        padding: 15px 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .logo h1 a {
        font-family: 'GmarketSans', sans-serif;
        font-weight: 700;
        font-size: 20px;
        text-decoration: none;
        color: #fff !important;
    }
    .header-link {
        color: #fff;
        text-decoration: none;
        margin-left: 20px;
        font-size: 1.2rem;
        cursor: pointer;
        transition: 0.3s;
    }
    .header-link:hover { color: #ff9800; }

    /* [푸터] 하단 고정 */
    #footer {
        margin-top: auto;
        background: #111; 
        color: #fff;
    }

    /* [로그인 섹션] 전용 스타일 */
    .signup-wrapper {
        background: #fff;
        padding: 40px 30px;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        max-width: 500px;
        margin: 40px auto;
        border: 1px solid #eee;
    }
    .form-title {
        font-family: 'GmarketSans';
        font-weight: 700;
        text-align: center;
        margin-bottom: 30px;
        color: #333;
    }

    /* [모달] 커스텀 디자인 (Depth Effect) */
    .custom-modal-overlay {
        z-index: 1050;
        display: none; /* 기본 숨김 */
        background: rgba(0,0,0,0.4);
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        justify-content: center; align-items: center;
        transition: all 0.3s ease;
        backdrop-filter: blur(2px);
    }
    .custom-modal-box {
        background: #fff;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        width: 90%; max-width: 400px;
        text-align: center;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        transform: scale(1);
        opacity: 1;
    }
    /* 뒤로 밀려난 모달 스타일 */
    .custom-modal-overlay.modal-depth-back {
        z-index: 1040;
        background: rgba(0,0,0,0.6);
    }
    .custom-modal-overlay.modal-depth-back .custom-modal-box {
        transform: scale(0.9) translateY(10px);
        opacity: 0.6;
    }
    /* 최상위 모달 */
    #customModalOverlay { z-index: 2000 !important; }

    /* [게시판] 스크롤바 & 높이 제한 */
    #boardList {
        max-height: 500px;
        overflow-y: auto;
        scrollbar-width: thin;
    }

    /* [대시보드] 카드 스타일 (style.css에 없는 전용 디자인) */
    .dashboard-card {
        background: #fff;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        border: 1px solid #f0f0f0;
        height: 100%;
    }
    .count-icon {
        font-size: 2.5rem;
        color: #2E7D32;
        margin-bottom: 10px;
    }
    .count-title {
        color: #666; font-size: 0.9rem; margin-bottom: 5px;
    }
    .count-val {
        font-family: 'GmarketSans';
        font-weight: 700;
        font-size: 1.5rem;
        color: #333;
    }
    .text-green { color: #2E7D32 !important; }

    /* [타임라인] 활동 내역 스타일 */
    .timeline-item {
        padding: 0 0 20px 20px;
        border-left: 2px solid #e0e0e0;
        position: relative;
    }
    .timeline-item::before {
        content: "";
        position: absolute;
        width: 12px; height: 12px;
        border-radius: 50%;
        left: -7px; top: 5px;
        background: #fff;
        border: 2px solid #2E7D32;
    }
    .timeline-date {
        font-size: 0.8rem; color: #999; margin-bottom: 3px;
    }
    .timeline-content h5 {
        font-size: 1rem; font-weight: 600; margin: 0; color: #333;
    }
    .timeline-content p {
        font-size: 0.9rem; color: #666; margin: 0;
    }

    /* [메뉴 탭] 버튼 스타일 */
    .menu-btn {
        width: 100%;
        text-align: left;
        padding: 15px;
        margin-bottom: 10px;
        border: 1px solid #eee;
        background: #fff;
        border-radius: 10px;
        font-weight: 600;
        color: #555;
        transition: all 0.2s;
        display: flex; justify-content: space-between; align-items: center;
    }
    .menu-btn:hover {
        background: #f8f9fa; border-color: #2E7D32; color: #2E7D32;
    }
    .menu-btn.active {
        background: #2E7D32; color: #fff; border-color: #2E7D32;
    }

    /* [로딩] 오버레이 */
    #loadingOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.95);
        z-index: 9999;
        display: none; /* JS가 제어함 */
        flex-direction: column; justify-content: center; align-items: center;
    }

    /* [공지사항] 미니 리스트 스타일 */
    .notice-mini-item {
        padding: 8px 0;
        border-bottom: 1px solid #eee;
        font-size: 0.9rem;
        cursor: pointer;
    }
    .notice-mini-item:last-child { border-bottom: none; }
    .notice-mini-item:hover { background-color: #f8f9fa; }

    /* [배지] 컨테이너 스타일 */
#badgeContainer > * {
        flex: 0 0 auto !important; /* 줄어들지 않음(0), 늘어나지 않음(0), 크기 자동(auto) */
        min-width: 150px; /* (선택사항) 뱃지가 너무 작아지지 않게 최소 너비 확보 */
    }

   #loginSection.hidden,
#dashboardSection.hidden {
  display: none !important;
}
   /* [모바일 최적화] 가로 스크롤바 숨기기 (작동은 하되 시각적으로만 숨김) */
    .scroll-hide::-webkit-scrollbar { display: none; }
    .scroll-hide { -ms-overflow-style: none; scrollbar-width: none; }

/* [새로운 뱃지 툴팁] 화면 중앙 고정(토스트 메시지) 스타일 */
.custom-badge-tooltip {
    /* 기본 설정: 숨김, 화면 기준 고정, 최상위 레이어 */
    display: none;
    position: fixed; /* 부모 요소의 overflow를 무시하고 화면 기준 배치 */
    z-index: 9999;   /* 다른 모든 요소 위에 표시 */
    pointer-events: none; /* 툴팁 자체가 터치를 방해하지 않게 함 */

    /* 위치 선정: 화면 정중앙 */
    top: 50%;
    left: 50%;
    /* 정중앙 정렬 + 처음에 약간 작게 시작(애니메이션용) */
    transform: translate(-50%, -50%) scale(0.9); 

    /* 스타일링: 세련된 검은색 알약 형태 */
    background-color: rgba(33, 37, 41, 0.95); /* 부드러운 검은색 */
    color: #fff;
    padding: 12px 24px;       /* 내부 여백을 넉넉히 */
    border-radius: 50px;      /* 둥근 알약 모양 */
    font-size: 1rem;          /* 글자 크기 키움 */
    font-weight: 600;         /* 약간 두껍게 */
    box-shadow: 0 4px 20px rgba(0,0,0,0.2); /* 부드러운 그림자 */
    white-space: nowrap;      /* 줄바꿈 방지 */
    
    /* 부드러운 등장 효과 */
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* 톡 튀어나오는 느낌 */
    opacity: 0;
}

/* [통합 표시 상태] 호버(PC) 또는 액티브(모바일 터치) 시 표시 */
/* 뱃지 아이템에 active 클래스가 붙거나 마우스가 올라가면 실행됨 */
.badge-item:hover .custom-badge-tooltip,
.badge-item.active .custom-badge-tooltip {
    display: block;
    opacity: 1;
    transform: translate(-50%, -50%) scale(1); /* 원래 크기로 톡 튀어나옴 */
}
</style>
</head>

<body>

  <header id="header" class="fixed-top">
    <div class="container d-flex align-items-center justify-content-between">
      
      <div class="logo">
        <h1><a href="index.html">용인모두의햇빛협동조합</a></h1>
      </div>

      <div class="d-flex align-items-center">
          <a href="index.html" class="header-link" title="메인으로 이동">
              <i class="bi bi-house-door"></i>
          </a>
          <a href="#" onclick="logout()" id="headerLogoutBtn" class="header-link hidden" title="로그아웃">
              <i class="bi bi-box-arrow-right"></i>
          </a>
      </div>

    </div>
  </header>

  <div id="loadingOverlay">
      <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;"></div>
      <div class="mt-3 fw-bold text-secondary" id="loadingMsg">잠시만 기다려주세요</div>
  </div>

<main class="container py-4">
    
    <div id="loginSection" class="hidden">
        <div class="signup-wrapper">
            <h2 class="form-title">조합원 공간</h2>
            
            <div class="alert alert-light border d-flex align-items-center" role="alert">
                <i class="bi bi-info-circle-fill text-success fs-4 me-3"></i>
                <div>
                    가입 시 등록한 <b>이메일</b>을 입력해주세요.<br>
                    <small class="text-muted">입력하신 메일로 로그인 링크를 보내드립니다.</small>
                </div>
            </div>

<div class="mb-3">
    <label class="form-label fw-bold small text-secondary">이메일 주소</label>
    <div class="input-group">
        <input type="email" id="emailInput" class="form-control form-control-lg" placeholder="example@email.com" onkeyup="if(event.key==='Enter') sendMagicLink()">
        <button class="btn btn-dark" type="button" onclick="sendMagicLink()">링크 받기</button>
    </div>
    
    <div class="text-end mt-2">
        <span class="small text-muted me-1">가입한 이메일이 기억나지 않나요?</span>
        <a href="#" class="small fw-bold text-decoration-none text-success" onclick="openFindEmailModal()">
            <i class="bi bi-search"></i> 이메일 찾기
        </a>
    </div>
</div>

            <div id="sentMsgBox" class="text-center hidden mt-4 p-4 bg-light rounded">
                <i class="bi bi-envelope-check text-success" style="font-size: 3rem;"></i>
                <h4 class="fw-bold mt-2">메일함을 확인해주세요!</h4>
                <p class="text-muted mb-3">
                    <span id="targetEmail" class="fw-bold text-dark"></span>(으)로<br>
                    로그인 링크가 발송되었습니다.
                </p>
                <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">이메일 다시 입력하기</button>
            </div>

            <div class="mt-4 pt-4 border-top">
                <button class="btn btn-warning w-100 fw-bold py-3" onclick="startKakaoLogin()">
                    <i class="bi bi-chat-fill me-2"></i> 카카오로 바로 시작하기
                </button>
                <div class="text-center mt-2">
                    <small class="text-muted">(기존에 카카오를 연동한 조합원만 가능합니다)</small>
                </div>
            </div>
        </div>
    </div>

<div id="dashboardSection" class="hidden">
    
    <div id="birthdayBanner" onclick="fireConfetti()">
        🎉 <span id="birthdayMsgName"></span>님, 생일을 진심으로 축하합니다! (클릭하면 폭죽이 터져요!) 🎂
    </div>

<div class="d-flex justify-content-between align-items-center mb-3">
        <div class="small text-muted">
            <i class="bi bi-info-circle me-1"></i> 상태
        </div>
        <span id="memberStatusBadge" class="badge rounded-pill bg-secondary">-</span>
    </div>

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
        
        <div class="d-flex align-items-center mb-2 mb-md-0">
            <h5 class="fw-bold m-0 me-2"><i class="bi bi-person-lines-fill me-2"></i>내 정보</h5>
            <span class="badge bg-light text-dark border">
                NO. <span id="infoMemberId">-</span>
            </span>
        </div>

        <div class="d-flex justify-content-between align-items-center w-100 w-md-auto">
            
            <div class="dropdown hidden me-2" id="profileSwitcher">
                <button class="btn btn-sm btn-outline-primary dropdown-toggle fw-bold" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-arrow-repeat"></i> <span id="currentProfileName">나(개인)</span>
                </button>
                <ul class="dropdown-menu shadow" id="profileListMenu">
                </ul>
            </div>

            <div class="ms-auto ms-md-2">
                <button class="btn btn-sm btn-outline-secondary" id="btnEditProfile" onclick="toggleEditMode(true)">정보 수정</button>
                <button class="btn btn-sm btn-success hidden" id="btnSaveProfile" onclick="saveProfile()">저장</button>
                <button class="btn btn-sm btn-light hidden" id="btnCancelEdit" onclick="toggleEditMode(false)">취소</button>
            </div>
        </div>
    </div>
        
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <label class="small text-muted">이름</label>
            <div class="fw-bold" id="infoName">-</div>
        </div>
        <div class="col-md-6">
            <label class="small text-muted">생년월일</label>
            <div class="fw-bold" id="infoBirth">-</div>
        </div>
        <div class="col-md-6">
            <label class="small text-muted">이메일 (변경불가)</label>
            <div class="fw-bold text-secondary" id="infoEmail">-</div>
        </div>

        <div class="col-md-6"> 
            <label class="small text-muted">전화번호</label>
            <div id="viewPhoneBox" class="fw-bold p-1 border-bottom" style="min-height: 30px;">-</div>
            <input type="text" id="editPhone" class="readonly-text" style="display:none;" oninput="autoHyphen(this)" maxlength="13" placeholder="010-0000-0000">
        </div>

        <div class="col-12">
            <label class="small text-muted">주소</label>
            <div id="viewAddressBox" class="fw-bold p-1 border-bottom" style="min-height: 30px;"></div>
            <div id="editAddressBox" class="addr-edit-group" style="display:none;">
                <div class="d-flex gap-2 mb-2"> 
                    <input type="text" id="editAddrMain" class="form-control" placeholder="주소 검색 버튼을 누르세요" readonly onclick="execDaumPostcode()" style="background-color:#fff;">
                    <button class="btn btn-secondary" type="button" onclick="execDaumPostcode()" style="white-space:nowrap;">주소 검색</button>
                </div>
                <input type="text" id="editAddrDetail" class="form-control" placeholder="상세 주소를 입력하세요">
            </div>
        </div>

        <div class="col-12 border-top pt-2 mt-2">
            <label class="small text-success fw-bold">환급/배당 계좌</label>
            <div id="viewBankBox" class="fw-bold p-1 border-bottom" style="min-height: 30px;">-</div>
            <div id="editBankBox" class="row g-2" style="display:none;">
                <div class="col-4">
                    <input type="text" id="editBankName" class="readonly-text" placeholder="은행명" readonly>
                </div>
                <div class="col-8">
                    <input type="text" id="editAccountNo" class="readonly-text" placeholder="계좌번호" readonly oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                </div>
                <div class="col-12">
                    <input type="text" id="editHolder" class="readonly-text" placeholder="예금주" readonly>
                </div>
                <small class="text-muted" style="font-size:0.8rem;">* 계좌번호를 수정하지 않으면 기존 정보가 유지됩니다.<br>* 본인 명의의 계좌를 입력해주세요.</small>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4" id="assetSummaryRow">
    </div>

    <div class="dashboard-card mb-4 p-3" style="background-color: #f8f9fa; border:none;">
        <div class="d-flex justify-content-between align-items-center mb-2 pb-1 border-bottom">
            <h6 class="fw-bold m-0 text-secondary"><i class="bi bi-megaphone-fill me-2"></i>최근 공지</h6>
            <button class="btn btn-sm btn-link text-muted text-decoration-none" onclick="loadBoard('notice')" style="font-size:0.8rem;">전체보기</button>
        </div>
        <div id="miniNoticeList" style="min-height: 30px;">
            <p class="text-center text-muted small py-2">로딩 중...</p>
        </div>
    </div>

<div class="dashboard-card mb-4">
        <h5 class="fw-bold mb-3 border-bottom pb-2">나의 뱃지 컬렉션</h5>
        
        <div id="badgeContainer" class="d-flex flex-nowrap align-items-center overflow-auto gap-3 py-2 scroll-hide" style="-webkit-overflow-scrolling: touch;">
            <span class="spinner-border spinner-border-sm"></span> 로딩 중...
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-5">
            <div class="dashboard-card">
                <h5 class="fw-bold mb-3 border-bottom pb-2">업무 신청</h5>
                
                <div class="d-grid gap-2">
                    <button class="menu-btn" onclick="toggleTab('extra', this)"><span><i class="bi bi-plus-circle me-2"></i>추가 출자</span><i class="bi bi-chevron-right"></i></button>
                    <button class="menu-btn" onclick="toggleTab('reduction', this)"><span><i class="bi bi-dash-circle me-2"></i>감자 신청</span><i class="bi bi-chevron-right"></i></button>
                    <button class="menu-btn" onclick="toggleTab('withdraw', this)"><span><i class="bi bi-box-arrow-left me-2"></i>탈퇴 신청</span><i class="bi bi-chevron-right"></i></button>
                    <button class="menu-btn hidden" id="menuBtnPartner" onclick="toggleTab('partner', this)"><span><i class="bi bi-shop-window me-2"></i>홈페이지 노출 신청</span><i class="bi bi-chevron-right"></i></button>
                    <button class="menu-btn" onclick="toggleTab('cert', this)"><span><i class="bi bi-file-earmark-pdf me-2"></i>증명서 발급</span><i class="bi bi-chevron-right"></i></button>
                </div>

                <div id="actionArea" class="mt-4 bg-light p-3 rounded">
                    <div id="tabPlaceholder" class="text-center text-muted small py-3">메뉴를 선택해주세요.</div>

                    <div id="tabExtra" class="hidden">
                        <h6 class="fw-bold mb-3">추가 출자 신청</h6>
                        <div class="mb-3">
                            <label class="form-label small">약정 금액 (1만원 단위)</label>
                            <input type="number" id="exAmount" class="form-control" placeholder="금액 입력" step="10000">
                        </div>
                        <button class="btn btn-success w-100 fw-bold" onclick="submitApplication('extra')">신청하기</button>
                    </div>

                    <div id="tabReduction" class="hidden">
                        <h6 class="fw-bold mb-3">감자 신청</h6>
                        <div class="alert alert-warning small py-2"><i class="bi bi-exclamation-triangle me-1"></i> 최소 10만원 이상의 출자금은 유지해야 합니다.</div>
                        <div class="mb-3">
                            <label class="form-label small">환급 요청액</label>
                            <input type="number" id="redAmount" class="form-control" placeholder="금액 입력">
                            <span id="redLimitDisplay" class="limit-text"></span>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="checkRedAgree">
                            <label class="form-check-label small" for="checkRedAgree">
                                감자는 다음년도 총회 승인 후 처리되며,<br>자산 상황에 따라 조정될 수 있음을 확인합니다.
                            </label>
                        </div>
                        <button class="btn btn-success w-100 fw-bold" onclick="submitApplication('reduction')">신청하기</button>
                    </div>

                    <div id="tabWithdraw" class="hidden">
                        <h6 class="fw-bold text-danger mb-3">탈퇴 신청</h6>
                        <div class="mb-3">
                            <label class="form-label small">탈퇴 사유</label>
                            <textarea id="wdReason" class="form-control" rows="3" placeholder="사유를 입력해주세요"></textarea>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="checkWdAgree">
                            <label class="form-check-label small text-danger fw-bold" for="checkWdAgree">
                                탈퇴 시 출자금은 다음년도 총회 승인 후<br>환급됨을 확인하였습니다.
                            </label>
                        </div>
                        <button class="btn btn-dark w-100 fw-bold" onclick="submitApplication('withdraw')">탈퇴 신청</button>
                    </div>

                    <div id="tabPartner" class="hidden">
                        <h6 class="fw-bold mb-3">협력 단체(파트너) 신청</h6>
                        <div class="alert alert-light border small mb-3">
                            <i class="bi bi-info-circle-fill me-1"></i>
                            홈페이지 [함께하는 사람들] 섹션에 노출됩니다.<br>
                            (로고 권장 사이즈: 300x150px, 배경 투명)
                        </div>

                        <div class="mb-2">
                            <label class="small text-muted fw-bold">단체/기업명</label>
                            <input type="text" id="ptName" class="form-control form-control-sm" placeholder="예: (주)용인햇빛">
                        </div>

                        <div class="mb-2">
                            <label class="small text-muted fw-bold">한 줄 소개</label>
                            <input type="text" id="ptDesc" class="form-control form-control-sm" placeholder="예: 태양광 유지보수 전문 기업">
                        </div>

                        <div class="mb-2">
                            <label class="small text-muted fw-bold">홈페이지 링크</label>
                            <input type="text" id="ptLink" class="form-control form-control-sm" placeholder="https://...">
                        </div>

                        <div class="mb-3">
                            <label class="small text-muted fw-bold">로고 이미지</label>
                            <input type="file" id="ptLogoFile" class="form-control form-control-sm" accept="image/*">
                            <input type="hidden" id="ptLogoUrl"> 
                            <div id="ptLogoPreview" class="mt-2 p-2 border rounded text-center bg-light hidden">
                                <img src="" style="max-height: 80px; max-width: 100%;">
                            </div>
                        </div>

                        <div id="ptStatusMsg" class="mb-3 text-end small fw-bold"></div>

                        <button class="btn btn-primary w-100 fw-bold" onclick="submitPartnerApplication()">
                            <i class="bi bi-send-check me-1"></i>신청/수정 하기
                        </button>
                    </div>

                    <div id="tabCert" class="hidden text-center py-3">
                        <h6 class="fw-bold">출자 증명서</h6>
                        <p class="small text-muted">현재 납입된 출자금을 기준으로<br>PDF 증명서를 생성합니다.</p>
                        <button class="btn btn-outline-success w-100 fw-bold" onclick="downloadCert()">
                            <i class="bi bi-download me-2"></i>다운로드
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="dashboard-card">
                <h5 class="fw-bold mb-4 border-bottom pb-2">통합 활동 타임라인</h5>
                <div id="timelineList" style="max-height: 600px; overflow-y: auto;">
                    <p class="text-center text-muted py-5">내역을 불러오는 중...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard-card mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
            <div class="d-flex gap-2 align-items-center">
                <h5 class="fw-bold m-0"><i class="bi bi-chat-dots-fill me-2"></i>자유게시판</h5>
            </div>
            <button class="btn btn-sm btn-dark" id="btnWritePost" onclick="openWriteModal()">
                <i class="bi bi-pencil-square"></i> 글쓰기
            </button>
        </div>
        <div id="boardList" style="min-height: 200px;"></div>
    </div>

    <div class="dashboard-card mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold m-0"><i class="bi bi-people-fill me-2"></i>가족/직원 계정 관리</h5>
            <button class="btn btn-sm btn-outline-secondary" onclick="openAddFamilyModal()">+ 추가</button>
        </div>
        <div id="familyListArea">
            <p class="text-muted small text-center py-3">등록된 구성원이 없습니다.</p>
        </div>
    </div>

</div>

<div id="historyModalOverlay" class="custom-modal-overlay">
    <div class="custom-modal-box" style="width: 95%; max-width: 500px; text-align: left; height: 70vh; display: flex; flex-direction: column;">
        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
            <h5 class="fw-bold m-0" id="historyModalTitle">상세 내역</h5>
            <button type="button" class="btn-close" onclick="document.getElementById('historyModalOverlay').style.display='none'"></button>
        </div>
        
        <div class="bg-light p-2 rounded mb-2 text-center small fw-bold" id="historyModalSummary">
            -
        </div>

        <div id="historyModalList" style="flex: 1; overflow-y: auto; min-height: 0;">
            </div>

        <div class="mt-3 text-end border-top pt-2">
            <button class="btn btn-dark w-100" onclick="document.getElementById('historyModalOverlay').style.display='none'">닫기</button>
        </div>
    </div>
</div>

<div id="historyModalOverlay" class="custom-modal-overlay">
    <div class="custom-modal-box" style="width: 95%; max-width: 500px; text-align: left; height: 70vh; display: flex; flex-direction: column;">
        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
            <h5 class="fw-bold m-0" id="historyModalTitle">상세 내역</h5>
            <button type="button" class="btn-close" onclick="document.getElementById('historyModalOverlay').style.display='none'"></button>
        </div>
        <div class="bg-light p-2 rounded mb-2 text-center small fw-bold" id="historyModalSummary">
            -
        </div>
        <div id="historyModalList" style="flex: 1; overflow-y: auto; min-height: 0;">
            </div>
        <div class="mt-3 text-end border-top pt-2">
            <button class="btn btn-dark w-100" onclick="document.getElementById('historyModalOverlay').style.display='none'">닫기</button>
        </div>
    </div>
</div> </main>
  

  <footer id="footer"></footer>
  
  <div id="customModalOverlay" class="custom-modal-overlay">
    <div class="custom-modal-box">
        <div style="font-size: 2rem; margin-bottom: 10px;">📢</div>
        <p id="customModalMsg" style="white-space: pre-wrap; margin-bottom: 20px; font-weight: 500; font-size: 1.1rem; color:#333;"></p>
        <div class="custom-modal-btn-group">
            <button id="btnModalNo" class="btn-modal btn-modal-no" onclick="closeCustomModal()">취소</button>
            <button id="btnModalYes" class="btn-modal btn-modal-yes">확인</button>
        </div>
    </div>
</div>

  <div id="findEmailModalOverlay" class="custom-modal-overlay">
    <div class="custom-modal-box" style="text-align:left; max-width:400px;">
        <h5 class="fw-bold mb-3"><i class="bi bi-person-badge me-2"></i>이메일 찾기</h5>
        <p class="small text-muted mb-4">
            가입 시 등록한 <b>이름</b>과 <b>휴대폰 번호</b>를 입력해주세요.<br>
            일치하는 정보가 있으면 이메일의 일부를 알려드립니다.
        </p>
        
        <div class="mb-3">
            <label class="form-label small fw-bold">이름</label>
            <input type="text" id="findEmailName" class="form-control" placeholder="홍길동">
        </div>

        <div class="mb-4">
            <label class="form-label small fw-bold">휴대폰 번호</label>
            <input type="tel" id="findEmailPhone" class="form-control" 
                   placeholder="010-0000-0000" maxlength="13" 
                   oninput="autoHyphen(this)"> </div>

        <div class="d-grid gap-2">
            <button class="btn btn-success fw-bold" onclick="tryFindEmail()">이메일 확인</button>
            <button class="btn btn-light btn-sm" onclick="document.getElementById('findEmailModalOverlay').style.display='none'">닫기</button>
        </div>
    </div>
</div>

  <div id="writeModalOverlay" class="custom-modal-overlay">
    <div class="custom-modal-box" style="text-align:left; max-width:500px;">
        <h5 class="fw-bold mb-3">게시글 작성</h5>
        <div class="mb-2">
            <input type="text" id="writeTitle" class="form-control" placeholder="제목">
        </div>
        <div class="mb-2">
            <textarea id="writeContent" class="form-control" rows="5" placeholder="내용을 입력하세요"></textarea>
        </div>
        <div class="mb-3">
            <label class="small text-muted">첨부파일 (URL 입력)</label>
            <input type="text" id="writeFile" class="form-control form-control-sm" placeholder="https://...">
        </div>
        <div class="custom-modal-btn-group">
            <button class="btn-modal btn-modal-no" onclick="document.getElementById('writeModalOverlay').style.display='none'">취소</button>
            <button class="btn-modal btn-modal-yes" onclick="submitPost()">등록</button>
        </div>
    </div>
</div>

<div id="familyModalOverlay" class="custom-modal-overlay">
    <div class="custom-modal-box" style="text-align:left; max-width:500px;">
        
        <ul class="nav nav-pills nav-fill mb-4" id="famModalTabs">
            <li class="nav-item">
                <button class="nav-link active fw-bold small" onclick="switchFamTab('new')">👶 자녀/가족 신규 등록</button>
            </li>
            <li class="nav-item">
                <button class="nav-link fw-bold small" onclick="switchFamTab('connect')">🤝 기존 계정 연결 (신청)</button>
            </li>
        </ul>

<div id="famTabNew">
    <div class="alert alert-light border small mb-3">
        <i class="bi bi-info-circle-fill me-1"></i>
        만 19세 미만 미성년 자녀만 등록 가능합니다.<br>
       </div>
    
    <div class="row g-2 mb-2">
        <div class="col-8">
            <label class="small text-muted fw-bold">이름 <span class="text-danger">*</span></label>
            <input type="text" id="newFamName" class="form-control form-control-sm" placeholder="이름">
        </div>
        <div class="col-4">
            <label class="small text-muted fw-bold">조합원번호 (자동)</label>
            <input type="text" id="newFamId" class="form-control form-control-sm bg-light" placeholder="생성됨" readonly>
        </div>
    </div>

    <div class="mb-2">
        <label class="small text-muted fw-bold">주민등록번호 <span class="text-danger">*</span></label>
        <div class="input-group input-group-sm">
            <input type="text" id="newFamRrn1" class="form-control" maxlength="6" placeholder="생년월일(6)" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
            <span class="input-group-text">-</span>
            <input type="password" id="newFamRrn2" class="form-control" maxlength="7" placeholder="뒷자리(7)" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
        </div>
    </div>

    <div class="mb-2">
        <label class="small text-muted fw-bold">법정대리인(나)과의 관계 <span class="text-danger">*</span></label>
        <div class="d-flex gap-2">
            <select id="newFamRelSelect" class="form-select form-select-sm" onchange="toggleFamilyRelationInput()">
                <option value="부">부 (아버지)</option>
                <option value="모">모 (어머니)</option>
                <option value="직접입력">기타 (직접입력)</option>
            </select>
            <input type="text" id="newFamRelInput" class="form-control form-control-sm hidden" placeholder="관계 입력">
        </div>
    </div>

    <div class="mb-2">
        <label class="small text-muted fw-bold">초기 출자금 (필수)</label>
        <input type="number" id="newFamCapital" class="form-control form-control-sm" placeholder="최소 100,000원" step="10000">
        <div class="form-text x-small text-secondary">최소 10만원 이상, 1만원 단위로 입력해주세요.</div>
    </div>

    <div class="p-2 bg-light rounded border mb-3">
        <label class="small text-success fw-bold mb-1"><i class="bi bi-bank me-1"></i>배당금 수령 계좌 (본인 명의)</label>
        <div class="row g-1">
            <div class="col-4">
                <input type="text" id="newFamBank" class="form-control form-control-sm" placeholder="은행명">
            </div>
            <div class="col-8">
                <input type="text" id="newFamAcc" class="form-control form-control-sm" placeholder="계좌번호 (-없이)">
            </div>
        </div>
    </div>

    <button class="btn btn-primary w-100 btn-sm fw-bold py-2" onclick="submitNewChild()">
        <i class="bi bi-file-earmark-check me-1"></i>정보 확인 및 동의서 작성
    </button>
</div>

        <div id="famTabConnect" class="hidden">
            <div class="alert alert-warning border small mb-3">
                <i class="bi bi-exclamation-circle-fill me-1"></i>
                이미 가입된 개인/단체에게 <b>"내 계정을 관리해달라"</b>고 요청합니다.<br>
                (상대방이 승낙해야 연결됩니다.)
            </div>

            <div class="input-group mb-3">
                <input type="text" id="searchConnectInput" class="form-control" placeholder="이름, 이메일, 또는 사업자번호">
                <button class="btn btn-dark" onclick="searchTargetMember()">검색</button>
            </div>

            <div id="connectResultArea" class="border rounded p-2 bg-light" style="height: 150px; overflow-y: auto;">
                <p class="text-center text-muted small py-4">검색어를 입력하세요.</p>
            </div>
        </div>

        <div class="text-end mt-3 border-top pt-2">
            <button class="btn btn-link text-secondary text-decoration-none btn-sm" onclick="document.getElementById('familyModalOverlay').style.display='none'">닫기</button>
        </div>
    </div>
</div>

  <div id="boardViewModal" class="custom-modal-overlay">
    <div class="custom-modal-box" style="width: 90%; max-width: 600px; text-align: left;">
        
        <div class="post-view-header">
            <h5 id="viewTitle" class="fw-bold m-0 text-break">제목 로딩중...</h5>
            <div class="post-view-meta mt-2">
                <span><i class="bi bi-person-circle me-1"></i><span id="viewAuthor">작성자</span></span>
                <span id="viewDate">0000.00.00</span>
            </div>
        </div>

        <div id="viewContent" class="post-view-content mb-3">
            내용 로딩중...
        </div>

        <div id="viewFiles" class="mb-3 border-top pt-3"></div>

        <div class="d-flex justify-content-between border-top pt-3">
            <button class="btn btn-outline-secondary btn-sm" onclick="reportPost()">🚨 신고</button>
            
            <div id="viewBtnGroup">
                <button class="btn btn-dark btn-sm" onclick="document.getElementById('boardViewModal').style.display='none'">닫기</button>
            </div>
        </div>
    </div>
</div>

<div id="manualMatchModal" class="custom-modal-overlay">
    <div class="custom-modal-box" style="text-align: left;">
        <h5 class="fw-bold mb-3">📢 조합원 찾기</h5>
        <p class="small text-muted mb-3">
            카카오 정보로 가입 정보를 찾지 못했습니다.<br>
            기존에 등록한 <b>이름</b>과 <b>연락처</b>를 입력해주세요.
        </p>
        
        <div class="mb-3">
            <label class="form-label small fw-bold">이름</label>
            <input type="text" id="manualName" class="form-control" placeholder="홍길동">
        </div>

        <div class="mb-2">
            <label class="form-label small fw-bold d-block">찾을 정보 선택</label>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="contactType" id="typePhone" value="phone" checked onchange="toggleContactInput()">
                <label class="form-check-label small" for="typePhone">전화번호</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="contactType" id="typeEmail" value="email" onchange="toggleContactInput()">
                <label class="form-check-label small" for="typeEmail">이메일</label>
            </div>
        </div>

        <div id="inputGroupPhone" class="mb-4">
            <input type="tel" id="manualPhone" class="form-control" 
                   placeholder="010-1234-5678" maxlength="13"
                   oninput="autoHyphen(this)">
            <div class="form-text x-small text-muted">숫자만 입력하면 자동으로 -가 붙습니다.</div>
        </div>

        <div id="inputGroupEmail" class="mb-4 hidden">
            <input type="email" id="manualEmail" class="form-control" placeholder="example@email.com">
        </div>

        <div class="d-grid gap-2">
            <button class="btn btn-success fw-bold" onclick="tryManualLink()">내 정보 찾기 & 연결</button>
            <button class="btn btn-light btn-sm text-secondary" onclick="manualMatchFail()">찾을 수 없나요? (문의하기)</button>
        </div>
    </div>
</div>


  <div id="noticeListModal" class="custom-modal-overlay">
    <div class="custom-modal-box" style="width: 90%; max-width: 500px; text-align: left; height: 80vh; display: flex; flex-direction: column;">
        
        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
            <h5 class="fw-bold m-0"><i class="bi bi-megaphone-fill me-2 text-danger"></i>공지사항</h5>
            <button type="button" class="btn-close" onclick="document.getElementById('noticeListModal').style.display='none'"></button>
        </div>

        <div class="mb-3">
            <div class="input-group">
                <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                <input type="text" id="noticeSearchInput" class="form-control" placeholder="검색어를 입력하세요 (예: 배당, 총회)" onkeyup="filterNoticeList()">
            </div>
        </div>

        <div id="noticeListResult" style="flex: 1; overflow-y: auto; min-height: 0;">
            <p class="text-center text-muted py-5">데이터 로딩 중...</p>
        </div>

        <div class="mt-3 text-end border-top pt-2">
            <button class="btn btn-dark w-100" onclick="document.getElementById('noticeListModal').style.display='none'">닫기</button>
        </div>
    </div>
</div>
  
  
<div id="layer" style="display:none;position:fixed;overflow:hidden;z-index:9999;-webkit-overflow-scrolling:touch;">
  <img src="//t1.daumcdn.net/postcode/resource/images/close.png" id="btnCloseLayer" style="cursor:pointer;position:absolute;right:-3px;top:-3px;z-index:1" onclick="closeDaumPostcode()" alt="닫기 버튼">
</div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="footer.js"></script>
  <script src="home_patch_note.js"></script>

 <script>
    // =========================================================================
    // 1. Supabase 설정
    // =========================================================================
    const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
    
    let _supabase = null;
    let curMem = null;
    let curAuth = null;
   let currentBoardLimit = 20;
let isBoardLoading = false;

    try {
        _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      window._client = _supabase;
    } catch (e) {
        console.error("Supabase Init Error", e);
        alert("시스템 연결 오류");
    }


   // [신규] 친절한 에러 메시지 변환기
function translateAuthError(errorMsg) {
    if (!errorMsg) return '알 수 없는 오류가 발생했습니다.';
    
    const msg = errorMsg.toLowerCase();
    
    if (msg.includes('invalid login credentials') || msg.includes('user not found')) {
        return '가입되지 않은 이메일이거나 정보가 올바르지 않습니다.';
    }
    if (msg.includes('rate limit') || msg.includes('too many requests')) {
        return '너무 많은 요청이 감지되었습니다. 잠시 후(약 1분 뒤) 다시 시도해주세요.';
    }
    if (msg.includes('validation failed') || msg.includes('email')) {
        return '이메일 주소 형식이 올바르지 않습니다. (예: user@example.com)';
    }
    if (msg.includes('security code')) {
        return '보안 코드가 만료되었거나 틀렸습니다. 다시 로그인해주세요.';
    }
    
    // 그 외 번역 안 된 에러는 원문 + 안내 표시
    return '시스템 오류: ' + errorMsg + '\n(지속되면 사무국에 문의해주세요)';
}
   
    function showLoading(show, msg) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        if(msg) document.getElementById('loadingMsg').innerText = msg;
    }

// [수정 1] 초기화 로직: 보안 강화 및 화면 겹침 원천 차단
// [수정] 초기화 로직: 세션 상태에 따라 showOnly로 명확하게 분기
window.addEventListener('DOMContentLoaded', async () => {
    // 1. 로딩바 표시 (HTML에 이미 hidden 클래스가 박혀있으므로 화면은 백지 상태임)
    if (typeof showLoading === 'function') showLoading(true, '시스템 보안 확인 중...');

    // 2. Supabase 연결 체크
    if(!_supabase) {
        if (typeof showLoading === 'function') showLoading(false);
        alert("시스템 오류: DB 연결 실패");
        return;
    }

    // 3. 인증 상태 변경 감지
    _supabase.auth.onAuthStateChange((event, session) => {
        // 로딩바 끄기 (결정 났음)
        if (typeof showLoading === 'function') showLoading(false);

        if (session) {
            // [로그인 상태] -> 데이터 로드 시작
            // 주의: 여기서 바로 showOnly('dashboardSection') 하지 않음.
            // 데이터가 텅 빈 화면이 보일 수 있으므로 loadDashboardData 완료 후 보여줌.
            handleLoginSuccess(session.user);
        } else {
            // [비로그인 상태] -> 로그인 화면 즉시 노출
            console.log("인증 세션 없음: 로그인 화면 이동");
            showOnly('loginSection'); 
        }
    });
});

    // =========================================================================
    // 2. 로그인 & 데이터 로드
    // =========================================================================
// [수정 2] 매직링크 발송: 에러 메시지 번역 적용
async function sendMagicLink() {
    const email = document.getElementById('emailInput').value.trim();
    if(!email.includes('@')) return showModal('이메일 주소 형식이 올바르지 않습니다.\n(@가 포함되어야 합니다)');
    
    showLoading(true, '보안 연결 초기화 및 메일 발송 중...');
    
    // 1. 기존 세션 로그아웃
    await _supabase.auth.signOut();

    // 2. 로그인 링크 발송
    const { error } = await _supabase.auth.signInWithOtp({
        email: email,
        options: { shouldCreateUser: false, emailRedirectTo: window.location.href } 
        // 주의: shouldCreateUser: false로 설정하여 미가입자가 로그인 시도 시 에러가 나도록 유도할 수도 있습니다.
        // 현재 정책(가입된 이메일만)에 맞게 false 권장. 만약 누구나 가입 가능하다면 true.
    });
    
    showLoading(false);

    if(error) {
        // ★ 여기가 변경된 부분입니다.
        const friendlyMsg = translateAuthError(error.message);
        showModal(friendlyMsg);
    }
    else {
        document.getElementById('sentMsgBox').classList.remove('hidden');
        document.getElementById('targetEmail').innerText = email;
    }
}

// [수정] 로그인 성공 후 처리 (자동 실패 시 -> 수동 모달 띄움)
async function handleLoginSuccess(user) {
    curAuth = user;
    showLoading(true, '정보 확인 중...');
    
    // 1. 자동 매칭 시도
    const { data: claimRes, error: claimErr } = await _supabase.rpc('claim_member_profile');
    
    showLoading(false);

    // [핵심 변경] 실패했다고 바로 쫓아내지 않음!
    if (claimErr || !claimRes.success) {
        console.log("자동 매칭 실패, 수동 매칭 모달 오픈");
        // 로그아웃 하지 않고, 모달을 띄움
        document.getElementById('manualMatchModal').style.display = 'flex';
        return; 
    }

    // 성공 시 대시보드 로드
    document.getElementById('headerLogoutBtn').classList.remove('hidden');
    
    // [1] 대시보드 데이터 우선 로드 (curMem 전역 변수가 여기서 세팅됨)
    await loadDashboardData(user.id);

    // [2] 관리 가능한 프로필(단체/가족) 목록 로드 (누락되었던 부분)
    // -> 이 함수가 호출되어야 상단에 드롭다운(프로필 스위처)이 나타납니다.
    // -> loadDashboardData 완료 후 호출해야 현재 프로필에 'Active' 체크가 가능합니다.
    if (typeof loadManagedProfiles === 'function') {
        await loadManagedProfiles(user.id);
    }
}

// [신규] 전화번호 자동 하이픈 & 숫자 이외 차단
function autoHyphen(target) {
    // 1. 숫자만 남기기 (공백, 문자 제거)
    let raw = target.value.replace(/[^0-9]/g, '');
    
    // 2. 01012341234 -> 010-1234-1234 포맷팅
    let formatted = '';
    if (raw.length < 4) {
        formatted = raw;
    } else if (raw.length < 7) {
        formatted = raw.substr(0, 3) + '-' + raw.substr(3);
    } else if (raw.length < 11) {
        formatted = raw.substr(0, 3) + '-' + raw.substr(3, 3) + '-' + raw.substr(6);
    } else {
        // 11자리까지만 처리 (그 이상은 잘라냄)
        raw = raw.substr(0, 11);
        formatted = raw.substr(0, 3) + '-' + raw.substr(3, 4) + '-' + raw.substr(7);
    }
    
    target.value = formatted;
}

// [신규] 라디오 버튼에 따라 입력창 교체
function toggleContactInput() {
    const isPhone = document.getElementById('typePhone').checked;
    const phoneGroup = document.getElementById('inputGroupPhone');
    const emailGroup = document.getElementById('inputGroupEmail');

    if (isPhone) {
        phoneGroup.classList.remove('hidden');
        emailGroup.classList.add('hidden');
        document.getElementById('manualPhone').focus();
    } else {
        phoneGroup.classList.add('hidden');
        emailGroup.classList.remove('hidden');
        document.getElementById('manualEmail').focus();
    }
}

// [수정] 수동 매칭 실행 함수 (Alert 제거 -> showModal 적용)
async function tryManualLink() {
    const name = document.getElementById('manualName').value.trim();
    const isPhone = document.getElementById('typePhone').checked;
    
    let contact = '';
    
    // [유효성 검사] alert 대신 showModal 사용
    if (isPhone) {
        contact = document.getElementById('manualPhone').value.trim();
        if (contact.length < 12) return showModal("전화번호를 올바르게 입력해주세요.\n(숫자만 입력하면 됩니다)");
    } else {
        contact = document.getElementById('manualEmail').value.trim();
        if (!contact.includes('@')) return showModal("올바른 이메일 형식이 아닙니다.");
    }

    if (!name) return showModal("이름을 입력해주세요.");

    // 로딩 시작
    showLoading(true, '조합원 명부 검색 중...');

    // 수동 매칭 RPC 호출
    const { data, error } = await _supabase.rpc('manual_claim_member', {
        p_name: name,
        p_contact: contact
    });

    showLoading(false);

    if (error) {
        showModal("오류 발생: " + error.message);
    } else if (data.success) {
        // [성공] 모달 닫고 -> 환영 메시지 모달 띄움 -> 확인 누르면 대시보드 로드
        document.getElementById('manualMatchModal').style.display = 'none';
        
        // ★ 환영 알럿을 모달로 변경
        // showConfirmModal을 응용해서 '확인' 버튼만 있는 환영창으로 씀
        // (또는 showModal을 쓰고 콜백이 필요하면 커스텀해야 하지만, 
        //  여기서는 showModal 후 바로 로드해도 사용자가 인지함)
        
        showModal("🎉 반갑습니다! 정보를 찾았습니다.\n계정이 성공적으로 연결되었습니다.");
        
        // 연결됐으니 대시보드 로드 (모달 뒤에서 로드됨)
        document.getElementById('headerLogoutBtn').classList.remove('hidden');
        await loadDashboardData(curAuth.id);
        
    } else {
        // [실패]
        showModal("일치하는 정보가 없습니다.\n이름이나 연락처를 다시 확인해주세요.");
    }
}

// [수정] 수동 매칭 포기 (Alert 제거)
async function manualMatchFail() {
    await _supabase.auth.signOut();
    document.getElementById('manualMatchModal').style.display = 'none';
    showModal("가입 정보를 찾을 수 없습니다.\n사무국으로 문의해 주시기 바랍니다.");
}

   // [신규] 뷰(view_member_list)에서 마스킹 된 계좌 정보만 조회하는 함수
async function fetchMaskedBankInfo(uuid) {
    try {
        // Step 1에서 뷰를 재정의했으므로 'id' 컬럼(UUID) 사용 가능
        const { data, error } = await _supabase
            .from('view_member_list')
            .select('account_number')
            .eq('id', uuid)
            .maybeSingle();

        if (error) {
            console.warn("뷰 조회 경고:", error.message);
            return null;
        }
        return data ? data.account_number : null;
    } catch (e) { return null; }
}
// [수정] 대시보드 데이터 로드: 출자, 신청, 기부, 포인트, 배당 모두 조회
async function loadDashboardData(uuid) {
    try {
        // 1. 멤버 기본 정보 조회
        const { data: member, error: memErr } = await _supabase
            .from('coop_members')
            .select('*')
            .eq('id', uuid)
            .single();

        if (memErr || !member) {
            console.error("멤버 조회 실패:", memErr);
            if (memErr && (memErr.code === 'PGRST301' || memErr.status === 403)) {
                alert("보안을 위해 다시 로그인해주세요.");
                logout(); 
                return;
            }
            throw new Error('회원 정보를 불러올 수 없습니다.');
        }

        // 마스킹 계좌 적용
        const maskedAcc = await fetchMaskedBankInfo(uuid);
        if (maskedAcc) member.account_number = maskedAcc; 
        curMem = member; 

        // 2. [변경] 모든 자산 데이터 병렬 조회 (Promise.all)
        // member_id(text) 또는 member_uid(uuid) 중 테이블에 맞는 것 사용
        const pLedger = _supabase.from('ref_members').select('*').eq('member_id', curMem.member_id).order('deposit_date', { ascending: false });
        const pApps = _supabase.from('coop_applications').select('*').eq('member_uid', uuid).order('created_at', { ascending: false });
        
        // 추가된 자산 조회
        const pDonations = _supabase.from('coop_donations').select('*').eq('member_uid', uuid).order('donation_date', { ascending: false });
        const pPoints = _supabase.from('coop_points').select('*').eq('member_uid', uuid).order('created_at', { ascending: false });
        const pDividends = _supabase.from('coop_dividends').select('*').eq('member_id', curMem.member_id).order('paid_at', { ascending: false });

        const [resLedger, resApps, resDonations, resPoints, resDividends] = await Promise.all([pLedger, pApps, pDonations, pPoints, pDividends]);

        // 데이터 추출 (없으면 빈 배열)
        const ledger = resLedger.data || [];
        const apps = resApps.data || [];
        const donations = resDonations.data || [];
        const points = resPoints.data || [];
        const dividends = resDividends.data || [];

        // 3. 자산 총계 계산 (카드 표시용)
        const assets = {
            total_capital: ledger.reduce((acc, cur) => acc + Number(cur.amount || 0), 0),
            total_donation: donations.reduce((acc, cur) => acc + Number(cur.amount || 0), 0),
            current_points: points.reduce((acc, cur) => acc + Number(cur.change_amount || 0), 0),
            // 배당금: total_amount 합계 (세전 기준, 필요시 net_amount로 변경 가능)
            total_dividend: dividends.reduce((acc, cur) => acc + Number(cur.total_amount || 0), 0)
        };
        curMem.total_capital = assets.total_capital; // 멤버 객체에도 업데이트

        // 4. 권한 로드
        const { data: officials } = await _supabase.from('coop_officials').select('category').eq('member_id', curMem.member_id);
        const myRoles = officials ? officials.map(r => r.category) : [];

        // 5. 렌더링 호출 (모든 데이터 전달)
        // 전역 변수 대신 인자로 전달하여 순수성 유지
        renderDashboard(curMem, apps, ledger, donations, points, dividends, assets, myRoles);
        
        // [부가 기능 로드]
        if(curMem.rrn_display) checkBirthday(curMem.rrn_display, curMem.name);
        if (typeof loadFamilyList === 'function') loadFamilyList(uuid);
        if (typeof loadMiniNotices === 'function') loadMiniNotices();
        if (typeof checkIncomingConnects === 'function') checkIncomingConnects();
        loadBoard('free', null, 20); 

        if (typeof Badges !== 'undefined') {
            Badges.render('badgeContainer', uuid, _supabase);
            Badges.checkAnniversary(curMem, _supabase);
        }

        showOnly('dashboardSection');

    } catch (e) {
        console.error("Dashboard Load Error:", e);
        showLoading(false);
        showModal('데이터 로드 오류: ' + e.message);
        showOnly('loginSection');
    } finally {
        showLoading(false);
    }
}



    // =========================================================================
    // 3. 렌더링 & 내 정보 수정 (toggleEditMode 포함)
    // =========================================================================





// [헬퍼] 자산 카드 추가 (사용자님 원본 스타일: col-6 col-md-3 유지)
function addAssetCard(row, title, val, unit='원') {
    const col = document.createElement('div');
    col.className = 'col-6 col-md-3';
    col.innerHTML = `
        <div class="dashboard-card text-center p-3">
            <small class="text-muted d-block mb-1">${title}</small>
            <div class="fw-bold fs-5 text-primary">${Number(val).toLocaleString()}${unit}</div>
        </div>`;
    row.appendChild(col);
}




    // [헬퍼] 생년월일 포맷팅
    function formatBirthDate(rrn) {
        if (!rrn || rrn.length < 6) return '-';
        const yy = rrn.substring(0, 2);
        const mm = rrn.substring(2, 4);
        const dd = rrn.substring(4, 6);
        
        // 성별 코드 확인 (없으면 1900년대로 가정)
        let prefix = '19';
        if (rrn.includes('-')) {
            const gender = rrn.split('-')[1].charAt(0);
            if (gender === '3' || gender === '4') prefix = '20';
        }
        
        return `${prefix}${yy}년 ${Number(mm)}월 ${Number(dd)}일`;
    }

    // =========================================================================
    // 4. 신청 및 타임라인
    // =========================================================================

// 전역 변수로 상세 내역 모달에서 쓸 데이터를 담아둡니다.
let globalHistoryData = {}; 

// [수정] 대시보드 렌더링: 자산 카드 동적 생성 및 타임라인 통합
function renderDashboard(member, apps, ledger, donations, points, dividends, assets, myRoles) {
    // 1. 기본 정보 매핑 (기존 유지)
    renderMemberStatusBadge(member?.status);
    setText('infoMemberId', member.member_id || '-'); // 상단으로 이동된 조합원 번호
    
    // ... 생년월일, 이름, 이메일 등 기존 로직 유지 ...
    const isOrg = member?.member_type === '단체' || member?.member_type === 'organization' || member?.join_category === '단체';
    const birthBox = document.getElementById('infoBirth') ? document.getElementById('infoBirth').closest('.col-md-6') : null;
    if (isOrg) {
        if (birthBox) birthBox.classList.add('hidden');
        setText('infoBirth', '-');
        const btnPartner = document.getElementById('menuBtnPartner');
        if(btnPartner) {
            btnPartner.classList.remove('hidden');
            loadPartnerInfo(member.member_id);
        }
    } else {
        if (birthBox) birthBox.classList.remove('hidden');
        setText('infoBirth', formatBirthDate(member.rrn_display));
        const btnPartner = document.getElementById('menuBtnPartner');
        if(btnPartner) btnPartner.classList.add('hidden');
    }
    setText('infoName', member.name);
    setText('infoEmail', member.email || curAuth.email);
    setVal('editPhone', member.phone);
    setVal('editBankName', member.bank_name);
    setVal('editAccountNo', member.account_number);
    setVal('editHolder', member.account_holder);
    setText('viewPhoneBox', member.phone);
    setText('viewAddressBox', member.address);
    setVal('editAddrMain', member.address);
    setVal('editAddrDetail', '');
    const bankText = (member.bank_name || '') + ' ' + (member.account_number || '') + ' (' + (member.account_holder || '') + ')';
    setText('viewBankBox', bankText.trim() === '()' ? '-' : bankText);
    
    // 게시판 탭 권한 처리
    const tabExec = document.getElementById('tabExec');
    const tabElec = document.getElementById('tabElec');
    if (myRoles.includes('executive') && tabExec) tabExec.classList.remove('hidden');
    if (myRoles.includes('election_comm') && tabElec) tabElec.classList.remove('hidden');


    // ----------------------------------------------------
    // [2] 자산 카드 동적 생성 (핵심 변경)
    // ----------------------------------------------------
    
    // 데이터 전역 저장 (모달용)
    globalHistoryData = { ledger, donations, points, dividends };

    const assetRow = document.getElementById('assetSummaryRow');
    assetRow.innerHTML = ''; // 초기화

    // 활성 자산 목록 만들기 (금액이 0이 아니거나, 내역이 있으면 표시)
    const activeAssets = [];

    // 1. 출자금 (항상 표시 권장)
    activeAssets.push({ title: '총 납입 출자금', val: assets.total_capital, unit: '원', icon: 'bi-piggy-bank', color: '#2E7D32', type: 'ledger' });

    // 2. 기부금
    if(assets.total_donation > 0 || donations.length > 0) {
        activeAssets.push({ title: '누적 기부금', val: assets.total_donation, unit: '원', icon: 'bi-heart-fill', color: '#E91E63', type: 'donation' });
    }

    // 3. 포인트
    if(assets.current_points !== 0 || points.length > 0) {
        activeAssets.push({ title: '보유 포인트', val: assets.current_points, unit: 'P', icon: 'bi-coin', color: '#FF9800', type: 'point' });
    }

    // 4. 배당금
    if(assets.total_dividend > 0 || dividends.length > 0) {
        activeAssets.push({ title: '배당금(세전)', val: assets.total_dividend, unit: '원', icon: 'bi-graph-up-arrow', color: '#1976D2', type: 'dividend' });
    }

    // Grid 컬럼 계산 (1개면 12, 2개면 6, 3개면 4, 4개면 3)
    const count = activeAssets.length;
    let colClass = 'col-12';
    if(count === 2) colClass = 'col-6';
    else if(count === 3) colClass = 'col-md-4 col-6'; // 모바일은 2줄로
    else if(count >= 4) colClass = 'col-md-3 col-6';

    activeAssets.forEach(item => {
        const div = document.createElement('div');
        div.className = colClass;
        // 클릭 시 openHistoryModal 호출
        div.innerHTML = `
            <div class="dashboard-card text-center p-3 h-100" style="cursor:pointer; transition: transform 0.2s;" 
                 onclick="openHistoryModal('${item.type}')" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                <i class="bi ${item.icon} count-icon" style="font-size: 2rem; color: ${item.color}; margin-bottom: 10px;"></i>
                <div class="count-title" style="color: #666; font-size: 0.9rem;">${item.title}</div>
                <div class="count-val" style="font-family: 'GmarketSans'; font-weight: 700; font-size: 1.3rem; color: #333;">
                    ${Number(item.val).toLocaleString()}${item.unit}
                </div>
                <div class="text-muted x-small mt-1"><i class="bi bi-search"></i> 상세내역</div>
            </div>`;
        assetRow.appendChild(div);
    });

    // ----------------------------------------------------
    // [3] 타임라인 렌더링 (통합)
    // ----------------------------------------------------
    renderTimeline(ledger, apps, donations, points, dividends);
}

// [수정] 상세 내역 모달 (디자인 개선: 글자 확대, 여백 추가, 기부금 '구분' 제거)
function openHistoryModal(type) {
    const titleEl = document.getElementById('historyModalTitle');
    const summaryEl = document.getElementById('historyModalSummary');
    const listEl = document.getElementById('historyModalList');
    
    let title = '';
    let total = 0;
    
    // [스타일 변경] table-sm 제거(여백 확보), small 제거(글자 확대), align-middle(수직 정렬)
    let html = '<div class="table-responsive"><table class="table table-hover align-middle mb-0" style="font-size: 1rem;"><thead>';
    
    // 데이터 소스 선택 및 테이블 구성
    if(type === 'ledger') {
        title = '💰 출자금 납입 상세';
        // 날짜 - 금액 (심플 모드)
        html += '<tr class="table-success"><th class="py-3 ps-3">날짜</th><th class="text-end py-3 pe-3">금액</th></tr></thead><tbody>';
        const data = globalHistoryData.ledger || [];
        total = data.reduce((a,c)=>a+Number(c.amount),0);
        
        if(data.length === 0) html += '<tr><td colspan="2" class="text-center py-4 text-muted">내역이 없습니다.</td></tr>';
        else {
            data.forEach(item => {
                html += `<tr>
                    <td class="py-3 ps-3">${item.deposit_date ? item.deposit_date.substring(0,10) : '-'}</td>
                    <td class="text-end fw-bold py-3 pe-3 text-success" style="font-size:1.1rem">+${Number(item.amount).toLocaleString()}</td>
                </tr>`;
            });
        }
        summaryEl.innerHTML = `총 납입액: <span class="text-success fs-5 fw-bold ms-2">${Number(total).toLocaleString()}</span>원`;

    } else if(type === 'donation') {
        title = '💖 기부금 납부 상세';
        // [수정 완료] '구분' 칼럼 제거 -> 날짜 - 금액만 표시
        html += '<tr class="table-danger"><th class="py-3 ps-3">날짜</th><th class="text-end py-3 pe-3">금액</th></tr></thead><tbody>';
        const data = globalHistoryData.donations || [];
        total = data.reduce((a,c)=>a+Number(c.amount),0);

        if(data.length === 0) html += '<tr><td colspan="2" class="text-center py-4 text-muted">내역이 없습니다.</td></tr>';
        else {
            data.forEach(item => {
                html += `<tr>
                    <td class="py-3 ps-3">${item.donation_date}</td>
                    <td class="text-end fw-bold py-3 pe-3 text-danger" style="font-size:1.1rem">${Number(item.amount).toLocaleString()}</td>
                </tr>`;
            });
        }
        summaryEl.innerHTML = `총 기부액: <span class="text-danger fs-5 fw-bold ms-2">${Number(total).toLocaleString()}</span>원`;

    } else if(type === 'point') {
        title = '🪙 포인트 내역';
        // 상세 모드: 날짜 - 내용 - 변동
        html += '<tr class="table-warning"><th class="py-3 ps-3" style="width:30%">날짜</th><th class="py-3">내용</th><th class="text-end py-3 pe-3">변동</th></tr></thead><tbody>';
        const data = globalHistoryData.points || [];
        total = data.reduce((a,c)=>a+Number(c.change_amount),0);

        if(data.length === 0) html += '<tr><td colspan="3" class="text-center py-4 text-muted">내역이 없습니다.</td></tr>';
        else {
            data.forEach(item => {
                const isPlus = item.change_amount > 0;
                const style = isPlus ? 'text-primary' : 'text-danger';
                const sign = isPlus ? '+' : '';
                html += `<tr>
                    <td class="py-3 ps-3 text-muted" style="font-size:0.9rem">${item.created_at ? item.created_at.substring(0,10) : '-'}</td>
                    <td class="py-3 fw-bold text-dark">${item.reason || item.transaction_type}</td>
                    <td class="text-end fw-bold py-3 pe-3 ${style}" style="font-size:1.1rem">${sign}${Number(item.change_amount).toLocaleString()}</td>
                </tr>`;
            });
        }
        summaryEl.innerHTML = `현재 잔액: <span class="text-dark fs-5 fw-bold ms-2">${Number(total).toLocaleString()}</span> P`;

    } else if(type === 'dividend') {
        title = '📈 배당금 지급 내역';
        // 상세 모드: 연도 - 지급일 - 금액
        html += '<tr class="table-primary"><th class="py-3 ps-3">귀속년도</th><th class="py-3">지급일</th><th class="text-end py-3 pe-3">금액(세전)</th></tr></thead><tbody>';
        const data = globalHistoryData.dividends || [];
        total = data.reduce((a,c)=>a+Number(c.total_amount),0);

        if(data.length === 0) html += '<tr><td colspan="3" class="text-center py-4 text-muted">내역이 없습니다.</td></tr>';
        else {
            data.forEach(item => {
                html += `<tr>
                    <td class="py-3 ps-3 fw-bold">${item.fiscal_year}년</td>
                    <td class="py-3 text-muted">${item.paid_at ? item.paid_at.substring(0,10) : '-'}</td>
                    <td class="text-end fw-bold py-3 pe-3 text-primary" style="font-size:1.1rem">+${Number(item.total_amount).toLocaleString()}</td>
                </tr>`;
            });
        }
        summaryEl.innerHTML = `누적 지급액: <span class="text-primary fs-5 fw-bold ms-2">${Number(total).toLocaleString()}</span>원`;
    }

    html += '</tbody></table></div>';
    
    titleEl.innerText = title;
    listEl.innerHTML = html;
    
    // 모달 표시
    setModalDepth(true);
    document.getElementById('historyModalOverlay').style.display = 'flex';
}
   
// [수정] 통합 타임라인 렌더링
function renderTimeline(ledger, apps, donations, points, dividends) {
    const list = document.getElementById('timelineList');
    const items = [];

    // 1. 데이터 정규화 (모두 동일한 형태 {ts, type, html}로 변환)
    
    // (1) 출자금
    ledger.forEach(d => {
        items.push({
            ts: d.deposit_date ? new Date(d.deposit_date).getTime() : 0,
            dateStr: d.deposit_date ? d.deposit_date.substring(0,10) : '-',
            html: `
                <div class="timeline-item">
                    <div class="timeline-date">${d.deposit_date ? d.deposit_date.substring(0,10) : '-'}</div>
                    <div class="timeline-content">
                        <h6 class="fw-bold text-success"><i class="bi bi-piggy-bank me-1"></i>출자금 입금</h6>
                        <p class="text-dark fw-bold">+${Number(d.amount).toLocaleString()}원</p>
                    </div>
                </div>`
        });
    });

    // (2) 신청 내역 (Apps)
    const appTypeMap = { 'extra': '추가출자', 'reduction': '감자신청', 'withdraw': '탈퇴신청', 'connect': '계정연결' };
    apps.forEach(app => {
        let statusBadge = app.status === 'approved' ? '<span class="badge bg-success">승인</span>' : 
                          app.status === 'pending' ? '<span class="badge bg-warning text-dark">검토중</span>' : 
                          '<span class="badge bg-secondary">종료</span>';
        items.push({
            ts: app.created_at ? new Date(app.created_at).getTime() : 0,
            dateStr: app.created_at ? app.created_at.substring(0,10) : '-',
            html: `
                <div class="timeline-item" style="border-left-color: #ff9800;">
                    <div class="timeline-date">${app.created_at ? app.created_at.substring(0,10) : '-'}</div>
                    <div class="timeline-content">
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold">[신청] ${appTypeMap[app.type] || app.type}</span>
                            ${statusBadge}
                        </div>
                        <p class="small text-muted">${app.amount ? Number(app.amount).toLocaleString()+'원' : ''}</p>
                    </div>
                </div>`
        });
    });

    // (3) 기부금
    donations.forEach(d => {
        items.push({
            ts: d.donation_date ? new Date(d.donation_date).getTime() : 0,
            dateStr: d.donation_date,
            html: `
                <div class="timeline-item" style="border-left-color: #E91E63;">
                    <div class="timeline-date">${d.donation_date}</div>
                    <div class="timeline-content">
                        <h6 class="fw-bold" style="color:#E91E63"><i class="bi bi-heart-fill me-1"></i>기부금 납부</h6>
                        <p class="fw-bold">${Number(d.amount).toLocaleString()}원 <small class="fw-normal text-muted">(${d.type || '일반'})</small></p>
                    </div>
                </div>`
        });
    });

    // (4) 포인트
    points.forEach(p => {
        const isPlus = p.change_amount > 0;
        const color = isPlus ? '#FF9800' : '#757575';
        const icon = isPlus ? 'bi-plus-circle' : 'bi-dash-circle';
        items.push({
            ts: p.created_at ? new Date(p.created_at).getTime() : 0,
            dateStr: p.created_at ? p.created_at.substring(0,10) : '-',
            html: `
                <div class="timeline-item" style="border-left-color: ${color};">
                    <div class="timeline-date">${p.created_at ? p.created_at.substring(0,10) : '-'}</div>
                    <div class="timeline-content">
                        <h6 class="fw-bold" style="color:${color}"><i class="bi bi-coin me-1"></i>포인트 ${p.transaction_type}</h6>
                        <p class="fw-bold">${isPlus?'+':''}${Number(p.change_amount).toLocaleString()}P <small class="fw-normal text-muted">(${p.reason})</small></p>
                    </div>
                </div>`
        });
    });

    // (5) 배당금
    dividends.forEach(d => {
        items.push({
            ts: d.paid_at ? new Date(d.paid_at).getTime() : (d.created_at ? new Date(d.created_at).getTime() : 0),
            dateStr: d.paid_at ? d.paid_at.substring(0,10) : '-',
            html: `
                <div class="timeline-item" style="border-left-color: #1976D2;">
                    <div class="timeline-date">${d.paid_at ? d.paid_at.substring(0,10) : '-'}</div>
                    <div class="timeline-content">
                        <h6 class="fw-bold text-primary"><i class="bi bi-graph-up-arrow me-1"></i>배당금 지급 (${d.fiscal_year}년도)</h6>
                        <p class="fw-bold">${Number(d.total_amount).toLocaleString()}원</p>
                    </div>
                </div>`
        });
    });

    // 2. 정렬 (최신순) & 렌더링
    items.sort((a, b) => b.ts - a.ts);

    if(items.length === 0) {
        list.innerHTML = '<div class="text-center text-muted py-5">활동 내역이 없습니다.</div>';
    } else {
        list.innerHTML = items.map(i => i.html).join('');
    }
}

async function cancelApp(appId) {
        // confirm -> showConfirmModal
        showConfirmModal('신청을 취소하시겠습니까?', async function() {
            showLoading(true);
            const { error } = await _supabase
                .from('coop_applications')
                .update({ status: 'cancelled' })
                .eq('id', appId);

            showLoading(false);
            if(error) showModal('취소 실패: ' + error.message);
            else {
                showModal('취소되었습니다.');
                loadDashboardData(curAuth.id);
            }
        });
    }

    // 신청 로직 (Submit)
async function submitApplication(type) {
        let amount = 0, reason = '';
        const totalCap = Number(curMem.total_capital || 0);

        if(type === 'extra') {
            amount = Number(document.getElementById('exAmount').value);
            if(amount < 10000) return showModal('1만원 이상 입력해주세요.');
        } 
        else if(type === 'reduction') {
            amount = Number(document.getElementById('redAmount').value);
            if(amount <= 0) return showModal('금액을 입력해주세요.');
            if(totalCap - amount < 100000) return showModal(`잔액 10만원 이상 유지해야 합니다.\n(현재: ${totalCap.toLocaleString()}원)`);
            if(!document.getElementById('checkRedAgree').checked) return showModal('안내 사항에 동의해주세요.');
        } 
        else if(type === 'withdraw') {
            reason = document.getElementById('wdReason').value;
            if(!reason) return showModal('사유를 입력해주세요.');
            if(!document.getElementById('checkWdAgree').checked) return showModal('동의 항목에 체크해주세요.');
        }

        // confirm -> showConfirmModal
        showConfirmModal('신청서를 제출하시겠습니까?', async function() {
            showLoading(true);
            const { error } = await _supabase.from('coop_applications').insert({
                member_uid: curAuth.id,
                member_id: curMem.member_id,
                name: curMem.name,
                type: type,
                amount: amount,
                reason: reason,
                status: 'pending'
            });

            showLoading(false);
            if(error) showModal('오류: ' + error.message);
            else {
                showModal('신청되었습니다.');
                // 초기화
                document.getElementById('exAmount').value = '';
                document.getElementById('redAmount').value = '';
                document.getElementById('wdReason').value = '';
                if(document.getElementById('checkRedAgree')) document.getElementById('checkRedAgree').checked = false;
                if(document.getElementById('checkWdAgree')) document.getElementById('checkWdAgree').checked = false;
                
                loadDashboardData(curAuth.id);
            }
        });
    }

// [수정] 프로필 저장 (주소 합치기 + 모달 확인)
// [수정] 프로필 저장 (전화번호 중복 체크 및 유효성 검사 추가)
async function saveProfile() {
    // 1. 입력값 가져오기
    const phone = document.getElementById('editPhone').value.trim();
    const mainAddr = document.getElementById('editAddrMain').value;
    const detailAddr = document.getElementById('editAddrDetail').value;
    const fullAddr = (mainAddr + ' ' + detailAddr).trim();
    const bank = document.getElementById('editBankName').value;
    const accNo = document.getElementById('editAccountNo').value; // 숫자만 들어옴 (HTML 제어)
    const holder = document.getElementById('editHolder').value;

    // 2. [검증] 전화번호 유효성 체크
    if (phone.length < 12) {
        return showModal('전화번호를 올바르게 입력해주세요.\n(예: 010-1234-5678)');
    }

    // 3. [검증] 전화번호 중복 체크 (DB 조회)
    // 설명: 내 현재 번호와 다르다면, 다른 사람이 쓰고 있는지 확인합니다.
    if (phone !== curMem.phone) {
        showLoading(true, '중복 검사 중...');
        
        try {
            const { data: existing, error: checkErr } = await _supabase
                .from('coop_members')
                .select('id')
                .eq('phone', phone)      // 입력한 번호와 같고
                .neq('id', curAuth.id)   // 내 ID는 아닌 것 (나 자신 제외)
                .maybeSingle();          // 하나라도 있으면 가져옴

            showLoading(false);

            if (checkErr) {
                console.error(checkErr);
                return showModal('중복 검사 중 오류가 발생했습니다.');
            }

            if (existing) {
                return showModal('이미 등록된 전화번호입니다.\n중복 가입은 불가능합니다.');
            }

        } catch (e) {
            showLoading(false);
            return showModal('시스템 오류: ' + e.message);
        }
    }

    // 4. 저장 진행 (기존 로직)
    showConfirmModal('정보를 수정하시겠습니까?', async function() {
        showLoading(true, '저장 중...');

        const { error } = await _supabase.rpc('update_my_profile', {
            p_phone: phone,
            p_address: fullAddr,
            p_bank_name: bank,
            p_account_number: accNo,
            p_account_holder: holder
        });

        showLoading(false);

        if (error) {
            showModal('수정 실패: ' + error.message);
        } else {
            showModal('수정되었습니다.');
            toggleEditMode(false);
            // 데이터 갱신을 위해 대시보드 리로드
            loadDashboardData(curAuth.id);
        }
    });
}

// [수정] 탭 전환 (감자 한도 체크 로직 포함)
function toggleTab(type, btn) {
        document.getElementById('tabPlaceholder').classList.add('hidden');
        // [수정] tabPartner 추가
        ['tabExtra', 'tabReduction', 'tabWithdraw', 'tabCert', 'tabPartner'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.classList.add('hidden');
        });

        document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        
        const targetId = 'tab' + type.charAt(0).toUpperCase() + type.slice(1);
        const targetEl = document.getElementById(targetId);
        if(targetEl) targetEl.classList.remove('hidden');

        if(type === 'reduction') {
            const total = Number(curMem.total_capital || 0);
            const limit = total - 100000;
            const display = document.getElementById('redLimitDisplay');
            const input = document.getElementById('redAmount');
            
            if(limit <= 0) {
                display.innerText = "현재 감자 신청 불가 (잔액 부족)";
                input.disabled = true;
                input.placeholder = "신청 불가";
            } else {
                display.innerText = `최대 신청 가능: ${limit.toLocaleString()}원`;
                input.disabled = false;
                input.placeholder = `최대 ${limit.toLocaleString()}`;
                
                input.oninput = function() {
                    if(Number(this.value) > limit) {
                        this.value = limit;
                        showModal(`최대 ${limit.toLocaleString()}원까지만 가능합니다.`); // alert -> showModal
                    }
                };
            }
        }
    }

async function downloadCert() {
    if(!curMem) return;
    showLoading(true, '증서 발급 중...');
    
    try {
        // 1. 납입 총액 계산
        const { data: pay } = await _supabase.from('ref_members').select('amount').eq('member_id', curMem.member_id);
        const ledgerTotal = pay ? pay.reduce((a,c)=>a+Number(c.amount),0) : 0;
        
        // 2. 최종 금액 (변수명 통일: finalTotal)
        const finalTotal = Math.max(ledgerTotal, Number(curMem.total_capital || 0));
        
        if(finalTotal === 0) { 
            showLoading(false); 
            return showModal('납입된 출자금이 없어 증명서를 발급할 수 없습니다.'); 
        }

        // 3. RPC 호출 (p_amount에 finalTotal 전달)
        // coop_certificates 테이블에 insert 권한이 있어야 함
        const { data: cert, error } = await _supabase.rpc('issue_certificate', { 
            p_member_id: curMem.member_id, 
            p_amount: finalTotal 
        });

        if (error) throw error;

        // 4. PDF 생성 (cert_generator.js 활용)
        const { data: info } = await _supabase.from('ref_company_info').select('value').eq('key', 'chairman_name').single();
        await generateContributionCert(curMem, finalTotal, cert.cert_number, info?info.value:"이사장", _supabase);
        
        showLoading(false);

    } catch(e) { 
        console.error(e); 
        showLoading(false); 
        showModal('증명서 발급 중 오류가 발생했습니다.\n' + (e.message || '')); 
    }
}

    function logout() { 
        showConfirmModal('로그아웃 하시겠습니까?', () => {
            _supabase.auth.signOut().then(() => location.reload());
        }); 
    }


// [수정] 카카오 로그인 함수 (전화번호 요청 추가)
async function startKakaoLogin() {
    try {
        showLoading(true, '카카오 로그인 페이지로 이동합니다...');

        const { data, error } = await _supabase.auth.signInWithOAuth({
            provider: 'kakao',
            options: {
                redirectTo: 'https://yonginsolar.github.io/home/membermanage.html', // 아까 고친 고정 주소
                // [핵심 추가] 카카오에게 전화번호(phone_number)와 이메일 권한을 요청함
                scopes: 'account_email phone_number' 
            }
        });

        if (error) throw error;
        
    } catch (e) {
        console.error("Kakao Login Error:", e);
        showLoading(false);
        showModal('카카오 로그인 연결 실패:\n' + e.message);
    }
}
    
    // [헬퍼] 안전한 값 설정
    function setText(id, txt) { const el=document.getElementById(id); if(el) el.innerText = txt || '-'; }
    function setVal(id, val) { const el=document.getElementById(id); if(el) el.value = val || ''; }

   // [추가] 모달 제어 함수
function showModal(msg) {
    document.getElementById('customModalMsg').innerText = msg;
    document.getElementById('btnModalNo').style.display = 'none'; // 취소버튼 숨김
    document.getElementById('btnModalYes').onclick = closeCustomModal;
    document.getElementById('customModalOverlay').style.display = 'flex';
}

// [신규] 모달 겹침 효과 제어
function setModalDepth(isPushBack) {
    const overlays = document.querySelectorAll('.custom-modal-overlay');
    // 현재 열려있는(display:flex) 모달 중, 최상위(확인창)가 아닌 것들을 찾음
    overlays.forEach(el => {
        if(el.id !== 'customModalOverlay' && el.style.display === 'flex') {
            if(isPushBack) el.classList.add('modal-depth-back');
            else el.classList.remove('modal-depth-back');
        }
    });
}

// 기존 showConfirmModal 수정 (Depth 적용)
function showConfirmModal(msg, yesCallback) {
    setModalDepth(true); // 기존 모달 뒤로 밀기
    document.getElementById('customModalMsg').innerText = msg;
    document.getElementById('btnModalNo').style.display = 'block';
    
    const overlay = document.getElementById('customModalOverlay');
    overlay.style.display = 'flex';
    
    document.getElementById('btnModalYes').onclick = function() {
        overlay.style.display = 'none';
        setModalDepth(false); // 복구
        if(yesCallback) yesCallback();
    };
    document.getElementById('btnModalNo').onclick = function() {
        overlay.style.display = 'none';
        setModalDepth(false); // 복구
    };
}

function closeCustomModal() {
    document.getElementById('customModalOverlay').style.display = 'none';
}

   // =========================================================================
    // [1] 렌더링 함수 (주소창 초기값 세팅 포함)
    // =========================================================================


    // =========================================================================
    // [2] 수정 모드 토글 (주소창 1단 ↔ 2단 전환 포함)
    // =========================================================================
function toggleEditMode(isEdit) {
    // 1. 제어할 요소들 가져오기
    const inputs = document.querySelectorAll('.readonly-text'); // input 태그들
    
    // 주소 관련
    const viewAddr = document.getElementById('viewAddressBox');
    const editAddr = document.getElementById('editAddressBox');
    
    // [추가] 전화번호 관련
    const viewPhone = document.getElementById('viewPhoneBox');
    const editPhone = document.getElementById('editPhone');

    // [추가] 계좌번호 관련
    const viewBank = document.getElementById('viewBankBox');
    const editBank = document.getElementById('editBankBox');

    // 계좌번호 입력창 (초기화용)
    const accInput = document.getElementById('editAccountNo');

    if (isEdit) {
        // [수정 모드 진입]
        
        // 버튼 제어
        document.getElementById('btnEditProfile').classList.add('hidden');
        document.getElementById('btnSaveProfile').classList.remove('hidden');
        document.getElementById('btnCancelEdit').classList.remove('hidden');
        
        // Input 속성 변경 (입력 가능하게)
        inputs.forEach(el => {
            el.readOnly = false;
            el.classList.add('editable-input');
            el.classList.remove('readonly-text');
        });

        // 계좌번호 UX (입력창 비우기)
        accInput.value = ''; 
        accInput.placeholder = '변경 시에만 입력하세요 (기존 유지)';

        // [핵심] 화면 전환 (View 숨김 -> Edit 보임)
        viewAddr.style.display = 'none';
        editAddr.style.display = 'block';

        viewPhone.style.display = 'none';
        editPhone.style.display = 'block';

        viewBank.style.display = 'none';
        editBank.style.display = 'flex'; // row 클래스이므로 flex 권장

        // 상세주소 등 edit-mode-only 클래스 보이기
        document.querySelectorAll('.edit-mode-only').forEach(el => el.style.display = 'block');

    } else {
        // [취소 / 뷰 모드 복귀]
        
        // 데이터 원복 (리로드)
        loadDashboardData(curAuth.id);
        
        // 버튼 제어
        document.getElementById('btnEditProfile').classList.remove('hidden');
        document.getElementById('btnSaveProfile').classList.add('hidden');
        document.getElementById('btnCancelEdit').classList.add('hidden');
        
        // Input 속성 변경 (읽기 전용)
        inputs.forEach(el => {
            el.readOnly = true;
            el.classList.remove('editable-input');
            el.classList.add('readonly-text');
        });

        // [핵심] 화면 전환 (Edit 숨김 -> View 보임)
        viewAddr.style.display = 'block';
        editAddr.style.display = 'none';

        viewPhone.style.display = 'block';
        editPhone.style.display = 'none';

        viewBank.style.display = 'block';
        editBank.style.display = 'none';

        document.querySelectorAll('.edit-mode-only').forEach(el => el.style.display = 'none');
    }
}

    // =========================================================================
    // [3] 다음 주소 찾기 (검색 결과를 2단 주소창에 분배)
    // =========================================================================
    function execDaumPostcode() {
        var element_layer = document.getElementById('layer');

        new daum.Postcode({
            oncomplete: function(data) {
                // 검색 결과 항목을 조합
                var addr = ''; // 주소 변수
                var extraAddr = ''; // 참고항목 변수

                // 사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
                if (data.userSelectedType === 'R') { // 도로명 주소
                    addr = data.roadAddress;
                } else { // 지번 주소
                    addr = data.jibunAddress;
                }

                // 건물명이 있고 공동주택일 경우 추가
                if(data.userSelectedType === 'R'){
                    if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)){
                        extraAddr += data.bname;
                    }
                    if(data.buildingName !== '' && data.apartment === 'Y'){
                        extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    if(extraAddr !== ''){
                        addr += ' (' + extraAddr + ')';
                    }
                }

                // ★ 값 넣기: 검색된 주소는 메인 창에, 커서는 상세 주소창으로
                document.getElementById('editAddrMain').value = addr;
                document.getElementById('editAddrDetail').value = ''; // 상세주소 초기화
                document.getElementById('editAddrDetail').focus();    // 상세주소로 포커스 이동

                // 레이어 닫기
                element_layer.style.display = 'none';
            },
            width : '100%',
            height : '100%',
            maxSuggestItems : 5
        }).embed(element_layer);

        // 레이어 보이기
        element_layer.style.display = 'block';

        // 레이어 위치 조정 (화면 중앙)
        initLayerPosition();
    }

    // (보조) 레이어 위치 잡는 함수
    function initLayerPosition(){
        var element_layer = document.getElementById('layer');
        var width = 300; 
        var height = 400;
        var borderWidth = 5;

        // 위에서 선언한 값들을 실제 element에 넣음
        element_layer.style.width = width + 'px';
        element_layer.style.height = height + 'px';
        element_layer.style.border = borderWidth + 'px solid';
        
        // 실행되는 순간의 화면 너비와 높이 값을 가져와서 중앙에 뜰 수 있도록 위치를 계산
        element_layer.style.left = (((window.innerWidth || document.documentElement.clientWidth) - width)/2 - borderWidth) + 'px';
        element_layer.style.top = (((window.innerHeight || document.documentElement.clientHeight) - height)/2 - borderWidth) + 'px';
    }

    // (보조) 닫기 버튼용 함수
    function closeDaumPostcode() {
        document.getElementById('layer').style.display = 'none';
    }

   // ==========================================
    // [추가] 1. 생일 축하 로직
    // ==========================================
    function checkBirthday(rrn, name) {
        if(!rrn || rrn.length < 4) return;
        const today = new Date();
        const mm = String(today.getMonth()+1).padStart(2,'0');
        const dd = String(today.getDate()).padStart(2,'0');
        const userBirthMMDD = rrn.substring(2, 6); // 주민번호 3~6번째 (MMDD)

        if(userBirthMMDD === mm + dd) {
            // 세션 스토리지 체크 (새로고침 시 계속 터지는 것 방지)
            if(!sessionStorage.getItem('birthdayShown')) {
                fireConfetti();
                sessionStorage.setItem('birthdayShown', 'true');
            }
            const banner = document.getElementById('birthdayBanner');
            document.getElementById('birthdayMsgName').innerText = name;
            banner.style.display = 'block';
        }
    }
    function fireConfetti() {
        if(window.confetti) {
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }
    }

    // ==========================================
    // [추가] 2. 가족/직원 관리
    // ==========================================
// ==========================================
// [가족/단체 관리] 신규 생성 & 연결 신청 로직
// ==========================================

// [수정] 모달 열기: 역할별 탭 제어 + 연결 상태 DB 조회 추가
async function openAddFamilyModal() {
    // 1. 기본 UI 초기화 (기존 유지)
    document.getElementById('familyModalOverlay').style.display = 'flex';
    document.getElementById('newFamName').value = '';
    document.getElementById('newFamId').value = '자동 생성 예정';
    
    // 2. [추가] 탭 버튼 제어 (단체는 자녀 탭 숨김)
    const tabNewBtn = document.querySelectorAll('#famModalTabs .nav-item')[0]; // 자녀 탭
    const isGroup = (curMem.member_type === '단체' || curMem.member_type === 'organization');

    if (isGroup) {
        tabNewBtn.style.display = 'none'; // 자녀 탭 숨김
        switchFamTab('connect');          // 강제로 '연결' 탭으로 이동
    } else {
        tabNewBtn.style.display = 'block'; // 개인은 자녀 탭 보임
        switchFamTab('new');               // 기본은 '자녀' 탭
    }

    // 3. [추가] 연결 상태 확인 (비동기 로직)
    // 연결 탭 영역에 로딩 표시
    const connArea = document.getElementById('famTabConnect');
    // 기존에 있던 검색창 대신 로딩바를 잠깐 띄웁니다.
    connArea.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-success mb-2"></div><br><small>연결 정보를 확인 중입니다...</small></div>';

    try {
        let isConnected = false;
        let targetInfo = null; // 연결된 상대방 정보 (이름, ID)

        if (isGroup) {
            // [단체 입장] 나를 관리하는 부모(manager_id)가 있는가?
            if (curMem.manager_id) {
                const { data: parent } = await _supabase.from('coop_members')
                    .select('name').eq('id', curMem.manager_id).single();
                
                isConnected = true;
                targetInfo = { name: parent ? parent.name : '알 수 없음', id: curMem.manager_id };
            }
        } else {
            // [개인 입장] 내가 관리하는 "단체"가 있는가? (1:1 원칙 체크)
            const { data: group } = await _supabase.from('coop_members')
                .select('id, name')
                .eq('manager_id', curAuth.id)
                .eq('member_type', '단체') // 단체만 체크 (자녀는 여러 명이어도 됨)
                .maybeSingle(); // 하나라도 있으면 가져옴
            
            if (group) {
                isConnected = true;
                targetInfo = { name: group.name, id: group.id };
            }
        }

        // 4. 상태에 따라 화면 그리기 (다음 함수 호출)
        renderConnectTabUI(connArea, isConnected, targetInfo, isGroup);

    } catch (e) {
        console.error("Connection Check Error:", e);
        connArea.innerHTML = '<div class="text-center text-danger py-3">정보 확인 실패<br>다시 시도해주세요.</div>';
    }
}

// [신규] 연결 탭 UI 렌더링 (검색창 vs 해제화면 분기)
function renderConnectTabUI(container, isConnected, targetInfo, amIGroup) {
    if (isConnected) {
        // [Case A] 이미 연결됨: 검색창 숨김 + 해제 버튼 노출
        const msg = amIGroup 
            ? `현재 <b>'${targetInfo.name}'</b> 님이<br>이 계정을 관리하고 있습니다.`
            : `현재 <b>'${targetInfo.name}'</b> (단체)를<br>관리하고 있습니다.`;

        container.innerHTML = `
            <div class="text-center py-4 bg-light rounded border">
                <div class="mb-3 text-success">
                    <i class="bi bi-link-45deg" style="font-size: 3rem;"></i>
                </div>
                <h6 class="fw-bold mb-3">연결된 계정</h6>
                <p class="text-muted mb-4 small">${msg}</p>
                
                <button class="btn btn-outline-danger btn-sm fw-bold px-4" onclick="disconnectRelation('${targetInfo.id}', ${amIGroup})">
                    <i class="bi bi-x-circle me-1"></i> 연결 해제
                </button>
            </div>
        `;
    } else {
        // [Case B] 연결 안 됨: 기존 검색창 UI 복원
        const guideMsg = amIGroup 
            ? '계정을 관리해줄 <b>대표자(개인)</b>를 찾으세요.' 
            : '관리할 <b>단체 계정</b>을 연결하세요.';

        container.innerHTML = `
            <div class="alert alert-warning border small mb-3">
                <i class="bi bi-info-circle-fill me-1"></i> ${guideMsg}
            </div>

            <div class="input-group mb-3">
                <input type="text" id="searchConnectInput" class="form-control" placeholder="이름, 이메일, 사업자번호">
                <button class="btn btn-dark" onclick="searchTargetMember()">검색</button>
            </div>

            <div id="connectResultArea" class="border rounded p-2 bg-white" style="height: 150px; overflow-y: auto;">
                <p class="text-center text-muted small py-4">검색어를 입력하세요.</p>
            </div>
        `;
    }
}

   // [신규] 연결 해제 로직 (개인/단체 공용)
async function disconnectRelation(targetId, amIGroup) {
    const confirmMsg = amIGroup 
        ? "관리자 연결을 해제하시겠습니까?\n이제 스스로 계정을 관리해야 합니다." 
        : "단체 관리를 종료하시겠습니까?";

    // 기존 showConfirmModal 사용
    showConfirmModal(confirmMsg, async () => {
        showLoading(true, '해제 처리 중...');
        
        let error = null;

        if (amIGroup) {
            // [단체 입장] 내 머리 위의 manager_id 삭제
            // (RLS 정책에 따라 자기 자신 업데이트는 보통 허용됨)
            const { error: err } = await _supabase.from('coop_members')
                .update({ manager_id: null })
                .eq('id', curAuth.id); // 내 ID 기준
            error = err;
        } else {
            // [개인 입장] 내가 관리하던 단체의 manager_id 삭제
            const { error: err } = await _supabase.from('coop_members')
                .update({ manager_id: null })
                .eq('id', targetId); // 단체의 UUID 기준
            error = err;
        }

        showLoading(false);

        if (error) {
            showModal('해제 실패: ' + error.message);
        } else {
            showModal('연결이 해제되었습니다.');
            document.getElementById('familyModalOverlay').style.display = 'none'; // 모달 닫기
            
            // 데이터 갱신 (대시보드 및 프로필 목록)
            await loadDashboardData(curAuth.id);
            if (typeof loadManagedProfiles === 'function') {
                await loadManagedProfiles(curAuth.id);
            }
        }
    });
}
   
// 2. 탭 전환
function switchFamTab(tabName) {
    const tabNew = document.getElementById('famTabNew');
    const tabConn = document.getElementById('famTabConnect');
    const btns = document.querySelectorAll('#famModalTabs .nav-link');

    if(tabName === 'new') {
        tabNew.classList.remove('hidden');
        tabConn.classList.add('hidden');
        btns[0].classList.add('active');
        btns[1].classList.remove('active');
    } else {
        tabNew.classList.add('hidden');
        tabConn.classList.remove('hidden');
        btns[0].classList.remove('active');
        btns[1].classList.add('active');
    }
}

// [수정] 1차 검증 및 동의서 모달 호출
function submitNewChild() {
    // 1. 입력값 가져오기
    const name = document.getElementById('newFamName').value;
    const rrn1 = document.getElementById('newFamRrn1').value;
    const rrn2 = document.getElementById('newFamRrn2').value;
    const capitalStr = document.getElementById('newFamCapital').value;
    const capital = Number(capitalStr);
    
    // 관계 값 결정
    const relSelect = document.getElementById('newFamRelSelect').value;
    const relInput = document.getElementById('newFamRelInput').value.trim();
    const relationship = (relSelect === '직접입력') ? relInput : relSelect;

    // 2. [검증] 필수 입력
    if(!name || rrn1.length !== 6 || rrn2.length < 1 || !relationship) {
        return showModal('필수 정보를 모두 입력해주세요.');
    }

    // 3. [검증] 미성년자 여부
    if (!isMinor(rrn1, rrn2)) {
        return showModal('가족(자녀) 신규 등록은\n미성년자만 가능합니다.');
    }

    // 4. [검증] 출자금 (10만원 이상 & 1만원 단위)
    if (capital < 100000) {
        return showModal('초기 출자금은 최소 100,000원 이상이어야 합니다.');
    }
    if (capital % 10000 !== 0) {
        return showModal('출자금은 1만원 단위로 입력해주세요.');
    }

    // 5. 동의서 모달 띄우기 (데이터 전달)
    openConsentModal({
        name, rrn1, rrn2, capital, relationship,
        bank: document.getElementById('newFamBank').value,
        acc: document.getElementById('newFamAcc').value
    });
}

// 4. [탭2] 연결 대상 검색
// [수정] 연결 대상 검색 (RPC 사용, 문법 에러 수정됨)
async function searchTargetMember() {
    const keyword = document.getElementById('searchConnectInput').value.trim();
    if(keyword.length < 2) return showModal('검색어를 2글자 이상 입력하세요.');

    const area = document.getElementById('connectResultArea');
    area.innerHTML = '<p class="text-center text-muted small py-3">검색 중...</p>';

    // 1. RPC 호출 (체이닝 없이 단독 실행)
    const { data: list, error } = await _supabase.rpc('search_profiles_for_connect', { keyword: keyword });

    if (error) {
        console.error(error);
        area.innerHTML = '<p class="text-center text-danger small py-3">검색 중 오류가 발생했습니다.</p>';
        return;
    }

    area.innerHTML = '';
    
    // 2. 나 자신 제외 필터링 (JS에서 처리)
    // (curMem이 로드된 상태여야 함)
    const myId = curMem ? curMem.id : null;
    const filteredList = list ? list.filter(m => m.id !== myId) : [];

    if(filteredList.length === 0) {
        area.innerHTML = '<p class="text-center text-muted small py-3">검색 결과가 없습니다.</p>';
        return;
    }

    let html = '<ul class="list-group list-group-flush small">';
    filteredList.forEach(m => {
        const typeBadge = m.member_type === '단체' ? '<span class="badge bg-info">단체</span>' : '<span class="badge bg-secondary">개인</span>';
        // 이메일 마스킹 (선택 사항)
        const emailDisplay = m.email || '이메일 없음';
        
        html += `
            <li class="list-group-item d-flex justify-content-between align-items-center p-2">
                <div>
                    ${typeBadge} <b>${m.name}</b>
                    <br><span class="text-muted x-small">${emailDisplay}</span>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="requestConnect('${m.id}', '${m.name}')">
                    연결 신청
                </button>
            </li>`;
    });
    html += '</ul>';
    area.innerHTML = html;
}

// 5. [탭2] 연결 신청 (Propose) -> coop_applications 테이블 활용
// [수정] 연결 신청 함수 (모달 닫기 -> 화면 스크롤 -> 인라인 메시지 표시)
async function requestConnect(targetUuid, targetName) {
    
    // confirm 모달은 유지 (사용자 실수 방지)
    showConfirmModal(`'${targetName}' 님과 연결을 신청하시겠습니까?`, async () => {
        showLoading(true);

        const { error } = await _supabase.from('coop_applications').insert({
            member_uid: curAuth.id,
            member_id: curMem.member_id,
            name: curMem.name,
            type: 'connect', 
            reason: `Target: ${targetUuid}`,
            amount: 0,
            status: 'pending'
        });

        showLoading(false);

        if(error) {
            showModal('신청 실패: ' + error.message);
        } else {
            // 1. 가족 모달 즉시 닫기
            document.getElementById('familyModalOverlay').style.display = 'none';
            
            // 2. 데이터 갱신 (비동기)
            await loadDashboardData(curAuth.id);

            // 3. [UX] 신청서 영역으로 부드럽게 스크롤 이동
            const actionArea = document.getElementById('actionArea');
            actionArea.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // 4. [UX] 신청서 상단에 성공 메시지 꽂기 (Alert 아님)
            showInlineFeedback(`✅ '${targetName}' 님에게 연결 신청을 보냈습니다.`);
        }
    });
}

// [신규] 인라인 피드백 메시지 (알럿 아님, 디자인된 박스)
function showInlineFeedback(msg) {
    const area = document.getElementById('actionArea');
    
    // 기존에 떠있는 메시지가 있다면 제거 (중복 방지)
    const oldMsg = document.getElementById('tempFeedbackMsg');
    if(oldMsg) oldMsg.remove();

    // 커스텀 메시지 박스 생성
    const div = document.createElement('div');
    div.id = 'tempFeedbackMsg';
    // 스타일: 연한 초록 배경, 짙은 초록 글씨, 깔끔한 테두리
    div.style.cssText = `
        background-color: #f1f8e9; 
        color: #2e7d32; 
        padding: 15px; 
        border-radius: 8px; 
        margin-bottom: 20px; 
        font-weight: 600; 
        text-align: center; 
        border: 1px solid #c5e1a5;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        animation: fadeIn 0.5s;
    `;
    div.innerHTML = msg;

    // actionArea의 최상단(첫번째 자식)으로 삽입
    area.prepend(div);

    // 4초 후 자동 삭제 (Fade out 효과가 필요하면 CSS 추가 필요하지만, 기능적으로는 제거가 확실함)
    setTimeout(() => {
        if(div) div.remove();
    }, 4000);
}

    async function loadFamilyList(managerUid) {
        // manager_id가 내 UUID인 멤버 조회
        const { data: fams } = await _supabase
            .from('coop_members')
            .select('*')
            .eq('manager_id', managerUid);
        
        const area = document.getElementById('familyListArea');
        if(!fams || fams.length === 0) {
            area.innerHTML = '<p class="text-muted small text-center py-3">등록된 구성원이 없습니다.</p>';
            return;
        }

        let html = '<ul class="list-group list-group-flush">';
        fams.forEach(f => {
            html += `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <span class="fw-bold">${f.name}</span>
                    <small class="text-muted ms-2">${f.member_id || '승인 대기중'}</small>
                </div>
                <span class="badge bg-light text-dark border">${f.join_category}</span>
            </li>`;
        });
        html += '</ul>';
        area.innerHTML = html;
    }

    async function submitFamily() {
        const name = document.getElementById('famName').value;
        const rrn1 = document.getElementById('famRrn1').value;
        const rrn2 = document.getElementById('famRrn2').value;
        const phone = document.getElementById('famPhone').value;

        if(!name || rrn1.length !== 6 || rrn2.length !== 1) return showModal('정보를 올바르게 입력해주세요.');

        showConfirmModal(`${name}님을 구성원으로 등록하시겠습니까?`, async () => {
            showLoading(true);
            
            // 부모 정보 복사 + 필수값 설정
            const { error } = await _supabase.from('coop_members').insert({
                manager_id: curAuth.id, // 부모 UUID 연결
                name: name,
                rrn_display: `${rrn1}-${rrn2}******`, // 마스킹 저장
                phone: phone,
                address: curMem.address, // 주소는 부모와 동일하다고 가정
                join_category: '가족', // 또는 단체면 '직원' (UI에서 선택하게 하거나 자동처리)
                status: 'active' // 즉시 활성화 (또는 pending)
            });

            showLoading(false);
            if(error) showModal('등록 실패: ' + error.message);
            else {
                showModal('등록되었습니다.');
                document.getElementById('familyModalOverlay').style.display = 'none';
                loadFamilyList(curAuth.id);
            }
        });
    }


// ==========================================
    // [게시판 로직] 공지사항(Notices) vs 게시판(Boards) 분기 처리
    // ==========================================
    let currentBoardCat = 'notice';

// [수정 4] 게시판 로드: 없는 칼럼(status) 참조 제거로 400 에러 해결
async function loadBoard(category, btn, limit = 20) {
    if (limit === 20) currentBoardLimit = 20;
    
    currentBoardCat = category;
    if(btn) {
        document.querySelectorAll('.board-tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    // 공지사항 로직 (기존 유지)
    if(category === 'notice' && !btn) {
        if(typeof openNoticeListModal === 'function') openNoticeListModal();
        return;
    }

    const btnWrite = document.getElementById('btnWritePost');
    if(btnWrite) btnWrite.classList.toggle('hidden', category === 'notice');

    const listArea = document.getElementById('boardList');
    if(limit === 20) listArea.innerHTML = '<div class="text-center py-5 text-muted">로딩중...</div>';

    // 데이터 조회
    const tableName = (category === 'notice') ? 'coop_notices' : 'coop_boards';
    
    // [핵심 수정] .eq('status', 'published') 삭제됨 -> 모든 글 조회
    const { data: posts, error } = await _supabase
        .from(tableName)
        .select('*')
        .order('created_at', { ascending: false })
        .range(0, limit - 1);

    if(error || !posts || posts.length === 0) {
        if (error) console.error("게시판 로드 실패:", error); // 디버깅용 로그
        if(limit === 20) listArea.innerHTML = '<div class="text-center py-5 text-muted">등록된 글이 없습니다.</div>';
        return;
    }

    let html = '';
    posts.forEach(p => {
        const date = p.created_at.substring(0,10);
        // HTML 태그 제거 (보안)
        const rawContent = p.content || '';
        const safeContent = rawContent.replace(/<[^>]*>?/gm, '');

        html += `
        <div class="board-list-item p-3 border-bottom" onclick="viewPost(${p.id}, '${category}')" style="cursor:pointer;">
            <div class="d-flex justify-content-between">
                <span class="fw-bold text-dark text-truncate">${p.title}</span>
                <small class="text-muted">${date}</small>
            </div>
            <div class="small text-secondary text-truncate mt-1">${safeContent}</div>
        </div>`;
    });

    html += `<div class="text-center py-3">
                <button class="btn btn-sm btn-outline-secondary rounded-pill px-4" onclick="loadMoreBoard()">더 보기 (+20)</button>
             </div>`;
             
    listArea.innerHTML = html;
}

// [신규] 더보기 실행 함수
function loadMoreBoard() {
    currentBoardLimit += 20;
    // 현재 카테고리 유지하며 갯수만 늘림
    loadBoard(currentBoardCat, null, currentBoardLimit);
}



    // [글쓰기] 모달 열기
    function openWriteModal() {
        document.getElementById('writeTitle').value = '';
        document.getElementById('writeContent').value = '';
        document.getElementById('writeFile').value = '';
        document.getElementById('writeModalOverlay').style.display = 'flex';
    }

    // [글쓰기] 등록 (자유/임원 게시판용)
    async function submitPost() {
        const title = document.getElementById('writeTitle').value;
        const content = document.getElementById('writeContent').value;
        const fileUrl = document.getElementById('writeFile').value; // 임시 파일 URL 입력

        if(!title || !content) return showModal('제목과 내용을 입력해주세요.');

        showConfirmModal('게시글을 등록하시겠습니까?', async () => {
            showLoading(true);
            
            // 파일 배열 처리
            const files = fileUrl ? [fileUrl] : [];

            const { error } = await _supabase.from('coop_boards').insert({
                category: currentBoardCat, // 현재 보고 있는 탭의 카테고리 (free, executive 등)
                title: title,
                content: content,
                files: files,
                author_name: curMem.name // 작성자 이름 기록
            });

            showLoading(false);
            if(error) showModal('등록 실패: ' + error.message);
            else {
                showModal('등록되었습니다.');
                document.getElementById('writeModalOverlay').style.display = 'none';
                loadBoard(currentBoardCat); // 목록 갱신
            }
        });
    }

    // [글보기] 상세 조회 (테이블 분기 처리 포함)
// [글보기] 상세 조회 및 버튼 권한 처리
// [수정] 게시글 상세 보기 함수 (오류 방지 및 권한 처리 강화)
async function viewPost(id, category) {
    const tableName = (category === 'notice') ? 'coop_notices' : 'coop_boards';
    
    // 1. 조회
    const { data: post, error } = await _supabase.from(tableName).select('*').eq('id', id).single();
    if(error || !post) return showModal('글을 불러오지 못했습니다.');

    // 2. 바인딩 (안전하게 ID 확인)
      
    setText('viewTitle', post.title);
    setText('viewAuthor', post.author_name || '익명');
    setText('viewDate', post.created_at ? post.created_at.substring(0,16).replace('T', ' ') : '-');
    setText('viewContent', post.content || '');

    // 3. 첨부파일
    const files = post.file_urls || post.files || [];
    const fileArea = document.getElementById('viewFiles');
    if(fileArea) {
        fileArea.innerHTML = '';
        files.forEach((f, i) => {
            fileArea.innerHTML += `<a href="${f}" target="_blank" class="btn btn-sm btn-outline-primary me-2"><i class="bi bi-download"></i> 파일 ${i+1}</a>`;
        });
    }

    // 4. 버튼 권한 (작성자 확인)
    const writerId = post.author_id; // ★ DB 칼럼 확인 필요 (author_id)
    const isMine = (curAuth && writerId && curAuth.id === writerId);
    
    // 현재 보고 있는 글 ID 전역 저장 (신고/삭제용)
    window.currentPostId = id; 

    const btnGroup = document.getElementById('viewBtnGroup');
    if(btnGroup) {
        let html = `<button class="btn btn-dark btn-sm" onclick="document.getElementById('boardViewModal').style.display='none'">닫기</button>`;
        
        // 공지사항 아니고 내 글이면 수정/삭제 노출
        if(category !== 'notice' && isMine) {
            html = `
                <button class="btn btn-warning btn-sm me-1" onclick="showModal('수정 준비중')">수정</button>
                <button class="btn btn-danger btn-sm me-1" onclick="deletePost('${post.id}')">삭제</button>
                ${html}
            `;
        }
        btnGroup.innerHTML = html;
    }

    // 5. 모달 열기
    document.getElementById('boardViewModal').style.display = 'flex';
}

// [신규] 게시글 신고 함수
function reportPost() {
    showConfirmModal('이 게시글을 관리자에게 신고하시겠습니까?', () => {
        // 실제 DB 로직은 추후 구현 (현재는 UI만 작동)
        showModal('신고가 접수되었습니다.\n관리자가 검토 후 조치합니다.');
        document.getElementById('boardViewModal').style.display = 'none';
    });
}
   // ==========================================
// [신규 기능] 프로필 전환 (Context Switching)
// ==========================================

// 1. 관리 가능한 프로필 목록 로드 및 UI 생성
// [디버깅용] 관리 가능한 프로필 목록 로드 및 UI 생성
async function loadManagedProfiles(myAuthId) {
    const switcher = document.getElementById('profileSwitcher');
    const menu = document.getElementById('profileListMenu');
    
    console.log("🔍 [Debug] 관리 프로필 조회 시작. 내 ID:", myAuthId);

    // (1) 본인 계정 정보
    const { data: me, error: errMe } = await _supabase.from('coop_members').select('id, name, member_type').eq('id', myAuthId).single();
    if(errMe) console.error("❌ 내 정보 조회 실패:", errMe);

    // (2) 내가 관리자인 계정들 가져오기 (manager_id가 나인 경우)
    const { data: subProfiles, error: errSub } = await _supabase
        .from('coop_members')
        .select('id, name, member_type')
        .eq('manager_id', myAuthId); // ★ 여기가 핵심

    if(errSub) console.error("❌ 서브 계정 조회 에러:", errSub);
    console.log("🔍 [Debug] 조회된 관리 계정 개수:", subProfiles ? subProfiles.length : 0);

    // 관리할 계정이 없으면 스위처 숨김 (여기에 걸리는지 확인 필요)
    if (!subProfiles || subProfiles.length === 0) {
        console.warn("⚠️ 관리할 계정이 0개라 드롭다운을 숨깁니다.");
        switcher.classList.add('hidden');
        return;
    }

    // (3) 리스트 만들기
    menu.innerHTML = '';
    const allProfiles = [me, ...subProfiles]; 

    allProfiles.forEach(p => {
        if(!p) return;
        const isMe = p.id === myAuthId;
        const badge = p.member_type === '단체' ? '<span class="badge bg-info ms-1">단체</span>' : '';
        const activeClass = (curMem && curMem.id === p.id) ? 'active' : ''; 

        menu.innerHTML += `
            <li>
                <button class="dropdown-item d-flex justify-content-between align-items-center ${activeClass}" onclick="switchProfile('${p.id}', '${p.name}')">
                    <span>${p.name} ${isMe ? '(나)' : ''}</span>
                    ${badge}
                </button>
            </li>`;
    });

    // 스위처 노출 (hidden 클래스 제거)
    console.log("✅ 드롭다운 메뉴 활성화 완료");
    switcher.classList.remove('hidden');
}

// 2. 프로필 전환 실행
async function switchProfile(targetUuid, targetName) {
    if(curMem && curMem.id === targetUuid) return; // 이미 선택된 프로필이면 무시

    showLoading(true, `${targetName} 님으로 전환 중...`);
    
    // ★ 핵심: 로그아웃 없이, 데이터 로드 함수만 대상 UUID로 다시 호출
    // curAuth(로그인된 정보)는 유지되고, curMem(화면 데이터)만 교체됨
    await loadDashboardData(targetUuid);
    
    // 스위처 UI 다시 그리기 (Active 상태 변경을 위해)
    await loadManagedProfiles(curAuth.id);
    
    showModal(`'${targetName}' 계정으로 전환되었습니다.\n이제 이 명의로 활동합니다.`);
}
   // [추가] 삭제 함수
async function deletePost(id) {
    showConfirmModal('정말 삭제하시겠습니까?', async () => {
        const { error } = await _supabase.from('coop_boards').delete().eq('id', id);
        if(error) showModal('삭제 실패');
        else {
            showModal('삭제되었습니다.');
            document.getElementById('boardViewModal').style.display = 'none';
            loadBoard(currentBoardCat); // 목록 갱신
        }
    });
}
   // [신규] 상단 미니 공지사항 로드
async function loadMiniNotices() {
    const listArea = document.getElementById('miniNoticeList');
    try {
        const { data: notices, error } = await _supabase
            .from('coop_notices')
            .select('id, title, created_at')
            .order('created_at', { ascending: false })
            .limit(3); // 3개만

        if (error) throw error;
        
        if (!notices || notices.length === 0) {
            listArea.innerHTML = '<p class="text-center text-muted small py-3">공지사항이 없습니다.</p>';
            return;
        }

        let html = '';
        notices.forEach(n => {
            const date = n.created_at.substring(5, 10); // MM-DD
            html += `
                <div class="notice-mini-item d-flex justify-content-between" onclick="viewPost(${n.id}, 'notice')">
                    <span class="text-truncate" style="max-width: 70%;">${n.title}</span>
                    <span class="text-muted small">${date}</span>
                </div>`;
        });
        listArea.innerHTML = html;
    } catch (e) {
        console.error(e);
        listArea.innerHTML = '<p class="text-center text-danger small">로드 실패</p>';
    }
}
   // [신규] 나에게 온 연결 요청 확인 및 렌더링
async function checkIncomingConnects() {
    // 1. RPC 호출 (Step 1에서 수정한 함수)
    const { data: requests, error } = await _supabase.rpc('get_my_pending_connects');
    
    // 2. 에러 및 데이터 체크
    if (error) {
        console.error("연결 요청 조회 실패:", error);
        return;
    }
    // requests가 null이거나 빈 배열이면 종료
    if (!requests || requests.length === 0) return;

    // 3. 알림 UI 생성
    const container = document.getElementById('dashboardSection');
    const existingAlert = document.getElementById('connectRequestAlert');
    if(existingAlert) existingAlert.remove();

    const alertDiv = document.createElement('div');
    alertDiv.id = 'connectRequestAlert';
    alertDiv.className = 'alert alert-primary border-primary d-flex flex-column gap-2 mb-4 shadow-sm';
    alertDiv.style.backgroundColor = '#e3f2fd';

    let html = `<div class="d-flex align-items-center text-primary fw-bold">
                    <i class="bi bi-link-45deg fs-3 me-2"></i>
                    계정 연결 요청이 도착했습니다!
                </div>`;

    // JSON 배열 순회
    requests.forEach(req => {
        html += `
            <div class="bg-white p-3 rounded border d-flex justify-content-between align-items-center mt-2">
                <div>
                    <span class="fw-bold text-dark">${req.requester_name}</span> 님이
                    <br><small class="text-muted">내 계정을 관리하길 원합니다.</small>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-danger" onclick="answerConnect(${req.app_id}, 'reject')">거절</button>
                    <button class="btn btn-sm btn-primary fw-bold" onclick="answerConnect(${req.app_id}, 'approve')">수락</button>
                </div>
            </div>`;
    });

    alertDiv.innerHTML = html;

    // 4. 삽입 위치: 생일 배너 다음
    const banner = document.getElementById('birthdayBanner');
    if(banner && banner.nextSibling) {
        container.insertBefore(alertDiv, banner.nextSibling);
    } else {
        container.prepend(alertDiv);
    }
}

// [신규] 연결 요청 응답 (수락/거절)
// [수정] 연결 요청 응답
async function answerConnect(appId, decision) {
    const actionText = (decision === 'approve') ? '수락' : '거절';
    
    // 모달 뎁스 효과 적용
    setModalDepth(true); 

    showConfirmModal(`정말 ${actionText}하시겠습니까?`, async () => {
        showLoading(true);
        const { error } = await _supabase.rpc('answer_connect_request', {
            p_app_id: appId, p_decision: decision
        });
        showLoading(false);

        if (error) showModal('오류: ' + error.message);
        else {
            showModal(`${actionText}되었습니다.`);
            
            // ★ 1번 해결: 승인했다면 내가 관리할 수 있는 프로필 목록을 갱신해야 함
            if(decision === 'approve') {
                await loadManagedProfiles(curAuth.id);
            }
            
            // 알림 제거 및 데이터 갱신
            loadDashboardData(curAuth.id); 
            const alertDiv = document.getElementById('connectRequestAlert');
            if(alertDiv) alertDiv.remove();
        }
        setModalDepth(false); // 뎁스 복구
    });
}
// [수정] 화면 전환 유틸리티: style 제어 방식 폐기 -> classList 제어 방식 도입
function showOnly(sectionId) {
    // 제어할 대상 섹션 ID 목록 (명시적으로 지정하여 안전성 확보)
    const sections = ['loginSection', 'dashboardSection'];

    sections.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;

        if (id === sectionId) {
            // [핵심] !important가 걸린 hidden 클래스를 '제거'해야만 화면이 보임
            el.classList.remove('hidden'); 
        } else {
            // 보이면 안 되는 섹션은 hidden 클래스 '추가'
            el.classList.add('hidden');
        }
    });
}
   // [신규] 조합원 상태 배지 렌더링 (노출만)
// [신규] 조합원 상태 배지 렌더링 (노출만)
function renderMemberStatusBadge(statusRaw) {
    const el = document.getElementById('memberStatusBadge');
    if (!el) return;

    const raw = (statusRaw || '').toString().trim();
    const lower = raw.toLowerCase();

    // 표시 텍스트(영문/내부값이 와도 한국어로 보이게)
    let label = raw || '미설정';

    // 색상 클래스
    let cls = 'badge rounded-pill bg-secondary';

    // 정상(파랑)
    if (raw === '정상' || lower === 'active' || lower === 'normal') {
        cls = 'badge rounded-pill bg-primary';
        label = '정상';
    }
    // 승인대기(노랑)
    else if (raw === '승인대기' || lower === 'pending' || lower === 'approval_pending' || lower === 'waiting') {
        cls = 'badge rounded-pill bg-warning text-dark';
        label = '승인대기';
    }
    // 탈퇴/제명(빨강)
    else if (raw === '탈퇴' || raw === '제명' || lower === 'withdrawn' || lower === 'expelled' || lower === 'removed') {
        cls = 'badge rounded-pill bg-danger';
        label = (raw === '제명' || lower === 'expelled' || lower === 'removed') ? '제명' : '탈퇴';
    }

    el.className = cls;
    el.innerText = label;
}

// [신규] 관계 '직접입력' 선택 시 입력창 토글
function toggleFamilyRelationInput() {
    const select = document.getElementById('newFamRelSelect');
    const input = document.getElementById('newFamRelInput');
    
    if (select.value === '직접입력') {
        input.classList.remove('hidden');
        input.focus();
    } else {
        input.classList.add('hidden');
        input.value = ''; // 값 초기화
    }
}

// [신규] 미성년자 판별 로직 (만 19세 미만 = true)
function isMinor(rrn1, rrn2Char) {
    if(!rrn1 || !rrn2Char) return false;
    
    const yy = parseInt(rrn1.substring(0, 2));
    const mm = parseInt(rrn1.substring(2, 4)) - 1; // 월(0~11)
    const dd = parseInt(rrn1.substring(4, 6));
    const gender = parseInt(rrn2Char.substring(0, 1));

    let fullYear;
    // 1900년대: 1, 2, 5, 6 / 2000년대: 3, 4, 7, 8
    if ([1, 2, 5, 6].includes(gender)) fullYear = 1900 + yy;
    else if ([3, 4, 7, 8].includes(gender)) fullYear = 2000 + yy;
    else return false; // 성별코드 오류 시 false 처리

    const birthDate = new Date(fullYear, mm, dd);
    const today = new Date();
    
    // 만 나이 계산
    let age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }

    return age < 19; 
}

// [신규] 동의서 모달 열기 & 최종 가입 처리
let tempChildData = null; // 데이터를 잠시 담아둘 변수

function openConsentModal(data) {
    tempChildData = data; // 데이터 임시 저장
    
    // 모달 내용 생성 (PDF 텍스트 + 체크박스)
    // 체크박스 라벨은 요청하신 대로 길게, 내용은 수정해서 쓰시면 됩니다.
    const content = `
        <div class="text-start bg-light p-3 rounded border mb-3" style="max-height: 300px; overflow-y: auto; font-size: 0.9rem; line-height: 1.6;">
            <h6 class="fw-bold text-center mb-3">[미성년자 조합원 가입 법정대리인 동의서]</h6>
            
            <p>1. <b>가입 동의:</b> 본인은 신청인(${data.name})의 법정대리인으로서 귀 협동조합 가입에 동의합니다.</p>
            <p>2. <b>내용 확인:</b> 본인은 신청인이 조합원 가입으로 발생하는 권리와 의무, 출자금 납입, 이용고 배당, 손실 발생 시 책임, 총회 의결권 등에 대해 잘 알고 있음을 확인합니다.</p>
            <p>3. <b>개인정보 활용:</b> 위 동의서와 관련해 조합에 가입되어 있지 않은 법정대리인의 개인정보 활용에 동의합니다.</p>
            <hr>
            <p class="small text-muted">수집 항목: 이름, 주민등록번호, 전화번호, 이메일, 주소, 관계<br>보유 기간: 수집·이용 목적 달성 시까지. 단, 관련 법령의 규정에 의하여 개인정보를 보유할 필요가 있는 경우, 해당 법령에서 정한 기간까지.</p>
        </div>
        
        <div class="form-check mb-2 text-start">
            <input class="form-check-input" type="checkbox" id="consentCheck1">
            <label class="form-check-label small fw-bold" for="consentCheck1">
                (필수) 위 1, 2, 3번의 동의서 내용을 모두 확인하였으며, 법정대리인으로서 신청인의 가입에 동의합니다.
            </label>
        </div>
        <div class="form-check mb-3 text-start">
            <input class="form-check-input" type="checkbox" id="consentCheck2">
            <label class="form-check-label small fw-bold text-primary" for="consentCheck2">
                (필수) 주민등록등본 및 신분증 사본 등 증빙 서류는 추후 사무국의 요청이 있을 시 별도로 제출하겠습니다.
            </label>
        </div>
    `;

    // 기존 모달 재활용
    const overlay = document.getElementById('customModalOverlay');
    document.getElementById('customModalMsg').innerHTML = content;
    
    // 버튼 커스텀
    const btnYes = document.getElementById('btnModalYes');
    const btnNo = document.getElementById('btnModalNo');
    
    btnNo.style.display = 'inline-block';
    btnNo.innerText = '취소';
    btnNo.onclick = () => { overlay.style.display = 'none'; };

    btnYes.innerText = '동의 및 가입완료';
    btnYes.onclick = executeChildJoin; // 클릭 시 실행할 함수 연결

    overlay.style.display = 'flex';
}

// [신규] 최종 DB 저장 함수
async function executeChildJoin() {
    const chk1 = document.getElementById('consentCheck1');
    const chk2 = document.getElementById('consentCheck2');

    if (!chk1.checked || !chk2.checked) {
        // 여기서 alert 대신 기존 텍스트나 스타일로 경고를 줄 수도 있지만,
        // 간단히 브라우저 알림으로 막습니다. (모달 위에 모달 띄우기 복잡함 방지)
        alert('모든 필수 항목에 동의 체크해주세요.'); 
        return;
    }

    if (!tempChildData) return;

    // 로딩 시작 (모달 닫고 로딩)
    document.getElementById('customModalOverlay').style.display = 'none';
    showLoading(true, '가입 처리 중...');

    const params = {
        p_manager_id: curAuth.id, // 부모 UUID
        p_name: tempChildData.name,
        p_rrn_display: `${tempChildData.rrn1}-${tempChildData.rrn2}******`,
        p_phone: null,   // 자녀 폰번호 없음 (독립 시 입력)
        p_address: curMem.address, // 부모 주소 상속
        p_initial_capital: tempChildData.capital,
        p_bank_name: tempChildData.bank,
        p_account_number: tempChildData.acc,
        p_account_holder: tempChildData.name
        // p_relationship 등은 RPC가 지원한다면 추가, 아니면 DB 트리거가 처리한다고 가정
    };

    // RPC 호출
    const { data, error } = await _supabase.rpc('create_full_child_member', params);

    showLoading(false);
    
    if (error) {
        showModal('가입 실패: ' + error.message);
    } else {
        showModal('🎉 가입이 완료되었습니다!\n(출자금 입금 및 관리자 승인 후 정식 조합원이 됩니다.)');
        document.getElementById('familyModalOverlay').style.display = 'none';
        
        // 목록 갱신
        loadDashboardData(curAuth.id);
        if (typeof loadManagedProfiles === 'function') {
            loadManagedProfiles(curAuth.id);
        }
    }
}

   // [전역 변수 추가] 공지사항 데이터 캐싱용 (스크립트 상단 변수 선언부에 두거나, 함수 근처에 두세요)
let cachedNoticeList = [];

// [수정] 공지사항 전체보기 모달 열기 (DB 조회 + 검색 초기화)
async function openNoticeListModal() {
    const modal = document.getElementById('noticeListModal');
    const listArea = document.getElementById('noticeListResult');
    const searchInput = document.getElementById('noticeSearchInput');

    // 1. 모달 초기화 및 표시
    searchInput.value = ''; // 검색창 비우기
    listArea.innerHTML = '<div class="d-flex justify-content-center py-5"><div class="spinner-border text-danger" role="status"></div></div>';
    modal.style.display = 'flex';

    try {
        // 2. 데이터 조회 (최신순 100개 제한)
        // status 컬럼 필터 없이 모든 공지 조회 (Step 1 논리 적용)
        const { data: notices, error } = await _supabase
            .from('coop_notices')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(100);

        if (error) throw error;

        // 3. 데이터 캐싱 및 렌더링
        cachedNoticeList = notices || [];
        renderNoticeItems(cachedNoticeList);

    } catch (e) {
        console.error(e);
        listArea.innerHTML = `<div class="text-center text-danger py-4">
            <i class="bi bi-exclamation-triangle mb-2 d-block fs-2"></i>
            목록을 불러오지 못했습니다.<br><small>${e.message}</small>
        </div>`;
    }
}

// [신규] 검색어 필터링 함수 (onkeyup 이벤트 연결)
function filterNoticeList() {
    const keyword = document.getElementById('noticeSearchInput').value.toLowerCase().trim();
    
    // 캐시된 데이터에서 제목이나 내용에 키워드가 포함된 것만 필터링
    const filtered = cachedNoticeList.filter(n => {
        const title = (n.title || '').toLowerCase();
        const content = (n.content || '').toLowerCase();
        return title.includes(keyword) || content.includes(keyword);
    });

    renderNoticeItems(filtered);
}

// [신규] 리스트 렌더링 헬퍼 함수
function renderNoticeItems(list) {
    const listArea = document.getElementById('noticeListResult');
    
    if (!list || list.length === 0) {
        listArea.innerHTML = '<div class="text-center text-muted py-5">검색 결과가 없습니다.</div>';
        return;
    }

    let html = '<div class="list-group list-group-flush">';
    list.forEach(n => {
        const date = n.created_at ? n.created_at.substring(0, 10) : '-';
        // HTML 태그 제거 (미리보기용)
        const rawContent = n.content || '';
        const safeContent = rawContent.replace(/<[^>]*>?/gm, '').substring(0, 50) + (rawContent.length > 50 ? '...' : '');

        // 클릭 시 기존 viewPost 함수 호출 (카테고리 'notice' 전달)
        // setModalDepth(true)를 추가하여 목록 모달을 뒤로 살짝 밀어주는 효과 적용
        html += `
            <button class="list-group-item list-group-item-action py-3" onclick="setModalDepth(true); viewPost(${n.id}, 'notice')">
                <div class="d-flex w-100 justify-content-between mb-1">
                    <h6 class="mb-1 fw-bold text-break">${n.title}</h6>
                    <small class="text-muted text-nowrap ms-2">${date}</small>
                </div>
                <small class="text-secondary">${safeContent}</small>
            </button>
        `;
    });
    html += '</div>';
    listArea.innerHTML = html;
}

   // [신규] 이메일 찾기 모달 열기
function openFindEmailModal() {
    // 입력창 초기화
    document.getElementById('findEmailName').value = '';
    document.getElementById('findEmailPhone').value = '';
    document.getElementById('findEmailModalOverlay').style.display = 'flex';
}

// [신규] 이메일 찾기 실행
async function tryFindEmail() {
    const name = document.getElementById('findEmailName').value.trim();
    const phone = document.getElementById('findEmailPhone').value.trim();

    // 1. 유효성 검사 (전화번호 12자리 이상: 010-XXXX-XXXX)
    if (!name || phone.length < 12) {
        // 기존 알럿 대신 모달 사용 (depth 처리 적용)
        setModalDepth(true); 
        return showModal('이름과 휴대폰 번호를 정확히 입력해주세요.');
    }

    showLoading(true, '정보 확인 중...');

    try {
        // 2. RPC 호출 (보안 함수)
        const { data, error } = await _supabase.rpc('find_member_email', {
            p_name: name,
            p_phone: phone
        });

        showLoading(false);

        if (error) {
            throw error;
        }

        // 3. 결과 처리
        if (data && data.success) {
            // 찾음
            document.getElementById('findEmailModalOverlay').style.display = 'none';
            showModal(`회원님의 이메일 주소 힌트입니다.\n\n📧 ${data.masked_email}\n\n위 주소로 다시 로그인해주세요.`);
        } else {
            // 못 찾음 (보안상 모호하게 메시지 처리)
            setModalDepth(true);
            showModal('일치하는 가입 정보를 찾을 수 없습니다.\n이름이나 전화번호를 확인해주세요.');
        }

    } catch (e) {
        showLoading(false);
        console.error(e);
        setModalDepth(true);
        showModal('오류가 발생했습니다: ' + e.message);
    }
}
   // ==========================================
// [신규] 파트너(협력단체) 신청 관련 함수
// ==========================================

// 1. 기존 파트너 정보 로드 (수정 시 편의성)
async function loadPartnerInfo(memberId) {
    if(!memberId) return;
    
    // 공개 조회가 가능하므로 public 테이블 조회
    const { data, error } = await _supabase
        .from('site_partners')
        .select('*')
        .eq('member_id', memberId)
        .maybeSingle(); // 없어도 에러 아님
    
    if(data) {
        document.getElementById('ptName').value = data.name || '';
        document.getElementById('ptDesc').value = data.description || '';
        document.getElementById('ptLink').value = data.link_url || '';
        document.getElementById('ptLogoUrl').value = data.logo_url || '';
        
        // 로고 미리보기
        if(data.logo_url) {
            const prev = document.getElementById('ptLogoPreview');
            prev.querySelector('img').src = data.logo_url;
            prev.classList.remove('hidden');
        }

        // 상태 표시
        const statusArea = document.getElementById('ptStatusMsg');
        if(data.status === 'pending') {
            statusArea.innerHTML = '<span class="text-warning">⏳ 승인 대기 중 (수정 가능)</span>';
        } else if(data.status === 'active') {
            statusArea.innerHTML = '<span class="text-success">✅ 승인됨 (수정 시 재심사)</span>';
        } else {
            statusArea.innerHTML = '';
        }
    }
}

// 2. 파트너 신청 제출 (상태 체크 + 이미지 업로드 + RPC 호출)
async function submitPartnerApplication() {
    // [1] 권한 체크: '정상' 상태가 아니면 신청 차단 (B안 적용)
    const myStatus = curMem.status || '';
    if (myStatus !== '정상' && myStatus !== 'active') {
        return showModal(`🚫 신청 불가\n\n현재 회원님의 상태는 '${myStatus}'입니다.\n출자금 납입 및 관리자 승인이 완료된\n'정상' 조합원만 파트너 신청이 가능합니다.`);
    }

    // [2] 입력값 확인
    const name = document.getElementById('ptName').value.trim();
    const desc = document.getElementById('ptDesc').value.trim();
    const link = document.getElementById('ptLink').value.trim();
    const fileInput = document.getElementById('ptLogoFile');
    let logoUrl = document.getElementById('ptLogoUrl').value; // 기존 URL

    if(!name || !desc) return showModal('단체명과 소개를 입력해주세요.');

    showConfirmModal('협력 단체 신청(수정)을 제출하시겠습니까?', async () => {
        showLoading(true, '처리 중...');

        try {
            // [3] 파일 업로드 (새 파일이 있는 경우만)
            if(fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const fileExt = file.name.split('.').pop();
                // 파일명 난수화 (충돌 방지)
                const fileName = `partners/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`;

                // assets 버킷에 업로드
                const { data: uploadData, error: uploadError } = await _supabase.storage
                    .from('assets')
                    .upload(fileName, file);

                if(uploadError) throw uploadError;

                // 공개 URL 획득
                const { data: urlData } = _supabase.storage
                    .from('assets')
                    .getPublicUrl(fileName);
                
                logoUrl = urlData.publicUrl;
            }

            // [4] RPC 호출 (DB 저장)
            // p_target_member_id에 현재 보고 있는 프로필(curMem.member_id) 전달
            const { data: result, error: rpcError } = await _supabase.rpc('request_partner_change', {
                p_target_member_id: curMem.member_id, 
                p_name: name,
                p_description: desc,
                p_link_url: link,
                p_logo_url: logoUrl
            });

            if(rpcError) throw rpcError;

            showLoading(false);

            if(result.success) {
                showModal(result.message); // RPC에서 리턴한 메시지 출력
                loadPartnerInfo(curMem.member_id); // 화면 갱신
            } else {
                showModal('오류: ' + result.message);
            }

        } catch (e) {
            showLoading(false);
            console.error(e);
            showModal('처리 중 오류가 발생했습니다.\n' + e.message);
        }
    });
}

</script>
</body>
</html>
