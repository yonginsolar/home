<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ì¡°í•©ì› ê´€ë¦¬ | ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•©</title>
    
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.css" rel="stylesheet">
    <link href="https://webfontworld.github.io/gmarket/GmarketSans.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <link rel="stylesheet" href="style.css">

    <style>
        /* [ë””ìì¸ ìˆ˜ì •] ìš”ì²­í•˜ì‹  í—¤ë”/í‘¸í„° ìŠ¤íƒ€ì¼ ì ìš© */
        
        /* 1. í—¤ë” (ê²€ì€ìƒ‰ ë°°ê²½, í°ìƒ‰ ê¸€ì”¨) */
        #header {
            background-color: #000; /* ì™„ì „ ê²€ì • */
            padding: 15px 0;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        #header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .logo h1 { margin: 0; line-height: 1; }
        .logo h1 a {
            color: #fff;
            text-decoration: none;
            font-family: 'GmarketSans', sans-serif; /* ì§€ë§ˆì¼“ ì‚°ìŠ¤ */
            font-weight: 700;
            font-size: 20px;
        }

        /* í—¤ë” ìš°ì¸¡ ì•„ì´ì½˜ ë²„íŠ¼ë“¤ */
        .header-icons a {
            color: #fff;
            font-size: 1.5rem; /* fs-4 */
            margin-left: 1rem; /* me-3 */
            text-decoration: none;
            transition: 0.3s;
            cursor: pointer;
        }
        .header-icons a:hover { color: #ff9800; }

        /* 2. í‘¸í„° (footer.js ë¡œë“œ ìœ„ì¹˜ í™•ë³´) */
        #footer {
            width: 100%;
            margin: 0;
            padding: 0;
            /* footer.js ë‚´ë¶€ ìŠ¤íƒ€ì¼ì„ ë”°ë¥´ë˜ ìœ„ì¹˜ ê³ ì • */
        }

        /* 3. ë³¸ë¬¸ ë ˆì´ì•„ì›ƒ ë³´ì • */
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #f8f9fa;
            padding-top: 80px; /* í—¤ë” ë†’ì´ë§Œí¼ ë„ì›€ */
        }

        /* ê¸°íƒ€ ìœ í‹¸ë¦¬í‹° */
        .hidden { display: none !important; }
        
        /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #eee;
            border-top: 4px solid #2E7D32; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ì¹´ë“œ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .signup-wrapper {
            background: #fff; padding: 40px 20px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            max-width: 500px; margin: 40px auto;
        }
        .card-box {
            background: #fff; padding: 30px; border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); border: 1px solid #eee;
        }
    </style>
</head>
<body>

    <header id="header">
        <div class="container">
            <div class="logo">
                <h1><a href="index.html">ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•©</a></h1>
            </div>

            <div class="header-icons d-flex align-items-center">
                <a href="index.html" title="ë©”ì¸ìœ¼ë¡œ ì´ë™">
                    <i class="bi bi-house-door"></i>
                </a>
                <a href="#" onclick="logout()" id="headerLogoutBtn" style="display:none;" title="ë¡œê·¸ì•„ì›ƒ">
                    <i class="bi bi-box-arrow-right"></i>
                </a>
            </div>
        </div>
    </header>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div style="margin-top:15px; font-weight:bold; color:#555;" id="loadingMsg">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
    </div>

    <main class="container py-4" style="min-height: 80vh;">
        
        <div id="loginSection">
            <div class="signup-wrapper">
                <h2 style="text-align: center; font-family:'GmarketSans'; margin-bottom:30px;">ì¡°í•©ì› ë¡œê·¸ì¸</h2>
                
                <div style="background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom: 20px; font-size:14px; color:#555;">
                    <i class="bi bi-envelope-check"></i> ê°€ì… ì‹œ ë“±ë¡í•œ <b>ì´ë©”ì¼ ì£¼ì†Œ</b>ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>
                    ì…ë ¥í•˜ì‹  ì´ë©”ì¼ë¡œ <b>ë¡œê·¸ì¸ ë§í¬</b>ë¥¼ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.
                </div>

                <div class="d-flex" style="gap:5px; margin-bottom:10px;">
                    <input type="email" id="emailInput" class="form-control" style="padding:12px; width:100%; border:1px solid #ddd; border-radius:8px;" placeholder="example@email.com" onkeyup="if(event.key==='Enter') sendMagicLink()">
                    <button onclick="sendMagicLink()" style="background:#333; color:#fff; border:none; padding:0 20px; border-radius:8px; white-space:nowrap;">ë§í¬ ë°›ê¸°</button>
                </div>

                <div id="sentMsgBox" class="hidden" style="margin-top: 20px; text-align: center;">
                    <div style="font-size: 50px;">ğŸ“§</div>
                    <h3 style="font-size:18px; font-weight:bold; margin:10px 0;">ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”!</h3>
                    <p style="color:#666; font-size:14px;">
                        <span id="targetEmail" style="color:#2E7D32; font-weight:bold;"></span>(ìœ¼)ë¡œ<br>
                        ë¡œê·¸ì¸ ë§í¬ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
                        ë©”ì¼í•¨ì˜ <b>[Log in]</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
                    </p>
                </div>
            </div>
        </div>

        <div id="dashboardSection" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0; font-family:'GmarketSans'; font-size:24px;">ë‚˜ì˜ ì¡°í•©ì› ì •ë³´</h2>
            </div>

            <div class="row" style="display:flex; gap:15px; flex-wrap:wrap; margin-bottom:30px;">
                <div class="card-box" style="flex:1; min-width:280px; text-align:center;">
                    <i class="bi bi-person-circle" style="font-size:40px; color:#2E7D32;"></i>
                    <h3 id="sumName" style="margin:10px 0;">-</h3>
                    <p class="text-muted mb-0">ì¡°í•©ì› ë²ˆí˜¸: <span id="sumId">-</span></p>
                </div>
                <div class="card-box" style="flex:1; min-width:280px; text-align:center;">
                    <i class="bi bi-piggy-bank" style="font-size:40px; color:#2E7D32;"></i>
                    <h3 id="sumTotal" style="margin:10px 0;">0ì›</h3>
                    <p class="text-muted mb-0">ì´ ë‚©ì… ì¶œìê¸ˆ</p>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px;">
                <div class="card-box">
                    <h4 style="font-family:'GmarketSans'; border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:20px;">ì—…ë¬´ ì‹ ì²­</h4>
                    
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
                        <button onclick="toggleTab('extra')" class="menu-btn" style="padding:10px; border:1px solid #ddd; background:#fff; border-radius:5px;">ì¶”ê°€ ì¶œì</button>
                        <button onclick="toggleTab('reduction')" class="menu-btn" style="padding:10px; border:1px solid #ddd; background:#fff; border-radius:5px;">ê°ì ì‹ ì²­</button>
                        <button onclick="toggleTab('withdraw')" class="menu-btn" style="padding:10px; border:1px solid #ddd; background:#fff; border-radius:5px;">íƒˆí‡´ ì‹ ì²­</button>
                        <button onclick="downloadCert()" class="menu-btn" style="padding:10px; border:1px solid #2E7D32; color:#2E7D32; background:#fff; border-radius:5px; font-weight:bold;">ì¦ëª…ì„œ</button>
                    </div>

                    <div id="tabContent" style="background:#f9f9f9; padding:15px; border-radius:10px;">
                        <div id="tabPlaceholder" class="text-center text-muted">ë©”ë‰´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>

                        <div id="tabExtra" class="hidden">
                            <h6>ì¶”ê°€ ì¶œì ì‹ ì²­</h6>
                            <input type="number" id="exAmount" class="form-control mb-2" style="width:100%; padding:8px;" placeholder="ê¸ˆì•¡ ì…ë ¥ (ì›)">
                            <button onclick="submitApplication('extra')" style="width:100%; background:#2E7D32; color:white; border:none; padding:10px; border-radius:5px;">ì‹ ì²­í•˜ê¸°</button>
                        </div>
                        <div id="tabReduction" class="hidden">
                            <h6>ê°ì ì‹ ì²­</h6>
                            <input type="number" id="redAmount" class="form-control mb-2" style="width:100%; padding:8px;" placeholder="í™˜ê¸‰ ìš”ì²­ì•¡">
                            <button onclick="submitApplication('reduction')" style="width:100%; background:#2E7D32; color:white; border:none; padding:10px; border-radius:5px;">ì‹ ì²­í•˜ê¸°</button>
                        </div>
                        <div id="tabWithdraw" class="hidden">
                            <h6 style="color:red;">íƒˆí‡´ ì‹ ì²­</h6>
                            <textarea id="wdReason" class="form-control mb-2" style="width:100%; padding:8px;" placeholder="ì‚¬ìœ  ì…ë ¥"></textarea>
                            <button onclick="submitApplication('withdraw')" style="width:100%; background:#333; color:white; border:none; padding:10px; border-radius:5px;">ì‹ ì²­í•˜ê¸°</button>
                        </div>
                    </div>
                </div>

                <div class="card-box">
                    <h4 style="font-family:'GmarketSans'; border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:20px;">ìµœê·¼ í™œë™</h4>
                    <div id="timelineList">
                        <p class="text-center text-muted">ë¡œë”© ì¤‘...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer id="footer"></footer>
    <script src="footer.js"></script>

    <script>
        // =========================================================================
        // Supabase ì„¤ì •
        // =========================================================================
        const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let curMem = null;

        // ë¡œë”© UI ì œì–´
        function showLoading(show, msg) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
            if(msg) document.getElementById('loadingMsg').innerText = msg;
        }

        // ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) {
                handleLoginSuccess(session.user);
            }
        });

        // 1. ë§¤ì§ë§í¬ ë°œì†¡
        async function sendMagicLink() {
            const email = document.getElementById('emailInput').value.trim();
            if(!email.includes('@')) return alert('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.');

            showLoading(true, 'ì¸ì¦ ë©”ì¼ ë°œì†¡ ì¤‘...');
            
            // â˜… ì¤‘ìš”: í˜„ì¬ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì„¤ì •
            const { error } = await _supabase.auth.signInWithOtp({
                email: email,
                options: { 
                    shouldCreateUser: false, 
                    emailRedirectTo: window.location.href 
                }
            });

            showLoading(false);

            if(error) {
                alert('ì˜¤ë¥˜: ' + error.message);
            } else {
                document.getElementById('sentMsgBox').classList.remove('hidden');
                document.getElementById('targetEmail').innerText = email;
            }
        }

        // 2. ë¡œê·¸ì¸ ì„±ê³µ í›„ ë°ì´í„° ë¡œë“œ
        async function handleLoginSuccess(user) {
            showLoading(true, 'ì¡°í•©ì› ì •ë³´ í™•ì¸ ì¤‘...');
            document.getElementById('headerLogoutBtn').style.display = 'block'; // í—¤ë” ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í‘œì‹œ

            // RPC í˜¸ì¶œ (ìˆ˜ì •ëœ claim_member_profile í•¨ìˆ˜ê°€ í•„ìš”í•¨)
            const { data: claimRes, error: claimErr } = await _supabase.rpc('claim_member_profile');

            if (claimErr || (!claimRes.success && claimRes.message === 'not_found')) {
                showLoading(false);
                await _supabase.auth.signOut();
                alert('ë¡œê·¸ì¸í•œ ì´ë©”ì¼ê³¼ ì¼ì¹˜í•˜ëŠ” ì¡°í•©ì› ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.\n(ê°€ì… ì‹œ ë“±ë¡ëœ ì´ë©”ì¼ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.)');
                return;
            }

            // ë°ì´í„° ì¡°íšŒ ë° í™”ë©´ ì „í™˜
            await loadDashboard(user.id);
        }

        async function loadDashboard(uuid) {
            try {
                // ë‚´ ì •ë³´ ì¡°íšŒ
                const { data: member } = await _supabase.from('coop_members').select('*').eq('id', uuid).single();
                curMem = member;

                // í™”ë©´ ë Œë”ë§
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('dashboardSection').classList.remove('hidden');

                document.getElementById('sumName').innerText = member.name;
                document.getElementById('sumId').innerText = member.member_id;
                document.getElementById('sumTotal').innerText = (member.pledge_amount || 0).toLocaleString() + 'ì›';

                // ë‚´ì—­ ì¡°íšŒ (ì˜ˆì‹œ)
                const { data: apps } = await _supabase.from('coop_applications').select('*').eq('member_uid', uuid);
                renderTimeline(apps || []);

                showLoading(false);
            } catch (e) {
                console.error(e);
                showLoading(false);
                alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
            }
        }

        function renderTimeline(list) {
            const el = document.getElementById('timelineList');
            if(list.length === 0) {
                el.innerHTML = '<p class="text-center text-muted">ìµœê·¼ í™œë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            let html = '';
            list.forEach(item => {
                html += `<div style="padding:10px; border-bottom:1px solid #f0f0f0;">
                    <span style="font-weight:bold;">${item.type}</span> 
                    <span style="float:right;">${Number(item.amount).toLocaleString()}ì›</span>
                    <div style="font-size:12px; color:#888;">${item.created_at.substring(0,10)} - ${item.status}</div>
                </div>`;
            });
            el.innerHTML = html;
        }

        // íƒ­ ê¸°ëŠ¥
        function toggleTab(type) {
            document.getElementById('tabPlaceholder').classList.add('hidden');
            ['tabExtra', 'tabReduction', 'tabWithdraw'].forEach(id => document.getElementById(id).classList.add('hidden'));
            
            const target = document.getElementById('tab' + type.charAt(0).toUpperCase() + type.slice(1));
            if(target) target.classList.remove('hidden');
        }

        async function submitApplication(type) {
            let amount = 0;
            if(type === 'extra') amount = document.getElementById('exAmount').value;
            if(type === 'reduction') amount = document.getElementById('redAmount').value;
            
            if(!confirm('ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            const { error } = await _supabase.from('coop_applications').insert({
                member_uid: curMem.id,
                member_id: curMem.member_id,
                name: curMem.name,
                type: type,
                amount: amount || 0
            });

            if(error) alert('ì‹¤íŒ¨: ' + error.message);
            else {
                alert('ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadDashboard(curMem.id);
            }
        }
        
        function downloadCert() {
            alert('PDF ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ ì¤€ë¹„ì¤‘');
        }

        function logout() {
            if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                _supabase.auth.signOut().then(() => location.reload());
            }
        }
    </script>
</body>
</html>
