<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>조합원 관리 - 용인모두의햇빛협동조합</title>
  
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.css" rel="stylesheet">
  <link href="https://webfontworld.github.io/gmarket/GmarketSans.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="cert_generator.js"></script>

  <link href="style.css" rel="stylesheet">
  
  <style>
    /* [기본 설정] 폰트 및 바디 */
    body {
        font-family: 'Pretendard', sans-serif;
        background-color: #f8f9fa;
        padding-top: 80px; /* 헤더 높이만큼 띄움 */
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }

    /* [헤더] 규정집 스타일 그대로 적용 (검은색) */
    #header {
        background-color: #000;
        padding: 15px 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .logo h1 a {
        font-family: 'GmarketSans', sans-serif;
        font-weight: 700;
        font-size: 20px;
        text-decoration: none;
        color: #fff !important;
    }
    .header-link {
        color: #fff;
        text-decoration: none;
        margin-left: 20px;
        font-size: 1.2rem;
        cursor: pointer;
        transition: 0.3s;
    }
    .header-link:hover { color: #ff9800; }

    /* [푸터] 하단 고정 및 스타일 */
    #footer {
        margin-top: auto;
        background: #111; /* 배경색 강제 지정 (CSS 로드 전 깨짐 방지) */
        color: #fff;
    }

    /* [로그인 섹션] 카드 스타일 */
    .signup-wrapper {
        background: #fff;
        padding: 40px 30px;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        max-width: 500px;
        margin: 40px auto;
        border: 1px solid #eee;
    }
    .form-title {
        font-family: 'GmarketSans';
        font-weight: 700;
        text-align: center;
        margin-bottom: 30px;
        color: #333;
    }
    
    /* [대시보드] 카드 박스 */
    .dashboard-card {
        background: #fff;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        border: 1px solid #f0f0f0;
        height: 100%;
    }
    .count-icon {
        font-size: 2.5rem;
        color: #2E7D32;
        margin-bottom: 10px;
    }
    .count-title {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 5px;
    }
    .count-val {
        font-family: 'GmarketSans';
        font-weight: 700;
        font-size: 1.5rem;
        color: #333;
    }

    /* [타임라인] 활동 내역 스타일 (필수 복구) */
    .timeline-item {
        padding: 0 0 20px 20px;
        border-left: 2px solid #e0e0e0;
        position: relative;
    }
    .timeline-item::before {
        content: "";
        position: absolute;
        width: 12px; height: 12px;
        border-radius: 50%;
        left: -7px; top: 5px;
        background: #fff;
        border: 2px solid #2E7D32;
    }
    .timeline-date {
        font-size: 0.8rem;
        color: #999;
        margin-bottom: 3px;
    }
    .timeline-content h5 {
        font-size: 1rem;
        font-weight: 600;
        margin: 0;
        color: #333;
    }
    .timeline-content p {
        font-size: 0.9rem;
        color: #666;
        margin: 0;
    }

    /* [메뉴 탭] 버튼 스타일 */
    .menu-btn {
        width: 100%;
        text-align: left;
        padding: 15px;
        margin-bottom: 10px;
        border: 1px solid #eee;
        background: #fff;
        border-radius: 10px;
        font-weight: 600;
        color: #555;
        transition: all 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .menu-btn:hover {
        background: #f8f9fa;
        border-color: #2E7D32;
        color: #2E7D32;
    }
    .menu-btn.active {
        background: #2E7D32;
        color: #fff;
        border-color: #2E7D32;
    }
    .menu-icon { font-size: 1.2rem; margin-right: 10px; }

    /* 로딩 오버레이 */
    #loadingOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.95);
        z-index: 9999;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    
    /* 유틸리티 */
    .hidden { display: none !important; }
    .text-green { color: #2E7D32 !important; }
  </style>
</head>

<body>

  <header id="header" class="fixed-top">
    <div class="container d-flex align-items-center justify-content-between">
      
      <div class="logo">
        <h1><a href="index.html">용인모두의햇빛협동조합</a></h1>
      </div>

      <div class="d-flex align-items-center">
          <a href="index.html" class="header-link" title="메인으로 이동">
              <i class="bi bi-house-door"></i>
          </a>
          <a href="#" onclick="logout()" id="headerLogoutBtn" class="header-link hidden" title="로그아웃">
              <i class="bi bi-box-arrow-right"></i>
          </a>
      </div>

    </div>
  </header>

  <div id="loadingOverlay">
      <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;"></div>
      <div class="mt-3 fw-bold text-secondary" id="loadingMsg">잠시만 기다려주세요</div>
  </div>

  <main class="container py-4">
    
    <div id="loginSection">
        <div class="signup-wrapper">
            <h2 class="form-title">조합원 공간</h2>
            
            <div class="alert alert-light border d-flex align-items-center" role="alert">
                <i class="bi bi-info-circle-fill text-success fs-4 me-3"></i>
                <div>
                    가입 시 등록한 <b>이메일</b>을 입력해주세요.<br>
                    <small class="text-muted">입력하신 메일로 로그인 링크를 보내드립니다.</small>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold small text-secondary">이메일 주소</label>
                <div class="input-group">
                    <input type="email" id="emailInput" class="form-control form-control-lg" placeholder="example@email.com" onkeyup="if(event.key==='Enter') sendMagicLink()">
                    <button class="btn btn-dark" type="button" onclick="sendMagicLink()">링크 받기</button>
                </div>
            </div>

            <div id="sentMsgBox" class="text-center hidden mt-4 p-4 bg-light rounded">
                <i class="bi bi-envelope-check text-success" style="font-size: 3rem;"></i>
                <h4 class="fw-bold mt-2">메일함을 확인해주세요!</h4>
                <p class="text-muted mb-3">
                    <span id="targetEmail" class="fw-bold text-dark"></span>(으)로<br>
                    로그인 링크가 발송되었습니다.
                </p>
                <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">이메일 다시 입력하기</button>
            </div>

            <div class="mt-4 pt-4 border-top">
                <button class="btn btn-warning w-100 fw-bold py-3" onclick="startKakaoLogin()">
                    <i class="bi bi-chat-fill me-2"></i> 카카오로 바로 시작하기
                </button>
                <div class="text-center mt-2">
                    <small class="text-muted">(기존에 카카오를 연동한 조합원만 가능합니다)</small>
                </div>
            </div>
        </div>
    </div>


        
<div id="dashboardSection" class="hidden">
        
        <div class="dashboard-card mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold m-0"><i class="bi bi-person-lines-fill me-2"></i>내 정보</h5>
                <div>
                    <button class="btn btn-sm btn-outline-secondary" id="btnEditProfile" onclick="toggleEditMode(true)">정보 수정</button>
                    <button class="btn btn-sm btn-success hidden" id="btnSaveProfile" onclick="saveProfile()">저장</button>
                    <button class="btn btn-sm btn-light hidden" id="btnCancelEdit" onclick="toggleEditMode(false)">취소</button>
                </div>
            </div>
            
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="small text-muted">이름</label>
                    <div class="fw-bold" id="infoName">-</div>
                </div>
                <div class="col-md-6">
                    <label class="small text-muted">생년월일</label>
                    <div class="fw-bold" id="infoBirth">-</div>
                </div>
                <div class="col-md-6">
                    <label class="small text-muted">이메일 (변경불가)</label>
                    <div class="fw-bold text-secondary" id="infoEmail">-</div>
                </div>

                <div class="col-md-6">
                    <label class="small text-muted">전화번호</label>
                    <input type="text" id="editPhone" class="readonly-text" readonly>
                </div>

                <div class="col-12">
                    <label class="small text-muted">주소</label>
                    <div class="input-group">
                        <input type="text" id="editAddress" class="readonly-text" readonly>
                        <button class="btn btn-outline-secondary edit-mode-only" style="display:none;" onclick="execDaumPostcode()">주소 검색</button>
                    </div>
                </div>

                <div class="col-12 border-top pt-2 mt-2">
                    <label class="small text-success fw-bold">환급/배당 계좌</label>
                    <div class="row g-2">
                        <div class="col-4">
                            <input type="text" id="editBankName" class="readonly-text" placeholder="은행명" readonly>
                        </div>
                        <div class="col-8">
                            <input type="text" id="editAccountNo" class="readonly-text" placeholder="계좌번호" readonly>
                        </div>
                        <div class="col-12">
                            <input type="text" id="editHolder" class="readonly-text" placeholder="예금주" readonly>
                        </div>
                    </div>
                    <small class="text-muted edit-mode-only" style="display:none; font-size:0.8rem;">* 계좌번호를 수정하지 않으면 기존 정보(마스킹)가 유지됩니다.</small>
                </div>
            </div>
        </div>


  <div class="row g-3 mb-4">
            <div class="col-md-6 col-lg-4">
                <div class="dashboard-card text-center">
                    <i class="bi bi-person-badge count-icon" style="font-size: 2.5rem; color: #2E7D32; margin-bottom: 10px;"></i>
                    <div class="count-title" style="color: #666; font-size: 0.9rem;">조합원 번호</div>
                    <div class="count-val" id="sumId" style="font-family: 'GmarketSans'; font-weight: 700; font-size: 1.5rem; color: #333;">-</div>
                </div>
            </div>
            <div class="col-md-6 col-lg-4">
                <div class="dashboard-card text-center">
                    <i class="bi bi-piggy-bank count-icon" style="font-size: 2.5rem; color: #2E7D32; margin-bottom: 10px;"></i>
                    <div class="count-title" style="color: #666; font-size: 0.9rem;">총 납입 출자금</div>
                    <div class="count-val text-green" id="sumTotal" style="font-family: 'GmarketSans'; font-weight: 700; font-size: 1.5rem; color: #2E7D32;">0원</div>
                </div>
            </div>
            <div class="col-md-12 col-lg-4">
                <div class="dashboard-card text-center d-flex flex-column justify-content-center align-items-center">
                   <div class="count-title mb-2" style="color: #666; font-size: 0.9rem;">환급/배당 계좌</div>
                   <div class="fw-bold fs-5" id="sumBank">등록된 계좌 없음</div>
                   <small class="text-muted mt-1" style="font-size:0.8rem;">변경은 '정보 수정' 버튼 클릭</small>
                </div>
            </div>
        </div>

  
        <div class="row g-4">
            <div class="col-lg-5">
                <div class="dashboard-card">
                    <h5 class="fw-bold mb-3 border-bottom pb-2">업무 신청</h5>
                    
                    <div class="d-grid gap-2">
                        <button class="menu-btn" onclick="toggleTab('extra', this)"><span><i class="bi bi-plus-circle me-2"></i>추가 출자</span><i class="bi bi-chevron-right"></i></button>
                        <button class="menu-btn" onclick="toggleTab('reduction', this)"><span><i class="bi bi-dash-circle me-2"></i>감자 신청</span><i class="bi bi-chevron-right"></i></button>
                        <button class="menu-btn" onclick="toggleTab('withdraw', this)"><span><i class="bi bi-box-arrow-left me-2"></i>탈퇴 신청</span><i class="bi bi-chevron-right"></i></button>
                        <button class="menu-btn" onclick="toggleTab('cert', this)"><span><i class="bi bi-file-earmark-pdf me-2"></i>증명서 발급</span><i class="bi bi-chevron-right"></i></button>
                    </div>

                    <div id="actionArea" class="mt-4 bg-light p-3 rounded">
                        <div id="tabPlaceholder" class="text-center text-muted small py-3">메뉴를 선택해주세요.</div>

                        <div id="tabExtra" class="hidden">
                            <h6 class="fw-bold mb-3">추가 출자 신청</h6>
                            <div class="mb-3">
                                <label class="form-label small">약정 금액 (1만원 단위)</label>
                                <input type="number" id="exAmount" class="form-control" placeholder="금액 입력" step="10000">
                            </div>
                            <button class="btn btn-success w-100 fw-bold" onclick="submitApplication('extra')">신청하기</button>
                        </div>

                        <div id="tabReduction" class="hidden">
                            <h6 class="fw-bold mb-3">감자 신청</h6>
                            <div class="alert alert-warning small py-2"><i class="bi bi-exclamation-triangle me-1"></i> 최소 10만원 이상의 출자금은 유지해야 합니다.</div>
                            <div class="mb-3">
                                <label class="form-label small">환급 요청액</label>
                                <input type="number" id="redAmount" class="form-control" placeholder="금액 입력">
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="checkRedAgree">
                                <label class="form-check-label small" for="checkRedAgree">
                                    감자는 다음년도 총회 승인 후 처리되며,<br>자산 상황에 따라 조정될 수 있음을 확인합니다.
                                </label>
                            </div>
                            <button class="btn btn-success w-100 fw-bold" onclick="submitApplication('reduction')">신청하기</button>
                        </div>

                        <div id="tabWithdraw" class="hidden">
                            <h6 class="fw-bold text-danger mb-3">탈퇴 신청</h6>
                            <div class="mb-3">
                                <label class="form-label small">탈퇴 사유</label>
                                <textarea id="wdReason" class="form-control" rows="3" placeholder="사유를 입력해주세요"></textarea>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="checkWdAgree">
                                <label class="form-check-label small text-danger fw-bold" for="checkWdAgree">
                                    탈퇴 시 출자금은 다음년도 총회 승인 후<br>환급됨을 확인하였습니다.
                                </label>
                            </div>
                            <button class="btn btn-dark w-100 fw-bold" onclick="submitApplication('withdraw')">탈퇴 신청</button>
                        </div>

                        <div id="tabCert" class="hidden text-center py-3">
                            <h6 class="fw-bold">출자 증명서</h6>
                            <p class="small text-muted">현재 납입된 출자금을 기준으로<br>PDF 증명서를 생성합니다.</p>
                            <button class="btn btn-outline-success w-100 fw-bold" onclick="downloadCert()">
                                <i class="bi bi-download me-2"></i>다운로드
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-7">
                <div class="dashboard-card">
                    <h5 class="fw-bold mb-4 border-bottom pb-2">최근 활동 내역</h5>
                    <div id="timelineList" style="max-height: 600px; overflow-y: auto;">
                        <p class="text-center text-muted py-5">내역을 불러오는 중...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </main>

  <footer id="footer"></footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="footer.js"></script>

  <script>
    // =========================================================================
    // 1. Supabase 설정 (사용자 제공 키 적용)
    // =========================================================================
    const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
    
    let _supabase = null;
    let curMem = null; // 조합원 정보
    let curAuth = null; // 인증 정보

    // 초기화 시도
    try {
        _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch (e) {
        console.error("Supabase Init Error", e);
        alert("시스템 연결 오류");
    }

    // 로딩 UI 제어
    function showLoading(show, msg) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        if(msg) document.getElementById('loadingMsg').innerText = msg;
    }

    // 초기 로드: 세션 확인
    window.addEventListener('DOMContentLoaded', async () => {
        if(!_supabase) return;
        
        // URL에 포함된 토큰으로 세션 복구
        const { data: { session } } = await _supabase.auth.getSession();
        
        if (session) {
            handleLoginSuccess(session.user);
        }
    });

    // =========================================================================
    // 2. 로그인 로직 (매직링크)
    // =========================================================================
    async function sendMagicLink() {
        if(!_supabase) return;
        const email = document.getElementById('emailInput').value.trim();
        if(!email.includes('@')) return alert('올바른 이메일 형식이 아닙니다.');

        showLoading(true, '인증 메일 발송 중...');
        
        // ★ emailRedirectTo: 현재 페이지로 다시 돌아오도록 설정
        const { error } = await _supabase.auth.signInWithOtp({
            email: email,
            options: { 
                shouldCreateUser: false, // 기존 회원만
                emailRedirectTo: window.location.href 
            }
        });

        showLoading(false);

        if(error) {
            // 사용자 미등록 에러 처리
            if(error.message.includes('Signups not allowed') || error.message.includes('User not found')) {
                alert('등록되지 않은 이메일입니다.\n조합 가입 시 등록한 이메일을 입력해주세요.');
            } else {
                alert('오류 발생: ' + error.message);
            }
        } else {
            // 성공 UI
            document.getElementById('sentMsgBox').classList.remove('hidden');
            document.getElementById('targetEmail').innerText = email;
            // 입력창 비활성화
            document.getElementById('emailInput').disabled = true;
        }
    }

    async function startKakaoLogin() {
        const { error } = await _supabase.auth.signInWithOAuth({
            provider: 'kakao',
            options: { redirectTo: window.location.href }
        });
        if(error) alert('카카오 로그인 오류: ' + error.message);
    }

    function logout() {
        if(confirm('로그아웃 하시겠습니까?')) {
            _supabase.auth.signOut().then(() => location.reload());
        }
    }

    // =========================================================================
    // 3. 데이터 로드 및 대시보드 렌더링
    // =========================================================================
    async function handleLoginSuccess(user) {
        curAuth = user;
        showLoading(true, '조합원 정보 확인 중...');
        
        // 헤더 로그아웃 버튼 표시
        document.getElementById('headerLogoutBtn').classList.remove('hidden');

        // 1. DB 매핑 (RPC 호출) - 이메일 기반 매칭
        const { data: claimRes, error: claimErr } = await _supabase.rpc('claim_member_profile');

        // 매칭 실패 처리
        if (claimErr || (!claimRes.success && claimRes.message === 'not_found')) {
            showLoading(false);
            await _supabase.auth.signOut();
            alert('로그인한 이메일과 일치하는 조합원 정보가 없습니다.\n(가입 시 등록된 이메일인지 확인해주세요.)');
            return;
        }

        // 2. 데이터 조회
        await loadDashboardData(user.id);
    }

    async function loadDashboardData(uuid) {
        try {
            // [A] 내 정보 (coop_members)
            const { data: member, error: memErr } = await _supabase
                .from('coop_members')
                .select('*')
                .eq('id', uuid)
                .single();
            
            if(memErr) throw memErr;
            curMem = member;

            // [B] 신청 내역 (coop_applications)
            const { data: apps } = await _supabase
                .from('coop_applications')
                .select('*')
                .eq('member_uid', uuid)
                .order('created_at', { ascending: false });

            // [C] 입금 내역 (ref_members)
            const { data: ledger } = await _supabase
                .from('ref_members')
                .select('*')
                .eq('member_id', curMem.member_id)
                .order('deposit_date', { ascending: false });

            // 렌더링 실행
            renderDashboard(member, apps || [], ledger || []);
            showLoading(false);

        } catch (e) {
            console.error(e);
            showLoading(false);
            alert('데이터를 불러오는 중 오류가 발생했습니다: ' + e.message);
        }
    }

// [헬퍼] 안전하게 텍스트 넣기 (ID가 없으면 에러 내지 않고 넘어감)
    function setText(id, text) {
        const el = document.getElementById(id);
        if (el) {
            el.innerText = text || '-';
        } else {
            console.warn(`[주의] HTML에 '${id}'라는 ID를 가진 태그가 없습니다.`);
        }
    }

    // [수정] 렌더링 함수 (안전장치 추가됨)
    function renderDashboard(member, apps, ledger) {
        // 섹션 전환
        const loginSec = document.getElementById('loginSection');
        const dashSec = document.getElementById('dashboardSection');
        if(loginSec) loginSec.classList.add('hidden');
        if(dashSec) dashSec.classList.remove('hidden');

        // 1. 기본 정보 표시 (setText 함수 사용으로 에러 방지)
        setText('infoName', member.name);
        setText('infoBirth', member.rrn_display ? member.rrn_display.substring(0,6) : '-');
        
        // 이메일은 Auth 정보에서 가져옴
        if(curAuth && curAuth.email) setText('infoEmail', curAuth.email);
        else setText('infoEmail', '-');
        
        // 2. 수정 폼 초기값 설정 (input은 value 속성이라 별도 처리)
        if(document.getElementById('editPhone')) document.getElementById('editPhone').value = member.phone || '';
        if(document.getElementById('editAddress')) document.getElementById('editAddress').value = member.address || '';
        if(document.getElementById('editBankName')) document.getElementById('editBankName').value = member.bank_name || '';
        if(document.getElementById('editAccountNo')) document.getElementById('editAccountNo').value = member.account_number || ''; // 마스킹된 값
        if(document.getElementById('editHolder')) document.getElementById('editHolder').value = member.account_holder || '';

        // 3. 상단 카운터 (요약 정보)
        setText('sumId', member.member_id);
        setText('sumTotal', Number(member.total_capital || 0).toLocaleString() + '원');
        
        // 4. 은행 정보 표시
        const bankText = member.bank_name ? `${member.bank_name} (계좌 있음)` : '미등록 계좌';
        setText('sumBank', bankText);

        // 5. 타임라인 렌더링
        renderTimeline(ledger, apps);
    }

function renderTimeline(ledger, apps) {
        const list = document.getElementById('timelineList');
        let html = '';

        if(ledger.length === 0 && apps.length === 0) {
            list.innerHTML = '<div class="text-center text-muted py-5">내역이 없습니다.</div>';
            return;
        }

        // 1. 입금 내역 (확정된 사실)
        ledger.forEach(item => {
            html += `
            <div class="timeline-item">
                <div class="timeline-date">${item.deposit_date ? item.deposit_date.substring(0,10) : '날짜미상'}</div>
                <div class="timeline-content">
                    <h5>입금 확인</h5>
                    <p class="text-success fw-bold">+${Number(item.amount).toLocaleString()}원</p>
                </div>
            </div>`;
        });

        // 2. 신청 내역 (진행상황 표시)
        const typeMap = { 'extra': '추가출자', 'reduction': '감자', 'withdraw': '탈퇴' };
        
        apps.forEach(app => {
            let statusBadge = '';
            let actionBtn = ''; // 취소 버튼용

            if(app.status === 'pending') {
                statusBadge = '<span class="badge bg-warning text-dark">검토중</span>';
                // [기능] 대기중일 때만 취소 버튼 활성화
                actionBtn = `<button class="btn btn-sm btn-outline-danger ms-2" style="font-size:0.7rem; padding:2px 6px;" onclick="cancelApp(${app.id})">취소</button>`;
            } else if(app.status === 'approved') {
                statusBadge = '<span class="badge bg-success">승인됨</span>';
            } else if(app.status === 'cancelled') {
                statusBadge = '<span class="badge bg-secondary">취소됨</span>';
            } else {
                statusBadge = '<span class="badge bg-danger">반려됨</span>';
            }

            let typeName = typeMap[app.type] || app.type;

            html += `
            <div class="timeline-item" style="border-left-color: #ff9800;">
                <div class="timeline-date">${app.created_at.substring(0,10)}</div>
                <div class="timeline-content">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-bold">[신청] ${typeName}</span>
                            ${statusBadge}
                        </div>
                        ${actionBtn} </div>
                    <p>${Number(app.amount).toLocaleString()}원 ${app.reason ? '('+app.reason+')' : ''}</p>
                </div>
            </div>`;
        });

        list.innerHTML = html;
    }

    // =========================================================================
    // 4. 탭 및 신청 기능
    // =========================================================================
    function toggleTab(type, btn) {
        // 모든 탭 숨기기
        document.getElementById('tabPlaceholder').classList.add('hidden');
        ['tabExtra', 'tabReduction', 'tabWithdraw', 'tabCert'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        
        // 버튼 활성화 스타일
        document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');

        // 해당 탭 보이기
        const target = document.getElementById('tab' + type.charAt(0).toUpperCase() + type.slice(1));
        if(target) target.classList.remove('hidden');
    }

async function submitApplication(type) {
        let amount = 0, reason = '';
        const totalCap = Number(curMem.total_capital || 0); // 뷰에서 가져온 총액

        if(type === 'extra') {
            amount = Number(document.getElementById('exAmount').value);
            if(amount < 10000) return alert('1만원 이상 입력해주세요.');
        } 
        else if(type === 'reduction') {
            amount = Number(document.getElementById('redAmount').value);
            if(amount <= 0) return alert('금액을 입력해주세요.');
            
            // [제약] 잔액 10만원 미만 불가
            if(totalCap - amount < 100000) {
                return alert(`감자 후 출자금이 최소 10만원 이상이어야 합니다.\n(현재: ${totalCap.toLocaleString()}원)`);
            }
            // [제약] 동의 체크 확인
            if(!document.getElementById('checkRedAgree').checked) return alert('안내 사항에 동의해주세요.');
        } 
        else if(type === 'withdraw') {
            reason = document.getElementById('wdReason').value;
            if(!reason) return alert('탈퇴 사유를 입력해주세요.');
            // [제약] 동의 체크 확인
            if(!document.getElementById('checkWdAgree').checked) return alert('탈퇴 안내 사항에 동의해주세요.');
        }

        if(!confirm('신청서를 제출하시겠습니까?')) return;
        showLoading(true);

        const { error } = await _supabase.from('coop_applications').insert({
            member_uid: curAuth.id,
            member_id: curMem.member_id,
            name: curMem.name,
            type: type,
            amount: amount,
            reason: reason,
            status: 'pending'
        });

        showLoading(false);
        if(error) alert('오류: ' + error.message);
        else {
            alert('신청되었습니다.');
            // 입력창 초기화
            document.getElementById('exAmount').value = '';
            document.getElementById('redAmount').value = '';
            document.getElementById('wdReason').value = '';
            if(document.getElementById('checkRedAgree')) document.getElementById('checkRedAgree').checked = false;
            if(document.getElementById('checkWdAgree')) document.getElementById('checkWdAgree').checked = false;
            
            loadDashboardData(curAuth.id); // 목록 갱신
        }
    }
// =========================================================================
    // 7. [업그레이드] 출자증서 PDF 생성 (직인 + 한글폰트 + 디자인)
    // =========================================================================

async function downloadCert() {
        if (!curMem) return alert('조합원 정보가 없습니다.');
        
        showLoading(true, '증서 발급 중...');

        try {
            // 1. 실제 납입금 합계 계산 (ref_members 기준)
            const { data: payments, error: payErr } = await _supabase
                .from('ref_members')
                .select('amount')
                .eq('member_id', curMem.member_id);

            if (payErr) throw payErr;
            const totalAmount = payments.reduce((acc, curr) => acc + Number(curr.amount), 0);

            if (totalAmount === 0) {
                showLoading(false);
                return alert("납입된 출자금 내역이 없습니다.");
            }

            // 2. 증서 번호 발급 (RPC 호출: 중복 방지 로직 포함)
            const { data: certRes, error: certErr } = await _supabase.rpc('issue_certificate', {
                p_member_id: curMem.member_id,
                p_amount: totalAmount
            });

            if (certErr) throw certErr;
            
            // 3. 이사장 이름 조회 (없으면 기본값)
            const { data: companyInfo } = await _supabase
                .from('ref_company_info')
                .select('value')
                .eq('key', 'chairman_name')
                .single();
            const chairmanName = (companyInfo && companyInfo.value) ? companyInfo.value : "김민호";

            // 4. 생성 모듈 호출 (cert_generator.js)
            // 인자: 회원정보, 총액, 증서번호, 이사장명, Supabase클라이언트
            await generateContributionCert(curMem, totalAmount, certRes.cert_number, chairmanName, _supabase);
            
            showLoading(false);

        } catch (e) {
            console.error(e);
            showLoading(false);
            alert("처리 중 오류가 발생했습니다: " + e.message);
        }
    }

    async function cancelApp(appId) {
        if(!confirm('신청을 취소하시겠습니까?')) return;
        showLoading(true);
        
        // 내 신청건 중 'pending' 상태인 것만 취소 가능 (RLS로도 보호됨)
        const { error } = await _supabase
            .from('coop_applications')
            .update({ status: 'cancelled' })
            .eq('id', appId);

        showLoading(false);
        if(error) alert('취소 실패: ' + error.message);
        else {
            alert('취소되었습니다.');
            loadDashboardData(curAuth.id); // 목록 갱신
        }
    }

    async function saveProfile() {
        if(!confirm('정보를 수정하시겠습니까?')) return;
        showLoading(true, '저장 중...');

        const phone = document.getElementById('editPhone').value;
        const addr = document.getElementById('editAddress').value;
        const bank = document.getElementById('editBankName').value;
        const accNo = document.getElementById('editAccountNo').value;
        const holder = document.getElementById('editHolder').value;

        // DB 함수(RPC) 호출: 서버에서 마스킹 여부 판단 후 암호화 저장
        const { error } = await _supabase.rpc('update_my_profile', {
            p_phone: phone,
            p_address: addr,
            p_bank_name: bank,
            p_account_number: accNo, // 마스킹된 값이 갈 수도 있고, 새 값이 갈 수도 있음
            p_account_holder: holder
        });

        if (error) {
            showLoading(false);
            alert('수정 실패: ' + error.message);
        } else {
            alert('수정되었습니다.');
            toggleEditMode(false); // 조회 모드로 복귀
        }
    }


  </script>
</body>
</html>
