<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ì¡°í•©ì› ê´€ë¦¬ | ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•©</title>
    
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <link href="https://webfontworld.github.io/gmarket/GmarketSans.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <link rel="stylesheet" href="style.css">

    <style>
        /* [ê¸´ê¸‰ ìˆ˜ì •] Footer ë° Modal CSS ê°•ì œ ì ìš© */
        
        /* 1. Footer ìŠ¤íƒ€ì¼ */
        #footer {
            background: #111;
            color: #fff;
            padding: 40px 0;
            margin-top: auto; /* ë°”ë‹¥ì— ë¶™ì´ê¸° */
        }
        #footer h3 {
            font-family: 'GmarketSans', sans-serif;
            font-size: 20px;
            color: #fff;
            margin-bottom: 15px;
        }
        #footer h3 span { color: #ff9800; }
        #footer p {
            font-size: 14px;
            line-height: 1.6;
            color: #ccc;
        }
        
        /* 2. Modal (Center Modal) ìŠ¤íƒ€ì¼ */
        .center-modal {
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            position: fixed;
            z-index: 10000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }
        .center-modal .modal-content {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: popUp 0.3s ease-out;
        }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* 3. ìœ í‹¸ë¦¬í‹° ë° ë ˆì´ì•„ì›ƒ */
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main { flex: 1; }
        .hidden { display: none !important; }
        
        /* ëŒ€ì‹œë³´ë“œ ìŠ¤íƒ€ì¼ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .card-box {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            border: 1px solid #eee;
        }
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px; }
        .menu-btn {
            padding: 15px; border: 1px solid #eee; background: #fff;
            border-radius: 10px; font-weight: 600; cursor: pointer; color: #555; width: 100%;
        }
        .menu-btn.active { background: #2E7D32; color: #fff; border-color: #2E7D32; }
        
        /* ë¡œë”©ë°” */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 10000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #eee;
            border-top: 4px solid #2E7D32; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³´ê°• */
        .btn-dark { background: #333; color: #fff; border: none; padding: 0 20px; border-radius: 0 10px 10px 0; }
        .email-gate-group { display: flex; height: 55px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-radius: 10px; }
        .email-gate-group input { border-radius: 10px 0 0 10px; border: 1px solid #eee; padding-left: 15px; width: 100%; }
        .btn-kakao { background: #FEE500; border: none; width: 100%; padding: 15px; border-radius: 10px; font-weight: bold; }
        .btn-submit-main { background: #2E7D32; color: #fff; border: none; width: 100%; padding: 15px; border-radius: 10px; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

    <header id="header" class="fixed-top" style="background:#000; padding:15px 0;">
        <div class="container d-flex align-items-center justify-content-between">
            <div class="logo">
                <h1 style="margin:0;"><a href="index.html" style="color:#fff; text-decoration:none; font-family:'GmarketSans'; font-size:20px;">ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›</a></h1>
            </div>
            <nav id="navbar" class="navbar">
                <ul style="list-style:none; margin:0; padding:0; display:flex; gap:20px;">
                    <li><a href="index.html" style="color:#fff; text-decoration:none;">í™ˆ</a></li>
                    <li><a href="#" style="color:#ff9800; text-decoration:none; font-weight:bold;">ì¡°í•©ì› ê³µê°„</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div style="margin-top:15px; font-weight:bold; color:#555;" id="loadingMsg">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
    </div>

    <main id="main" style="padding-top: 100px; padding-bottom: 60px; background:#fcfcfc;">
        
        <div id="loginSection" class="container">
            <div class="signup-wrapper" style="max-width: 500px; margin:0 auto; background:#fff; padding:40px 20px; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.05);">
                <h2 style="text-align: center; font-family:'GmarketSans'; margin-bottom:30px;">ì¡°í•©ì› ë¡œê·¸ì¸</h2>
                
                <div class="info-box" style="background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom: 20px; font-size:14px; color:#555;">
                    <i class="bi bi-envelope-check"></i> ê°€ì… ì‹œ ë“±ë¡í•œ <b>ì´ë©”ì¼ ì£¼ì†Œ</b>ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>
                    ì…ë ¥í•˜ì‹  ì´ë©”ì¼ë¡œ <b>ë¡œê·¸ì¸ ë§í¬</b>ë¥¼ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.
                </div>

                <div class="email-gate-group">
                    <input type="email" id="emailInput" placeholder="example@email.com" onkeyup="if(event.key==='Enter') sendMagicLink()">
                    <button class="btn-dark" id="btnSendLink" onclick="sendMagicLink()">ë§í¬ ë°›ê¸°</button>
                </div>

                <div id="sentMsgBox" class="hidden" style="margin-top: 20px; text-align: center; animation: popUp 0.3s ease-out;">
                    <div style="font-size: 50px;">ğŸ“§</div>
                    <h3 style="font-size:18px; font-weight:bold; margin:10px 0;">ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”!</h3>
                    <p style="color:#666; font-size:14px;">
                        <span id="targetEmail" style="color:#2E7D32; font-weight:bold;"></span>(ìœ¼)ë¡œ<br>
                        ë¡œê·¸ì¸ ë§í¬ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
                        ë©”ì¼í•¨ì˜ <b>[Log in / ë¡œê·¸ì¸]</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
                    </p>
                    <button onclick="location.reload()" style="background:none; border:none; text-decoration:underline; color:#999; cursor:pointer;">ì´ë©”ì¼ ë‹¤ì‹œ ì…ë ¥í•˜ê¸°</button>
                </div>

                <div style="margin-top: 40px; border-top: 1px solid #eee; padding-top: 30px;">
                    <button class="btn-kakao" onclick="startKakaoLogin()">
                        <i class="bi bi-chat-fill" style="margin-right:8px;"></i> ì¹´ì¹´ì˜¤ë¡œ ë°”ë¡œ ì‹œì‘
                    </button>
                    <div style="text-align:center; font-size:12px; color:#888; margin-top:10px;">
                        (ê¸°ì¡´ íšŒì›ì´ ì¹´ì¹´ì˜¤ë¥¼ ì—°ë™í•œ ê²½ìš°ì—ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤)
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboardSection" class="container hidden">
            <div class="d-flex justify-content-between align-items-center mb-4" style="display:flex; justify-content:space-between;">
                <h2 style="margin:0; font-family:'GmarketSans';">ë‚˜ì˜ ì¡°í•©ì› ì •ë³´</h2>
                <button onclick="logout()" style="border:1px solid #ddd; background:#fff; padding:5px 10px; border-radius:5px;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <section class="counts" style="margin-bottom:30px;">
                <div class="row" style="display:flex; gap:10px; flex-wrap:wrap;">
                    <div style="flex:1; min-width:250px;" class="card-box">
                        <div style="text-align:center;">
                            <i class="bi bi-person" style="font-size:30px; color:#2E7D32;"></i>
                            <h3 id="sumName" style="margin:10px 0;">-</h3>
                            <p style="color:#666; margin:0;">ì¡°í•©ì›</p>
                            <div id="sumId" style="font-size:12px; color:#999;"></div>
                        </div>
                    </div>
                    <div style="flex:1; min-width:250px;" class="card-box">
                        <div style="text-align:center;">
                            <i class="bi bi-cash-coin" style="font-size:30px; color:#2E7D32;"></i>
                            <h3 id="sumTotal" style="margin:10px 0;">0ì›</h3>
                            <p style="color:#666; margin:0;">ì´ ë‚©ì… ì¶œìê¸ˆ</p>
                        </div>
                    </div>
                </div>
            </section>

            <div class="dashboard-grid">
                <div class="left-col">
                    <div class="card-box">
                        <h3 style="font-family:'GmarketSans'; font-size:18px; font-weight:bold;">ğŸ“Œ ì—…ë¬´ ì‹ ì²­</h3>
                        <div class="menu-grid">
                            <button class="menu-btn" onclick="toggleTab('extra', this)">ì¶”ê°€ ì¶œì</button>
                            <button class="menu-btn" onclick="toggleTab('reduction', this)">ê°ì ì‹ ì²­</button>
                            <button class="menu-btn" onclick="toggleTab('withdraw', this)">íƒˆí‡´ ì‹ ì²­</button>
                            <button class="menu-btn" onclick="toggleTab('cert', this)" style="color:#2E7D32;">ì¦ëª…ì„œ ë°œê¸‰</button>
                        </div>
                        
                        <div id="actionArea" style="margin-top:20px; border-top:1px dashed #ddd; padding-top:20px;">
                            <div id="tabPlaceholder" style="text-align:center; color:#999; font-size:14px;">ìœ„ ë©”ë‰´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>

                            <div id="tabExtra" class="hidden">
                                <h4>ì¶”ê°€ ì¶œì ì‹ ì²­</h4>
                                <input type="number" id="exAmount" class="menu-btn" placeholder="ê¸ˆì•¡ ì…ë ¥ (1ë§Œì› ë‹¨ìœ„)" step="10000" style="text-align:left; cursor:text;">
                                <button class="btn-submit-main" onclick="submitApplication('extra')">ì‹ ì²­í•˜ê¸°</button>
                            </div>

                            <div id="tabReduction" class="hidden">
                                <h4>ê°ì ì‹ ì²­</h4>
                                <p style="font-size:13px; color:#e65100;">ë“±ë¡ëœ ê³„ì¢Œ(<span class="bank-display"></span>)ë¡œ í™˜ê¸‰ë©ë‹ˆë‹¤.</p>
                                <input type="number" id="redAmount" class="menu-btn" placeholder="í™˜ê¸‰ ìš”ì²­ì•¡" style="text-align:left; cursor:text;">
                                <button class="btn-submit-main" onclick="submitApplication('reduction')">ì‹ ì²­í•˜ê¸°</button>
                            </div>

                            <div id="tabWithdraw" class="hidden">
                                <h4 style="color:#d32f2f;">íƒˆí‡´ ì‹ ì²­</h4>
                                <p style="font-size:13px; color:#d32f2f;">ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (í™˜ê¸‰ê³„ì¢Œ: <span class="bank-display"></span>)</p>
                                <textarea id="wdReason" class="menu-btn" placeholder="íƒˆí‡´ ì‚¬ìœ  ì…ë ¥" style="height:80px; text-align:left; cursor:text;"></textarea>
                                <button class="btn-submit-main" style="background:#333;" onclick="submitApplication('withdraw')">íƒˆí‡´ ì‹ ì²­</button>
                            </div>

                            <div id="tabCert" class="hidden">
                                <h4>ì¦ëª…ì„œ ë°œê¸‰</h4>
                                <p style="text-align:center; padding:10px;">ì¶œì ì¦ëª…ì„œë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.</p>
                                <button class="btn-submit-main" onclick="downloadCert()">ë‹¤ìš´ë¡œë“œ</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="right-col">
                    <div class="card-box">
                        <h3 style="font-family:'GmarketSans'; font-size:18px; font-weight:bold;">ğŸ“… ìµœê·¼ ë‚´ì—­</h3>
                        <div id="timelineList" style="margin-top:20px;">
                            <div style="text-align:center; color:#999;">ë¡œë”© ì¤‘...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer id="footer">
        <div class="container" style="padding: 0 20px;">
            <h3>ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›<span>.</span></h3>
            <p>
                ê²½ê¸°ë„ ìš©ì¸ì‹œ ì²˜ì¸êµ¬<br>
                ë¬¸ì˜: 010-2513-5736 (ì‚¬ë¬´êµ­ì¥ ê¹€ë¯¼í˜¸)<br>
                ì´ë©”ì¼: yonginsolar@gmail.com
            </p>
            <p style="font-size:12px; margin-top:20px; color:#555;">
                &copy; 2025 Yongin Solar Cooperative. All Rights Reserved.
            </p>
        </div>
    </footer>

    <div id="alertModal" class="center-modal">
        <div class="modal-content">
            <div style="font-size:40px; margin-bottom:10px;">ğŸ“¢</div>
            <div id="alertMsg" style="font-weight:bold; margin-bottom:20px; white-space:pre-wrap; line-height:1.5;"></div>
            <button class="btn-submit-main" onclick="document.getElementById('alertModal').style.display='none'">í™•ì¸</button>
        </div>
    </div>

<script>
    // =========================================================================
    // 1. Supabase ì„¤ì • (ì œê³µí•´ì£¼ì‹  í‚¤ ì ìš©ë¨)
    // =========================================================================
    const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
    
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let curMem = null;
    let curAuth = null;

    // ë¡œë”©ë°”
    function showLoading(show, msg) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        if(msg) document.getElementById('loadingMsg').innerText = msg;
    }

    // ì•Œë¦¼ì°½
    function showAlert(msg) {
        document.getElementById('alertMsg').innerText = msg;
        document.getElementById('alertModal').style.display = 'flex';
    }

    // ì´ˆê¸°í™”: í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¸ì…˜(ë§í¬ íƒ€ê³  ë“¤ì–´ì™”ì„ ë•Œ) í™•ì¸
    window.addEventListener('DOMContentLoaded', async () => {
        // ì£¼ì†Œì°½ì˜ í† í°ì„ íŒŒì‹±í•´ì„œ ì„¸ì…˜ì„ ë³µêµ¬í•¨
        const { data: { session } } = await _supabase.auth.getSession();
        
        if (session) {
            // ë¡œê·¸ì¸ ìƒíƒœë¼ë©´ ë°”ë¡œ ëŒ€ì‹œë³´ë“œ ë¡œë“œ
            handleLoginSuccess(session.user);
        }
    });

    // =========================================================================
    // 2. ë§¤ì§ë§í¬ ë¡œê·¸ì¸ (OTP ì…ë ¥ ì—†ìŒ)
    // =========================================================================
    async function sendMagicLink() {
        const email = document.getElementById('emailInput').value.trim();
        if(!email || !email.includes('@')) return showAlert('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');

        showLoading(true, 'ë§í¬ ë°œì†¡ ì¤‘...');

        // â˜… í•µì‹¬: emailRedirectToë¥¼ í˜„ì¬ í˜ì´ì§€ë¡œ ì„¤ì •í•´ì•¼ 404ê°€ ì•ˆ ë‚¨ (ë‹¨, ëŒ€ì‹œë³´ë“œ ì„¤ì • ì„ í–‰ í•„ìˆ˜)
        const { error } = await _supabase.auth.signInWithOtp({
            email: email,
            options: { 
                shouldCreateUser: false, // ê¸°ì¡´ íšŒì›ë§Œ
                emailRedirectTo: window.location.href // ì´ í˜ì´ì§€ë¡œ ë‹¤ì‹œ ëŒì•„ì˜¤ê²Œ ì„¤ì •
            }
        });

        showLoading(false);

        if(error) {
            if(error.message.includes('Signups not allowed') || error.message.includes('User not found')) {
                showAlert('ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.\nê°€ì… ì‹œ ë“±ë¡í•œ ì´ë©”ì¼ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
            } else {
                showAlert('ì˜¤ë¥˜: ' + error.message);
            }
        } else {
            // ì„±ê³µ ì‹œ ì…ë ¥ì°½ ìˆ¨ê¸°ê³  ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
            document.querySelector('.email-gate-group').classList.add('hidden');
            document.querySelector('.info-box').classList.add('hidden');
            document.getElementById('sentMsgBox').classList.remove('hidden');
            document.getElementById('targetEmail').innerText = email;
        }
    }

    // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸
    async function startKakaoLogin() {
        const { error } = await _supabase.auth.signInWithOAuth({
            provider: 'kakao',
            options: { redirectTo: window.location.href }
        });
        if(error) showAlert('ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì˜¤ë¥˜: ' + error.message);
    }

    function logout() {
        if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            _supabase.auth.signOut().then(() => location.reload());
        }
    }

    // =========================================================================
    // 3. ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§ (ë¡œê·¸ì¸ ì„±ê³µ í›„)
    // =========================================================================
    async function handleLoginSuccess(user) {
        curAuth = user;
        showLoading(true, 'ì •ë³´ í™•ì¸ ì¤‘...');

        // 1. DB ë§¤í•‘ (ì´ë©”ì¼ ì¼ì¹˜ ì‹œ UUID ì—…ë°ì´íŠ¸)
        const { data: claimRes, error: claimErr } = await _supabase.rpc('claim_member_profile');
        
        if (claimErr || (!claimRes.success && claimRes.message === 'not_found')) {
            showLoading(false);
            await _supabase.auth.signOut();
            showAlert('ì¡°í•©ì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì‚¬ë¬´êµ­ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
            return;
        }

        // 2. ë°ì´í„° ì¡°íšŒ
        await refreshDashboard();
    }

    async function refreshDashboard() {
        try {
            const myUuid = curAuth.id;

            // ë‚´ ì •ë³´
            const { data: member, error: memErr } = await _supabase
                .from('coop_members')
                .select('*')
                .eq('id', myUuid)
                .single();
            if(memErr) throw memErr;
            curMem = member;

            // ì‹ ì²­ ë‚´ì—­
            const { data: apps } = await _supabase
                .from('coop_applications')
                .select('*')
                .eq('member_uid', myUuid)
                .order('created_at', { ascending: false });

            // ì…ê¸ˆ ë‚´ì—­ (Ref Members)
            const { data: ledger } = await _supabase
                .from('ref_members')
                .select('*')
                .eq('member_id', curMem.member_id)
                .order('deposit_date', { ascending: false });

            renderDashboard(member, apps || [], ledger || []);
            showLoading(false);

        } catch (e) {
            showLoading(false);
            console.error(e);
            showAlert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
        }
    }

    function renderDashboard(member, apps, ledger) {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('dashboardSection').classList.remove('hidden');

        document.getElementById('sumName').innerText = member.name;
        document.getElementById('sumId').innerText = member.member_id;
        document.getElementById('sumTotal').innerText = (member.pledge_amount || 0).toLocaleString() + 'ì›';

        const bankStr = member.bank_name ? `${member.bank_name}` : 'ë¯¸ë“±ë¡';
        document.querySelectorAll('.bank-display').forEach(el => el.innerText = bankStr);

        renderTimeline(ledger, apps);
    }

    function renderTimeline(ledger, apps) {
        const list = document.getElementById('timelineList');
        let html = '';

        if(ledger.length === 0 && apps.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">í™œë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        // ì…ê¸ˆ ë‚´ì—­ í‘œì‹œ
        ledger.forEach(item => {
            html += `
            <div style="padding:10px; border-bottom:1px solid #f0f0f0;">
                <div style="font-size:12px; color:#999;">${item.deposit_date ? item.deposit_date.substring(0,10) : '-'}</div>
                <div style="display:flex; justify-content:space-between;">
                    <span style="font-weight:bold;">ì…ê¸ˆ í™•ì¸</span>
                    <span style="color:#2E7D32;">+${Number(item.amount).toLocaleString()}ì›</span>
                </div>
            </div>`;
        });
        
        // ì‹ ì²­ ë‚´ì—­ í‘œì‹œ (ì§„í–‰ì¤‘ì¸ ê²ƒ)
        apps.forEach(app => {
            let statusText = app.status === 'pending' ? 'ê²€í† ì¤‘' : 'ì²˜ë¦¬ë¨';
            let color = app.status === 'pending' ? '#ff9800' : '#888';
            let typeMap = { 'extra': 'ì¶”ê°€ì¶œì', 'reduction': 'ê°ì', 'withdraw': 'íƒˆí‡´' };

            html += `
            <div style="padding:10px; border-bottom:1px solid #f0f0f0; background:#fffbf0;">
                <div style="font-size:12px; color:#999;">${app.created_at.substring(0,10)}</div>
                <div style="display:flex; justify-content:space-between;">
                    <span style="font-weight:bold;">[ì‹ ì²­] ${typeMap[app.type]}</span>
                    <span style="color:${color}; font-size:13px;">${statusText}</span>
                </div>
                <div style="text-align:right; font-size:13px;">${Number(app.amount).toLocaleString()}ì›</div>
            </div>`;
        });

        list.innerHTML = html;
    }

    function toggleTab(type, btn) {
        document.getElementById('tabPlaceholder').classList.add('hidden');
        ['tabExtra', 'tabReduction', 'tabWithdraw', 'tabCert'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));

        document.getElementById('tab' + type.charAt(0).toUpperCase() + type.slice(1)).classList.remove('hidden');
        btn.classList.add('active');
    }

    async function submitApplication(type) {
        let amount = 0, reason = '';
        if(type === 'extra') amount = document.getElementById('exAmount').value;
        if(type === 'reduction') amount = document.getElementById('redAmount').value;
        if(type === 'withdraw') reason = document.getElementById('wdReason').value;

        if(!confirm('ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        
        showLoading(true);
        const { error } = await _supabase.from('coop_applications').insert({
            member_uid: curAuth.id,
            member_id: curMem.member_id,
            name: curMem.name,
            type: type,
            amount: amount || 0,
            reason: reason
        });
        showLoading(false);

        if(error) showAlert('ì˜¤ë¥˜: ' + error.message);
        else {
            showAlert('ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.');
            refreshDashboard();
        }
    }

    function downloadCert() {
        if(!window.jspdf) return showAlert('PDF ìƒì„± ì˜¤ë¥˜');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("Certificate (Demo)", 105, 30, { align: "center" });
        doc.text(`User: ${curMem.name}`, 20, 50);
        doc.save('cert.pdf');
    }

</script>
</body>
</html>
