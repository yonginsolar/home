<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¡°í•©ì› ê´€ë¦¬ - ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•©</title>
  
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.css" rel="stylesheet">
  <link href="https://webfontworld.github.io/gmarket/GmarketSans.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="cert_generator.js"></script>
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <script src="badges.js"></script>

  <link href="style.css" rel="stylesheet">
  
  <style>
    /* [ê¸°ë³¸ ì„¤ì •] í°íŠ¸ ë° ë°”ë”” */
    body {
        font-family: 'Pretendard', sans-serif;
        background-color: #f8f9fa;
        padding-top: 80px; /* í—¤ë” ë†’ì´ë§Œí¼ ë„ì›€ */
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }

    /* [í—¤ë”] ê·œì •ì§‘ ìŠ¤íƒ€ì¼ ê·¸ëŒ€ë¡œ ì ìš© (ê²€ì€ìƒ‰) */
    #header {
        background-color: #000;
        padding: 15px 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .logo h1 a {
        font-family: 'GmarketSans', sans-serif;
        font-weight: 700;
        font-size: 20px;
        text-decoration: none;
        color: #fff !important;
    }
    .header-link {
        color: #fff;
        text-decoration: none;
        margin-left: 20px;
        font-size: 1.2rem;
        cursor: pointer;
        transition: 0.3s;
    }
    .header-link:hover { color: #ff9800; }

    /* [í‘¸í„°] í•˜ë‹¨ ê³ ì • ë° ìŠ¤íƒ€ì¼ */
    #footer {
        margin-top: auto;
        background: #111; /* ë°°ê²½ìƒ‰ ê°•ì œ ì§€ì • (CSS ë¡œë“œ ì „ ê¹¨ì§ ë°©ì§€) */
        color: #fff;
    }

    /* [ë¡œê·¸ì¸ ì„¹ì…˜] ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .signup-wrapper {
        background: #fff;
        padding: 40px 30px;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        max-width: 500px;
        margin: 40px auto;
        border: 1px solid #eee;
    }
    .form-title {
        font-family: 'GmarketSans';
        font-weight: 700;
        text-align: center;
        margin-bottom: 30px;
        color: #333;
    }
    
    /* [ëŒ€ì‹œë³´ë“œ] ì¹´ë“œ ë°•ìŠ¤ */
    .dashboard-card {
        background: #fff;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        border: 1px solid #f0f0f0;
        height: 100%;
    }
    .count-icon {
        font-size: 2.5rem;
        color: #2E7D32;
        margin-bottom: 10px;
    }
    .count-title {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 5px;
    }
    .count-val {
        font-family: 'GmarketSans';
        font-weight: 700;
        font-size: 1.5rem;
        color: #333;
    }

    /* [íƒ€ì„ë¼ì¸] í™œë™ ë‚´ì—­ ìŠ¤íƒ€ì¼ (í•„ìˆ˜ ë³µêµ¬) */
    .timeline-item {
        padding: 0 0 20px 20px;
        border-left: 2px solid #e0e0e0;
        position: relative;
    }
    .timeline-item::before {
        content: "";
        position: absolute;
        width: 12px; height: 12px;
        border-radius: 50%;
        left: -7px; top: 5px;
        background: #fff;
        border: 2px solid #2E7D32;
    }
    .timeline-date {
        font-size: 0.8rem;
        color: #999;
        margin-bottom: 3px;
    }
    .timeline-content h5 {
        font-size: 1rem;
        font-weight: 600;
        margin: 0;
        color: #333;
    }
    .timeline-content p {
        font-size: 0.9rem;
        color: #666;
        margin: 0;
    }

    /* [ë©”ë‰´ íƒ­] ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .menu-btn {
        width: 100%;
        text-align: left;
        padding: 15px;
        margin-bottom: 10px;
        border: 1px solid #eee;
        background: #fff;
        border-radius: 10px;
        font-weight: 600;
        color: #555;
        transition: all 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .menu-btn:hover {
        background: #f8f9fa;
        border-color: #2E7D32;
        color: #2E7D32;
    }
    .menu-btn.active {
        background: #2E7D32;
        color: #fff;
        border-color: #2E7D32;
    }
    .menu-icon { font-size: 1.2rem; margin-right: 10px; }

    /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
    #loadingOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.95);
        z-index: 9999;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    
    /* ìœ í‹¸ë¦¬í‹° */
    .hidden { display: none !important; }
    .text-green { color: #2E7D32 !important; }
  </style>
</head>

<body>

  <header id="header" class="fixed-top">
    <div class="container d-flex align-items-center justify-content-between">
      
      <div class="logo">
        <h1><a href="index.html">ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•©</a></h1>
      </div>

      <div class="d-flex align-items-center">
          <a href="index.html" class="header-link" title="ë©”ì¸ìœ¼ë¡œ ì´ë™">
              <i class="bi bi-house-door"></i>
          </a>
          <a href="#" onclick="logout()" id="headerLogoutBtn" class="header-link hidden" title="ë¡œê·¸ì•„ì›ƒ">
              <i class="bi bi-box-arrow-right"></i>
          </a>
      </div>

    </div>
  </header>

  <div id="loadingOverlay">
      <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;"></div>
      <div class="mt-3 fw-bold text-secondary" id="loadingMsg">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
  </div>

<main class="container py-4">
    
    <div id="loginSection">
        <div class="signup-wrapper">
            <h2 class="form-title">ì¡°í•©ì› ê³µê°„</h2>
            
            <div class="alert alert-light border d-flex align-items-center" role="alert">
                <i class="bi bi-info-circle-fill text-success fs-4 me-3"></i>
                <div>
                    ê°€ì… ì‹œ ë“±ë¡í•œ <b>ì´ë©”ì¼</b>ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>
                    <small class="text-muted">ì…ë ¥í•˜ì‹  ë©”ì¼ë¡œ ë¡œê·¸ì¸ ë§í¬ë¥¼ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.</small>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold small text-secondary">ì´ë©”ì¼ ì£¼ì†Œ</label>
                <div class="input-group">
                    <input type="email" id="emailInput" class="form-control form-control-lg" placeholder="example@email.com" onkeyup="if(event.key==='Enter') sendMagicLink()">
                    <button class="btn btn-dark" type="button" onclick="sendMagicLink()">ë§í¬ ë°›ê¸°</button>
                </div>
            </div>

            <div id="sentMsgBox" class="text-center hidden mt-4 p-4 bg-light rounded">
                <i class="bi bi-envelope-check text-success" style="font-size: 3rem;"></i>
                <h4 class="fw-bold mt-2">ë©”ì¼í•¨ì„ í™•ì¸í•´ì£¼ì„¸ìš”!</h4>
                <p class="text-muted mb-3">
                    <span id="targetEmail" class="fw-bold text-dark"></span>(ìœ¼)ë¡œ<br>
                    ë¡œê·¸ì¸ ë§í¬ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.
                </p>
                <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">ì´ë©”ì¼ ë‹¤ì‹œ ì…ë ¥í•˜ê¸°</button>
            </div>

            <div class="mt-4 pt-4 border-top">
                <button class="btn btn-warning w-100 fw-bold py-3" onclick="startKakaoLogin()">
                    <i class="bi bi-chat-fill me-2"></i> ì¹´ì¹´ì˜¤ë¡œ ë°”ë¡œ ì‹œì‘í•˜ê¸°
                </button>
                <div class="text-center mt-2">
                    <small class="text-muted">(ê¸°ì¡´ì— ì¹´ì¹´ì˜¤ë¥¼ ì—°ë™í•œ ì¡°í•©ì›ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤)</small>
                </div>
            </div>
        </div>
    </div>

    <div id="dashboardSection" class="hidden">
        
        <div id="birthdayBanner" onclick="fireConfetti()">
            ğŸ‰ <span id="birthdayMsgName"></span>ë‹˜, ìƒì¼ì„ ì§„ì‹¬ìœ¼ë¡œ ì¶•í•˜í•©ë‹ˆë‹¤! (í´ë¦­í•˜ë©´ í­ì£½ì´ í„°ì ¸ìš”!) ğŸ‚
        </div>

        <div class="dashboard-card mb-4" id="profileCard">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold m-0"><i class="bi bi-person-lines-fill me-2"></i>ë‚´ ì •ë³´</h5>
                <div>
                    <button class="btn btn-sm btn-outline-secondary" id="btnEditProfile" onclick="toggleEditMode(true)">ì •ë³´ ìˆ˜ì •</button>
                    <button class="btn btn-sm btn-success hidden" id="btnSaveProfile" onclick="saveProfile()">ì €ì¥</button>
                    <button class="btn btn-sm btn-light hidden" id="btnCancelEdit" onclick="toggleEditMode(false)">ì·¨ì†Œ</button>
                </div>
            </div>
            
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="small text-muted">ì´ë¦„</label>
                    <div class="fw-bold" id="infoName">-</div>
                </div>
                <div class="col-md-6">
                    <label class="small text-muted">ìƒë…„ì›”ì¼</label>
                    <div class="fw-bold" id="infoBirth">-</div>
                </div>
                <div class="col-md-6">
                    <label class="small text-muted">ì´ë©”ì¼ (ë³€ê²½ë¶ˆê°€)</label>
                    <div class="fw-bold text-secondary" id="infoEmail">-</div>
                </div>

                <div class="col-md-6">
                    <label class="small text-muted">ì „í™”ë²ˆí˜¸</label>
                    <input type="text" id="editPhone" class="readonly-text" readonly>
                </div>

                <div class="col-12">
                    <label class="small text-muted">ì£¼ì†Œ</label>
                    
                    <div id="viewAddressBox" class="fw-bold p-1 border-bottom" style="min-height: 30px;"></div>
                    
                    <div id="editAddressBox" class="addr-edit-group">
                        <div class="d-flex gap-2 mb-2"> 
                            <input type="text" id="editAddrMain" class="form-control" placeholder="ì£¼ì†Œ ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”" readonly onclick="execDaumPostcode()" style="background-color:#fff;">
                            <button class="btn btn-secondary" type="button" onclick="execDaumPostcode()" style="white-space:nowrap;">ì£¼ì†Œ ê²€ìƒ‰</button>
                        </div>
                        <input type="text" id="editAddrDetail" class="form-control" placeholder="ìƒì„¸ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                </div>

                <div class="col-12 border-top pt-2 mt-2">
                    <label class="small text-success fw-bold">í™˜ê¸‰/ë°°ë‹¹ ê³„ì¢Œ</label>
                    <div class="row g-2">
                        <div class="col-4">
                            <input type="text" id="editBankName" class="readonly-text" placeholder="ì€í–‰ëª…" readonly>
                        </div>
                        <div class="col-8">
                            <input type="text" id="editAccountNo" class="readonly-text" placeholder="ê³„ì¢Œë²ˆí˜¸" readonly>
                        </div>
                        <div class="col-12">
                            <input type="text" id="editHolder" class="readonly-text" placeholder="ì˜ˆê¸ˆì£¼" readonly>
                        </div>
                    </div>
                    <small class="text-muted edit-mode-only" style="display:none; font-size:0.8rem;">* ê³„ì¢Œë²ˆí˜¸ë¥¼ ìˆ˜ì •í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ì¡´ ì •ë³´(ë§ˆìŠ¤í‚¹)ê°€ ìœ ì§€ë©ë‹ˆë‹¤.</small>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4" id="assetSummaryRow">
            <div class="col-md-6 col-lg-4">
                <div class="dashboard-card text-center">
                    <i class="bi bi-person-badge count-icon" style="font-size: 2.5rem; color: #2E7D32; margin-bottom: 10px;"></i>
                    <div class="count-title" style="color: #666; font-size: 0.9rem;">ì¡°í•©ì› ë²ˆí˜¸</div>
                    <div class="count-val" id="sumId" style="font-family: 'GmarketSans'; font-weight: 700; font-size: 1.5rem; color: #333;">-</div>
                </div>
            </div>
            <div class="col-md-6 col-lg-4">
                <div class="dashboard-card text-center">
                    <i class="bi bi-piggy-bank count-icon" style="font-size: 2.5rem; color: #2E7D32; margin-bottom: 10px;"></i>
                    <div class="count-title" style="color: #666; font-size: 0.9rem;">ì´ ë‚©ì… ì¶œìê¸ˆ</div>
                    <div class="count-val text-green" id="sumTotal" style="font-family: 'GmarketSans'; font-weight: 700; font-size: 1.5rem; color: #2E7D32;">0ì›</div>
                </div>
            </div>
            <div class="col-md-12 col-lg-4">
                <div class="dashboard-card text-center d-flex flex-column justify-content-center align-items-center">
                   <div class="count-title mb-2" style="color: #666; font-size: 0.9rem;">í™˜ê¸‰/ë°°ë‹¹ ê³„ì¢Œ</div>
                   <div class="fw-bold fs-5" id="sumBank">ë“±ë¡ëœ ê³„ì¢Œ ì—†ìŒ</div>
                   <small class="text-muted mt-1" style="font-size:0.8rem;">ë³€ê²½ì€ 'ì •ë³´ ìˆ˜ì •' ë²„íŠ¼ í´ë¦­</small>
                </div>
            </div>
        </div>

      <div class="dashboard-card mb-4">
    <h5 class="fw-bold mb-3 border-bottom pb-2">ë‚˜ì˜ ë±ƒì§€ ì»¬ë ‰ì…˜</h5>
    <div id="badgeContainer" class="py-2">
        <span class="spinner-border spinner-border-sm"></span> ë¡œë”© ì¤‘...
    </div>
</div>

        <div class="row g-4 mb-4">
            <div class="col-lg-5">
                <div class="dashboard-card">
                    <h5 class="fw-bold mb-3 border-bottom pb-2">ì—…ë¬´ ì‹ ì²­</h5>
                    
                    <div class="d-grid gap-2">
                        <button class="menu-btn" onclick="toggleTab('extra', this)"><span><i class="bi bi-plus-circle me-2"></i>ì¶”ê°€ ì¶œì</span><i class="bi bi-chevron-right"></i></button>
                        <button class="menu-btn" onclick="toggleTab('reduction', this)"><span><i class="bi bi-dash-circle me-2"></i>ê°ì ì‹ ì²­</span><i class="bi bi-chevron-right"></i></button>
                        <button class="menu-btn" onclick="toggleTab('withdraw', this)"><span><i class="bi bi-box-arrow-left me-2"></i>íƒˆí‡´ ì‹ ì²­</span><i class="bi bi-chevron-right"></i></button>
                        <button class="menu-btn" onclick="toggleTab('cert', this)"><span><i class="bi bi-file-earmark-pdf me-2"></i>ì¦ëª…ì„œ ë°œê¸‰</span><i class="bi bi-chevron-right"></i></button>
                    </div>

                    <div id="actionArea" class="mt-4 bg-light p-3 rounded">
                        <div id="tabPlaceholder" class="text-center text-muted small py-3">ë©”ë‰´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>

                        <div id="tabExtra" class="hidden">
                            <h6 class="fw-bold mb-3">ì¶”ê°€ ì¶œì ì‹ ì²­</h6>
                            <div class="mb-3">
                                <label class="form-label small">ì•½ì • ê¸ˆì•¡ (1ë§Œì› ë‹¨ìœ„)</label>
                                <input type="number" id="exAmount" class="form-control" placeholder="ê¸ˆì•¡ ì…ë ¥" step="10000">
                            </div>
                            <button class="btn btn-success w-100 fw-bold" onclick="submitApplication('extra')">ì‹ ì²­í•˜ê¸°</button>
                        </div>

                        <div id="tabReduction" class="hidden">
                            <h6 class="fw-bold mb-3">ê°ì ì‹ ì²­</h6>
                            <div class="alert alert-warning small py-2"><i class="bi bi-exclamation-triangle me-1"></i> ìµœì†Œ 10ë§Œì› ì´ìƒì˜ ì¶œìê¸ˆì€ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.</div>
                            <div class="mb-3">
                                <label class="form-label small">í™˜ê¸‰ ìš”ì²­ì•¡</label>
                                <input type="number" id="redAmount" class="form-control" placeholder="ê¸ˆì•¡ ì…ë ¥">
                                <span id="redLimitDisplay" class="limit-text"></span>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="checkRedAgree">
                                <label class="form-check-label small" for="checkRedAgree">
                                    ê°ìëŠ” ë‹¤ìŒë…„ë„ ì´íšŒ ìŠ¹ì¸ í›„ ì²˜ë¦¬ë˜ë©°,<br>ìì‚° ìƒí™©ì— ë”°ë¼ ì¡°ì •ë  ìˆ˜ ìˆìŒì„ í™•ì¸í•©ë‹ˆë‹¤.
                                </label>
                            </div>
                            <button class="btn btn-success w-100 fw-bold" onclick="submitApplication('reduction')">ì‹ ì²­í•˜ê¸°</button>
                        </div>

                        <div id="tabWithdraw" class="hidden">
                            <h6 class="fw-bold text-danger mb-3">íƒˆí‡´ ì‹ ì²­</h6>
                            <div class="mb-3">
                                <label class="form-label small">íƒˆí‡´ ì‚¬ìœ </label>
                                <textarea id="wdReason" class="form-control" rows="3" placeholder="ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"></textarea>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="checkWdAgree">
                                <label class="form-check-label small text-danger fw-bold" for="checkWdAgree">
                                    íƒˆí‡´ ì‹œ ì¶œìê¸ˆì€ ë‹¤ìŒë…„ë„ ì´íšŒ ìŠ¹ì¸ í›„<br>í™˜ê¸‰ë¨ì„ í™•ì¸í•˜ì˜€ìŠµë‹ˆë‹¤.
                                </label>
                            </div>
                            <button class="btn btn-dark w-100 fw-bold" onclick="submitApplication('withdraw')">íƒˆí‡´ ì‹ ì²­</button>
                        </div>

                        <div id="tabCert" class="hidden text-center py-3">
                            <h6 class="fw-bold">ì¶œì ì¦ëª…ì„œ</h6>
                            <p class="small text-muted">í˜„ì¬ ë‚©ì…ëœ ì¶œìê¸ˆì„ ê¸°ì¤€ìœ¼ë¡œ<br>PDF ì¦ëª…ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
                            <button class="btn btn-outline-success w-100 fw-bold" onclick="downloadCert()">
                                <i class="bi bi-download me-2"></i>ë‹¤ìš´ë¡œë“œ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-7">
                <div class="dashboard-card">
                    <h5 class="fw-bold mb-4 border-bottom pb-2">ìµœê·¼ í™œë™ ë‚´ì—­</h5>
                    <div id="timelineList" style="max-height: 600px; overflow-y: auto;">
                        <p class="text-center text-muted py-5">ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-card mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                <div class="d-flex gap-2">
                    <button class="board-tab-btn active" onclick="loadBoard('notice', this)">ê³µì§€ì‚¬í•­</button>
                    <button class="board-tab-btn" onclick="loadBoard('free', this)">ììœ ê²Œì‹œíŒ</button>
                    <button class="board-tab-btn hidden" id="tabExec" onclick="loadBoard('executive', this)">ì„ì›</button>
                    <button class="board-tab-btn hidden" id="tabElec" onclick="loadBoard('election', this)">ì„ ê´€ìœ„</button>
                </div>
                <button class="btn btn-sm btn-dark hidden" id="btnWritePost" onclick="openWriteModal()">
                    <i class="bi bi-pencil-square"></i> ê¸€ì“°ê¸°
                </button>
            </div>
            <div id="boardList" style="min-height: 200px;">
                </div>
        </div>

        <div class="dashboard-card mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold m-0"><i class="bi bi-people-fill me-2"></i>ê°€ì¡±/ì§ì› ê³„ì • ê´€ë¦¬</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="openAddFamilyModal()">+ ì¶”ê°€</button>
            </div>
            <div id="familyListArea">
                <p class="text-muted small text-center py-3">ë“±ë¡ëœ êµ¬ì„±ì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </div>

    </div> </main>
  

  <footer id="footer"></footer>

  <div id="customModalOverlay" class="custom-modal-overlay">
    <div class="custom-modal-box">
        <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“¢</div>
        <p id="customModalMsg" style="white-space: pre-wrap; margin-bottom: 20px; font-weight: 500; font-size: 1.1rem; color:#333;"></p>
        <div class="custom-modal-btn-group">
            <button id="btnModalNo" class="btn-modal btn-modal-no" onclick="closeCustomModal()">ì·¨ì†Œ</button>
            <button id="btnModalYes" class="btn-modal btn-modal-yes">í™•ì¸</button>
        </div>
    </div>
</div>

  <div id="writeModalOverlay" class="custom-modal-overlay">
    <div class="custom-modal-box" style="text-align:left; max-width:500px;">
        <h5 class="fw-bold mb-3">ê²Œì‹œê¸€ ì‘ì„±</h5>
        <div class="mb-2">
            <input type="text" id="writeTitle" class="form-control" placeholder="ì œëª©">
        </div>
        <div class="mb-2">
            <textarea id="writeContent" class="form-control" rows="5" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        </div>
        <div class="mb-3">
            <label class="small text-muted">ì²¨ë¶€íŒŒì¼ (URL ì…ë ¥)</label>
            <input type="text" id="writeFile" class="form-control form-control-sm" placeholder="https://...">
        </div>
        <div class="custom-modal-btn-group">
            <button class="btn-modal btn-modal-no" onclick="document.getElementById('writeModalOverlay').style.display='none'">ì·¨ì†Œ</button>
            <button class="btn-modal btn-modal-yes" onclick="submitPost()">ë“±ë¡</button>
        </div>
    </div>
</div>


  
<div id="layer" style="display:none;position:fixed;overflow:hidden;z-index:9999;-webkit-overflow-scrolling:touch;">
  <img src="//t1.daumcdn.net/postcode/resource/images/close.png" id="btnCloseLayer" style="cursor:pointer;position:absolute;right:-3px;top:-3px;z-index:1" onclick="closeDaumPostcode()" alt="ë‹«ê¸° ë²„íŠ¼">
</div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="footer.js"></script>

 <script>
    // =========================================================================
    // 1. Supabase ì„¤ì •
    // =========================================================================
    const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
    
    let _supabase = null;
    let curMem = null;
    let curAuth = null;

    try {
        _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch (e) {
        console.error("Supabase Init Error", e);
        alert("ì‹œìŠ¤í…œ ì—°ê²° ì˜¤ë¥˜");
    }

    function showLoading(show, msg) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        if(msg) document.getElementById('loadingMsg').innerText = msg;
    }

    // ì´ˆê¸°í™”
    window.addEventListener('DOMContentLoaded', async () => {
        if(!_supabase) return;
        const { data: { session } } = await _supabase.auth.getSession();
        if (session) handleLoginSuccess(session.user);
    });

    // =========================================================================
    // 2. ë¡œê·¸ì¸ & ë°ì´í„° ë¡œë“œ
    // =========================================================================
async function sendMagicLink() {
    const email = document.getElementById('emailInput').value.trim();
    if(!email.includes('@')) return showModal('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    
    showLoading(true, 'ì¸ì¦ ë©”ì¼ ë°œì†¡ ì¤‘...');
    
    // [ìˆ˜ì •ë¨] shouldCreateUser: true
    // ì´ì œ ì—†ëŠ” ì´ë©”ì¼ì´ë©´ 'ìë™ ê°€ì…' ì²˜ë¦¬ë˜ë©´ì„œ -> DB íŠ¸ë¦¬ê±°ê°€ ë°œë™ -> ë°ì´í„° ë§¤ì¹­ ì„±ê³µ
    const { error } = await _supabase.auth.signInWithOtp({
        email: email,
        options: { shouldCreateUser: true, emailRedirectTo: window.location.href }
    });
    
    showLoading(false);

    if(error) showModal('ì˜¤ë¥˜: ' + error.message);
    else {
        document.getElementById('sentMsgBox').classList.remove('hidden');
        document.getElementById('targetEmail').innerText = email;
    }
}

async function handleLoginSuccess(user) {
        curAuth = user;
        showLoading(true, 'ì •ë³´ í™•ì¸ ì¤‘...');
        document.getElementById('headerLogoutBtn').classList.remove('hidden');

        const { data: claimRes, error: claimErr } = await _supabase.rpc('claim_member_profile');
        if (claimErr || (!claimRes.success && claimRes.message === 'not_found')) {
            await _supabase.auth.signOut();
            showLoading(false);
            return showModal('ì¡°í•©ì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); // alert -> showModal
        }
        await loadDashboardData(user.id);
    }

async function loadDashboardData(uuid) {
        try {
            // [1] ë‚´ ì •ë³´ & ìì‚° (ìƒˆë¡œ ë§Œë“  VIEW ì‚¬ìš©)
            const { data: assets, error: assetErr } = await _supabase.from('view_my_assets').select('*').eq('member_uid', uuid).single();
            if(assetErr) throw assetErr;
            
            // ê¸°ì¡´ curMem í˜¸í™˜ì„±ì„ ìœ„í•´ view_member_listë„ í•œë²ˆ í˜¸ì¶œ (ì •ë³´ìˆ˜ì • ë“± ìƒì„¸ì •ë³´ìš©)
            const { data: member } = await _supabase.from('view_member_list').select('*').eq('id', uuid).single();
            curMem = member; 
            
            // [2] ì‹ ì²­ ë‚´ì—­ & ì…ê¸ˆ ë‚´ì—­ (ê¸°ì¡´ ë™ì¼)
            const { data: apps } = await _supabase.from('coop_applications').select('*').eq('member_uid', uuid).order('created_at', { ascending: false });
            const { data: ledger } = await _supabase.from('ref_members').select('*').eq('member_id', curMem.member_id).order('deposit_date', { ascending: false });

            // [3] ì„ì› ì—¬ë¶€ í™•ì¸ (ê²Œì‹œíŒ ê¶Œí•œìš©)
            const { data: officials } = await _supabase.from('coop_officials').select('category').eq('member_id', curMem.member_id);
            const myRoles = officials ? officials.map(r => r.category) : [];

            // ë Œë”ë§ ì‹¤í–‰
            renderDashboard(member, apps || [], ledger || [], assets, myRoles);
            
            // ì¶”ê°€ ê¸°ëŠ¥ ì‹¤í–‰
            checkBirthday(member.rrn_display, member.name);
            loadFamilyList(uuid);
            loadBoard('notice'); // ê¸°ë³¸ ê³µì§€ì‚¬í•­ ë¡œë“œ

            showLoading(false);

        } catch (e) {
            console.error(e);
            showLoading(false);
            showModal('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
        }

  // [ì¶”ê°€] ë±ƒì§€ ë Œë”ë§ & Nì£¼ë…„ ì²´í¬
Badges.render('badgeContainer', curAuth.id, _supabase);
Badges.checkAnniversary(curMem, _supabase);

showLoading(false);
    }



    // =========================================================================
    // 3. ë Œë”ë§ & ë‚´ ì •ë³´ ìˆ˜ì • (toggleEditMode í¬í•¨)
    // =========================================================================
function renderDashboard(member, apps, ledger, assets, myRoles) {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('dashboardSection').classList.remove('hidden');

        // 1. ê¸°ë³¸ ì •ë³´ (ê¸°ì¡´ ë™ì¼)
        setText('infoName', member.name);
        setText('infoBirth', formatBirthDate(member.rrn_display));
        setText('infoEmail', curAuth.email);
        setVal('editPhone', member.phone);
        setVal('editBankName', member.bank_name);
        setVal('editAccountNo', member.account_number);
        setVal('editHolder', member.account_holder);
        setText('viewAddressBox', member.address);
        setVal('editAddrMain', member.address); 
        setVal('editAddrDetail', '');

        // 2. ìì‚° í˜„í™© ì¹´ë“œ (ë™ì  ìƒì„±)
        const assetRow = document.getElementById('assetSummaryRow');
        // ê¸°ë³¸ 2ê°œ(ë²ˆí˜¸, ì¶œìê¸ˆ)ëŠ” ìœ ì§€í•˜ê³  ì¶”ê°€ ìì‚°ë§Œ ë¶™ì„
        // ì´ˆê¸°í™”: ì• 2ê°œ divë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ ì‚­ì œ
        while(assetRow.children.length > 2) { assetRow.removeChild(assetRow.lastChild); }

        // ê°’ ë§¤í•‘
        setText('sumId', member.member_id);
        setText('sumTotal', Number(assets.total_capital).toLocaleString() + 'ì›');

        // (A) ê¸°ë¶€ê¸ˆ (ìˆì„ ë•Œë§Œ)
        if(assets.total_donation > 0) addAssetCard(assetRow, 'ê¸°ë¶€ê¸ˆ', assets.total_donation);
        // (B) ë°°ë‹¹ê¸ˆ (ì¶œì+ì´ìš©ê³  í•©ê³„, ìˆì„ ë•Œë§Œ)
        const totalDiv = (assets.dividend_capital || 0) + (assets.dividend_usage || 0);
        if(totalDiv > 0) addAssetCard(assetRow, 'ë°°ë‹¹ê¸ˆ(ì¶œì+ì´ìš©)', totalDiv);
        // (C) í¬ì¸íŠ¸ (ìˆì„ ë•Œë§Œ)
        if(assets.current_points > 0) addAssetCard(assetRow, 'í¬ì¸íŠ¸', assets.current_points, 'P');

        // 3. ê²Œì‹œíŒ íƒ­ ê¶Œí•œ ì²˜ë¦¬
        if(myRoles.includes('executive')) document.getElementById('tabExec').classList.remove('hidden');
        if(myRoles.includes('election_comm')) document.getElementById('tabElec').classList.remove('hidden');

        // 4. íƒ€ì„ë¼ì¸ (ê¸°ì¡´ ë™ì¼)
        renderTimeline(ledger, apps);
    }

    // [í—¬í¼] ìì‚° ì¹´ë“œ ì¶”ê°€
    function addAssetCard(row, title, val, unit='ì›') {
        const col = document.createElement('div');
        col.className = 'col-6 col-md-3';
        col.innerHTML = `
            <div class="dashboard-card text-center p-3">
                <small class="text-muted d-block mb-1">${title}</small>
                <div class="fw-bold fs-5 text-primary">${Number(val).toLocaleString()}${unit}</div>
            </div>`;
        row.appendChild(col);
    }





    // [í—¬í¼] ìƒë…„ì›”ì¼ í¬ë§·íŒ…
    function formatBirthDate(rrn) {
        if (!rrn || rrn.length < 6) return '-';
        const yy = rrn.substring(0, 2);
        const mm = rrn.substring(2, 4);
        const dd = rrn.substring(4, 6);
        
        // ì„±ë³„ ì½”ë“œ í™•ì¸ (ì—†ìœ¼ë©´ 1900ë…„ëŒ€ë¡œ ê°€ì •)
        let prefix = '19';
        if (rrn.includes('-')) {
            const gender = rrn.split('-')[1].charAt(0);
            if (gender === '3' || gender === '4') prefix = '20';
        }
        
        return `${prefix}${yy}ë…„ ${Number(mm)}ì›” ${Number(dd)}ì¼`;
    }

    // =========================================================================
    // 4. ì‹ ì²­ ë° íƒ€ì„ë¼ì¸
    // =========================================================================
    function renderTimeline(ledger, apps) {
        const list = document.getElementById('timelineList');
        let html = '';

        if(ledger.length === 0 && apps.length === 0) {
            list.innerHTML = '<div class="text-center text-muted py-5">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        ledger.forEach(item => {
            html += `
            <div class="timeline-item">
                <div class="timeline-date">${item.deposit_date ? item.deposit_date.substring(0,10) : 'ë‚ ì§œë¯¸ìƒ'}</div>
                <div class="timeline-content">
                    <h5>ì…ê¸ˆ í™•ì¸</h5>
                    <p class="text-success fw-bold">+${Number(item.amount).toLocaleString()}ì›</p>
                </div>
            </div>`;
        });

        const typeMap = { 'extra': 'ì¶”ê°€ì¶œì', 'reduction': 'ê°ì', 'withdraw': 'íƒˆí‡´' };
        apps.forEach(app => {
            let statusBadge = '';
            let actionBtn = '';

            if(app.status === 'pending') {
                statusBadge = '<span class="badge bg-warning text-dark">ê²€í† ì¤‘</span>';
                actionBtn = `<button class="btn btn-sm btn-outline-danger ms-2" style="font-size:0.7rem; padding:2px 6px;" onclick="cancelApp(${app.id})">ì·¨ì†Œ</button>`;
            } else if(app.status === 'approved') {
                statusBadge = '<span class="badge bg-success">ìŠ¹ì¸ë¨</span>';
            } else if(app.status === 'cancelled') {
                statusBadge = '<span class="badge bg-secondary">ì·¨ì†Œë¨</span>';
            } else {
                statusBadge = '<span class="badge bg-danger">ë°˜ë ¤ë¨</span>';
            }

            html += `
            <div class="timeline-item" style="border-left-color: #ff9800;">
                <div class="timeline-date">${app.created_at.substring(0,10)}</div>
                <div class="timeline-content">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-bold">[ì‹ ì²­] ${typeMap[app.type]}</span>
                            ${statusBadge}
                        </div>
                        ${actionBtn}
                    </div>
                    <p>${Number(app.amount).toLocaleString()}ì›</p>
                </div>
            </div>`;
        });

        list.innerHTML = html;
    }

async function cancelApp(appId) {
        // confirm -> showConfirmModal
        showConfirmModal('ì‹ ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async function() {
            showLoading(true);
            const { error } = await _supabase
                .from('coop_applications')
                .update({ status: 'cancelled' })
                .eq('id', appId);

            showLoading(false);
            if(error) showModal('ì·¨ì†Œ ì‹¤íŒ¨: ' + error.message);
            else {
                showModal('ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadDashboardData(curAuth.id);
            }
        });
    }

    // ì‹ ì²­ ë¡œì§ (Submit)
async function submitApplication(type) {
        let amount = 0, reason = '';
        const totalCap = Number(curMem.total_capital || 0);

        if(type === 'extra') {
            amount = Number(document.getElementById('exAmount').value);
            if(amount < 10000) return showModal('1ë§Œì› ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        } 
        else if(type === 'reduction') {
            amount = Number(document.getElementById('redAmount').value);
            if(amount <= 0) return showModal('ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            if(totalCap - amount < 100000) return showModal(`ì”ì•¡ 10ë§Œì› ì´ìƒ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.\n(í˜„ì¬: ${totalCap.toLocaleString()}ì›)`);
            if(!document.getElementById('checkRedAgree').checked) return showModal('ì•ˆë‚´ ì‚¬í•­ì— ë™ì˜í•´ì£¼ì„¸ìš”.');
        } 
        else if(type === 'withdraw') {
            reason = document.getElementById('wdReason').value;
            if(!reason) return showModal('ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            if(!document.getElementById('checkWdAgree').checked) return showModal('ë™ì˜ í•­ëª©ì— ì²´í¬í•´ì£¼ì„¸ìš”.');
        }

        // confirm -> showConfirmModal
        showConfirmModal('ì‹ ì²­ì„œë¥¼ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async function() {
            showLoading(true);
            const { error } = await _supabase.from('coop_applications').insert({
                member_uid: curAuth.id,
                member_id: curMem.member_id,
                name: curMem.name,
                type: type,
                amount: amount,
                reason: reason,
                status: 'pending'
            });

            showLoading(false);
            if(error) showModal('ì˜¤ë¥˜: ' + error.message);
            else {
                showModal('ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.');
                // ì´ˆê¸°í™”
                document.getElementById('exAmount').value = '';
                document.getElementById('redAmount').value = '';
                document.getElementById('wdReason').value = '';
                if(document.getElementById('checkRedAgree')) document.getElementById('checkRedAgree').checked = false;
                if(document.getElementById('checkWdAgree')) document.getElementById('checkWdAgree').checked = false;
                
                loadDashboardData(curAuth.id);
            }
        });
    }

// [ìˆ˜ì •] í”„ë¡œí•„ ì €ì¥ (ì£¼ì†Œ í•©ì¹˜ê¸° + ëª¨ë‹¬ í™•ì¸)
async function saveProfile() {
        // confirm -> showConfirmModal
        showConfirmModal('ì •ë³´ë¥¼ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async function() {
            showLoading(true, 'ì €ì¥ ì¤‘...');

            const phone = document.getElementById('editPhone').value;
            const mainAddr = document.getElementById('editAddrMain').value;
            const detailAddr = document.getElementById('editAddrDetail').value;
            const fullAddr = (mainAddr + ' ' + detailAddr).trim();
            const bank = document.getElementById('editBankName').value;
            const accNo = document.getElementById('editAccountNo').value;
            const holder = document.getElementById('editHolder').value;

            const { error } = await _supabase.rpc('update_my_profile', {
                p_phone: phone,
                p_address: fullAddr,
                p_bank_name: bank,
                p_account_number: accNo,
                p_account_holder: holder
            });

            showLoading(false);
            if (error) showModal('ìˆ˜ì • ì‹¤íŒ¨: ' + error.message); // alert -> showModal
            else {
                showModal('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.'); // alert -> showModal
                toggleEditMode(false);
            }
        });
    }

// [ìˆ˜ì •] íƒ­ ì „í™˜ (ê°ì í•œë„ ì²´í¬ ë¡œì§ í¬í•¨)
function toggleTab(type, btn) {
        document.getElementById('tabPlaceholder').classList.add('hidden');
        ['tabExtra', 'tabReduction', 'tabWithdraw', 'tabCert'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        document.getElementById('tab' + type.charAt(0).toUpperCase() + type.slice(1)).classList.remove('hidden');

        if(type === 'reduction') {
            const total = Number(curMem.total_capital || 0);
            const limit = total - 100000;
            const display = document.getElementById('redLimitDisplay');
            const input = document.getElementById('redAmount');
            
            if(limit <= 0) {
                display.innerText = "í˜„ì¬ ê°ì ì‹ ì²­ ë¶ˆê°€ (ì”ì•¡ ë¶€ì¡±)";
                input.disabled = true;
                input.placeholder = "ì‹ ì²­ ë¶ˆê°€";
            } else {
                display.innerText = `ìµœëŒ€ ì‹ ì²­ ê°€ëŠ¥: ${limit.toLocaleString()}ì›`;
                input.disabled = false;
                input.placeholder = `ìµœëŒ€ ${limit.toLocaleString()}`;
                
                input.oninput = function() {
                    if(Number(this.value) > limit) {
                        this.value = limit;
                        showModal(`ìµœëŒ€ ${limit.toLocaleString()}ì›ê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`); // alert -> showModal
                    }
                };
            }
        }
    }

async function downloadCert() {
        if(!curMem) return;
        showLoading(true, 'ì¦ì„œ ë°œê¸‰ ì¤‘...');
        try {
            const { data: pay } = await _supabase.from('ref_members').select('amount').eq('member_id', curMem.member_id);
            const total = pay ? pay.reduce((a,c)=>a+Number(c.amount),0) : 0;
            if(total===0) { showLoading(false); return showModal('ë‚©ì… ë‚´ì—­ ì—†ìŒ'); } // alert -> showModal

            const { data: cert } = await _supabase.rpc('issue_certificate', { p_member_id: curMem.member_id, p_amount: total });
            const { data: info } = await _supabase.from('ref_company_info').select('value').eq('key', 'chairman_name').single();
            
            await generateContributionCert(curMem, total, cert.cert_number, info?info.value:"ê¹€ë¯¼í˜¸", _supabase);
            showLoading(false);
        } catch(e) { console.error(e); showLoading(false); showModal('ì˜¤ë¥˜ ë°œìƒ'); } // alert -> showModal
    }

    function logout() { 
        showConfirmModal('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
            _supabase.auth.signOut().then(() => location.reload());
        }); 
    }

    function startKakaoLogin() { showModal('ì¹´ì¹´ì˜¤ ì—°ë™ ì¤€ë¹„ì¤‘'); } // alert -> showModal
    
    // [í—¬í¼] ì•ˆì „í•œ ê°’ ì„¤ì •
    function setText(id, txt) { const el=document.getElementById(id); if(el) el.innerText = txt || '-'; }
    function setVal(id, val) { const el=document.getElementById(id); if(el) el.value = val || ''; }

    function closeDaumPostcode() { document.getElementById('layer').style.display = 'none'; }

   // [ì¶”ê°€] ëª¨ë‹¬ ì œì–´ í•¨ìˆ˜
function showModal(msg) {
    document.getElementById('customModalMsg').innerText = msg;
    document.getElementById('btnModalNo').style.display = 'none'; // ì·¨ì†Œë²„íŠ¼ ìˆ¨ê¹€
    document.getElementById('btnModalYes').onclick = closeCustomModal;
    document.getElementById('customModalOverlay').style.display = 'flex';
}

function showConfirmModal(msg, yesCallback) {
    document.getElementById('customModalMsg').innerText = msg;
    document.getElementById('btnModalNo').style.display = 'block'; // ì·¨ì†Œë²„íŠ¼ ë³´ì„
    document.getElementById('customModalOverlay').style.display = 'flex';
    document.getElementById('btnModalYes').onclick = function() {
        closeCustomModal();
        if(yesCallback) yesCallback();
    };
}

function closeCustomModal() {
    document.getElementById('customModalOverlay').style.display = 'none';
}

   // =========================================================================
    // [1] ë Œë”ë§ í•¨ìˆ˜ (ì£¼ì†Œì°½ ì´ˆê¸°ê°’ ì„¸íŒ… í¬í•¨)
    // =========================================================================
    function renderDashboard(member, apps, ledger) {
        // ì„¹ì…˜ ì „í™˜
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('dashboardSection').classList.remove('hidden');

        // 1. ê¸°ë³¸ ì •ë³´ í‘œì‹œ
        const infoName = document.getElementById('infoName');
        const infoBirth = document.getElementById('infoBirth');
        const infoEmail = document.getElementById('infoEmail');
        
        if (infoName) infoName.innerText = member.name || '-';
        if (infoBirth) infoBirth.innerText = formatBirthDate(member.rrn_display);
        if (infoEmail) infoEmail.innerText = curAuth.email || '-';
        
        // 2. ìˆ˜ì • í¼ ì´ˆê¸°ê°’ ì„¤ì •
        if (document.getElementById('editPhone')) document.getElementById('editPhone').value = member.phone || '';
        if (document.getElementById('editBankName')) document.getElementById('editBankName').value = member.bank_name || '';
        if (document.getElementById('editAccountNo')) document.getElementById('editAccountNo').value = member.account_number || '';
        if (document.getElementById('editHolder')) document.getElementById('editHolder').value = member.account_holder || '';

        // â˜… [ì£¼ì†Œ ì²˜ë¦¬] í•µì‹¬ ë¡œì§
        // (A) ë³´ê¸° ëª¨ë“œìš©: ì „ì²´ ì£¼ì†Œ í‘œì‹œ
        const viewAddr = document.getElementById('viewAddressBox');
        if (viewAddr) viewAddr.innerText = member.address || '-';

        // (B) ìˆ˜ì • ëª¨ë“œìš©: DBì— ì €ì¥ëœ ì£¼ì†Œë¥¼ ì¼ë‹¨ 'ë©”ì¸ ì£¼ì†Œì°½'ì— ë‹¤ ë„£ìŒ
        if (document.getElementById('editAddrMain')) document.getElementById('editAddrMain').value = member.address || '';
        if (document.getElementById('editAddrDetail')) document.getElementById('editAddrDetail').value = ''; // ìƒì„¸ëŠ” ë¹„ì›Œë‘ 

        // 3. ìƒë‹¨ ìš”ì•½ ì •ë³´
        if (document.getElementById('sumId')) document.getElementById('sumId').innerText = member.member_id || '-';
        
        const sumTotal = document.getElementById('sumTotal');
        if (sumTotal) sumTotal.innerText = Number(member.total_capital || 0).toLocaleString() + 'ì›';
        
        const sumBank = document.getElementById('sumBank');
        if (sumBank) sumBank.innerText = member.bank_name ? `${member.bank_name} (ê³„ì¢Œ ìˆìŒ)` : 'ë¯¸ë“±ë¡';

        // 4. íƒ€ì„ë¼ì¸ ë Œë”ë§
        renderTimeline(ledger, apps);
    }

    // =========================================================================
    // [2] ìˆ˜ì • ëª¨ë“œ í† ê¸€ (ì£¼ì†Œì°½ 1ë‹¨ â†” 2ë‹¨ ì „í™˜ í¬í•¨)
    // =========================================================================
function toggleEditMode(isEdit) {
        const inputs = document.querySelectorAll('.readonly-text');
        const editOnly = document.querySelectorAll('.edit-mode-only'); 
        
        const viewAddr = document.getElementById('viewAddressBox');
        const editAddr = document.getElementById('editAddressBox');

        // ê³„ì¢Œë²ˆí˜¸ ì…ë ¥ì°½ ìš”ì†Œ
        const accInput = document.getElementById('editAccountNo');

        if (isEdit) {
            document.getElementById('btnEditProfile').classList.add('hidden');
            document.getElementById('btnSaveProfile').classList.remove('hidden');
            document.getElementById('btnCancelEdit').classList.remove('hidden');
            
            inputs.forEach(el => {
                el.readOnly = false;
                el.classList.add('editable-input');
                el.classList.remove('readonly-text');
            });

            // [ì¶”ê°€] ê³„ì¢Œë²ˆí˜¸ UX ê°œì„ : ìˆ˜ì • ëª¨ë“œ ì§„ì… ì‹œ ë§ˆìŠ¤í‚¹ëœ ê°’ ë¹„ìš°ê¸°
            // ì‚¬ìš©ìê°€ "ì•„, ìƒˆë¡œ ì…ë ¥í•´ì•¼ í•˜ëŠ”êµ¬ë‚˜"ë¼ê³  ì§ê´€ì ìœ¼ë¡œ ì•Œê²Œ í•¨
            accInput.value = ''; 
            accInput.placeholder = 'ë³€ê²½ ì‹œì—ë§Œ ì…ë ¥í•˜ì„¸ìš” (ê¸°ì¡´ ìœ ì§€)';

            // ì£¼ì†Œì°½ ì „í™˜
            viewAddr.style.display = 'none';
            editAddr.style.display = 'block';
            editOnly.forEach(el => el.classList.remove('hidden'));

        } else {
            // ì·¨ì†Œ ì‹œ ë°ì´í„° ì›ë³µ (ë¦¬ë¡œë“œ)
            loadDashboardData(curAuth.id);
            
            document.getElementById('btnEditProfile').classList.remove('hidden');
            document.getElementById('btnSaveProfile').classList.add('hidden');
            document.getElementById('btnCancelEdit').classList.add('hidden');
            
            inputs.forEach(el => {
                el.readOnly = true;
                el.classList.remove('editable-input');
                el.classList.add('readonly-text');
            });

            viewAddr.style.display = 'block';
            editAddr.style.display = 'none';
            editOnly.forEach(el => el.classList.add('hidden'));
        }
    }

    // =========================================================================
    // [3] ë‹¤ìŒ ì£¼ì†Œ ì°¾ê¸° (ê²€ìƒ‰ ê²°ê³¼ë¥¼ 2ë‹¨ ì£¼ì†Œì°½ì— ë¶„ë°°)
    // =========================================================================
    function execDaumPostcode() {
        var element_layer = document.getElementById('layer');

        new daum.Postcode({
            oncomplete: function(data) {
                // ê²€ìƒ‰ ê²°ê³¼ í•­ëª©ì„ ì¡°í•©
                var addr = ''; // ì£¼ì†Œ ë³€ìˆ˜
                var extraAddr = ''; // ì°¸ê³ í•­ëª© ë³€ìˆ˜

                // ì‚¬ìš©ìê°€ ì„ íƒí•œ ì£¼ì†Œ íƒ€ì…ì— ë”°ë¼ í•´ë‹¹ ì£¼ì†Œ ê°’ì„ ê°€ì ¸ì˜¨ë‹¤.
                if (data.userSelectedType === 'R') { // ë„ë¡œëª… ì£¼ì†Œ
                    addr = data.roadAddress;
                } else { // ì§€ë²ˆ ì£¼ì†Œ
                    addr = data.jibunAddress;
                }

                // ê±´ë¬¼ëª…ì´ ìˆê³  ê³µë™ì£¼íƒì¼ ê²½ìš° ì¶”ê°€
                if(data.userSelectedType === 'R'){
                    if(data.bname !== '' && /[ë™|ë¡œ|ê°€]$/g.test(data.bname)){
                        extraAddr += data.bname;
                    }
                    if(data.buildingName !== '' && data.apartment === 'Y'){
                        extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    if(extraAddr !== ''){
                        addr += ' (' + extraAddr + ')';
                    }
                }

                // â˜… ê°’ ë„£ê¸°: ê²€ìƒ‰ëœ ì£¼ì†ŒëŠ” ë©”ì¸ ì°½ì—, ì»¤ì„œëŠ” ìƒì„¸ ì£¼ì†Œì°½ìœ¼ë¡œ
                document.getElementById('editAddrMain').value = addr;
                document.getElementById('editAddrDetail').value = ''; // ìƒì„¸ì£¼ì†Œ ì´ˆê¸°í™”
                document.getElementById('editAddrDetail').focus();    // ìƒì„¸ì£¼ì†Œë¡œ í¬ì»¤ìŠ¤ ì´ë™

                // ë ˆì´ì–´ ë‹«ê¸°
                element_layer.style.display = 'none';
            },
            width : '100%',
            height : '100%',
            maxSuggestItems : 5
        }).embed(element_layer);

        // ë ˆì´ì–´ ë³´ì´ê¸°
        element_layer.style.display = 'block';

        // ë ˆì´ì–´ ìœ„ì¹˜ ì¡°ì • (í™”ë©´ ì¤‘ì•™)
        initLayerPosition();
    }

    // (ë³´ì¡°) ë ˆì´ì–´ ìœ„ì¹˜ ì¡ëŠ” í•¨ìˆ˜
    function initLayerPosition(){
        var element_layer = document.getElementById('layer');
        var width = 300; 
        var height = 400;
        var borderWidth = 5;

        // ìœ„ì—ì„œ ì„ ì–¸í•œ ê°’ë“¤ì„ ì‹¤ì œ elementì— ë„£ìŒ
        element_layer.style.width = width + 'px';
        element_layer.style.height = height + 'px';
        element_layer.style.border = borderWidth + 'px solid';
        
        // ì‹¤í–‰ë˜ëŠ” ìˆœê°„ì˜ í™”ë©´ ë„ˆë¹„ì™€ ë†’ì´ ê°’ì„ ê°€ì ¸ì™€ì„œ ì¤‘ì•™ì— ëœ° ìˆ˜ ìˆë„ë¡ ìœ„ì¹˜ë¥¼ ê³„ì‚°
        element_layer.style.left = (((window.innerWidth || document.documentElement.clientWidth) - width)/2 - borderWidth) + 'px';
        element_layer.style.top = (((window.innerHeight || document.documentElement.clientHeight) - height)/2 - borderWidth) + 'px';
    }

    // (ë³´ì¡°) ë‹«ê¸° ë²„íŠ¼ìš© í•¨ìˆ˜
    function closeDaumPostcode() {
        document.getElementById('layer').style.display = 'none';
    }

   // ==========================================
    // [ì¶”ê°€] 1. ìƒì¼ ì¶•í•˜ ë¡œì§
    // ==========================================
    function checkBirthday(rrn, name) {
        if(!rrn || rrn.length < 4) return;
        const today = new Date();
        const mm = String(today.getMonth()+1).padStart(2,'0');
        const dd = String(today.getDate()).padStart(2,'0');
        const userBirthMMDD = rrn.substring(2, 6); // ì£¼ë¯¼ë²ˆí˜¸ 3~6ë²ˆì§¸ (MMDD)

        if(userBirthMMDD === mm + dd) {
            // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ì²´í¬ (ìƒˆë¡œê³ ì¹¨ ì‹œ ê³„ì† í„°ì§€ëŠ” ê²ƒ ë°©ì§€)
            if(!sessionStorage.getItem('birthdayShown')) {
                fireConfetti();
                sessionStorage.setItem('birthdayShown', 'true');
            }
            const banner = document.getElementById('birthdayBanner');
            document.getElementById('birthdayMsgName').innerText = name;
            banner.style.display = 'block';
        }
    }
    function fireConfetti() {
        if(window.confetti) {
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }
    }

    // ==========================================
    // [ì¶”ê°€] 2. ê°€ì¡±/ì§ì› ê´€ë¦¬
    // ==========================================
    function openAddFamilyModal() {
        document.getElementById('familyModalOverlay').style.display = 'flex';
        // ë¶€ëª¨ ì—°ë½ì²˜ ìë™ ì…ë ¥ (í¸ì˜ì„±)
        document.getElementById('famPhone').value = curMem.phone || '';
    }

    async function loadFamilyList(managerUid) {
        // manager_idê°€ ë‚´ UUIDì¸ ë©¤ë²„ ì¡°íšŒ
        const { data: fams } = await _supabase
            .from('coop_members')
            .select('*')
            .eq('manager_id', managerUid);
        
        const area = document.getElementById('familyListArea');
        if(!fams || fams.length === 0) {
            area.innerHTML = '<p class="text-muted small text-center py-3">ë“±ë¡ëœ êµ¬ì„±ì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        let html = '<ul class="list-group list-group-flush">';
        fams.forEach(f => {
            html += `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <span class="fw-bold">${f.name}</span>
                    <small class="text-muted ms-2">${f.member_id || 'ìŠ¹ì¸ ëŒ€ê¸°ì¤‘'}</small>
                </div>
                <span class="badge bg-light text-dark border">${f.join_category}</span>
            </li>`;
        });
        html += '</ul>';
        area.innerHTML = html;
    }

    async function submitFamily() {
        const name = document.getElementById('famName').value;
        const rrn1 = document.getElementById('famRrn1').value;
        const rrn2 = document.getElementById('famRrn2').value;
        const phone = document.getElementById('famPhone').value;

        if(!name || rrn1.length !== 6 || rrn2.length !== 1) return showModal('ì •ë³´ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');

        showConfirmModal(`${name}ë‹˜ì„ êµ¬ì„±ì›ìœ¼ë¡œ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async () => {
            showLoading(true);
            
            // ë¶€ëª¨ ì •ë³´ ë³µì‚¬ + í•„ìˆ˜ê°’ ì„¤ì •
            const { error } = await _supabase.from('coop_members').insert({
                manager_id: curAuth.id, // ë¶€ëª¨ UUID ì—°ê²°
                name: name,
                rrn_display: `${rrn1}-${rrn2}******`, // ë§ˆìŠ¤í‚¹ ì €ì¥
                phone: phone,
                address: curMem.address, // ì£¼ì†ŒëŠ” ë¶€ëª¨ì™€ ë™ì¼í•˜ë‹¤ê³  ê°€ì •
                join_category: 'ê°€ì¡±', // ë˜ëŠ” ë‹¨ì²´ë©´ 'ì§ì›' (UIì—ì„œ ì„ íƒí•˜ê²Œ í•˜ê±°ë‚˜ ìë™ì²˜ë¦¬)
                status: 'active' // ì¦‰ì‹œ í™œì„±í™” (ë˜ëŠ” pending)
            });

            showLoading(false);
            if(error) showModal('ë“±ë¡ ì‹¤íŒ¨: ' + error.message);
            else {
                showModal('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                document.getElementById('familyModalOverlay').style.display = 'none';
                loadFamilyList(curAuth.id);
            }
        });
    }


// ==========================================
    // [ê²Œì‹œíŒ ë¡œì§] ê³µì§€ì‚¬í•­(Notices) vs ê²Œì‹œíŒ(Boards) ë¶„ê¸° ì²˜ë¦¬
    // ==========================================
    let currentBoardCat = 'notice';

    async function loadBoard(category, btn) {
        currentBoardCat = category;
        
        // 1. íƒ­ UI í™œì„±í™”
        if(btn) {
            document.querySelectorAll('.board-tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // 2. ê¸€ì“°ê¸° ë²„íŠ¼ ë…¸ì¶œ ì—¬ë¶€ (ê³µì§€ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•˜ë¯€ë¡œ ì¼ë‹¨ ìˆ¨ê¹€, ììœ ê²Œì‹œíŒì€ ë…¸ì¶œ)
        const btnWrite = document.getElementById('btnWritePost');
        if(category === 'free' || category === 'executive' || category === 'election') {
            btnWrite.classList.remove('hidden');
        } else {
            btnWrite.classList.add('hidden'); // ê³µì§€ì‚¬í•­ íƒ­ì—ì„œëŠ” ê¸€ì“°ê¸° ë²„íŠ¼ ìˆ¨ê¹€
        }

        const listArea = document.getElementById('boardList');
        listArea.innerHTML = '<div class="text-center py-5 text-muted">ë¡œë”©ì¤‘...</div>';

        let posts = [];
        let error = null;

        // â˜… [í•µì‹¬] ì¹´í…Œê³ ë¦¬ì— ë”°ë¼ ë‹¤ë¥¸ í…Œì´ë¸” ì¡°íšŒ
        if (category === 'notice') {
            // ê³µì§€ì‚¬í•­ í…Œì´ë¸” (coop_notices)
            // í•„ìš”í•œ ì»¬ëŸ¼: id, title, created_at, content, file_urls
            const res = await _supabase
                .from('coop_notices')
                .select('*')
                .eq('status', 'published') // ê²Œì‹œëœ ê²ƒë§Œ
                .eq('category', 'general') // í˜¹ì€ ì¹´í…Œê³ ë¦¬ ë¬´ê´€í•˜ê²Œ
                .order('created_at', { ascending: false });
            posts = res.data;
            error = res.error;
        } else {
            // ì¼ë°˜/ì„ì› ê²Œì‹œíŒ í…Œì´ë¸” (coop_boards)
            const res = await _supabase
                .from('coop_boards')
                .select('*')
                .eq('category', category)
                .order('created_at', { ascending: false });
            posts = res.data;
            error = res.error;
        }

        if(error) {
            console.error(error);
            listArea.innerHTML = '<div class="text-center py-3 text-danger">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        if(!posts || posts.length === 0) {
            listArea.innerHTML = '<div class="text-center py-5 text-muted">ë“±ë¡ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        let html = '';
        posts.forEach(p => {
            const date = p.created_at ? p.created_at.substring(0,10) : '';
            // ê³µì§€ì‚¬í•­ì€ file_urls, ì¼ë°˜ê²Œì‹œíŒì€ files ì¹¼ëŸ¼ ì‚¬ìš© (í˜¸í™˜ ì²˜ë¦¬)
            const fileCount = (p.file_urls?.length || p.files?.length || 0);
            const fileIcon = fileCount > 0 ? '<i class="bi bi-paperclip ms-1 text-muted"></i>' : '';

            html += `
            <div class="board-list-item" onclick="viewPost(${p.id}, '${category}')">
                <div class="d-flex justify-content-between">
                    <span class="fw-bold text-dark text-truncate">${p.title} ${fileIcon}</span>
                    <small class="text-muted" style="min-width: 80px; text-align: right;">${date}</small>
                </div>
                <div class="small text-secondary text-truncate mt-1">${p.content.replace(/<[^>]*>?/gm, '')}</div>
            </div>`;
        });
        listArea.innerHTML = html;
    }

    // [ê¸€ì“°ê¸°] ëª¨ë‹¬ ì—´ê¸°
    function openWriteModal() {
        document.getElementById('writeTitle').value = '';
        document.getElementById('writeContent').value = '';
        document.getElementById('writeFile').value = '';
        document.getElementById('writeModalOverlay').style.display = 'flex';
    }

    // [ê¸€ì“°ê¸°] ë“±ë¡ (ììœ /ì„ì› ê²Œì‹œíŒìš©)
    async function submitPost() {
        const title = document.getElementById('writeTitle').value;
        const content = document.getElementById('writeContent').value;
        const fileUrl = document.getElementById('writeFile').value; // ì„ì‹œ íŒŒì¼ URL ì…ë ¥

        if(!title || !content) return showModal('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

        showConfirmModal('ê²Œì‹œê¸€ì„ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async () => {
            showLoading(true);
            
            // íŒŒì¼ ë°°ì—´ ì²˜ë¦¬
            const files = fileUrl ? [fileUrl] : [];

            const { error } = await _supabase.from('coop_boards').insert({
                category: currentBoardCat, // í˜„ì¬ ë³´ê³  ìˆëŠ” íƒ­ì˜ ì¹´í…Œê³ ë¦¬ (free, executive ë“±)
                title: title,
                content: content,
                files: files,
                author_name: curMem.name // ì‘ì„±ì ì´ë¦„ ê¸°ë¡
            });

            showLoading(false);
            if(error) showModal('ë“±ë¡ ì‹¤íŒ¨: ' + error.message);
            else {
                showModal('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                document.getElementById('writeModalOverlay').style.display = 'none';
                loadBoard(currentBoardCat); // ëª©ë¡ ê°±ì‹ 
            }
        });
    }

    // [ê¸€ë³´ê¸°] ìƒì„¸ ì¡°íšŒ (í…Œì´ë¸” ë¶„ê¸° ì²˜ë¦¬ í¬í•¨)
    async function viewPost(id, category) {
        const tableName = (category === 'notice') ? 'coop_notices' : 'coop_boards';
        
        const { data: post } = await _supabase.from(tableName).select('*').eq('id', id).single();
        if(!post) return;

        document.getElementById('viewTitle').innerText = post.title;
        // ê³µì§€ëŠ” author_nameì´ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì²˜ë¦¬
        document.getElementById('viewAuthor').innerText = post.author_name || 'ê´€ë¦¬ì'; 
        document.getElementById('viewDate').innerText = post.created_at.substring(0,16).replace('T', ' ');
        document.getElementById('viewContent').innerText = post.content;
        
        // ì²¨ë¶€íŒŒì¼ ì²˜ë¦¬ (í˜¸í™˜ì„±)
        const files = post.file_urls || post.files || [];
        const fileArea = document.getElementById('viewFiles');
        fileArea.innerHTML = '';
        
        if(files.length > 0) {
            files.forEach((f, idx) => {
                // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
                fileArea.innerHTML += `<a href="${f}" target="_blank" class="btn btn-sm btn-outline-primary me-2"><i class="bi bi-download"></i> ì²¨ë¶€íŒŒì¼ ${idx+1}</a>`;
            });
        }

        document.getElementById('boardViewModal').style.display = 'flex';
    }
</script>
</body>
</html>
