<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8">
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ì¡°í•©ì› ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    
    <link rel="stylesheet" href="style.css">
    <style>
        /* ì¶”ê°€ ìŠ¤íƒ€ì¼ */
        .hidden { display: none !important; }
        .loading-text { margin-top:10px; font-weight:bold; color:#555; }
    </style>
  </head>
  <body>
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingMsg" class="loading-text">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
    </div>
    
    <div id="layer"><div style="cursor:pointer;position:absolute;right:0;top:0;width:40px;height:40px;background:#333;color:white;text-align:center;line-height:40px;" onclick="document.getElementById('layer').style.display='none'">Ã—</div></div>

    <div class="container">
      
      <div id="loginSection">
          <div style="background:#e3f2fd; color:#1565c0; padding:20px; border-radius:12px; margin-bottom:20px; font-size:14px; line-height:1.5;">
            <b>ğŸ‘‹ ì•ˆë…•í•˜ì„¸ìš”, ì¡°í•©ì›ë‹˜!</b><br>
            ì‹œìŠ¤í…œ ì´ì „ìœ¼ë¡œ ì¸í•´ <b>ìµœì´ˆ 1íšŒ ë³¸ì¸ ì¸ì¦(ì´ë©”ì¼)</b>ì´ í•„ìš”í•©ë‹ˆë‹¤.<br><br>
            ë¬¸ì˜: ì‚¬ë¬´êµ­ì¥ ê¹€ë¯¼í˜¸ 010-2513-5736
          </div>
          
          <div class="section-card">
            <label>ì¡°í•©ì› ë²ˆí˜¸ (í™•ì¸ìš©)</label>
            <div class="box-row">
              <input type="text" id="memberIdInput" placeholder="ì˜ˆ: 2025-01-0001" oninput="handleMemberIdInput(this)" onkeyup="if(event.key==='Enter') handleSearch()">
              <button class="btn-main" id="btnSearch" style="width:auto; padding:12px 20px;" onclick="handleSearch()">ì¡°íšŒ</button>
            </div>
            <div style="font-size:11px; color:#888; margin-top:4px;">ìˆ«ìë§Œ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ë³€í™˜ë©ë‹ˆë‹¤.</div>

            <div id="emailAuthArea" class="hidden" style="margin-top:20px; border-top:1px dashed #eee; padding-top:20px;">
              <label>ë“±ë¡ëœ ì´ë©”ì¼ í™•ì¸</label>
              <div class="box-row" style="background:#f8f9fa; padding:10px; border-radius:8px; border:1px solid #eee;">
                <input type="text" id="emailDisplay" placeholder="ì´ë©”ì¼ ì…ë ¥" style="background:transparent; border:none; padding:0; color:#333; flex:1; font-weight:bold;">
                <button class="btn-sub" id="btnSendAuth" onclick="requestAuth()">ì¸ì¦ë²ˆí˜¸ ë°›ê¸°</button>
              </div>
              
              <div id="authInputBox" class="hidden" style="margin-top:15px;">
                <div class="box-row">
                  <input type="text" id="authCode" placeholder="ì¸ì¦ë²ˆí˜¸ 6ìë¦¬" style="text-align:center; letter-spacing:3px;" onkeyup="if(event.key==='Enter') verifyAuth()">
                  <button class="btn-main" style="width:80px;" onclick="verifyAuth()">ë¡œê·¸ì¸</button>
                </div>
                <div style="color:red; font-size:12px; margin-top:5px;" id="loginMsg"></div>
              </div>
            </div>

            <div style="margin-top:30px; border-top:1px solid #eee; padding-top:20px;">
                <button class="btn-kakao" onclick="startKakaoLogin()">
                    <svg viewBox="0 0 32 32" width="20" height="20" style="vertical-align:middle; margin-right:5px;"><path d="M16 4C9.922 4 5 8.014 5 12.964c0 3.197 2.067 6.007 5.223 7.575-.246.914-.888 3.321-.916 3.496-.046.302.109.432.288.432.124 0 .201-.034.303-.099 3.498-2.31 5.093-3.414 5.263-3.525.55.082 1.115.122 1.688.122 6.078 0 11-4.014 11-8.964S22.078 4 16 4z" fill="#000000"></path></svg>
                    ì¹´ì¹´ì˜¤ë¡œ ë¡œê·¸ì¸ (ì—°ë™ëœ ê²½ìš°)
                </button>
            </div>
          </div>
      </div>

      <div id="dashboardSection" class="hidden">
          <div class="top-util-bar">
              <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
          </div>

          <div class="section-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
              <div style="display:flex; align-items:center; gap:8px;">
                <span style="font-size:18px; font-weight:bold;">ë‚´ ì •ë³´</span>
                <button class="btn-sub" style="padding:4px 8px; font-size:11px;" onclick="refresh()">â†» ìƒˆë¡œê³ ì¹¨</button>
              </div>
            </div>
            
            <div class="summary-box">
              <div id="birthdayBanner" style="display:none; background:#fff3cd; color:#856404; padding:10px; border-radius:5px; margin-bottom:10px; text-align:center;"></div>

              <div class="summary-row"><span>ì´ë¦„</span><span id="sumName"></span></div>
              <div class="summary-row"><span>ë²ˆí˜¸</span><span id="sumId"></span></div>
              <div class="summary-row"><span>ì´ë©”ì¼</span><span id="sumEmail"></span></div>
              <div class="summary-row"><span>ì—°ë½ì²˜</span><span id="sumPhone"></span></div>
              <div class="summary-row"><span>ì£¼ì†Œ</span><span id="sumAddr" style="max-width:200px; text-align:right;"></span></div>
              <div class="summary-row" style="margin-top:10px; border-top:1px dashed #ddd; padding-top:5px;">
                <span>ë°°ë‹¹/í™˜ê¸‰ ê³„ì¢Œ</span>
                <span id="sumAccount" style="color:#1967d2;"></span>
              </div>
              <div style="font-size:11px; color:#999; text-align:right; margin-top:2px;">(ê³„ì¢Œ ì •ë³´ ìˆ˜ì •ì€ ì‚¬ë¬´êµ­ ë¬¸ì˜)</div>
            </div>
            
            <div class="summary-box" style="margin-top:15px; background:#e8f0fe; border-color:#d2e3fc;">
              <div class="summary-row">
                <span style="color:#1967d2;">ì´ ë‚©ë¶€ ì¶œìê¸ˆ</span>
                <span id="sumTotal" style="color:#1967d2; font-size:16px; font-weight:bold;"></span>
              </div>
            </div>

            <div class="summary-box" id="pendingAppsBox" style="display:none; margin-top:15px; background:#fff8e1; border-color:#ffe0b2;">
                <div style="font-weight:bold; color:#e65100; margin-bottom:5px;">â³ ì²˜ë¦¬ ì¤‘ì¸ ì‹ ì²­ ë‚´ì—­</div>
                <div id="pendingAppsList"></div>
            </div>

            <div class="summary-box" style="background:#fff; border:1px solid #eee; margin-top:15px;">
              <div style="font-weight:bold; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">ì…ê¸ˆ ë° ì²˜ë¦¬ ë‚´ì—­</div>
              <div id="depositList" style="font-size:13px; color:#555; max-height:200px; overflow-y:auto;"></div>
            </div>
          </div>

          <div class="menu-grid">
            <button class="menu-btn" onclick="toggleTab('extra', this)">ì¶”ê°€ ì¶œì</button>
            <button class="menu-btn" onclick="toggleTab('reduction', this)">ê°ì ì‹ ì²­</button>
            <button class="menu-btn" onclick="toggleTab('withdraw', this)">íƒˆí‡´ ì‹ ì²­</button>
            <button class="menu-btn" onclick="toggleTab('cert', this)" style="color:var(--primary-color);">ğŸ–¨ï¸ ì¦ëª…ì„œ</button>
          </div>

          <div id="tabExtra" class="section-card hidden">
            <h3>ì¶”ê°€ ì¶œì ì‹ ì²­</h3>
            <div class="notice-box">
               ğŸ’¡ <b>ì…ê¸ˆ ì „ ì‹ ì²­ í•„ìˆ˜!</b><br>
               ì…ê¸ˆì ì‹ë³„ì„ ìœ„í•´ ë°˜ë“œì‹œ ì‹ ì²­ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.
            </div>
            
            <div class="input-group"><label>ì…ê¸ˆ ì˜ˆì • ê¸ˆì•¡ (1ë§Œì› ë‹¨ìœ„)</label>
              <input type="number" id="exAmount" step="10000" min="0" oninput="handleAmountInput(this)">
              <div id="exHint" style="font-size:12px; color:#666; margin-top:4px;"></div>
            </div>
            
            <button class="btn-main" onclick="submitApplication('extra')">ì‹ ì²­í•˜ê¸°</button>
          </div>

          <div id="tabReduction" class="section-card hidden">
            <h3>ê°ì ì‹ ì²­</h3>
            <div class="notice-box" style="background:#fff3e0; color:#e65100;">
                â€» ë“±ë¡ëœ ë°°ë‹¹ ê³„ì¢Œë¡œ ì…ê¸ˆë©ë‹ˆë‹¤.<br>
                (<span class="my-bank-display" style="font-weight:bold;"></span>)
            </div>
            <div class="input-group"><label>í™˜ê¸‰ ìš”ì²­ ê¸ˆì•¡</label>
              <input type="number" id="redAmount" step="10000" min="0" oninput="handleAmountInput(this)">
              <div id="redHint" style="font-size:12px; color:#666; margin-top:4px;"></div>
            </div>
            <div class="check-item">
              <input type="checkbox" id="redAgree"> 
              <label for="redAgree">ê°ìëŠ” ë‹¤ìŒë…„ë„ ì´íšŒ ìŠ¹ì¸ í›„ ì²˜ë¦¬ë¨ì„ í™•ì¸í•©ë‹ˆë‹¤.</label>
            </div>
            <button class="btn-main" onclick="submitApplication('reduction')">ì‹ ì²­í•˜ê¸°</button>
          </div>

          <div id="tabWithdraw" class="section-card hidden">
            <h3>íƒˆí‡´ ì‹ ì²­</h3>
            <div class="notice-box" style="background:#ffebee; color:#c62828;">
                âš ï¸ <b>ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</b><br>
                ë‚©ì…í•œ ì¶œìê¸ˆì€ ë‹¤ìŒë…„ë„ ì´íšŒ ìŠ¹ì¸ í›„<br>
                ë“±ë¡ëœ ê³„ì¢Œ(<span class="my-bank-display"></span>)ë¡œ í™˜ê¸‰ë©ë‹ˆë‹¤.
            </div>
            <div class="input-group"><label>íƒˆí‡´ ì‚¬ìœ </label><textarea id="wdReason" placeholder="ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea></div>
            <div class="check-item">
              <input type="checkbox" id="wdAgree"> 
              <label for="wdAgree">ì •ê´€ì— ë”°ë¥¸ íƒˆí‡´ ì ˆì°¨ ë° í™˜ê¸‰ ê·œì •ì„ í™•ì¸í•˜ì˜€ìŠµë‹ˆë‹¤.</label>
            </div>
            <button class="btn-main" onclick="submitApplication('withdraw')">ì‹ ì²­í•˜ê¸°</button>
          </div>

          <div id="tabCert" class="section-card hidden">
            <h3>ì¦ëª…ì„œ ë°œê¸‰</h3>
            <div class="notice-box">
               ğŸ“„ <b>ì¶œì ì¦ì„œ ë°œê¸‰</b><br>
               í˜„ì¬ ë‚©ì…ëœ ì¶œìê¸ˆ ê¸°ì¤€ìœ¼ë¡œ ì¦ëª…ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
            </div>
            <button class="btn-main" onclick="downloadCert()">PDF ë‹¤ìš´ë¡œë“œ</button>
          </div>
          
          <div class="footer-contact">
              ë¬¸ì˜ : ì‚¬ë¬´êµ­ì¥ ê¹€ë¯¼í˜¸ 010-2513-5736
          </div>
      </div>
    </div>

    <div id="alertModal" class="modal">
        <div class="modal-content" style="text-align:center;">
            <div id="alertMsg" style="margin-bottom:15px; white-space:pre-wrap;"></div>
            <button class="btn-main" onclick="document.getElementById('alertModal').style.display='none'">í™•ì¸</button>
        </div>
    </div>

<script>
    // =========================================================================
    // 1. ì„¤ì • ë° ì´ˆê¸°í™”
    // =========================================================================
    // â˜… ì£¼ì˜: Supabase í”„ë¡œì íŠ¸ ì„¤ì •ê°’ ì…ë ¥ í•„ìˆ˜
    const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k'; 
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let curMem = null;  // DBì—ì„œ ê°€ì ¸ì˜¨ ì¡°í•©ì› ì •ë³´ (coop_members)
    let curAuth = null; // Supabase Auth ì •ë³´

    // ë¡œë”©ë°” ì œì–´
    function showLoading(show, msg) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        if(msg) document.getElementById('loadingMsg').innerText = msg;
    }

    function showAlert(msg) {
        document.getElementById('alertMsg').innerText = msg;
        document.getElementById('alertModal').style.display = 'flex';
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¸ì…˜ í™•ì¸
    window.addEventListener('DOMContentLoaded', async () => {
        const { data: { session } } = await _supabase.auth.getSession();
        if (session) {
            handleLoginSuccess(session.user);
        } else {
            document.getElementById('loginSection').classList.remove('hidden');
        }
    });

    // =========================================================================
    // 2. ì¸ì¦ ë° ë¡œê·¸ì¸ ë¡œì§ (ì´ë©”ì¼ OTP -> ë§¤í•‘)
    // =========================================================================
    
    // [A] ì¡°íšŒ ë²„íŠ¼ (UX ìœ ì§€ìš©, ì‹¤ì œ ë¡œì§ì€ ë°”ë¡œ ì´ë©”ì¼ ì…ë ¥ ìœ ë„)
    function handleSearch() {
        const idInput = document.getElementById('memberIdInput').value;
        if(!idInput) return showAlert('ì¡°í•©ì› ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        
        // UX: ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´ ì´ë©”ì¼ ì…ë ¥ì°½ì„ ì—´ì–´ì¤Œ
        document.getElementById('emailAuthArea').classList.remove('hidden');
        document.getElementById('emailDisplay').focus();
    }

    // [B] ì¸ì¦ë²ˆí˜¸ ë°œì†¡ (Supabase Magic Link/OTP)
    async function requestAuth() {
        const email = document.getElementById('emailDisplay').value.trim();
        if(!email || !email.includes('@')) return showAlert('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.');

        showLoading(true, 'ì¸ì¦ë²ˆí˜¸ ë°œì†¡ ì¤‘...');
        
        const { error } = await _supabase.auth.signInWithOtp({
            email: email,
            options: { shouldCreateUser: false } // ê¸°ì¡´ì— ë“±ë¡ëœ ì´ë©”ì¼ë§Œ í—ˆìš© (ë³´ì•ˆ)
        });

        showLoading(false);

        if(error) {
            // ì‚¬ìš©ìê°€ ì—†ì–´ì„œ ì—ëŸ¬ê°€ ë‚œ ê²½ìš° ì²˜ë¦¬
            if(error.message.includes('Signups not allowed') || error.message.includes('User not found')) {
                showAlert('ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.\nì‚¬ë¬´êµ­ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
            } else {
                showAlert('ì˜¤ë¥˜: ' + error.message);
            }
        } else {
            document.getElementById('authInputBox').classList.remove('hidden');
            document.getElementById('btnSendAuth').innerText = 'ì¬ì „ì†¡';
            showAlert('ì¸ì¦ë²ˆí˜¸(6ìë¦¬)ê°€ ì´ë©”ì¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
    }

    // [C] ì¸ì¦ë²ˆí˜¸ ê²€ì¦ (ë¡œê·¸ì¸ ì²˜ë¦¬)
    async function verifyAuth() {
        const email = document.getElementById('emailDisplay').value.trim();
        const code = document.getElementById('authCode').value.trim();
        if(code.length < 6) return showAlert('ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

        showLoading(true, 'ë¡œê·¸ì¸ ì¤‘...');

        const { data, error } = await _supabase.auth.verifyOtp({
            email: email, token: code, type: 'email'
        });

        if(error) {
            showLoading(false);
            document.getElementById('loginMsg').innerText = 'ì¸ì¦ ì‹¤íŒ¨: ' + error.message;
        } else {
            // ì„±ê³µ ì‹œ DB ë§¤í•‘ ë° ë°ì´í„° ë¡œë“œ ì§„ì…
            handleLoginSuccess(data.user);
        }
    }

    // [D] ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ (Supabase OAuth)
    async function startKakaoLogin() {
        const { data, error } = await _supabase.auth.signInWithOAuth({
            provider: 'kakao',
            options: {
                redirectTo: window.location.href // í˜„ì¬ í˜ì´ì§€ë¡œ ë³µê·€
            }
        });
        if(error) showAlert('ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì˜¤ë¥˜: ' + error.message);
    }

    function logout() {
        if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            _supabase.auth.signOut().then(() => location.reload());
        }
    }

    // =========================================================================
    // 3. ë°ì´í„° ë¡œë“œ ë° ëŒ€ì‹œë³´ë“œ (í•µì‹¬ ë¡œì§)
    // =========================================================================
    async function handleLoginSuccess(user) {
        curAuth = user;
        
        // 1. DB ë§¤í•‘ (SQLì—ì„œ ë§Œë“  claim_member_profile í•¨ìˆ˜ í˜¸ì¶œ)
        // ì´ë©”ì¼ì´ ì¼ì¹˜í•˜ë©´ coop_members.idë¥¼ í˜„ì¬ UUIDë¡œ ì—…ë°ì´íŠ¸í•¨
        const { data: claimRes, error: claimErr } = await _supabase.rpc('claim_member_profile');
        
        if (claimErr) {
            showLoading(false);
            console.error(claimErr);
            showAlert('ì‹œìŠ¤í…œ ì˜¤ë¥˜: ë§¤í•‘ í•¨ìˆ˜ í˜¸ì¶œ ì‹¤íŒ¨');
            return;
        }
        
        if (!claimRes.success && claimRes.message === 'not_found') {
            showLoading(false);
            // ë§¤í•‘ ì‹¤íŒ¨ ì‹œ: ë¡œê·¸ì¸ í’€ê³  ì•ˆë‚´
            await _supabase.auth.signOut();
            showAlert('í•´ë‹¹ ì´ë©”ì¼ë¡œ ë“±ë¡ëœ ì¡°í•©ì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nê°€ì… ì‹œ ë“±ë¡í•œ ì´ë©”ì¼ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
            return;
        }

        // 2. ë°ì´í„° ë¡œë“œ
        await refresh();
    }

    async function refresh() {
        showLoading(true, 'ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        try {
            const myUuid = curAuth.id;

            // [1] ë‚´ ì •ë³´ ì¡°íšŒ (coop_members)
            const { data: member, error: memErr } = await _supabase
                .from('coop_members')
                .select('*')
                .eq('id', myUuid)
                .single();

            if(memErr) throw memErr;
            curMem = member;

            // [2] ì‹ ì²­ ë‚´ì—­ ì¡°íšŒ (coop_applications)
            const { data: apps, error: appErr } = await _supabase
                .from('coop_applications')
                .select('*')
                .eq('member_uid', myUuid)
                .order('created_at', { ascending: false });

            // [3] ì…ê¸ˆ ë‚´ì—­ ì¡°íšŒ (ref_members) - member_id(ë¬¸ìì—´)ë¡œ ì¡°íšŒ
            const { data: ledger, error: ledErr } = await _supabase
                .from('ref_members')
                .select('*')
                .eq('member_id', curMem.member_id) // 2025-01-xxxx
                .order('deposit_date', { ascending: false });

            renderDashboard(member, apps || [], ledger || []);
            showLoading(false);

        } catch (e) {
            showLoading(false);
            console.error(e);
            showAlert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
        }
    }

    // =========================================================================
    // 4. í™”ë©´ ë Œë”ë§
    // =========================================================================
    function renderDashboard(member, apps, ledger) {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('dashboardSection').classList.remove('hidden');

        // ê¸°ë³¸ ì •ë³´
        document.getElementById('sumName').innerText = member.name;
        document.getElementById('sumId').innerText = member.member_id;
        document.getElementById('sumEmail').innerText = member.email;
        document.getElementById('sumPhone').innerText = member.phone || '-';
        document.getElementById('sumAddr').innerText = member.address || '-';
        
        // ê³„ì¢Œ ì •ë³´ (ì•”í˜¸í™”ëœ ê²½ìš° ë§ˆìŠ¤í‚¹ ì²˜ë¦¬ í•„ìš”í•˜ë‚˜, ì—¬ê¸°ì„  í‰ë¬¸ bank_name ì‚¬ìš© ì˜ˆì‹œ)
        // ì‹¤ì œë¡œëŠ” bank_nameë§Œ í‰ë¬¸ì´ê³  account_numberëŠ” ì•”í˜¸ë¬¸ì¼ ìˆ˜ ìˆìŒ
        const bankStr = member.bank_name ? `${member.bank_name} (ê³„ì¢Œ ë“±ë¡ë¨)` : '(ë¯¸ë“±ë¡)';
        document.getElementById('sumAccount').innerText = bankStr;
        
        // ì€í–‰ëª… í‘œì‹œ (ì‹ ì²­ íƒ­ ì•ˆë‚´ìš©)
        document.querySelectorAll('.my-bank-display').forEach(el => el.innerText = bankStr);

        // ì´ ì¶œìê¸ˆ
        const total = member.pledge_amount || 0; // í˜¹ì€ total_amount ì¹¼ëŸ¼
        document.getElementById('sumTotal').innerText = total.toLocaleString() + 'ì›';

        // ì…ê¸ˆ ë‚´ì—­ ë Œë”ë§
        const depositBox = document.getElementById('depositList');
        if(ledger.length === 0) {
            depositBox.innerHTML = '<div style="padding:10px; text-align:center;">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        } else {
            let html = '<table style="width:100%; border-collapse:collapse;">';
            ledger.forEach(row => {
                // ref_members êµ¬ì¡°ì— ë”°ë¼ í•„ë“œëª… ì¡°ì • í•„ìš” (ì—¬ê¸°ì„  deposit_date, amount ê°€ì •)
                html += `<tr style="border-bottom:1px solid #f0f0f0;">
                    <td style="padding:8px;">${row.deposit_date ? row.deposit_date.substring(0,10) : '-'}</td>
                    <td style="padding:8px; text-align:right;">${Number(row.amount||0).toLocaleString()}ì›</td>
                </tr>`;
            });
            html += '</table>';
            depositBox.innerHTML = html;
        }

        // ì§„í–‰ ì¤‘ì¸ ì‹ ì²­ ë‚´ì—­ ë Œë”ë§
        const pendingApps = apps.filter(a => a.status === 'pending');
        const pendingBox = document.getElementById('pendingAppsBox');
        if(pendingApps.length > 0) {
            pendingBox.style.display = 'block';
            let html = '';
            pendingApps.forEach(app => {
                let typeName = app.type === 'extra' ? 'ì¶”ê°€ì¶œì' : (app.type === 'reduction' ? 'ê°ì' : 'íƒˆí‡´');
                html += `<div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px;">
                    <span>[${typeName}] ${app.amount > 0 ? Number(app.amount).toLocaleString()+'ì›' : ''}</span>
                    <span style="color:#e65100;">ê²€í† ì¤‘</span>
                </div>`;
            });
            document.getElementById('pendingAppsList').innerHTML = html;
        } else {
            pendingBox.style.display = 'none';
        }

        // ìƒì¼ ë°°ë„ˆ (ì£¼ë¯¼ë²ˆí˜¸ íŒŒì‹±)
        if(member.rrn_display) {
            // 840914-1******
            const mm = member.rrn_display.substring(2,4);
            const dd = member.rrn_display.substring(4,6);
            const today = new Date();
            if((today.getMonth()+1) == mm && today.getDate() == dd) {
                document.getElementById('birthdayBanner').innerHTML = "ğŸ‰ <b>ìƒì¼ ì¶•í•˜ë“œë ¤ìš”!</b><br>ì˜¤ëŠ˜ë„ ë¹›ë‚˜ëŠ” í•˜ë£¨ ë˜ì„¸ìš” ğŸ‚";
                document.getElementById('birthdayBanner').style.display = 'block';
            }
        }
    }

    // =========================================================================
    // 5. ì‹ ì²­ ë¡œì§ (í†µí•© í…Œì´ë¸” Insert)
    // =========================================================================
    async function submitApplication(type) {
        let amount = 0;
        let reason = '';

        // ìœ íš¨ì„± ê²€ì‚¬
        if(type === 'extra') {
            amount = document.getElementById('exAmount').value;
            if(!amount || amount < 10000) return showAlert('1ë§Œì› ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        } else if(type === 'reduction') {
            amount = document.getElementById('redAmount').value;
            if(!amount || amount <= 0) return showAlert('ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            if(!document.getElementById('redAgree').checked) return showAlert('ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
        } else if(type === 'withdraw') {
            reason = document.getElementById('wdReason').value;
            if(!reason) return showAlert('íƒˆí‡´ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            if(!document.getElementById('wdAgree').checked) return showAlert('ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
        }

        if(!confirm('ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        showLoading(true, 'ì‹ ì²­ì„œ ì œì¶œ ì¤‘...');

        const { error } = await _supabase
            .from('coop_applications')
            .insert({
                member_uid: curAuth.id,
                member_id: curMem.member_id,
                name: curMem.name,
                type: type,
                amount: amount || 0,
                reason: reason,
                status: 'pending' // SQL defaultê°€ ìˆì§€ë§Œ ëª…ì‹œ
            });

        showLoading(false);
        if(error) {
            showAlert('ì‹ ì²­ ì‹¤íŒ¨: ' + error.message);
        } else {
            showAlert('ì„±ê³µì ìœ¼ë¡œ ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.');
            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            document.getElementById('exAmount').value = '';
            document.getElementById('redAmount').value = '';
            document.getElementById('wdReason').value = '';
            // íƒ­ ë‹«ê³  ìƒˆë¡œê³ ì¹¨
            refresh();
        }
    }

    // =========================================================================
    // 6. PDF ì¦ëª…ì„œ (í´ë¼ì´ì–¸íŠ¸ ìƒì„±)
    // =========================================================================
    async function downloadCert() {
        if(!window.jspdf) return showAlert('PDF ëª¨ë“ˆ ë¡œë“œ ì‹¤íŒ¨');
        if(!curMem) return;

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // [ì¤‘ìš”] í•œê¸€ í°íŠ¸ ì ìš©
        // jsPDFëŠ” ê¸°ë³¸ì ìœ¼ë¡œ í•œê¸€ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. 
        // addFontë¡œ .ttf íŒŒì¼ì„ base64ë¡œ ë³€í™˜í•œ ë¬¸ìì—´ì„ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤.
        // í˜„ì¬ëŠ” ì˜ˆì‹œë¡œ ì˜ì–´ë¡œ ì¶œë ¥í•˜ê±°ë‚˜, ë³„ë„ì˜ í°íŠ¸ ë¡œë“œ ë¡œì§ì´ í•„ìš”í•©ë‹ˆë‹¤.
        
        // doc.addFileToVFS('Malgun.ttf', 'ì—¬ê¸°ì—_ì—„ì²­_ê¸´_BASE64_ë¬¸ìì—´');
        // doc.addFont('Malgun.ttf', 'Malgun', 'normal');
        // doc.setFont('Malgun'); 

        // ì„ì‹œ: í•œê¸€ ê¹¨ì§ ë°©ì§€ë¥¼ ìœ„í•´ ì˜ì–´ë¡œ í‘œê¸°í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•´ì•¼ í•¨.
        // ì—¬ê¸°ì„œëŠ” ë°ì´í„° ë§¤í•‘ ë¡œì§ë§Œ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤.
        
        doc.setFontSize(20);
        doc.text("Certificate of Contribution", 105, 30, { align: "center" });
        
        doc.setFontSize(12);
        doc.text(`Name: ${curMem.name} (Korean text requires font)`, 20, 50);
        doc.text(`Member ID: ${curMem.member_id}`, 20, 60);
        doc.text(`Total Amount: ${Number(curMem.pledge_amount||0).toLocaleString()} KRW`, 20, 70);
        doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 80);

        doc.save(`ì¶œìì¦ì„œ_${curMem.member_id}.pdf`);
    }

    // =========================================================================
    // 7. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    // =========================================================================
    function toggleTab(type, btn) {
        // ëª¨ë“  íƒ­ ìˆ¨ê¸°ê¸°
        ['tabExtra', 'tabReduction', 'tabWithdraw', 'tabCert'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        // íƒ­ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì œê±°
        document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active')); // CSSì— .active ì¶”ê°€ í•„ìš”
        
        // ì„ íƒ íƒ­ ë³´ì´ê¸°
        const targetId = 'tab' + type.charAt(0).toUpperCase() + type.slice(1);
        document.getElementById(targetId).classList.remove('hidden');
        if(btn) btn.classList.add('active'); // ìŠ¤íƒ€ì¼ë§ í•„ìš”
    }

    function handleMemberIdInput(el) {
        var v = el.value.replace(/[^0-9]/g, '');
        if (v.length > 4 && v.length <= 6) { v = v.slice(0,4) + '-' + v.slice(4); } 
        else if (v.length > 6) { v = v.slice(0,4) + '-' + v.slice(4,6) + '-' + v.slice(6,10); }
        el.value = v;
    }

    function handleAmountInput(el) {
        let v = Number(el.value);
        let hintId = el.id === 'exAmount' ? 'exHint' : 'redHint';
        let hintText = v >= 10000 ? v.toLocaleString() + 'ì›' : '';
        document.getElementById(hintId).textContent = hintText;
    }
</script>
</body>
</html>
