<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>조합원 관리 - 용인모두의햇빛협동조합</title>
  
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.css" rel="stylesheet">
  <link href="https://webfontworld.github.io/gmarket/GmarketSans.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="cert_generator.js"></script>

  <link href="style.css" rel="stylesheet">
  
  <style>
    /* [기본 설정] 폰트 및 바디 */
    body {
        font-family: 'Pretendard', sans-serif;
        background-color: #f8f9fa;
        padding-top: 80px; /* 헤더 높이만큼 띄움 */
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }

    /* [헤더] 규정집 스타일 그대로 적용 (검은색) */
    #header {
        background-color: #000;
        padding: 15px 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .logo h1 a {
        font-family: 'GmarketSans', sans-serif;
        font-weight: 700;
        font-size: 20px;
        text-decoration: none;
        color: #fff !important;
    }
    .header-link {
        color: #fff;
        text-decoration: none;
        margin-left: 20px;
        font-size: 1.2rem;
        cursor: pointer;
        transition: 0.3s;
    }
    .header-link:hover { color: #ff9800; }

    /* [푸터] 하단 고정 및 스타일 */
    #footer {
        margin-top: auto;
        background: #111; /* 배경색 강제 지정 (CSS 로드 전 깨짐 방지) */
        color: #fff;
    }

    /* [로그인 섹션] 카드 스타일 */
    .signup-wrapper {
        background: #fff;
        padding: 40px 30px;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        max-width: 500px;
        margin: 40px auto;
        border: 1px solid #eee;
    }
    .form-title {
        font-family: 'GmarketSans';
        font-weight: 700;
        text-align: center;
        margin-bottom: 30px;
        color: #333;
    }
    
    /* [대시보드] 카드 박스 */
    .dashboard-card {
        background: #fff;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        border: 1px solid #f0f0f0;
        height: 100%;
    }
    .count-icon {
        font-size: 2.5rem;
        color: #2E7D32;
        margin-bottom: 10px;
    }
    .count-title {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 5px;
    }
    .count-val {
        font-family: 'GmarketSans';
        font-weight: 700;
        font-size: 1.5rem;
        color: #333;
    }

    /* [타임라인] 활동 내역 스타일 (필수 복구) */
    .timeline-item {
        padding: 0 0 20px 20px;
        border-left: 2px solid #e0e0e0;
        position: relative;
    }
    .timeline-item::before {
        content: "";
        position: absolute;
        width: 12px; height: 12px;
        border-radius: 50%;
        left: -7px; top: 5px;
        background: #fff;
        border: 2px solid #2E7D32;
    }
    .timeline-date {
        font-size: 0.8rem;
        color: #999;
        margin-bottom: 3px;
    }
    .timeline-content h5 {
        font-size: 1rem;
        font-weight: 600;
        margin: 0;
        color: #333;
    }
    .timeline-content p {
        font-size: 0.9rem;
        color: #666;
        margin: 0;
    }

    /* [메뉴 탭] 버튼 스타일 */
    .menu-btn {
        width: 100%;
        text-align: left;
        padding: 15px;
        margin-bottom: 10px;
        border: 1px solid #eee;
        background: #fff;
        border-radius: 10px;
        font-weight: 600;
        color: #555;
        transition: all 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .menu-btn:hover {
        background: #f8f9fa;
        border-color: #2E7D32;
        color: #2E7D32;
    }
    .menu-btn.active {
        background: #2E7D32;
        color: #fff;
        border-color: #2E7D32;
    }
    .menu-icon { font-size: 1.2rem; margin-right: 10px; }

    /* 로딩 오버레이 */
    #loadingOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.95);
        z-index: 9999;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    
    /* 유틸리티 */
    .hidden { display: none !important; }
    .text-green { color: #2E7D32 !important; }
  </style>
</head>

<body>

  <header id="header" class="fixed-top">
    <div class="container d-flex align-items-center justify-content-between">
      
      <div class="logo">
        <h1><a href="index.html">용인모두의햇빛협동조합</a></h1>
      </div>

      <div class="d-flex align-items-center">
          <a href="index.html" class="header-link" title="메인으로 이동">
              <i class="bi bi-house-door"></i>
          </a>
          <a href="#" onclick="logout()" id="headerLogoutBtn" class="header-link hidden" title="로그아웃">
              <i class="bi bi-box-arrow-right"></i>
          </a>
      </div>

    </div>
  </header>

  <div id="loadingOverlay">
      <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;"></div>
      <div class="mt-3 fw-bold text-secondary" id="loadingMsg">잠시만 기다려주세요</div>
  </div>

  <main class="container py-4">
    
    <div id="loginSection">
        <div class="signup-wrapper">
            <h2 class="form-title">조합원 공간</h2>
            
            <div class="alert alert-light border d-flex align-items-center" role="alert">
                <i class="bi bi-info-circle-fill text-success fs-4 me-3"></i>
                <div>
                    가입 시 등록한 <b>이메일</b>을 입력해주세요.<br>
                    <small class="text-muted">입력하신 메일로 로그인 링크를 보내드립니다.</small>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold small text-secondary">이메일 주소</label>
                <div class="input-group">
                    <input type="email" id="emailInput" class="form-control form-control-lg" placeholder="example@email.com" onkeyup="if(event.key==='Enter') sendMagicLink()">
                    <button class="btn btn-dark" type="button" onclick="sendMagicLink()">링크 받기</button>
                </div>
            </div>

            <div id="sentMsgBox" class="text-center hidden mt-4 p-4 bg-light rounded">
                <i class="bi bi-envelope-check text-success" style="font-size: 3rem;"></i>
                <h4 class="fw-bold mt-2">메일함을 확인해주세요!</h4>
                <p class="text-muted mb-3">
                    <span id="targetEmail" class="fw-bold text-dark"></span>(으)로<br>
                    로그인 링크가 발송되었습니다.
                </p>
                <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">이메일 다시 입력하기</button>
            </div>

            <div class="mt-4 pt-4 border-top">
                <button class="btn btn-warning w-100 fw-bold py-3" onclick="startKakaoLogin()">
                    <i class="bi bi-chat-fill me-2"></i> 카카오로 바로 시작하기
                </button>
                <div class="text-center mt-2">
                    <small class="text-muted">(기존에 카카오를 연동한 조합원만 가능합니다)</small>
                </div>
            </div>
        </div>
    </div>


        
<div id="dashboardSection" class="hidden">
        
        <div class="dashboard-card mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold m-0"><i class="bi bi-person-lines-fill me-2"></i>내 정보</h5>
                <div>
                    <button class="btn btn-sm btn-outline-secondary" id="btnEditProfile" onclick="toggleEditMode(true)">정보 수정</button>
                    <button class="btn btn-sm btn-success hidden" id="btnSaveProfile" onclick="saveProfile()">저장</button>
                    <button class="btn btn-sm btn-light hidden" id="btnCancelEdit" onclick="toggleEditMode(false)">취소</button>
                </div>
            </div>
            
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="small text-muted">이름</label>
                    <div class="fw-bold" id="infoName">-</div>
                </div>
                <div class="col-md-6">
                    <label class="small text-muted">생년월일</label>
                    <div class="fw-bold" id="infoBirth">-</div>
                </div>
                <div class="col-md-6">
                    <label class="small text-muted">이메일 (변경불가)</label>
                    <div class="fw-bold text-secondary" id="infoEmail">-</div>
                </div>

                <div class="col-md-6">
                    <label class="small text-muted">전화번호</label>
                    <input type="text" id="editPhone" class="readonly-text" readonly>
                </div>

                <div class="col-12">
                    <label class="small text-muted">주소</label>
                    <div class="input-group">
                        <input type="text" id="editAddress" class="readonly-text" readonly>
                        <button class="btn btn-outline-secondary edit-mode-only" style="display:none;" onclick="execDaumPostcode()">주소 검색</button>
                    </div>
                </div>

                <div class="col-12 border-top pt-2 mt-2">
                    <label class="small text-success fw-bold">환급/배당 계좌</label>
                    <div class="row g-2">
                        <div class="col-4">
                            <input type="text" id="editBankName" class="readonly-text" placeholder="은행명" readonly>
                        </div>
                        <div class="col-8">
                            <input type="text" id="editAccountNo" class="readonly-text" placeholder="계좌번호" readonly>
                        </div>
                        <div class="col-12">
                            <input type="text" id="editHolder" class="readonly-text" placeholder="예금주" readonly>
                        </div>
                    </div>
                    <small class="text-muted edit-mode-only" style="display:none; font-size:0.8rem;">* 계좌번호를 수정하지 않으면 기존 정보(마스킹)가 유지됩니다.</small>
                </div>
            </div>
        </div>


  <div class="row g-3 mb-4">
            <div class="col-md-6 col-lg-4">
                <div class="dashboard-card text-center">
                    <i class="bi bi-person-badge count-icon" style="font-size: 2.5rem; color: #2E7D32; margin-bottom: 10px;"></i>
                    <div class="count-title" style="color: #666; font-size: 0.9rem;">조합원 번호</div>
                    <div class="count-val" id="sumId" style="font-family: 'GmarketSans'; font-weight: 700; font-size: 1.5rem; color: #333;">-</div>
                </div>
            </div>
            <div class="col-md-6 col-lg-4">
                <div class="dashboard-card text-center">
                    <i class="bi bi-piggy-bank count-icon" style="font-size: 2.5rem; color: #2E7D32; margin-bottom: 10px;"></i>
                    <div class="count-title" style="color: #666; font-size: 0.9rem;">총 납입 출자금</div>
                    <div class="count-val text-green" id="sumTotal" style="font-family: 'GmarketSans'; font-weight: 700; font-size: 1.5rem; color: #2E7D32;">0원</div>
                </div>
            </div>
            <div class="col-md-12 col-lg-4">
                <div class="dashboard-card text-center d-flex flex-column justify-content-center align-items-center">
                   <div class="count-title mb-2" style="color: #666; font-size: 0.9rem;">환급/배당 계좌</div>
                   <div class="fw-bold fs-5" id="sumBank">등록된 계좌 없음</div>
                   <small class="text-muted mt-1" style="font-size:0.8rem;">변경은 '정보 수정' 버튼 클릭</small>
                </div>
            </div>
        </div>

  
        <div class="row g-4">
            <div class="col-lg-5">
                <div class="dashboard-card">
                    <h5 class="fw-bold mb-3 border-bottom pb-2">업무 신청</h5>
                    
                    <div class="d-grid gap-2">
                        <button class="menu-btn" onclick="toggleTab('extra', this)"><span><i class="bi bi-plus-circle me-2"></i>추가 출자</span><i class="bi bi-chevron-right"></i></button>
                        <button class="menu-btn" onclick="toggleTab('reduction', this)"><span><i class="bi bi-dash-circle me-2"></i>감자 신청</span><i class="bi bi-chevron-right"></i></button>
                        <button class="menu-btn" onclick="toggleTab('withdraw', this)"><span><i class="bi bi-box-arrow-left me-2"></i>탈퇴 신청</span><i class="bi bi-chevron-right"></i></button>
                        <button class="menu-btn" onclick="toggleTab('cert', this)"><span><i class="bi bi-file-earmark-pdf me-2"></i>증명서 발급</span><i class="bi bi-chevron-right"></i></button>
                    </div>

                    <div id="actionArea" class="mt-4 bg-light p-3 rounded">
                        <div id="tabPlaceholder" class="text-center text-muted small py-3">메뉴를 선택해주세요.</div>

                        <div id="tabExtra" class="hidden">
                            <h6 class="fw-bold mb-3">추가 출자 신청</h6>
                            <div class="mb-3">
                                <label class="form-label small">약정 금액 (1만원 단위)</label>
                                <input type="number" id="exAmount" class="form-control" placeholder="금액 입력" step="10000">
                            </div>
                            <button class="btn btn-success w-100 fw-bold" onclick="submitApplication('extra')">신청하기</button>
                        </div>

                        <div id="tabReduction" class="hidden">
                            <h6 class="fw-bold mb-3">감자 신청</h6>
                            <div class="alert alert-warning small py-2"><i class="bi bi-exclamation-triangle me-1"></i> 최소 10만원 이상의 출자금은 유지해야 합니다.</div>
                            <div class="mb-3">
                                <label class="form-label small">환급 요청액</label>
                                <input type="number" id="redAmount" class="form-control" placeholder="금액 입력">
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="checkRedAgree">
                                <label class="form-check-label small" for="checkRedAgree">
                                    감자는 다음년도 총회 승인 후 처리되며,<br>자산 상황에 따라 조정될 수 있음을 확인합니다.
                                </label>
                            </div>
                            <button class="btn btn-success w-100 fw-bold" onclick="submitApplication('reduction')">신청하기</button>
                        </div>

                        <div id="tabWithdraw" class="hidden">
                            <h6 class="fw-bold text-danger mb-3">탈퇴 신청</h6>
                            <div class="mb-3">
                                <label class="form-label small">탈퇴 사유</label>
                                <textarea id="wdReason" class="form-control" rows="3" placeholder="사유를 입력해주세요"></textarea>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="checkWdAgree">
                                <label class="form-check-label small text-danger fw-bold" for="checkWdAgree">
                                    탈퇴 시 출자금은 다음년도 총회 승인 후<br>환급됨을 확인하였습니다.
                                </label>
                            </div>
                            <button class="btn btn-dark w-100 fw-bold" onclick="submitApplication('withdraw')">탈퇴 신청</button>
                        </div>

                        <div id="tabCert" class="hidden text-center py-3">
                            <h6 class="fw-bold">출자 증명서</h6>
                            <p class="small text-muted">현재 납입된 출자금을 기준으로<br>PDF 증명서를 생성합니다.</p>
                            <button class="btn btn-outline-success w-100 fw-bold" onclick="downloadCert()">
                                <i class="bi bi-download me-2"></i>다운로드
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-7">
                <div class="dashboard-card">
                    <h5 class="fw-bold mb-4 border-bottom pb-2">최근 활동 내역</h5>
                    <div id="timelineList" style="max-height: 600px; overflow-y: auto;">
                        <p class="text-center text-muted py-5">내역을 불러오는 중...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </main>

  <footer id="footer"></footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="footer.js"></script>

 <script>
    // =========================================================================
    // 1. Supabase 설정
    // =========================================================================
    const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
    
    let _supabase = null;
    let curMem = null;
    let curAuth = null;

    try {
        _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch (e) {
        console.error("Supabase Init Error", e);
        alert("시스템 연결 오류");
    }

    function showLoading(show, msg) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        if(msg) document.getElementById('loadingMsg').innerText = msg;
    }

    // 초기화
    window.addEventListener('DOMContentLoaded', async () => {
        if(!_supabase) return;
        const { data: { session } } = await _supabase.auth.getSession();
        if (session) handleLoginSuccess(session.user);
    });

    // =========================================================================
    // 2. 로그인 & 데이터 로드
    // =========================================================================
    async function sendMagicLink() {
        const email = document.getElementById('emailInput').value.trim();
        if(!email.includes('@')) return alert('올바른 이메일 주소를 입력해주세요.');
        
        showLoading(true, '인증 메일 발송 중...');
        const { error } = await _supabase.auth.signInWithOtp({
            email: email,
            options: { shouldCreateUser: false, emailRedirectTo: window.location.href }
        });
        showLoading(false);

        if(error) alert('오류: ' + error.message);
        else {
            document.getElementById('sentMsgBox').classList.remove('hidden');
            document.getElementById('targetEmail').innerText = email;
        }
    }

    async function handleLoginSuccess(user) {
        curAuth = user;
        showLoading(true, '정보 확인 중...');
        document.getElementById('headerLogoutBtn').classList.remove('hidden');

        // 매핑 확인
        const { data: claimRes, error: claimErr } = await _supabase.rpc('claim_member_profile');
        if (claimErr || (!claimRes.success && claimRes.message === 'not_found')) {
            await _supabase.auth.signOut();
            showLoading(false);
            return alert('조합원 정보를 찾을 수 없습니다.');
        }

        // 데이터 로드
        await loadDashboardData(user.id);
    }

    async function loadDashboardData(uuid) {
        try {
            // [1] 내 정보 (VIEW 사용)
            const { data: member, error: memErr } = await _supabase
                .from('view_member_list')
                .select('*')
                .eq('id', uuid)
                .single();
            
            if(memErr) throw memErr;
            curMem = member;

            // [2] 신청 내역
            const { data: apps } = await _supabase
                .from('coop_applications')
                .select('*')
                .eq('member_uid', uuid)
                .order('created_at', { ascending: false });

            // [3] 입금 내역
            const { data: ledger } = await _supabase
                .from('ref_members')
                .select('*')
                .eq('member_id', curMem.member_id)
                .order('deposit_date', { ascending: false });

            renderDashboard(member, apps || [], ledger || []);
            showLoading(false);

        } catch (e) {
            console.error(e);
            showLoading(false);
            alert('데이터 로드 실패: ' + e.message);
        }
    }

    // =========================================================================
    // 3. 렌더링 & 내 정보 수정 (toggleEditMode 포함)
    // =========================================================================
    function renderDashboard(member, apps, ledger) {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('dashboardSection').classList.remove('hidden');

        // 1. 기본 정보
        setText('infoName', member.name);
        // 생년월일 포맷팅 (840914 -> 1984년 9월 14일)
        setText('infoBirth', formatBirthDate(member.rrn_display));
        setText('infoEmail', curAuth.email);
        
        // 2. 수정 폼 초기값
        setVal('editPhone', member.phone);
        setVal('editAddress', member.address);
        setVal('editBankName', member.bank_name);
        setVal('editAccountNo', member.account_number); // 마스킹된 값
        setVal('editHolder', member.account_holder);

        // 3. 요약 정보
        setText('sumId', member.member_id);
        // 총 납입금 (뷰의 total_capital 사용)
        setText('sumTotal', Number(member.total_capital || 0).toLocaleString() + '원');
        
        // 은행 정보 표시
        const bankText = member.bank_name ? `${member.bank_name} (계좌 있음)` : '미등록 계좌';
        setText('sumBank', bankText);

        renderTimeline(ledger, apps);
    }

    // [누락되었던 함수 복구] 수정 모드 토글
    function toggleEditMode(isEdit) {
        const inputs = document.querySelectorAll('.readonly-text, .editable-input');
        const editOnly = document.querySelectorAll('.edit-mode-only');
        
        if (isEdit) {
            document.getElementById('btnEditProfile').classList.add('hidden');
            document.getElementById('btnSaveProfile').classList.remove('hidden');
            document.getElementById('btnCancelEdit').classList.remove('hidden');
            
            inputs.forEach(el => {
                el.readOnly = false;
                el.classList.add('editable-input');
                el.classList.remove('readonly-text');
            });
            editOnly.forEach(el => el.style.display = 'inline-block');
        } else {
            // 취소 시 리로드
            loadDashboardData(curAuth.id);
            document.getElementById('btnEditProfile').classList.remove('hidden');
            document.getElementById('btnSaveProfile').classList.add('hidden');
            document.getElementById('btnCancelEdit').classList.add('hidden');
            
            inputs.forEach(el => {
                el.readOnly = true;
                el.classList.remove('editable-input');
                el.classList.add('readonly-text');
            });
            editOnly.forEach(el => el.style.display = 'none');
        }
    }

    async function saveProfile() {
        if(!confirm('정보를 수정하시겠습니까?')) return;
        showLoading(true, '저장 중...');

        const phone = document.getElementById('editPhone').value;
        const addr = document.getElementById('editAddress').value;
        const bank = document.getElementById('editBankName').value;
        const accNo = document.getElementById('editAccountNo').value;
        const holder = document.getElementById('editHolder').value;

        const { error } = await _supabase.rpc('update_my_profile', {
            p_phone: phone,
            p_address: addr,
            p_bank_name: bank,
            p_account_number: accNo,
            p_account_holder: holder
        });

        if (error) {
            showLoading(false);
            alert('수정 실패: ' + error.message);
        } else {
            alert('수정되었습니다.');
            toggleEditMode(false);
        }
    }

    // [헬퍼] 생년월일 포맷팅
    function formatBirthDate(rrn) {
        if (!rrn || rrn.length < 6) return '-';
        const yy = rrn.substring(0, 2);
        const mm = rrn.substring(2, 4);
        const dd = rrn.substring(4, 6);
        
        // 성별 코드 확인 (없으면 1900년대로 가정)
        let prefix = '19';
        if (rrn.includes('-')) {
            const gender = rrn.split('-')[1].charAt(0);
            if (gender === '3' || gender === '4') prefix = '20';
        }
        
        return `${prefix}${yy}년 ${Number(mm)}월 ${Number(dd)}일`;
    }

    // =========================================================================
    // 4. 신청 및 타임라인
    // =========================================================================
    function renderTimeline(ledger, apps) {
        const list = document.getElementById('timelineList');
        let html = '';

        if(ledger.length === 0 && apps.length === 0) {
            list.innerHTML = '<div class="text-center text-muted py-5">내역이 없습니다.</div>';
            return;
        }

        ledger.forEach(item => {
            html += `
            <div class="timeline-item">
                <div class="timeline-date">${item.deposit_date ? item.deposit_date.substring(0,10) : '날짜미상'}</div>
                <div class="timeline-content">
                    <h5>입금 확인</h5>
                    <p class="text-success fw-bold">+${Number(item.amount).toLocaleString()}원</p>
                </div>
            </div>`;
        });

        const typeMap = { 'extra': '추가출자', 'reduction': '감자', 'withdraw': '탈퇴' };
        apps.forEach(app => {
            let statusBadge = '';
            let actionBtn = '';

            if(app.status === 'pending') {
                statusBadge = '<span class="badge bg-warning text-dark">검토중</span>';
                actionBtn = `<button class="btn btn-sm btn-outline-danger ms-2" style="font-size:0.7rem; padding:2px 6px;" onclick="cancelApp(${app.id})">취소</button>`;
            } else if(app.status === 'approved') {
                statusBadge = '<span class="badge bg-success">승인됨</span>';
            } else if(app.status === 'cancelled') {
                statusBadge = '<span class="badge bg-secondary">취소됨</span>';
            } else {
                statusBadge = '<span class="badge bg-danger">반려됨</span>';
            }

            html += `
            <div class="timeline-item" style="border-left-color: #ff9800;">
                <div class="timeline-date">${app.created_at.substring(0,10)}</div>
                <div class="timeline-content">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-bold">[신청] ${typeMap[app.type]}</span>
                            ${statusBadge}
                        </div>
                        ${actionBtn}
                    </div>
                    <p>${Number(app.amount).toLocaleString()}원</p>
                </div>
            </div>`;
        });

        list.innerHTML = html;
    }

    async function cancelApp(appId) {
        if(!confirm('신청을 취소하시겠습니까?')) return;
        showLoading(true);
        const { error } = await _supabase
            .from('coop_applications')
            .update({ status: 'cancelled' })
            .eq('id', appId);

        showLoading(false);
        if(error) alert('취소 실패: ' + error.message);
        else {
            alert('취소되었습니다.');
            loadDashboardData(curAuth.id);
        }
    }

    // 신청 로직 (Submit)
    async function submitApplication(type) {
        let amount = 0, reason = '';
        const totalCap = Number(curMem.total_capital || 0);

        if(type === 'extra') {
            amount = Number(document.getElementById('exAmount').value);
            if(amount < 10000) return alert('1만원 이상 입력해주세요.');
        } 
        else if(type === 'reduction') {
            amount = Number(document.getElementById('redAmount').value);
            if(amount <= 0) return alert('금액을 입력해주세요.');
            if(totalCap - amount < 100000) return alert(`최소 10만원 이상 유지해야 합니다.\n(현재: ${totalCap.toLocaleString()}원)`);
            if(!document.getElementById('checkRedAgree').checked) return alert('동의 항목에 체크해주세요.');
        } 
        else if(type === 'withdraw') {
            reason = document.getElementById('wdReason').value;
            if(!reason) return alert('사유를 입력해주세요.');
            if(!document.getElementById('checkWdAgree').checked) return alert('동의 항목에 체크해주세요.');
        }

        if(!confirm('신청하시겠습니까?')) return;
        showLoading(true);

        const { error } = await _supabase.from('coop_applications').insert({
            member_uid: curAuth.id,
            member_id: curMem.member_id,
            name: curMem.name,
            type: type,
            amount: amount,
            reason: reason,
            status: 'pending'
        });

        showLoading(false);
        if(error) alert('오류: ' + error.message);
        else {
            alert('신청되었습니다.');
            document.getElementById('exAmount').value = '';
            document.getElementById('redAmount').value = '';
            document.getElementById('wdReason').value = '';
            loadDashboardData(curAuth.id);
        }
    }

    // 탭 및 유틸
    function toggleTab(type, btn) {
        document.getElementById('tabPlaceholder').classList.add('hidden');
        ['tabExtra', 'tabReduction', 'tabWithdraw', 'tabCert'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        document.getElementById('tab' + type.charAt(0).toUpperCase() + type.slice(1)).classList.remove('hidden');
    }

    // PDF 다운로드
    async function downloadCert() {
        if(!curMem) return;
        showLoading(true, '증서 발급 중...');
        try {
            const { data: payments } = await _supabase.from('ref_members').select('amount').eq('member_id', curMem.member_id);
            const totalAmount = payments ? payments.reduce((a,c)=>a+Number(c.amount),0) : 0;
            if(totalAmount===0) { showLoading(false); return alert('납입 내역이 없습니다.'); }

            const { data: certRes } = await _supabase.rpc('issue_certificate', { p_member_id: curMem.member_id, p_amount: totalAmount });
            const { data: info } = await _supabase.from('ref_company_info').select('value').eq('key', 'chairman_name').single();
            const chairman = info ? info.value : "김민호";

            await generateContributionCert(curMem, totalAmount, certRes.cert_number, chairman, _supabase);
            showLoading(false);
        } catch(e) { console.error(e); showLoading(false); alert('오류 발생'); }
    }

    function logout() { if(confirm('로그아웃?')) _supabase.auth.signOut().then(()=>location.reload()); }
    function startKakaoLogin() { alert('카카오 설정 필요'); }
    
    // [헬퍼] 안전한 값 설정
    function setText(id, txt) { const el=document.getElementById(id); if(el) el.innerText = txt || '-'; }
    function setVal(id, val) { const el=document.getElementById(id); if(el) el.value = val || ''; }

    // 주소찾기
    function execDaumPostcode() {
        var layer = document.getElementById('layer');
        new daum.Postcode({
            oncomplete: function(data) {
                var addr = data.userSelectedType === 'R' ? data.roadAddress : data.jibunAddress;
                if(data.buildingName) addr += ' (' + data.buildingName + ')';
                document.getElementById('editAddress').value = addr;
                layer.style.display = 'none';
            }, width:'100%', height:'100%'
        }).embed(layer);
        layer.style.display = 'block';
        // 레이어 위치 조정 로직 생략 (단순화)
        layer.style.top = '100px'; layer.style.left = '50%'; layer.style.marginLeft = '-150px';
    }
    function closeDaumPostcode() { document.getElementById('layer').style.display = 'none'; }
</script>
</body>
</html>
