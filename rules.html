<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¡°í•© ê·œì •ì§‘</title>
  
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">

  <style>
    body { background-color: #f5f7fa; font-family: 'Pretendard', sans-serif; padding-top: 60px; }
    
    /* 1. ì‹¬í”Œí•´ì§„ í—¤ë” */
    .sticky-header {
        position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
        background: rgba(255, 255, 255, 0.98);
        border-bottom: 1px solid #eee;
        height: 60px; display: flex; align-items: center;
        transition: top 0.3s;
    }
    
    /* 2. ì ‘ì—ˆë‹¤ íˆë‹¤ í•˜ëŠ” ê²€ìƒ‰ì°½ */
    #search-area {
        position: fixed; top: 60px; left: 0; width: 100%; 
        background: white; padding: 15px; z-index: 999;
        border-bottom: 1px solid #eee; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
    }
    #search-area.show { display: block; }

    /* 3. íƒ­ ìŠ¤íƒ€ì¼ */
    .nav-tabs .nav-link { color: #888; font-weight: 600; border: none; padding: 15px 20px; }
    .nav-tabs .nav-link.active { color: var(--color-primary, #009961); border-bottom: 3px solid var(--color-primary, #009961); background: transparent; }

    /* 4. [í•µì‹¬] ìŠ¤ë§ˆíŠ¸ ë””ìì¸ ìš”ì†Œ */
    /* ì œNì¥ (ì„¹ì…˜ êµ¬ë¶„) */
    .chapter-header {
        margin-top: 40px; margin-bottom: 15px;
        font-size: 1.2rem; font-weight: 800; color: #2c3e50;
        border-left: 5px solid var(--color-primary, #009961);
        padding-left: 15px;
    }
    /* ë¶€ì¹™ (ê°•ì¡°) */
    .addendum-header {
        margin-top: 50px; margin-bottom: 20px;
        background: #e9ecef; padding: 10px 15px;
        font-weight: 800; border-radius: 8px; color: #495057;
        text-align: center;
    }

    /* ì¡°í•­ ì¹´ë“œ */
    .article-card {
        background: white; border: 1px solid #e9ecef; border-radius: 12px;
        padding: 20px; margin-bottom: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    }
    .article-title { 
        color: var(--color-secondary, #2c3e50); 
        font-weight: 700; font-size: 1.05rem; 
        margin-bottom: 10px; display: block; 
    }
    .article-content { 
        font-size: 0.95rem; line-height: 1.7; color: #555; 
        word-break: keep-all; padding-left: 2px;
    }
    /* ê²€ìƒ‰ í•˜ì´ë¼ì´íŠ¸ */
    .highlight { background-color: #fff3cd; font-weight: bold; }
  </style>
</head>

<body>

  <header class="sticky-header">
    <div class="container d-flex justify-content-between align-items-center">
        <a href="index.html" class="text-decoration-none text-dark fw-bold fs-5">
            <i class="bi bi-chevron-left me-1"></i> ê·œì •ì§‘
        </a>
        
        <div class="d-flex gap-3">
            <button class="btn btn-light rounded-circle" onclick="toggleSearch()">
                <i class="bi bi-search"></i>
            </button>
        </div>
    </div>
  </header>

  <div id="search-area">
      <div class="container">
        <div class="input-group">
            <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
            <input type="text" id="searchInput" class="form-control border-start-0" placeholder="ì¡°í•­ì´ë‚˜ ë‹¨ì–´ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”">
            <button class="btn btn-outline-secondary" onclick="toggleSearch()">ë‹«ê¸°</button>
        </div>
      </div>
  </div>

  <div style="background:white; border-bottom:1px solid #eee;">
      <div class="container">
        <ul class="nav nav-tabs nav-fill" id="myTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="tab-articles" data-bs-toggle="tab" data-bs-target="#pane-articles">ğŸ“œ ì •ê´€</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="tab-bylaws" data-bs-toggle="tab" data-bs-target="#pane-bylaws">âš–ï¸ ê·œì•½</button>
            </li>
        </ul>
      </div>
  </div>

  <main class="container py-4">
    <div class="tab-content">
        <div class="tab-pane fade show active" id="pane-articles">
            <div class="d-flex justify-content-between align-items-end mb-4 px-2">
                <div>
                    <h2 class="fw-bold m-0">ì •ê´€</h2>
                    <small class="text-muted" id="ver-articles">ë²„ì „ ì •ë³´ ë¡œë”©ì¤‘...</small>
                </div>
                <div id="file-articles"></div> </div>
            
            <div id="content-articles"></div> <div class="mt-5">
                <h6 class="fw-bold text-muted border-bottom pb-2 mb-3">ğŸ—„ï¸ ì§€ë‚œ ê°œì • ì´ë ¥</h6>
                <div class="accordion" id="acc-articles"></div>
            </div>
        </div>

        <div class="tab-pane fade" id="pane-bylaws">
            <div class="d-flex justify-content-between align-items-end mb-4 px-2">
                <div>
                    <h2 class="fw-bold m-0">ìš´ì˜ ê·œì•½</h2>
                    <small class="text-muted" id="ver-bylaws">ë²„ì „ ì •ë³´ ë¡œë”©ì¤‘...</small>
                </div>
                <div id="file-bylaws"></div>
            </div>

            <div id="content-bylaws"></div>

            <div class="mt-5">
                <h6 class="fw-bold text-muted border-bottom pb-2 mb-3">ğŸ—„ï¸ ì§€ë‚œ ê°œì • ì´ë ¥</h6>
                <div class="accordion" id="acc-bylaws"></div>
            </div>
        </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script>
    const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    window.onload = async () => {
        await loadDocs('ì •ê´€', 'articles');
        await loadDocs('ê·œì•½', 'bylaws');
        
        // ê²€ìƒ‰ í•„í„° ì—°ê²°
        document.getElementById('searchInput').addEventListener('keyup', filterContent);
        
        // URL í•´ì‹œ(#bylaws) ìˆìœ¼ë©´ íƒ­ ì´ë™
        if(window.location.hash === '#bylaws') {
            const triggerEl = document.querySelector('#tab-bylaws');
            bootstrap.Tab.getInstance(triggerEl) || new bootstrap.Tab(triggerEl).show();
        }
    };

    function toggleSearch() {
        document.getElementById('search-area').classList.toggle('show');
        if(document.getElementById('search-area').classList.contains('show')) {
            document.getElementById('searchInput').focus();
        }
    }

    async function loadDocs(keyword, type) {
        const { data } = await _supabase.from('site_documents')
            .select('*')
            .eq('category', 'doc')
            .ilike('title', `%${keyword}%`)
            .order('event_date', {ascending: false});

        if (!data || data.length === 0) return;

        // ìµœì‹  ë²„ì „ (is_current ìš°ì„ , ì—†ìœ¼ë©´ ë‚ ì§œìˆœ 1ë²ˆ)
        let current = data.find(d => d.is_current) || data[0];
        let past = data.filter(d => d.id !== current.id);

        // 1. í˜„ì¬ ë²„ì „ ë Œë”ë§
        if (current) {
            document.getElementById(`ver-${type}`).innerText = `${current.event_date} ì‹œí–‰ | ${current.version || 'ì œì •'}`;
            if(current.file_url) {
                document.getElementById(`file-${type}`).innerHTML = 
                    `<a href="${current.file_url}" target="_blank" class="btn btn-sm btn-outline-secondary"><i class="bi bi-file-pdf"></i> ì›ë¬¸</a>`;
            }
            
            // â˜… ìŠ¤ë§ˆíŠ¸ íŒŒì‹± ë Œë”ë§ ì‹¤í–‰
            renderSmartContent(current.content, `content-${type}`);
        }

        // 2. ê³¼ê±° ì´ë ¥ ë Œë”ë§ (ì•„ì½”ë””ì–¸)
        const accContainer = document.getElementById(`acc-${type}`);
        if(past.length > 0) {
            past.forEach((doc, i) => {
                const id = `collapse-${type}-${i}`;
                accContainer.innerHTML += `
                    <div class="accordion-item searchable-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${id}">
                                <span class="badge bg-secondary me-2">${doc.event_date}</span> ${doc.title}
                            </button>
                        </h2>
                        <div id="${id}" class="accordion-collapse collapse">
                            <div class="accordion-body bg-light">
                                ${textToHtml(doc.content)}
                                ${doc.file_url ? `<div class="mt-2"><a href="${doc.file_url}" target="_blank" class="btn btn-sm btn-dark">PDF ë³´ê¸°</a></div>` : ''}
                            </div>
                        </div>
                    </div>`;
            });
        } else {
            accContainer.innerHTML = '<div class="text-center py-3 small text-muted">ì´ì „ ê°œì • ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
    }

    // â˜… [í•µì‹¬] ì§„ì§œ ìŠ¤ë§ˆíŠ¸í•œ íŒŒì‹± í•¨ìˆ˜ (ì¥, ì¡°, ë¶€ì¹™ êµ¬ë¶„)
    function renderSmartContent(text, containerId) {
        if (!text) return;
        const container = document.getElementById(containerId);
        container.innerHTML = ''; // ì´ˆê¸°í™”

        // ì¤„ ë‹¨ìœ„ë¡œ ë¶„ë¦¬ (ë¹ˆ ì¤„ ì œê±°)
        const lines = text.split('\n').map(l => l.trim()).filter(l => l);
        
        let currentCardBody = null; // í˜„ì¬ ì‘ì„± ì¤‘ì¸ ì¹´ë“œ ë‚´ìš©

        lines.forEach(line => {
            // 1. [ì œNì¥] ê°ì§€ -> í° ì œëª©
            if (line.match(/^ì œ\s*\d+\s*ì¥/)) {
                closeCard(); // ì´ì „ ì¹´ë“œ ë‹«ê¸°
                container.innerHTML += `<div class="chapter-header searchable-item">${line}</div>`;
            }
            // 2. [ë¶€ì¹™] ê°ì§€ -> ì¤‘ê°„ êµ¬ë¶„ì„ 
            else if (line.match(/^ë¶€\s*ì¹™/)) {
                closeCard();
                container.innerHTML += `<div class="addendum-header searchable-item">${line}</div>`;
            }
            // 3. [ì œNì¡°] ê°ì§€ -> ìƒˆ ì¹´ë“œ ì‹œì‘
            else if (line.match(/^ì œ\s*\d+\s*ì¡°/)) {
                closeCard(); // ì´ì „ ì¹´ë“œ ë‹«ê¸°
                
                // ì¹´ë“œ ì‹œì‘ (ì œëª©ì€ ë°”ë¡œ ë„£ê³ , ë‚´ìš©ì€ currentCardBodyì— ìŒ“ìŒ)
                const cardDiv = document.createElement('div');
                cardDiv.className = 'article-card searchable-item';
                
                // ì œëª©ê³¼ ë‚´ìš© ë¶„ë¦¬ (ì˜ˆ: "ì œ1ì¡°(ëª©ì ) ì´ ì¡°í•©ì€...")
                // ê´„í˜¸ ë‹«íˆëŠ” ê³³ or ê³µë°± ê¸°ì¤€ìœ¼ë¡œ ì œëª© ëŠê¸°
                // ë‹¨ìˆœí•˜ê²Œ ì¤„ ì „ì²´ë¥¼ ì œëª©ìœ¼ë¡œ ì“°ê³ , ë‹¤ìŒ ì¤„ë¶€í„° ë‚´ìš©ìœ¼ë¡œ ì“¸ ìˆ˜ë„ ìˆìŒ.
                // ì—¬ê¸°ì„œëŠ” "ì œNì¡°"ê°€ í¬í•¨ëœ ì¤„ ì „ì²´ë¥¼ ì œëª©(ê°•ì¡°)ìœ¼ë¡œ ì”ë‹ˆë‹¤.
                cardDiv.innerHTML = `<span class="article-title">${line}</span>`;
                
                // ë‚´ìš© ë‹´ì„ ê·¸ë¦‡ ìƒì„±
                currentCardBody = document.createElement('div');
                currentCardBody.className = 'article-content';
                cardDiv.appendChild(currentCardBody);
                
                container.appendChild(cardDiv);
            }
            // 4. ê·¸ ì™¸ ë‚´ìš© -> í˜„ì¬ ì¹´ë“œì— ì¶”ê°€
            else {
                if (currentCardBody) {
                    currentCardBody.innerHTML += line + '<br>';
                } else {
                    // ì¹´ë“œê°€ ì—†ëŠ” ìƒíƒœì—ì„œ ë‚˜ì˜¨ ê¸€(ì„œë¬¸ ë“±)ì€ ê·¸ëƒ¥ í…ìŠ¤íŠ¸ë¡œ
                    container.innerHTML += `<p class="searchable-item text-muted small px-2">${line}</p>`;
                }
            }
        });

        function closeCard() {
            currentCardBody = null; // ì¹´ë“œ ë‹«í˜ ì²˜ë¦¬
        }
    }

    function textToHtml(str) { return str ? str.replace(/\n/g, '<br>') : ''; }

    // ê²€ìƒ‰ ê¸°ëŠ¥
    function filterContent() {
        const val = document.getElementById('searchInput').value.toLowerCase();
        const items = document.querySelectorAll('.searchable-item');
        
        items.forEach(el => {
            // ì•„ì½”ë””ì–¸ ë‚´ë¶€ ë‚´ìš©ì€ ê²€ìƒ‰ ëŒ€ìƒì—ì„œ ì œì™¸ (í¼ì³ì§„ ê²ƒë§Œ ê²€ìƒ‰í•˜ê³  ì‹¶ë‹¤ë©´ ë¡œì§ ì¶”ê°€ í•„ìš”)
            // ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœí•˜ê²Œ ì „ì²´ í•„í„°ë§
            if(el.innerText.toLowerCase().includes(val)) {
                el.style.display = '';
            } else {
                el.style.display = 'none';
            }
        });
    }
  </script>
</body>
</html>
