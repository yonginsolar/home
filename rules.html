<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¡°í•© ê·œì •ì§‘ - ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•©</title>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet"> 
  
  <style>
      /* í—¤ë” ê°•ì œ ìŠ¤íƒ€ì¼ (í° ë°°ê²½ì— ê²€ì€ ê¸€ì”¨) */
      #header { background: #fff !important; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
      #navbar ul li a { color: #333 !important; }
      #navbar .mobile-nav-toggle { color: #333 !important; }
      .logo h1 a { color: #333 !important; }
  </style>
</head>

<body style="background-color: #f8f9fa;">

  <header id="header" class="fixed-top">
    <div class="container d-flex align-items-center justify-content-between">
      <div class="logo">
        <h1><a href="index.html">ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•©</a></h1>
      </div>
      <nav id="navbar" class="navbar">
        <ul>
          <li><a class="nav-link" href="index.html">í™ˆìœ¼ë¡œ</a></li>
          <li><a class="nav-link" href="index.html#contact">ë¬¸ì˜í•˜ê¸°</a></li>
        </ul>
        <i class="bi bi-list mobile-nav-toggle"></i>
      </nav>
    </div>
  </header>

  <div style="height: 70px;"></div>

  <div class="sticky-nav-area">
      <div class="container">
          <div class="input-group mb-2">
              <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-secondary"></i></span>
              <input type="text" id="searchInput" class="form-control border-start-0" placeholder="ì¡°í•­ ê²€ìƒ‰ (ì˜ˆ: ì´ì‚¬íšŒ, ì¶œìê¸ˆ)">
          </div>

          <ul class="nav nav-pills nav-fill" id="pills-tab" role="tablist">
              <li class="nav-item">
                  <button class="nav-link active" id="pills-articles-tab" data-bs-toggle="pill" data-bs-target="#pills-articles" type="button" onclick="window.scrollTo(0,0)">ğŸ“œ ì •ê´€</button>
              </li>
              <li class="nav-item">
                  <button class="nav-link" id="pills-bylaws-tab" data-bs-toggle="pill" data-bs-target="#pills-bylaws" type="button" onclick="window.scrollTo(0,0)">âš–ï¸ ê·œì•½</button>
              </li>
          </ul>
      </div>
  </div>

  <main class="container py-3" style="min-height: 80vh;">
    <div class="tab-content" id="pills-tabContent">
        
        <div class="tab-pane fade show active" id="pills-articles">
            <div class="text-center mb-4">
                <h4 class="fw-bold">ì •ê´€ (Articles)</h4>
                <p class="text-muted small" id="articles-version">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
            <div id="articles-container"></div> 
            
            <div class="mt-5 pt-4 border-top">
                <h6 class="fw-bold text-muted mb-3 small">ì§€ë‚œ ê°œì • ì´ë ¥</h6>
                <div class="accordion" id="accordionArticles"></div>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-bylaws">
            <div class="text-center mb-4">
                <h4 class="fw-bold">ìš´ì˜ ê·œì•½ (Bylaws)</h4>
                <p class="text-muted small" id="bylaws-version">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
            <div id="bylaws-container"></div> 

            <div class="mt-5 pt-4 border-top">
                <h6 class="fw-bold text-muted mb-3 small">ì§€ë‚œ ê°œì • ì´ë ¥</h6>
                <div class="accordion" id="accordionBylaws"></div>
            </div>
        </div>

    </div>
  </main>

  <footer id="footer" style="background:#2c3e50; color:white; padding:30px 0; margin-top:50px;">
    <div class="container text-center">
      <div class="copyright">
        &copy; Copyright <strong><span>ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•©</span></strong>. All Rights Reserved
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script>
    const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    window.onload = async () => {
        await loadDocuments('ì •ê´€', 'articles');
        await loadDocuments('ê·œì•½', 'bylaws');
        document.getElementById('searchInput').addEventListener('input', filterContent);
        if(window.location.hash === '#bylaws') {
            const trigger = document.querySelector('#pills-bylaws-tab');
            if(trigger) new bootstrap.Tab(trigger).show();
        }
    };

    async function loadDocuments(keyword, typeId) {
        const { data } = await _supabase.from('site_documents')
            .select('*').eq('category', 'doc').ilike('title', `%${keyword}%`).order('event_date', {ascending: false});

        if (!data || data.length === 0) {
            document.getElementById(`${typeId}-container`).innerHTML = '<div class="text-center py-5 text-muted">ë“±ë¡ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        let currentDoc = data.find(d => d.is_current) || data[0];
        let pastDocs = data.filter(d => d.id !== currentDoc.id);

        if (currentDoc) {
            document.getElementById(`${typeId}-version`).innerText = `ì‹œí–‰ì¼: ${currentDoc.event_date} | ë²„ì „: ${currentDoc.version || 'Original'}`;
            // â˜… í•µì‹¬ í•¨ìˆ˜ í˜¸ì¶œ
            renderCards(currentDoc.content, `${typeId}-container`);
        }

        // ì•„ì½”ë””ì–¸ (ê³¼ê±° ìë£Œ)
        const archiveBox = document.getElementById(typeId === 'articles' ? 'accordionArticles' : 'accordionBylaws');
        if (pastDocs.length > 0) {
            let html = '';
            pastDocs.forEach((doc, idx) => {
                const itemId = `${typeId}Arch${idx}`;
                html += `
                    <div class="accordion-item searchable-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${itemId}">
                                ${doc.title} <span class="archive-badge">${doc.event_date}</span>
                            </button>
                        </h2>
                        <div id="${itemId}" class="accordion-collapse collapse">
                            <div class="accordion-body bg-light">
                                <div class="archive-content" style="white-space: pre-wrap; font-size:0.9rem;">${doc.content}</div>
                            </div>
                        </div>
                    </div>`;
            });
            archiveBox.innerHTML = html;
        } else {
            archiveBox.innerHTML = '<div class="text-center text-muted small py-3">ì§€ë‚œ ê°œì • ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
    }

    // â˜…â˜…â˜… [í•µì‹¬ ë¡œì§] êµ­ì¥ë‹˜ ìš”ì²­ì‚¬í•­ ë°˜ì˜ â˜…â˜…â˜…
    function renderCards(text, containerId) {
        const container = document.getElementById(containerId);
        if (!text) return;

        // 1. ì¤„ë°”ê¿ˆì„ ê¸°ì¤€ìœ¼ë¡œ ì¼ë‹¨ ë‚˜ëˆ•ë‹ˆë‹¤.
        const lines = text.split('\n');
        
        let html = '';
        let buffer = ''; // ì¹´ë“œ ë‚´ìš©ì„ ëª¨ì„ ì„ì‹œ ì €ì¥ì†Œ
        let currentTitle = ''; // í˜„ì¬ ì¹´ë“œ ì œëª©

        // ì •ê·œì‹ íŒ¨í„´
        const chapterPattern = /^ì œ\s*\d+\s*ì¥/; // "ì œ1ì¥" ì°¾ê¸°
        const addendaPattern = /^ë¶€\s*ì¹™/;       // "ë¶€ì¹™" ì°¾ê¸°
        const articlePattern = /^(ì œ\s*\d+\s*ì¡°.*?)(?=\s|$|\(|\[)/; // "ì œ3ì¡°"ë§Œ ì°¾ê¸°

        lines.forEach(line => {
            const trimmed = line.trim();
            if(!trimmed) return;

            // [Case 1] ì œNì¥ -> í° ì œëª©ìœ¼ë¡œ ë¶„ë¦¬
            if (chapterPattern.test(trimmed)) {
                // ì´ì „ê¹Œì§€ ëª¨ì•˜ë˜ ì¹´ë“œê°€ ìˆìœ¼ë©´ ì¶œë ¥
                if (currentTitle || buffer) flushCard();
                html += `<div class="chapter-title searchable-item">${trimmed}</div>`;
                return;
            }

            // [Case 2] ë¶€ì¹™ -> ì¤‘ê°„ ì œëª©ìœ¼ë¡œ ë¶„ë¦¬
            if (addendaPattern.test(trimmed)) {
                if (currentTitle || buffer) flushCard();
                html += `<div class="addenda-title searchable-item">${trimmed}</div>`;
                return;
            }

            // [Case 3] ì œNì¡° -> ìƒˆë¡œìš´ ì¹´ë“œ ì‹œì‘
            if (trimmed.startsWith('ì œ') && trimmed.includes('ì¡°')) {
                // ì´ì „ ì¹´ë“œ ì¶œë ¥
                if (currentTitle || buffer) flushCard();

                // ì œëª©ê³¼ ë‚´ìš© ë¶„ë¦¬ ë¡œì§ (â‘  ì•ì—ì„œ ìë¥´ê¸° í¬í•¨)
                // ì˜ˆ: "ì œ3ì¡°(ëª©ì ) â‘  ì¡°í•©ì€..." -> ì œëª©: "ì œ3ì¡°(ëª©ì )", ë‚´ìš©: "â‘  ì¡°í•©ì€..."
                
                // 1. â‘ , 1. ê°™ì€ ë²ˆí˜¸ê°€ ë‚˜ì˜¤ëŠ”ì§€ ì°¾ëŠ”ë‹¤.
                const splitIndex = trimmed.search(/(\(|\[|â‘ |1\.|ê°€\.)/);
                
                if (splitIndex > -1) {
                    // íŠ¹ìˆ˜ë¬¸ìë‚˜ ê´„í˜¸ê°€ ìˆìœ¼ë©´ ê±°ê¸°ì„œë¶€í„° ë‚´ìš©ìœ¼ë¡œ ë³´ì§€ë§Œ,
                    // "ì œ3ì¡°(ëª©ì )" ì²˜ëŸ¼ ê´„í˜¸ê°€ ë°”ë¡œ ë¶™ì–´ìˆëŠ” ê±´ ì œëª©ìœ¼ë¡œ ë´ì•¼ í•¨.
                    // ë”°ë¼ì„œ "ì œ3ì¡°(ëª©ì )" ê¹Œì§€ëŠ” ì œëª©, ê·¸ ë’¤ ê³µë°±ì´ë‚˜ â‘ ë¶€í„° ë‚´ìš©.
                    
                    // ê´„í˜¸ê°€ ë‹«íˆëŠ” ê³³ ì°¾ê¸°
                    const parenEnd = trimmed.indexOf(')');
                    if (parenEnd > -1 && parenEnd < trimmed.length - 1) {
                        // ê´„í˜¸ ë‹«íŒ ë’¤ ë‚´ìš©ì´ ì´ì–´ì§€ë©´ ê±°ê¸°ì„œ ìë¦„
                        currentTitle = trimmed.substring(0, parenEnd + 1).trim();
                        buffer = trimmed.substring(parenEnd + 1).trim();
                    } else {
                        // ê´„í˜¸ê°€ ì—†ìœ¼ë©´ ìˆ«ìë‚˜ íŠ¹ìˆ˜ë¬¸ì ì•ì—ì„œ ìë¦„
                        // ë‹¨, "ì œ3ì¡°" ìì²´ê°€ ë„ˆë¬´ ì§§ìœ¼ë©´ ì „ì²´ë¥¼ ì œëª©ìœ¼ë¡œ
                        currentTitle = trimmed; 
                        buffer = '';
                        
                        // ë§Œì•½ "ì œ3ì¡° â‘ ë‚´ìš©" ì²˜ëŸ¼ ë˜ì–´ìˆë‹¤ë©´?
                        const circleMatch = trimmed.search(/â‘ |â‘¡|â‘¢|â‘£|â‘¤|â‘¥|â‘¦|â‘§|â‘¨|â‘©/);
                        if (circleMatch > 0) {
                             currentTitle = trimmed.substring(0, circleMatch).trim();
                             buffer = trimmed.substring(circleMatch).trim();
                        }
                    }
                } else {
                    currentTitle = trimmed;
                    buffer = '';
                }
                return;
            }

            // [Case 4] ì¼ë°˜ ë‚´ìš© -> ë²„í¼ì— ì¶”ê°€
            if (trimmed) {
                buffer += (buffer ? '<br>' : '') + trimmed;
            }
        });

        // ë§ˆì§€ë§‰ ë‚¨ì€ ì¹´ë“œ ì¶œë ¥
        if (currentTitle || buffer) flushCard();

        // ë‚´ë¶€ í•¨ìˆ˜: ì¹´ë“œ HTML ìƒì„±
        function flushCard() {
            // ë‚´ìš©ì— â‘  ê°™ì€ê²Œ ìˆìœ¼ë©´ ì¤„ë°”ê¿ˆ ì²˜ë¦¬í•´ì„œ ë³´ê¸° ì¢‹ê²Œ
            let formattedBody = buffer.replace(/(â‘ |â‘¡|â‘¢|â‘£|â‘¤|â‘¥|â‘¦|â‘§|â‘¨|â‘©)/g, '<br>$1');
            // ë§¨ ì•ì¤„ì— ë¶ˆí•„ìš”í•œ <br> ì œê±°
            if(formattedBody.startsWith('<br>')) formattedBody = formattedBody.substring(4);

            html += `
            <div class="article-card searchable-item">
                ${currentTitle ? `<span class="article-title">${currentTitle}</span>` : ''}
                <div class="article-content">${formattedBody}</div>
            </div>`;
            
            // ì´ˆê¸°í™”
            currentTitle = '';
            buffer = '';
        }

        container.innerHTML = html;
    }

    // ê²€ìƒ‰ í•„í„°
    function filterContent() {
        const keyword = document.getElementById('searchInput').value.toLowerCase();
        const items = document.querySelectorAll('.searchable-item');

        items.forEach(item => {
            const collapseDiv = item.querySelector('.accordion-collapse');
            if (collapseDiv && !collapseDiv.classList.contains('show')) {
                item.style.display = ''; return; 
            }
            if (item.innerText.toLowerCase().includes(keyword)) item.style.display = '';
            else item.style.display = 'none';
        });
    }
  </script>
</body>
</html>
