<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¡°í•© ê·œì •ì§‘ - ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•©</title>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet"> 
</head>

<body>

  <header id="header" class="fixed-top header-scrolled" style="background:#fff; box-shadow:0 2px 15px rgba(0,0,0,0.1);">
    <div class="container d-flex align-items-center justify-content-between">
      <div class="logo">
        <h1 class="text-dark"><a href="index.html" class="text-dark" style="text-decoration:none;">ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•©</a></h1>
      </div>
      <nav id="navbar" class="navbar">
        <ul>
          <li><a class="nav-link scrollto" href="index.html#hero">í™ˆìœ¼ë¡œ</a></li>
          <li><a class="nav-link scrollto" href="index.html#contact">ë¬¸ì˜í•˜ê¸°</a></li>
        </ul>
        <i class="bi bi-list mobile-nav-toggle"></i>
      </nav>
    </div>
  </header>

  <div style="height: 80px;"></div>

  <div class="sticky-nav-area">
      <div class="container">
          <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="m-0 fw-bold"><i class="bi bi-book-half me-2 text-success"></i>ì¡°í•© ê·œì •ì§‘</h5>
          </div>
          
          <div class="input-group mb-3">
              <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
              <input type="text" id="searchInput" class="form-control" placeholder="í‚¤ì›Œë“œ ê²€ìƒ‰ (ì˜ˆ: ì´ì‚¬íšŒ, ì¡°í•©ì›)">
          </div>

          <ul class="nav nav-pills nav-fill" id="pills-tab" role="tablist">
              <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="pills-articles-tab" data-bs-toggle="pill" data-bs-target="#pills-articles" type="button" onclick="window.scrollTo(0,0)">ğŸ“œ ì •ê´€</button>
              </li>
              <li class="nav-item" role="presentation">
                  <button class="nav-link" id="pills-bylaws-tab" data-bs-toggle="pill" data-bs-target="#pills-bylaws" type="button" onclick="window.scrollTo(0,0)">âš–ï¸ ê·œì•½</button>
              </li>
          </ul>
      </div>
  </div>

  <main class="container py-4" style="min-height: 60vh;">
    <div class="tab-content" id="pills-tabContent">
        
        <div class="tab-pane fade show active" id="pills-articles">
            <div class="text-center pb-4">
                <h3 class="fw-bold">ì •ê´€ (Articles)</h3>
                <p class="text-muted small" id="articles-version">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
            
            <div id="articles-container"></div> 
            
            <div class="mt-5 pt-4 border-top">
                <h6 class="fw-bold text-muted mb-3 small"><i class="bi bi-clock-history"></i> ê°œì • ì´ë ¥ (History)</h6>
                <div class="accordion" id="accordionArticles"></div>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-bylaws">
            <div class="text-center pb-4">
                <h3 class="fw-bold">ìš´ì˜ ê·œì•½ (Bylaws)</h3>
                <p class="text-muted small" id="bylaws-version">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
            
            <div id="bylaws-container"></div> 

            <div class="mt-5 pt-4 border-top">
                <h6 class="fw-bold text-muted mb-3 small"><i class="bi bi-clock-history"></i> ê°œì • ì´ë ¥ (History)</h6>
                <div class="accordion" id="accordionBylaws"></div>
            </div>
        </div>

    </div>
  </main>

  <footer id="footer" style="background:#2c3e50; color:white; padding:30px 0;">
    <div class="container text-center">
      <div class="copyright">
        &copy; Copyright <strong><span>ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•©</span></strong>. All Rights Reserved
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script>
    const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    window.onload = async () => {
        // DBì—ì„œ ë¬¸ì„œ ê°€ì ¸ì˜¤ê¸° (ì œëª©ì— 'ì •ê´€'/'ê·œì•½' í¬í•¨ëœ ê²ƒ)
        await loadDocuments('ì •ê´€', 'articles');
        await loadDocuments('ê·œì•½', 'bylaws');
        
        // ê²€ìƒ‰ ê¸°ëŠ¥ ì—°ê²°
        document.getElementById('searchInput').addEventListener('input', filterContent);
        
        // URL í•´ì‹œ ì²´í¬ (ì˜ˆ: rules.html#bylaws ë¡œ ì ‘ì† ì‹œ ê·œì•½ íƒ­ ì—´ê¸°)
        if(window.location.hash === '#bylaws') {
            const trigger = document.querySelector('#pills-bylaws-tab');
            if(trigger) {
                const tab = new bootstrap.Tab(trigger);
                tab.show();
            }
        }
    };

    // DB ë¡œë“œ í•¨ìˆ˜
    async function loadDocuments(keyword, typeId) {
        const { data } = await _supabase.from('site_documents')
            .select('*')
            .eq('category', 'doc') // ë¬¸ì„œ ì¹´í…Œê³ ë¦¬ë§Œ
            .ilike('title', `%${keyword}%`) 
            .order('event_date', {ascending: false});

        if (!data || data.length === 0) {
            document.getElementById(`${typeId}-container`).innerHTML = '<div class="text-center py-5 text-muted">ë“±ë¡ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        // 1. í˜„ì¬ ë²„ì „ (is_current ì²´í¬ëœ ê²ƒ ì¤‘ ìµœì‹ , ì—†ìœ¼ë©´ ê·¸ëƒ¥ ìµœì‹ )
        let currentDoc = data.find(d => d.is_current) || data[0];
        
        // 2. ê³¼ê±° ë²„ì „ (í˜„ì¬ ë²„ì „ ì œì™¸í•œ ë‚˜ë¨¸ì§€)
        let pastDocs = data.filter(d => d.id !== currentDoc.id);

        // [í˜„ì¬ ë²„ì „ ë Œë”ë§]
        if (currentDoc) {
            document.getElementById(`${typeId}-version`).innerText = 
                `ì‹œí–‰ì¼: ${currentDoc.event_date} | ë²„ì „: ${currentDoc.version || 'Original'}`;
            
            // â˜… ì¹´ë“œ ìƒì„± ë¡œì§ í˜¸ì¶œ
            renderCards(currentDoc.content, `${typeId}-container`);
        }

        // [ê³¼ê±° ë²„ì „ ë Œë”ë§] (ì•„ì½”ë””ì–¸)
        const archiveBox = document.getElementById(typeId === 'articles' ? 'accordionArticles' : 'accordionBylaws');
        if (pastDocs.length > 0) {
            let html = '';
            pastDocs.forEach((doc, idx) => {
                const itemId = `${typeId}Arch${idx}`;
                html += `
                    <div class="accordion-item searchable-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${itemId}">
                                ${doc.title} <span class="archive-badge">${doc.event_date}</span>
                            </button>
                        </h2>
                        <div id="${itemId}" class="accordion-collapse collapse">
                            <div class="accordion-body bg-light">
                                <div class="archive-content" style="white-space: pre-wrap; font-size:0.9rem;">
                                    ${doc.content} 
                                </div>
                            </div>
                        </div>
                    </div>`;
            });
            archiveBox.innerHTML = html;
        } else {
            archiveBox.innerHTML = '<div class="text-center text-muted small py-3">ì§€ë‚œ ê°œì • ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
    }

    // â˜… [í•µì‹¬ ê¸°ëŠ¥] í…ìŠ¤íŠ¸ë¥¼ "ì œNì¡°" ê¸°ì¤€ìœ¼ë¡œ ì˜ë¼ì„œ ì˜ˆìœ ì¹´ë“œë¡œ ë§Œë“¤ê¸°
    function renderCards(text, containerId) {
        const container = document.getElementById(containerId);
        if (!text) return;

        // ì •ê·œì‹: ì¤„ë°”ê¿ˆ ë’¤ì— 'ì œ ìˆ«ì ì¡°'ê°€ ë‚˜ì˜¤ë©´ ê±°ê¸°ì„œ ìª¼ê°¬
        const parts = text.split(/(\n|^)(?=ì œ\s*\d+\s*ì¡°)/g);
        
        let html = '';
        parts.forEach(part => {
            const trimmed = part.trim();
            if (!trimmed) return;

            let title = '';
            let body = '';

            // 'ì œ...ì¡°'ë¡œ ì‹œì‘í•˜ëŠ”ì§€ í™•ì¸
            if (trimmed.startsWith('ì œ')) {
                // 1. ì²« ë²ˆì§¸ ì¤„ë°”ê¿ˆì„ ì°¾ì•„ì„œ ì œëª©/ë‚´ìš© ë¶„ë¦¬ ì‹œë„
                const firstBreak = trimmed.indexOf('\n');
                
                if (firstBreak > -1) {
                    title = trimmed.substring(0, firstBreak).trim();
                    body = trimmed.substring(firstBreak).trim();
                } else {
                    // 2. ì¤„ë°”ê¿ˆì´ ì—†ìœ¼ë©´ ')' ê´„í˜¸ ë’¤ë‚˜ ê³µë°± ê¸°ì¤€ìœ¼ë¡œ ì œëª© ì¶”ì¶œ ì‹œë„
                    // ì˜ˆ: "ì œ3ì¡°(ëª©ì ) ë‚´ìš©..." -> ì œëª©: ì œ3ì¡°(ëª©ì ), ë‚´ìš©: ë‚´ìš©...
                    const match = trimmed.match(/^(ì œ\s*\d+\s*ì¡°.*?\)|ì œ\s*\d+\s*ì¡°)\s*/);
                    if (match) {
                        title = match[0].trim();
                        body = trimmed.substring(match[0].length).trim();
                    } else {
                        // ì‹¤íŒ¨ ì‹œ ì „ì²´ë¥¼ ì œëª©ìœ¼ë¡œ (ë‚´ìš© ì—†ìŒ)
                        title = trimmed;
                    }
                }
            } else {
                // ì œNì¡°ê°€ ì•„ë‹ˆë©´ (ì„œë¬¸, ë¶€ì¹™ ë“±)
                title = '';
                body = trimmed;
            }

            // HTML ì¡°ë¦½
            if (title) {
                // â˜… ì—¬ê¸°ê°€ êµ­ì¥ë‹˜ì´ ì›í•˜ì‹  ë””ìì¸ (ë…¹ìƒ‰ ì œëª© + ê²€ì • ë³¸ë¬¸)
                html += `
                <div class="article-card searchable-item">
                    <span class="article-title">${title}</span>
                    <div class="article-content">${textToHtml(body)}</div>
                </div>`;
            } else {
                // ì œëª© ì—†ëŠ” ë©ì–´ë¦¬
                html += `
                <div class="article-card searchable-item">
                    <div class="article-content">${textToHtml(body)}</div>
                </div>`;
            }
        });

        container.innerHTML = html;
    }

    // ì¤„ë°”ê¿ˆì„ <br>ë¡œ ë³€í™˜
    function textToHtml(str) {
        if (!str) return '';
        return str.replace(/\n/g, '<br>');
    }

    // ê²€ìƒ‰ í•„í„°
    function filterContent() {
        const keyword = document.getElementById('searchInput').value.toLowerCase();
        const items = document.querySelectorAll('.searchable-item');

        items.forEach(item => {
            // ì•„ì½”ë””ì–¸ì´ ë‹«í˜€ìˆìœ¼ë©´ ê²€ìƒ‰ ì œì™¸
            const collapseDiv = item.querySelector('.accordion-collapse');
            if (collapseDiv && !collapseDiv.classList.contains('show')) {
                item.style.display = ''; 
                return; 
            }

            const text = item.innerText.toLowerCase();
            if (text.includes(keyword)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    }
  </script>
</body>
</html>
